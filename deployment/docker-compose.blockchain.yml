version: '3.9'

# Blockchain Layer - V11 Core Services
# Usage: docker-compose -f docker-compose.base.yml -f docker-compose.blockchain.yml up -d

services:
  # API Gateway - NGINX reverse proxy and load balancer
  api-gateway:
    image: nginx:alpine
    container_name: aurigraph-api-gateway
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl/certs:/etc/nginx/certs:ro
    networks:
      - frontend
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      app: aurigraph-dlt
      component: api
      role: gateway

  # V11 API Service - Main REST API endpoint
  api-v11:
    image: aurigraph/v11:latest
    container_name: aurigraph-api-v11
    environment:
      JAVA_OPTS: -Xmx2g -Xms1g
      QUARKUS_HTTP_PORT: 9003
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-aurigraph_dlt}
      DB_USER: ${DB_USER:-aurigraph}
      DB_PASSWORD: ${DB_PASSWORD:-aurigraph}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      HAZELCAST_HOST: hazelcast
      HAZELCAST_PORT: 5701
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "9003:9003"
    networks:
      - frontend
      - backend
    depends_on:
      - postgres
      - redis
      - hazelcast
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9003/q/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      app: aurigraph-dlt
      component: api
      role: v11-service

  # Validator Node 1 - Consensus participant
  validator-1:
    image: aurigraph/v11:latest
    container_name: aurigraph-validator-1
    environment:
      JAVA_OPTS: -Xmx4g -Xms2g
      NODE_TYPE: validator
      NODE_ID: validator-1
      VALIDATOR_PORT: 9100
      CONSENSUS_PEERS: validator-2:9100,validator-3:9100
      DB_HOST: postgres
      DB_PORT: 5432
    ports:
      - "9100:9100"
    networks:
      - backend
    depends_on:
      - postgres
    restart: unless-stopped
    labels:
      app: aurigraph-dlt
      component: consensus
      role: validator

  # Validator Node 2 - Consensus participant
  validator-2:
    image: aurigraph/v11:latest
    container_name: aurigraph-validator-2
    environment:
      JAVA_OPTS: -Xmx4g -Xms2g
      NODE_TYPE: validator
      NODE_ID: validator-2
      VALIDATOR_PORT: 9101
      CONSENSUS_PEERS: validator-1:9100,validator-3:9100
      DB_HOST: postgres
      DB_PORT: 5432
    ports:
      - "9101:9101"
    networks:
      - backend
    depends_on:
      - postgres
    restart: unless-stopped
    labels:
      app: aurigraph-dlt
      component: consensus
      role: validator

  # Validator Node 3 - Consensus participant
  validator-3:
    image: aurigraph/v11:latest
    container_name: aurigraph-validator-3
    environment:
      JAVA_OPTS: -Xmx4g -Xms2g
      NODE_TYPE: validator
      NODE_ID: validator-3
      VALIDATOR_PORT: 9102
      CONSENSUS_PEERS: validator-1:9100,validator-2:9101
      DB_HOST: postgres
      DB_PORT: 5432
    ports:
      - "9102:9102"
    networks:
      - backend
    depends_on:
      - postgres
    restart: unless-stopped
    labels:
      app: aurigraph-dlt
      component: consensus
      role: validator

networks:
  frontend:
    external: true
  backend:
    external: true

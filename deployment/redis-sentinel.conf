# Sprint 18: Redis Sentinel Configuration for HA
# Automatic failover and monitoring for Redis cluster

# ========== Sentinel Configuration ==========
# Port Sentinel listens on
port 26379

# Bind to all interfaces
bind 0.0.0.0

# Daemonize (disable in Docker)
daemonize no

# Log file
logfile "/var/log/sentinel.log"

# Log level
loglevel notice

# ========== Master Monitoring ==========
# Master name: redis-master
# Master host: redis-primary
# Master port: 6379
# Quorum: 2 (need 2 out of 3 Sentinels to agree on failover)
sentinel monitor redis-master redis-primary 6379 2

# ========== Sentinel Timeout Settings ==========
# How long a master should be disconnected to be considered down (milliseconds)
sentinel down-after-milliseconds redis-master 30000

# How long failover process can take (milliseconds)
sentinel failover-timeout redis-master 180000

# ========== Replication Settings ==========
# Number of replicas to reconfigure for new master
sentinel parallel-syncs redis-master 1

# ========== Notification Scripts (Optional) ==========
# Script to run when master is down
# sentinel notification-script redis-master /path/to/notification.sh

# Script to run before/after failover
# sentinel client-reconfig-script redis-master /path/to/reconfig.sh

# ========== Security ==========
# Require password for Sentinel access
requirepass sentinel_password_2025

# Master auth password (if master requires password)
sentinel auth-pass redis-master redis_password_2025

# ACL support (Redis 6.0+)
# aclfile "/etc/redis/sentinel-acl.conf"

# ========== Monitoring ==========
# Enable extended statistics
stats_replication_offset yes

# Track master offset
tracking_info_percentage 100

# ========== Connection Settings ==========
# TCP backlog
tcp-backlog 511

# TCP keep-alive
tcp-keepalive 300

# ========== Memory Management ==========
# Memory limit
maxmemory 256mb

# Memory eviction policy
maxmemory-policy allkeys-lru

# ========== Append Only File (Persistence) ==========
# Enable AOF for durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec

# ========== Snapshot (RDB) ==========
# Save snapshots
save 900 1      # 15 minutes if 1 change
save 300 10     # 5 minutes if 10 changes
save 60 10000   # 1 minute if 10000 changes

# Stop writes if save fails
stop-writes-on-bgsave-error yes

# Compress snapshots
rdbcompression yes

# RDB filename
dbfilename "dump.rdb"

# ========== Sentinel Specific ==========
# Sentinel working directory (for dump files, etc.)
dir "/var/lib/redis"

# ========== Sentinel Monitoring Intervals ==========
# How often to check master health
sentinel auth-user redis-master default
sentinel auth-pass redis-master redis_password_2025

# Ping interval (how often to ping master)
sentinel ping-interval 30000

# Info replication interval (how often to get replication info)
sentinel info-period 10000

# ========== Sentinel Denial of Service Protection ==========
# Deny or allow access from a list of clients
# sentinel deny-scripts-reconfig yes

# ========== Cluster Support (If using Redis Cluster) ==========
# sentinel cluster-enabled no

# ========== Extensions (Modules) ==========
# loadmodule "/path/to/module.so"

# ========== ACL Configuration ==========
# Define ACL users for Sentinel
# user admin on >admin_password_2025 +@all ~*
# user sentinel on >sentinel_password_2025 +sentinel +ping +info +client +config +rewrite +hello +failover ~*
# user monitoring on >monitoring_password_2025 +@read ~*

# ========== Sentinel Named IP Groups ==========
# For multi-region deployments
# replica-binding-address 10.0.0.2

# ========== Sentinel Failover Behavior ==========
# Timeout for waiting on failover completion
sentinel min-other-sentinels 1

# ========== Master Down Detection ==========
# If sentinel sees master as down X times, take action
sentinel monitor-retry 30000

# ========== Announce Settings (for Docker/Kubernetes) ==========
# sentinel announce-ip 172.26.0.40
# sentinel announce-port 26379

# ========== Redis Sentinel Verbosity ==========
# Increased logging for debugging
loglevel notice

# Sentinel log file
logfile ""

# ========== Sentinel TLS Support (Redis 6.0+) ==========
# TLS port for Sentinel
tls-port 26380

# TLS certificate files
tls-cert-file /etc/redis/sentinel/tls/sentinel.crt
tls-key-file /etc/redis/sentinel/tls/sentinel.key
tls-ca-cert-file /etc/redis/sentinel/tls/ca.crt

# TLS DH params
tls-dh-params-file /etc/redis/sentinel/tls/sentinel.dh

# Require authentication for TLS
tls-replication yes
tls-enabled yes

# ========== Sentinel Client Output Buffer Limits ==========
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ========== Master Reachability ==========
# How many consecutive failures before marking as down
sentinel down-after-milliseconds redis-master 30000

# ========== Failover Conditions ==========
# Number of Sentinels that must agree to failover
sentinel parallel-syncs redis-master 1

# ========== Sentinel Keepalive ==========
# Keep sentinel connections alive
sentinel sentinel-subscribe-timeout 30000

# ========== Configuration Rewrite ==========
# Automatically update this file on failover
sentinel auto-reset-timeout 180000

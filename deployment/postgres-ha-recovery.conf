# Sprint 18: PostgreSQL HA Recovery Configuration
# Streaming replication and automatic failover for high availability

# ========== Replication Settings ==========
# Enable archiving for point-in-time recovery
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10
wal_keep_segments = 64

# Archive WAL logs to storage
archive_mode = on
archive_command = 'test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'
archive_timeout = 300

# ========== Hot Standby Settings ==========
hot_standby = on
hot_standby_feedback = on

# ========== Recovery Configuration ==========
# Primary server connection string for standby
# This will be set via environment variables
primary_conninfo = 'host=postgres-primary port=5432 user=replication password=$REPLICATION_PASSWORD'

# Automatic failover promotion
promote_trigger_file = '/tmp/promote_to_primary'

# ========== Synchronous Replication ==========
# Ensure data is replicated before acknowledging write (for durability)
synchronous_commit = remote_apply
synchronous_standby_names = 'standby1'

# ========== Connection Settings ==========
# Allow replication connections
listen_addresses = '*'
max_connections = 500

# ========== Checkpoint Settings ==========
checkpoint_timeout = 15min
max_checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100

# ========== Performance Tuning ==========
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 4MB

# ========== Replication Slot Settings ==========
# Use replication slots for automatic WAL retention
slot_name = 'standby_slot1'
slot_type = 'physical'

# ========== Logging ==========
log_replication_commands = on
log_connections = on
log_disconnections = on
log_statement = 'all'
log_duration = off
log_min_duration_statement = 1000

# ========== SSL/TLS Settings ==========
ssl = on
ssl_cert_file = '/var/lib/postgresql/server.crt'
ssl_key_file = '/var/lib/postgresql/server.key'
ssl_ca_file = '/var/lib/postgresql/ca.crt'

# ========== Monitoring ==========
track_activities = on
track_counts = on
track_io_timing = on
shared_preload_libraries = 'pg_stat_statements'

# ========== Security ==========
# Restrict superuser access
super_user_reserved_connections = 10

# Force all connections over SSL
password_encryption = scram-sha-256

# ========== Backup and Recovery ==========
# WAL archiving destination
wal_archive_dir = '/var/lib/postgresql/archive'

# Point-in-time recovery
recovery_target_timeline = 'latest'
recovery_target = 'immediate'

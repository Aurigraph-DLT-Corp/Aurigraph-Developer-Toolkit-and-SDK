version: '3.8'

# AV11-17 External Storage Configuration
# User data and logs stored on bare-metal server outside containers

services:
  # PostgreSQL Database for persistent user data
  aurigraph-database:
    image: postgres:16-alpine
    container_name: aurigraph-database
    environment:
      POSTGRES_DB: aurigraph
      POSTGRES_USER: aurigraph
      POSTGRES_PASSWORD: aurigraph123
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      # External bare-metal storage for database
      - /opt/aurigraph/data/postgresql:/var/lib/postgresql/data
      - /opt/aurigraph/logs/postgresql:/var/log/postgresql
    ports:
      - "5432:5432"
    networks:
      - aurigraph-external
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aurigraph -d aurigraph"]
      interval: 30s
      timeout: 10s
      retries: 5
    labels:
      - "aurigraph.service=database"
      - "aurigraph.compliance=AV11-17"

  # Redis for session management and caching
  aurigraph-redis:
    image: redis:7-alpine
    container_name: aurigraph-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      # External storage for Redis persistence
      - /opt/aurigraph/data/redis:/data
      - /opt/aurigraph/logs/redis:/var/log/redis
    ports:
      - "6379:6379"
    networks:
      - aurigraph-external
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "aurigraph.service=cache"
      - "aurigraph.compliance=AV11-17"

  # AV11-17 Compliant Basic Node with External Storage
  aurigraph-basicnode-external:
    build:
      context: .
      dockerfile: src/main/docker/Dockerfile.native
    image: aurigraph/basicnode:10.19.0-av10-17-external
    container_name: aurigraph-basicnode-external
    environment:
      # Database configuration
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://aurigraph-database:5432/aurigraph
      QUARKUS_DATASOURCE_USERNAME: aurigraph
      QUARKUS_DATASOURCE_PASSWORD: aurigraph123
      
      # Redis configuration
      QUARKUS_REDIS_HOSTS: redis://aurigraph-redis:6379
      
      # External storage configuration
      AURIGRAPH_STORAGE_EXTERNAL_ENABLED: "true"
      AURIGRAPH_STORAGE_EXTERNAL_BASE_PATH: "/external/data"
      
      # Node configuration
      AURIGRAPH_NODE_ID: "basic-node-external-${HOSTNAME}"
      AURIGRAPH_NODE_COMPLIANCE: "AV11-17"
      
      # AV11-17 Performance settings
      QUARKUS_HTTP_HOST: "0.0.0.0"
      QUARKUS_HTTP_PORT: "8080"
      JAVA_OPTS_APPEND: "-Xmx256m -Xms128m -XX:+UseG1GC"
    
    volumes:
      # Mount external bare-metal storage
      - /opt/aurigraph/data:/external/data
      - /opt/aurigraph/logs:/external/logs
      - /opt/aurigraph/config:/external/config:ro
      
      # Additional mounts for user-specific data
      - /opt/aurigraph/users:/external/users
      - /opt/aurigraph/checkpoints:/external/checkpoints
      - /opt/aurigraph/transactions:/external/transactions
    
    ports:
      - "8080:8080"
      - "9090:9090" # Metrics port
    
    networks:
      - aurigraph-external
      - aurigraph-internal
    
    depends_on:
      aurigraph-database:
        condition: service_healthy
      aurigraph-redis:
        condition: service_healthy
    
    restart: unless-stopped
    
    # AV11-17 Resource constraints
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    labels:
      - "aurigraph.service=basicnode"
      - "aurigraph.compliance=AV11-17"
      - "aurigraph.storage=external"

  # File System Monitor for external storage health
  storage-monitor:
    image: alpine:latest
    container_name: aurigraph-storage-monitor
    command: |
      sh -c '
        while true; do
          echo "$(date): Monitoring external storage health"
          df -h /external/data
          du -sh /external/data/* 2>/dev/null || true
          sleep 300
        done
      '
    volumes:
      - /opt/aurigraph:/external:ro
      - /opt/aurigraph/logs/monitor:/var/log
    networks:
      - aurigraph-external
    restart: unless-stopped
    labels:
      - "aurigraph.service=storage-monitor"
      - "aurigraph.compliance=AV11-17"

  # Backup Service for external data
  backup-service:
    image: alpine:latest
    container_name: aurigraph-backup
    command: |
      sh -c '
        apk add --no-cache rsync
        while true; do
          echo "$(date): Starting backup process"
          rsync -av /external/data/ /backup/data-$(date +%Y%m%d-%H%M)/
          find /backup -name "data-*" -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
          echo "$(date): Backup completed"
          sleep 86400  # Daily backup
        done
      '
    volumes:
      - /opt/aurigraph:/external:ro
      - /opt/aurigraph/backup:/backup
    networks:
      - aurigraph-external
    restart: unless-stopped
    labels:
      - "aurigraph.service=backup"
      - "aurigraph.compliance=AV11-17"

networks:
  aurigraph-external:
    driver: bridge
    name: aurigraph-external
    labels:
      - "aurigraph.network=external"
      - "aurigraph.compliance=AV11-17"
  
  aurigraph-internal:
    driver: bridge
    name: aurigraph-internal
    internal: true
    labels:
      - "aurigraph.network=internal"
      - "aurigraph.compliance=AV11-17"

volumes:
  # Named volumes for backup and redundancy
  aurigraph-data-backup:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/aurigraph/backup/data
  
  aurigraph-logs-backup:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/aurigraph/backup/logs
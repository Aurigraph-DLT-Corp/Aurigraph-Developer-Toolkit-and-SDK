name: Quality Gates

on:
  pull_request:
    branches: [main, develop]

jobs:
  quality-check:
    name: Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests with coverage
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ./mvnw clean verify

      - name: Quality Gate 1 - Coverage
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          # Check if JaCoCo CSV report exists
          if [ ! -f target/site/jacoco/jacoco.csv ]; then
            echo "âŒ JaCoCo report not found"
            exit 1
          fi

          # Calculate coverage from JaCoCo CSV
          COVERAGE=$(awk -F',' 'NR>1 { instructions += $4 + $5; covered += $5 } END { print int(100 * covered / instructions) }' target/site/jacoco/jacoco.csv)
          echo "::notice::Test Coverage: $COVERAGE%"

          if [ "$COVERAGE" -lt "85" ]; then
            echo "::error::Coverage $COVERAGE% is below 85% threshold"
            exit 1
          fi
          echo "::notice::âœ… Quality Gate 1 PASSED - Coverage: $COVERAGE%"

      - name: Quality Gate 2 - No Critical Bugs
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        continue-on-error: true
        run: |
          ./mvnw spotbugs:check -Dspotbugs.threshold=High || echo "::warning::SpotBugs check failed"

      - name: Quality Gate 3 - Code Style
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        continue-on-error: true
        run: |
          ./mvnw checkstyle:check || echo "::warning::Checkstyle check failed"

      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read JaCoCo report
            let coverage = 'N/A';
            try {
              const csvPath = 'aurigraph-av10-7/aurigraph-v11-standalone/target/site/jacoco/jacoco.csv';
              const csvContent = fs.readFileSync(csvPath, 'utf8');
              const lines = csvContent.split('\n').slice(1);
              let instructions = 0, covered = 0;
              lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 6) {
                  instructions += parseInt(parts[3]) + parseInt(parts[4]);
                  covered += parseInt(parts[4]);
                }
              });
              coverage = Math.round(100 * covered / instructions) + '%';
            } catch (e) {
              console.error('Error reading coverage:', e);
            }

            const body = `## ğŸ“Š Quality Gates Report

            | Gate | Status | Details |
            |------|--------|---------|
            | Test Coverage | ${coverage >= 85 ? 'âœ…' : 'âŒ'} | ${coverage} (threshold: 85%) |
            | Critical Bugs | âš ï¸  | SpotBugs analysis |
            | Code Style | âš ï¸  | Checkstyle validation |

            ${coverage >= 85 ? 'âœ… All critical quality gates passed!' : 'âŒ Quality gate failed: Coverage below threshold'}

            ---
            *Generated by Aurigraph V12 CI/CD Pipeline*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

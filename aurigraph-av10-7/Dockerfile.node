FROM node:20-alpine

# Install Java 24 for NTRU backend
RUN apk add --no-cache openjdk21

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./
COPY tsconfig.json ./

# Install dependencies
RUN npm ci --only=production

# Copy source code
COPY src/ ./src/
COPY config/ ./config/

# Build the application
RUN npm run build

# Create startup script for basic nodes
RUN echo '#!/bin/sh' > /app/start-nodes.sh && \
    echo 'echo "ðŸš€ Starting 20 Basic Nodes in TEST Channel..."' >> /app/start-nodes.sh && \
    echo 'echo "Channel: $CHANNEL_NAME"' >> /app/start-nodes.sh && \
    echo 'echo "Connecting to validators: $CONNECT_TO_VALIDATORS"' >> /app/start-nodes.sh && \
    echo 'echo ""' >> /app/start-nodes.sh && \
    echo '' >> /app/start-nodes.sh && \
    echo '# Node type distribution' >> /app/start-nodes.sh && \
    echo 'NODE_TYPES_ARRAY=("FULL" "FULL" "FULL" "FULL" "FULL" "FULL" "FULL" "FULL" "LIGHT" "LIGHT" "LIGHT" "LIGHT" "LIGHT" "LIGHT" "LIGHT" "ARCHIVE" "ARCHIVE" "BRIDGE" "BRIDGE" "BRIDGE")' >> /app/start-nodes.sh && \
    echo '' >> /app/start-nodes.sh && \
    echo '# Start 20 node processes' >> /app/start-nodes.sh && \
    echo 'for i in $(seq 1 20); do' >> /app/start-nodes.sh && \
    echo '  port=$((8100 + i))' >> /app/start-nodes.sh && \
    echo '  p2p_port=$((30100 + i))' >> /app/start-nodes.sh && \
    echo '  node_type=${NODE_TYPES_ARRAY[$((i-1))]}' >> /app/start-nodes.sh && \
    echo '  node_id="NODE-$(printf "%03d" $i)"' >> /app/start-nodes.sh && \
    echo '  echo "Starting $node_type node $node_id on port $port..."' >> /app/start-nodes.sh && \
    echo '  NODE_ID="$node_id" \' >> /app/start-nodes.sh && \
    echo '  NODE_TYPE="$node_type" \' >> /app/start-nodes.sh && \
    echo '  API_PORT="$port" \' >> /app/start-nodes.sh && \
    echo '  P2P_PORT="$p2p_port" \' >> /app/start-nodes.sh && \
    echo '  NODE_INDEX="$i" \' >> /app/start-nodes.sh && \
    echo '  node dist/nodes/basic-node.js &' >> /app/start-nodes.sh && \
    echo 'done' >> /app/start-nodes.sh && \
    echo '' >> /app/start-nodes.sh && \
    echo 'echo ""' >> /app/start-nodes.sh && \
    echo 'echo "âœ… All 20 nodes started successfully!"' >> /app/start-nodes.sh && \
    echo 'echo "ðŸ”— Node APIs: ports 8101-8120"' >> /app/start-nodes.sh && \
    echo 'echo "ðŸ“¡ P2P Network: ports 30101-30120"' >> /app/start-nodes.sh && \
    echo 'echo "ðŸŒ Connected to TEST channel"' >> /app/start-nodes.sh && \
    echo 'echo ""' >> /app/start-nodes.sh && \
    echo 'wait' >> /app/start-nodes.sh && \
    chmod +x /app/start-nodes.sh

# Create basic node entry point
RUN echo 'import { EnhancedDLTNode } from "../nodes/EnhancedDLTNode";' > /app/dist/nodes/basic-node.js && \
    echo 'import { QuantumCryptoManagerV2 } from "../crypto/QuantumCryptoManagerV2";' >> /app/dist/nodes/basic-node.js && \
    echo 'import { HyperRAFTPlusPlusV2 } from "../consensus/HyperRAFTPlusPlusV2";' >> /app/dist/nodes/basic-node.js && \
    echo 'import { Logger } from "../core/Logger";' >> /app/dist/nodes/basic-node.js && \
    echo '' >> /app/dist/nodes/basic-node.js && \
    echo 'async function startBasicNode() {' >> /app/dist/nodes/basic-node.js && \
    echo '  const logger = new Logger(`Node-${process.env.NODE_ID}`);' >> /app/dist/nodes/basic-node.js && \
    echo '  logger.info(`ðŸŒ Starting ${process.env.NODE_TYPE} node ${process.env.NODE_ID} in TEST channel`);' >> /app/dist/nodes/basic-node.js && \
    echo '' >> /app/dist/nodes/basic-node.js && \
    echo '  const quantumCrypto = new QuantumCryptoManagerV2();' >> /app/dist/nodes/basic-node.js && \
    echo '  await quantumCrypto.initialize();' >> /app/dist/nodes/basic-node.js && \
    echo '' >> /app/dist/nodes/basic-node.js && \
    echo '  const consensus = new HyperRAFTPlusPlusV2();' >> /app/dist/nodes/basic-node.js && \
    echo '  await consensus.initialize();' >> /app/dist/nodes/basic-node.js && \
    echo '' >> /app/dist/nodes/basic-node.js && \
    echo '  const config = {' >> /app/dist/nodes/basic-node.js && \
    echo '    nodeId: process.env.NODE_ID,' >> /app/dist/nodes/basic-node.js && \
    echo '    nodeType: process.env.NODE_TYPE,' >> /app/dist/nodes/basic-node.js && \
    echo '    networkId: process.env.NETWORK_ID,' >> /app/dist/nodes/basic-node.js && \
    echo '    port: parseInt(process.env.API_PORT),' >> /app/dist/nodes/basic-node.js && \
    echo '    p2pPort: parseInt(process.env.P2P_PORT),' >> /app/start-nodes.sh && \
    echo '    channelName: process.env.CHANNEL_NAME,' >> /app/dist/nodes/basic-node.js && \
    echo '    quantumSecurity: true,' >> /app/dist/nodes/basic-node.js && \
    echo '    enableSharding: false,' >> /app/dist/nodes/basic-node.js && \
    echo '    consensusRole: "FOLLOWER"' >> /app/dist/nodes/basic-node.js && \
    echo '  };' >> /app/dist/nodes/basic-node.js && \
    echo '' >> /app/dist/nodes/basic-node.js && \
    echo '  const node = new EnhancedDLTNode(config, quantumCrypto, consensus);' >> /app/dist/nodes/basic-node.js && \
    echo '  await node.initialize();' >> /app/dist/nodes/basic-node.js && \
    echo '' >> /app/dist/nodes/basic-node.js && \
    echo '  logger.info(`âœ… ${process.env.NODE_TYPE} node ${process.env.NODE_ID} ready in TEST channel`);' >> /app/dist/nodes/basic-node.js && \
    echo '}' >> /app/dist/nodes/basic-node.js && \
    echo '' >> /app/dist/nodes/basic-node.js && \
    echo 'startBasicNode().catch(console.error);' >> /app/dist/nodes/basic-node.js

EXPOSE 8101-8120 30101-30120

CMD ["/app/start-nodes.sh"]
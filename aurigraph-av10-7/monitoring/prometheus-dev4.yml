# Prometheus Configuration for Aurigraph AV10-7 Dev4 Environment
# Agent-coordinated monitoring for 800K+ TPS platform

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    environment: 'dev4'
    platform: 'aurigraph-av10-7'
    agent_coordinated: 'true'

# Scrape configurations for all AV10 components
scrape_configs:
  # Validator Node Metrics
  - job_name: 'aurigraph-validator-dev4'
    static_configs:
      - targets: ['validator-dev4-01:8180']
    metrics_path: '/metrics'
    scrape_interval: 5s
    scrape_timeout: 10s
    params:
      module: ['validator']

  # Basic Nodes Metrics
  - job_name: 'aurigraph-nodes-dev4'
    static_configs:
      - targets: 
        - 'node-dev4-01:8200'
        - 'node-dev4-02:8201'
        - 'node-dev4-03:8202'
    metrics_path: '/metrics'
    scrape_interval: 10s
    scrape_timeout: 10s
    params:
      module: ['node']

  # Management Dashboard Metrics
  - job_name: 'aurigraph-management-dev4'
    static_configs:
      - targets: ['management-dev4:3240']
    metrics_path: '/api/metrics'
    scrape_interval: 10s

  # Vizor Dashboard Metrics
  - job_name: 'aurigraph-vizor-dev4'
    static_configs:
      - targets: ['vizor-dev4:3252']
    metrics_path: '/api/metrics'
    scrape_interval: 15s

  # System Metrics (Node Exporter)
  - job_name: 'node-exporter-dev4'
    static_configs:
      - targets: ['host.docker.internal:9100']
    scrape_interval: 10s

  # AV10 Component-Specific Metrics
  - job_name: 'av10-quantum-sharding'
    static_configs:
      - targets: 
        - 'validator-dev4-01:8180'
        - 'node-dev4-01:8200'
        - 'node-dev4-02:8201'
    metrics_path: '/api/quantum/metrics'
    scrape_interval: 5s

  - job_name: 'av10-rwa-platform'
    static_configs:
      - targets: 
        - 'node-dev4-01:8200'
        - 'node-dev4-02:8201'
    metrics_path: '/api/rwa/metrics'
    scrape_interval: 10s

  - job_name: 'av10-predictive-analytics'
    static_configs:
      - targets: ['node-dev4-02:8201']
    metrics_path: '/api/predictive/metrics'
    scrape_interval: 15s

  - job_name: 'av10-neural-networks'
    static_configs:
      - targets: ['node-dev4-02:8201']
    metrics_path: '/api/neural/metrics'
    scrape_interval: 20s

  - job_name: 'av10-compliance'
    static_configs:
      - targets: ['node-dev4-03:8202']
    metrics_path: '/api/compliance/metrics'
    scrape_interval: 30s

# Alerting rules for dev4 environment
rule_files:
  - "/etc/prometheus/alerts/av10-alerts.yml"

# Alert manager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# Recording rules for performance metrics
recording_rules:
  # TPS calculations
  - name: aurigraph.tps
    rules:
    - record: aurigraph:tps:rate5m
      expr: rate(aurigraph_transactions_total[5m])
    - record: aurigraph:tps:avg
      expr: avg(aurigraph:tps:rate5m)
    - record: aurigraph:tps:sum
      expr: sum(aurigraph:tps:rate5m)

  # Latency calculations
  - name: aurigraph.latency
    rules:
    - record: aurigraph:latency:p95
      expr: histogram_quantile(0.95, aurigraph_transaction_duration_seconds_bucket)
    - record: aurigraph:latency:p99
      expr: histogram_quantile(0.99, aurigraph_transaction_duration_seconds_bucket)
    - record: aurigraph:latency:avg
      expr: avg(aurigraph_transaction_duration_seconds_sum / aurigraph_transaction_duration_seconds_count)

  # Resource utilization
  - name: aurigraph.resources
    rules:
    - record: aurigraph:cpu:avg
      expr: avg(rate(container_cpu_usage_seconds_total[5m])) by (container_label_com_docker_compose_service)
    - record: aurigraph:memory:usage_ratio
      expr: container_memory_usage_bytes / container_spec_memory_limit_bytes
    - record: aurigraph:network:bytes_rate
      expr: rate(container_network_receive_bytes_total[5m]) + rate(container_network_transmit_bytes_total[5m])

  # Consensus metrics
  - name: aurigraph.consensus
    rules:
    - record: aurigraph:consensus:block_rate
      expr: rate(aurigraph_blocks_total[1m])
    - record: aurigraph:consensus:validator_participation
      expr: aurigraph_validator_votes_total / aurigraph_consensus_rounds_total
    - record: aurigraph:consensus:finality_time
      expr: avg(aurigraph_consensus_finality_duration_seconds)

# Storage configuration
storage:
  tsdb:
    retention.time: 30d
    retention.size: 50GB
# Aurigraph V11 - Backup Services Module
# Description: Database backups, state snapshots, disaster recovery
version: '3.8'

networks:
  backup:
    driver: bridge

volumes:
  backup-data:
    driver: local
  backup-storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BACKUP_DIR:-./backups}

services:
  # ================================
  # PostgreSQL Backup Service
  # ================================
  postgres-backup:
    image: prodrigestivill/postgres-backup-local:16-alpine
    container_name: aurigraph-postgres-backup
    restart: unless-stopped

    environment:
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-aurigraph}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_EXTRA_OPTS=-Z9 --schema=public --blobs
      - SCHEDULE=@daily
      - BACKUP_KEEP_DAYS=7
      - BACKUP_KEEP_WEEKS=4
      - BACKUP_KEEP_MONTHS=6
      - HEALTHCHECK_PORT=8080

    volumes:
      - backup-storage:/backups

    networks:
      - backup

    labels:
      - "com.aurigraph.service=backup"
      - "com.aurigraph.component=postgres-backup"

  # ================================
  # RocksDB State Backup
  # ================================
  rocksdb-backup:
    image: alpine:latest
    container_name: aurigraph-rocksdb-backup
    restart: "no"
    profiles: ["backup"]

    volumes:
      - ./data/aurigraph:/data/rocksdb:ro
      - backup-storage:/backups
      - ./scripts:/scripts:ro

    command: >
      sh -c "
      apk add --no-cache tar gzip;
      TIMESTAMP=$$(date +%Y%m%d_%H%M%S);
      tar -czf /backups/rocksdb_backup_$${TIMESTAMP}.tar.gz -C /data rocksdb;
      find /backups -name 'rocksdb_backup_*.tar.gz' -mtime +7 -delete;
      echo 'RocksDB backup completed: rocksdb_backup_'$${TIMESTAMP}'.tar.gz';
      "

    networks:
      - backup

    labels:
      - "com.aurigraph.service=backup"
      - "com.aurigraph.component=rocksdb-backup"

  # ================================
  # Configuration Backup
  # ================================
  config-backup:
    image: alpine:latest
    container_name: aurigraph-config-backup
    restart: "no"
    profiles: ["backup"]

    volumes:
      - ./config:/config:ro
      - ./02-config:/project-config:ro
      - backup-storage:/backups

    command: >
      sh -c "
      apk add --no-cache tar gzip;
      TIMESTAMP=$$(date +%Y%m%d_%H%M%S);
      tar -czf /backups/config_backup_$${TIMESTAMP}.tar.gz -C / config project-config;
      find /backups -name 'config_backup_*.tar.gz' -mtime +30 -delete;
      echo 'Configuration backup completed: config_backup_'$${TIMESTAMP}'.tar.gz';
      "

    networks:
      - backup

    labels:
      - "com.aurigraph.service=backup"
      - "com.aurigraph.component=config-backup"

  # ================================
  # S3 Backup Uploader
  # ================================
  s3-backup-sync:
    image: amazon/aws-cli:latest
    container_name: aurigraph-s3-sync
    restart: "no"
    profiles: ["backup", "cloud-backup"]

    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_REGION:-us-east-1}
      - S3_BUCKET=${S3_BACKUP_BUCKET:-aurigraph-backups}

    volumes:
      - backup-storage:/backups:ro

    command: >
      sh -c "
      aws s3 sync /backups s3://$${S3_BUCKET}/backups/ --delete --storage-class GLACIER;
      echo 'S3 sync completed to s3://'$${S3_BUCKET}'/backups/';
      "

    networks:
      - backup

    labels:
      - "com.aurigraph.service=backup"
      - "com.aurigraph.component=s3-sync"

  # ================================
  # Backup Restore Service
  # ================================
  restore-service:
    image: alpine:latest
    container_name: aurigraph-restore
    restart: "no"
    profiles: ["restore"]

    volumes:
      - backup-storage:/backups:ro
      - ./data/aurigraph:/data/rocksdb
      - ./scripts:/scripts:ro

    command: >
      sh -c "
      if [ -z '$${RESTORE_FILE}' ]; then
        echo 'ERROR: RESTORE_FILE environment variable not set';
        exit 1;
      fi;
      if [ ! -f '/backups/$${RESTORE_FILE}' ]; then
        echo 'ERROR: Backup file not found: '$${RESTORE_FILE};
        exit 1;
      fi;
      echo 'Restoring from: '$${RESTORE_FILE};
      tar -xzf /backups/$${RESTORE_FILE} -C /data;
      echo 'Restore completed successfully';
      "

    networks:
      - backup

    labels:
      - "com.aurigraph.service=backup"
      - "com.aurigraph.component=restore-service"

  # ================================
  # Backup Monitoring
  # ================================
  backup-monitor:
    image: prom/pushgateway:v1.7.0
    container_name: aurigraph-backup-monitor
    restart: unless-stopped
    profiles: ["backup-monitoring"]

    ports:
      - "9091:9091"

    networks:
      - backup

    labels:
      - "com.aurigraph.service=backup"
      - "com.aurigraph.component=backup-monitor"

# Aurigraph V11 - CI/CD Integration Module
# Description: Jenkins, GitLab Runner, artifact storage, CI/CD pipelines
version: '3.8'

networks:
  cicd:
    driver: bridge

volumes:
  jenkins-data:
    driver: local
  gitlab-runner-config:
    driver: local
  nexus-data:
    driver: local

services:
  # ================================
  # Jenkins CI/CD Server
  # ================================
  jenkins:
    image: jenkins/jenkins:lts-jdk21
    container_name: aurigraph-jenkins
    restart: unless-stopped
    profiles: ["jenkins"]

    user: root

    environment:
      - JENKINS_OPTS=--httpPort=8081
      - JAVA_OPTS=-Xmx2048m -Xms512m

    ports:
      - "8081:8081"
      - "50000:50000"

    volumes:
      - jenkins-data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - ./jenkins/plugins.txt:/usr/share/jenkins/ref/plugins.txt:ro

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8081/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    networks:
      - cicd

    labels:
      - "com.aurigraph.service=cicd"
      - "com.aurigraph.component=jenkins"

  # ================================
  # GitLab Runner
  # ================================
  gitlab-runner:
    image: gitlab/gitlab-runner:alpine
    container_name: aurigraph-gitlab-runner
    restart: unless-stopped
    profiles: ["gitlab"]

    volumes:
      - gitlab-runner-config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      - RUNNER_EXECUTOR=docker
      - DOCKER_IMAGE=maven:3.9-eclipse-temurin-21

    networks:
      - cicd

    labels:
      - "com.aurigraph.service=cicd"
      - "com.aurigraph.component=gitlab-runner"

  # ================================
  # Artifact Repository - Nexus
  # ================================
  nexus:
    image: sonatype/nexus3:latest
    container_name: aurigraph-nexus
    restart: unless-stopped
    profiles: ["artifacts"]

    environment:
      - INSTALL4J_ADD_VM_PARAMS=-Xms1024m -Xmx2048m

    ports:
      - "8082:8081"  # Nexus UI
      - "8083:8083"  # Docker Registry

    volumes:
      - nexus-data:/nexus-data

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8081/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

    networks:
      - cicd

    labels:
      - "com.aurigraph.service=cicd"
      - "com.aurigraph.component=nexus"

  # ================================
  # SonarQube Code Quality
  # ================================
  sonarqube-db:
    image: postgres:16-alpine
    container_name: aurigraph-sonarqube-db
    restart: unless-stopped
    profiles: ["sonarqube"]

    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=${SONAR_DB_PASSWORD:-sonar}
      - POSTGRES_DB=sonarqube

    volumes:
      - ./data/sonarqube-db:/var/lib/postgresql/data

    networks:
      - cicd

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sonar"]
      interval: 10s
      timeout: 5s
      retries: 5

  sonarqube:
    image: sonarqube:community
    container_name: aurigraph-sonarqube
    restart: unless-stopped
    profiles: ["sonarqube"]

    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://sonarqube-db:5432/sonarqube
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=${SONAR_DB_PASSWORD:-sonar}
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true

    ports:
      - "9000:9000"

    volumes:
      - ./data/sonarqube-data:/opt/sonarqube/data
      - ./data/sonarqube-logs:/opt/sonarqube/logs
      - ./data/sonarqube-extensions:/opt/sonarqube/extensions

    depends_on:
      sonarqube-db:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9000/api/system/status | grep -q '\"status\":\"UP\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

    networks:
      - cicd

    labels:
      - "com.aurigraph.service=cicd"
      - "com.aurigraph.component=sonarqube"

  # ================================
  # Docker Registry (Private)
  # ================================
  docker-registry:
    image: registry:2
    container_name: aurigraph-docker-registry
    restart: unless-stopped
    profiles: ["registry"]

    environment:
      - REGISTRY_HTTP_ADDR=0.0.0.0:5000
      - REGISTRY_STORAGE_DELETE_ENABLED=true

    ports:
      - "5000:5000"

    volumes:
      - ./data/docker-registry:/var/lib/registry
      - ./config/registry:/etc/docker/registry:ro

    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:5000/v2/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

    networks:
      - cicd

    labels:
      - "com.aurigraph.service=cicd"
      - "com.aurigraph.component=docker-registry"

  # ================================
  # CI/CD Build Agent
  # ================================
  build-agent:
    image: maven:3.9-eclipse-temurin-21
    container_name: aurigraph-build-agent
    restart: "no"
    profiles: ["build"]

    working_dir: /workspace

    volumes:
      - .:/workspace
      - ~/.m2:/root/.m2
      - /var/run/docker.sock:/var/run/docker.sock

    command: >
      sh -c "
      echo 'Starting build...';
      ./mvnw clean package -DskipTests;
      echo 'Build completed successfully';
      "

    networks:
      - cicd

    labels:
      - "com.aurigraph.service=cicd"
      - "com.aurigraph.component=build-agent"

  # ================================
  # Deployment Agent
  # ================================
  deploy-agent:
    image: alpine:latest
    container_name: aurigraph-deploy-agent
    restart: "no"
    profiles: ["deploy"]

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./target:/artifacts:ro
      - ./scripts:/scripts:ro

    command: >
      sh -c "
      apk add --no-cache docker-cli curl;
      echo 'Starting deployment...';
      /scripts/deploy.sh;
      echo 'Deployment completed';
      "

    networks:
      - cicd

    labels:
      - "com.aurigraph.service=cicd"
      - "com.aurigraph.component=deploy-agent"

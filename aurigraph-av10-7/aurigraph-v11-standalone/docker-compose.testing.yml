# Aurigraph V11 - Testing Services Module
# Description: Test containers, integration tests, E2E testing infrastructure
version: '3.8'

networks:
  testing:
    driver: bridge

services:
  # ================================
  # Test Database (PostgreSQL)
  # ================================
  postgres-test:
    image: postgres:16-alpine
    container_name: aurigraph-postgres-test
    restart: "no"
    profiles: ["testing"]

    environment:
      - POSTGRES_DB=aurigraph_test
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_password
      - POSTGRES_HOST_AUTH_METHOD=trust

    ports:
      - "5433:5432"

    tmpfs:
      - /var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user"]
      interval: 10s
      timeout: 5s
      retries: 5

    networks:
      - testing

    labels:
      - "com.aurigraph.service=testing"
      - "com.aurigraph.component=postgres-test"

  # ================================
  # Test Redis Cache
  # ================================
  redis-test:
    image: redis:7.2.4-alpine
    container_name: aurigraph-redis-test
    restart: "no"
    profiles: ["testing"]

    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru

    ports:
      - "6380:6379"

    tmpfs:
      - /data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

    networks:
      - testing

    labels:
      - "com.aurigraph.service=testing"
      - "com.aurigraph.component=redis-test"

  # ================================
  # Unit Test Runner
  # ================================
  unit-tests:
    build:
      context: .
      dockerfile: Dockerfile
      target: test
    container_name: aurigraph-unit-tests
    restart: "no"
    profiles: ["unit-tests"]

    environment:
      - TEST_TYPE=unit
      - MAVEN_OPTS=-Xmx1024m
      - QUARKUS_TEST_PROFILE=test

    volumes:
      - ./src:/app/src:ro
      - ./target:/app/target
      - ./pom.xml:/app/pom.xml:ro
      - ~/.m2:/root/.m2

    command: ./mvnw test -Dtest=**/*Test.java

    networks:
      - testing

    labels:
      - "com.aurigraph.service=testing"
      - "com.aurigraph.component=unit-tests"

  # ================================
  # Integration Test Runner
  # ================================
  integration-tests:
    build:
      context: .
      dockerfile: Dockerfile
      target: test
    container_name: aurigraph-integration-tests
    restart: "no"
    profiles: ["integration-tests"]

    environment:
      - TEST_TYPE=integration
      - POSTGRES_HOST=postgres-test
      - REDIS_HOST=redis-test
      - QUARKUS_TEST_PROFILE=integration

    volumes:
      - ./src:/app/src:ro
      - ./target:/app/target
      - ./pom.xml:/app/pom.xml:ro
      - ~/.m2:/root/.m2

    command: ./mvnw verify -Dtest=**/*IT.java

    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy

    networks:
      - testing

    labels:
      - "com.aurigraph.service=testing"
      - "com.aurigraph.component=integration-tests"

  # ================================
  # E2E Test Runner (Selenium)
  # ================================
  selenium-hub:
    image: selenium/hub:4.18.0
    container_name: aurigraph-selenium-hub
    restart: "no"
    profiles: ["e2e-tests"]

    ports:
      - "4444:4444"
      - "4442:4442"
      - "4443:4443"

    environment:
      - SE_SESSION_REQUEST_TIMEOUT=300
      - SE_NODE_MAX_SESSIONS=5

    networks:
      - testing

    labels:
      - "com.aurigraph.service=testing"
      - "com.aurigraph.component=selenium-hub"

  selenium-chrome:
    image: selenium/node-chrome:4.18.0
    container_name: aurigraph-selenium-chrome
    restart: "no"
    profiles: ["e2e-tests"]

    environment:
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_SESSIONS=3

    shm_size: 2gb

    depends_on:
      - selenium-hub

    networks:
      - testing

    labels:
      - "com.aurigraph.service=testing"
      - "com.aurigraph.component=selenium-chrome"

  e2e-tests:
    build:
      context: ./enterprise-portal
      dockerfile: Dockerfile.test
    container_name: aurigraph-e2e-tests
    restart: "no"
    profiles: ["e2e-tests"]

    environment:
      - SELENIUM_HUB_URL=http://selenium-hub:4444
      - BASE_URL=http://aurigraph-v11-native:9003

    volumes:
      - ./enterprise-portal/e2e:/app/e2e:ro
      - ./test-reports:/app/reports

    command: npm run test:e2e

    depends_on:
      - selenium-hub
      - selenium-chrome

    networks:
      - testing

    labels:
      - "com.aurigraph.service=testing"
      - "com.aurigraph.component=e2e-tests"

  # ================================
  # Performance Test (K6)
  # ================================
  k6-load-test:
    image: grafana/k6:latest
    container_name: aurigraph-k6-load
    restart: "no"
    profiles: ["performance-tests"]

    environment:
      - K6_OUT=influxdb=http://influxdb:8086/k6

    volumes:
      - ./tests/performance:/scripts:ro
      - ./test-reports:/reports

    command: >
      run
      --vus 100
      --duration 5m
      --out json=/reports/k6-results.json
      /scripts/load-test.js

    networks:
      - testing

    labels:
      - "com.aurigraph.service=testing"
      - "com.aurigraph.component=k6-load-test"

  # ================================
  # Test Report Generator
  # ================================
  allure-report:
    image: frankescobar/allure-docker-service:latest
    container_name: aurigraph-allure-report
    restart: "no"
    profiles: ["test-reports"]

    ports:
      - "5050:5050"

    volumes:
      - ./test-reports/allure-results:/app/allure-results
      - ./test-reports/allure-reports:/app/allure-reports

    environment:
      - CHECK_RESULTS_EVERY_SECONDS=3
      - KEEP_HISTORY=1

    networks:
      - testing

    labels:
      - "com.aurigraph.service=testing"
      - "com.aurigraph.component=allure-report"

  # ================================
  # Test Coverage Reporter (JaCoCo)
  # ================================
  coverage-report:
    image: nginx:alpine
    container_name: aurigraph-coverage-report
    restart: "no"
    profiles: ["test-reports"]

    ports:
      - "8090:80"

    volumes:
      - ./target/site/jacoco:/usr/share/nginx/html:ro

    networks:
      - testing

    labels:
      - "com.aurigraph.service=testing"
      - "com.aurigraph.component=coverage-report"

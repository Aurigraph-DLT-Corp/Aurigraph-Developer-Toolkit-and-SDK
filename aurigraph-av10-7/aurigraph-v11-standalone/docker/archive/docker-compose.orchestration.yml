# Aurigraph V11 - Service Orchestration Master File
# Description: Orchestrates all modular Docker Compose files
# Usage: docker-compose -f docker-compose.orchestration.yml --profile <profile> up
version: '3.8'

# Import all modular compose files
include:
  - path: docker-compose.yml
    env_file: .env
  - path: docker-compose.monitoring.yml
    env_file: .env
  - path: docker-compose.security.yml
    env_file: .env
  - path: docker-compose.backup.yml
    env_file: .env
  - path: docker-compose.scaling.yml
    env_file: .env
  - path: docker-compose.testing.yml
    env_file: .env
  - path: docker-compose.ci.yml
    env_file: .env
  - path: docker-compose.staging.yml
    env_file: .env
  - path: docker-compose.migration.yml
    env_file: .env

# Global networks (shared across modules)
networks:
  global-frontend:
    external: true
    name: aurigraph-frontend
  global-backend:
    external: true
    name: aurigraph-backend
  global-monitoring:
    external: true
    name: monitoring

# Global volumes (shared across modules)
volumes:
  global-aurigraph-data:
    external: true
    name: aurigraph-data
  global-prometheus-data:
    external: true
    name: prometheus-data
  global-grafana-data:
    external: true
    name: grafana-data

# Orchestration profiles
# Usage examples:
#   Production full stack:
#     docker-compose -f docker-compose.orchestration.yml up
#
#   Development with monitoring:
#     docker-compose -f docker-compose.orchestration.yml --profile monitoring up
#
#   Staging environment:
#     docker-compose -f docker-compose.orchestration.yml --profile staging up
#
#   Testing environment:
#     docker-compose -f docker-compose.orchestration.yml --profile testing --profile unit-tests up
#
#   CI/CD with Jenkins:
#     docker-compose -f docker-compose.orchestration.yml --profile jenkins --profile artifacts up
#
#   Full production with all services:
#     docker-compose -f docker-compose.orchestration.yml \
#       --profile monitoring \
#       --profile backup \
#       --profile scaling \
#       up -d

services:
  # Orchestration health check service
  orchestration-health:
    image: alpine:latest
    container_name: aurigraph-orchestration-health
    restart: "no"
    profiles: ["health-check"]

    command: >
      sh -c "
      echo '=== Aurigraph V11 Orchestration Health Check ===';
      echo '';
      echo 'Checking service availability...';
      echo '';
      apk add --no-cache curl;

      echo 'Core Application:';
      curl -f http://aurigraph-v11-native:9003/q/health || echo 'FAIL: Core app not healthy';

      echo '';
      echo 'Monitoring Services:';
      curl -f http://prometheus:9090/-/healthy || echo 'WARN: Prometheus not available';
      curl -f http://grafana:3000/api/health || echo 'WARN: Grafana not available';

      echo '';
      echo 'Security Services:';
      curl -f http://vault:8200/v1/sys/health || echo 'WARN: Vault not available';
      curl -f http://keycloak:8180/health/ready || echo 'WARN: Keycloak not available';

      echo '';
      echo '=== Health Check Complete ===';
      "

    networks:
      - global-frontend
      - global-backend

    labels:
      - "com.aurigraph.service=orchestration"
      - "com.aurigraph.component=health-check"

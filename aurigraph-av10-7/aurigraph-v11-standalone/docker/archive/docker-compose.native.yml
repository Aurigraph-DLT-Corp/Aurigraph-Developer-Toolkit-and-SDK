# Aurigraph V12 Native Container Deployment
# Uses native GraalVM executables (not JVM)
#
# Key Benefits:
# - Sub-second startup (<500ms vs 30s JVM)
# - Low memory footprint (256MB vs 4GB JVM)
# - Instant scaling for container orchestration
#
# Deploy:
#   docker-compose -f docker-compose.native.yml up -d
#   docker-compose -f docker-compose.native.yml up -d --scale native-business=5

version: '3.8'

x-native-common: &native-common
  image: aurigraph/v12-native:latest
  restart: unless-stopped
  networks:
    - aurigraph-network
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 512M
      reservations:
        cpus: '0.25'
        memory: 128M
  healthcheck:
    test: ["CMD", "curl", "-sf", "http://localhost:9003/api/v11/health"]
    interval: 15s
    timeout: 5s
    retries: 3
    start_period: 10s
  logging:
    driver: "json-file"
    options:
      max-size: "50m"
      max-file: "3"

services:
  # Native Business Nodes - Transaction Processing
  native-business-1:
    <<: *native-common
    container_name: aurigraph-native-business-1
    hostname: native-business-1
    ports:
      - "19101:9003"
      - "19111:9004"
    environment:
      - NODE_TYPE=BUSINESS
      - NODE_ID=native-business-1
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod

  native-business-2:
    <<: *native-common
    container_name: aurigraph-native-business-2
    hostname: native-business-2
    ports:
      - "19102:9003"
      - "19112:9004"
    environment:
      - NODE_TYPE=BUSINESS
      - NODE_ID=native-business-2
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod

  native-business-3:
    <<: *native-common
    container_name: aurigraph-native-business-3
    hostname: native-business-3
    ports:
      - "19103:9003"
      - "19113:9004"
    environment:
      - NODE_TYPE=BUSINESS
      - NODE_ID=native-business-3
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod

  # Native Validator Nodes - Consensus
  native-validator-1:
    <<: *native-common
    container_name: aurigraph-native-validator-1
    hostname: native-validator-1
    ports:
      - "19201:9003"
      - "19211:9004"
    environment:
      - NODE_TYPE=VALIDATOR
      - NODE_ID=native-validator-1
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod

  native-validator-2:
    <<: *native-common
    container_name: aurigraph-native-validator-2
    hostname: native-validator-2
    ports:
      - "19202:9003"
      - "19212:9004"
    environment:
      - NODE_TYPE=VALIDATOR
      - NODE_ID=native-validator-2
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod

  native-validator-3:
    <<: *native-common
    container_name: aurigraph-native-validator-3
    hostname: native-validator-3
    ports:
      - "19203:9003"
      - "19213:9004"
    environment:
      - NODE_TYPE=VALIDATOR
      - NODE_ID=native-validator-3
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod

  # Native EI Nodes - Light Clients
  native-ei-1:
    <<: *native-common
    container_name: aurigraph-native-ei-1
    hostname: native-ei-1
    ports:
      - "19301:9003"
      - "19311:9004"
    environment:
      - NODE_TYPE=EI
      - NODE_ID=native-ei-1
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  native-ei-2:
    <<: *native-common
    container_name: aurigraph-native-ei-2
    hostname: native-ei-2
    ports:
      - "19302:9003"
      - "19312:9004"
    environment:
      - NODE_TYPE=EI
      - NODE_ID=native-ei-2
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

networks:
  aurigraph-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# Aurigraph V11 - Security Services Module
# Description: Keycloak IAM, Vault secrets management, certificate management
version: '3.8'

networks:
  security:
    driver: bridge
    internal: false
  backend:
    driver: bridge
    internal: true

volumes:
  vault-data:
    driver: local
  keycloak-data:
    driver: local
  postgres-keycloak:
    driver: local

services:
  # ================================
  # Secrets Management - Vault
  # ================================
  vault:
    image: hashicorp/vault:1.15.4
    container_name: aurigraph-vault
    restart: unless-stopped

    cap_add:
      - IPC_LOCK

    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=${VAULT_ROOT_TOKEN:-dev-root-token-aurigraph}
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://127.0.0.1:8200
      - VAULT_API_ADDR=http://127.0.0.1:8200
      - VAULT_LOG_LEVEL=info
      - VAULT_SEAL_TYPE=shamir

    ports:
      - "8200:8200"

    volumes:
      - vault-data:/vault/data
      - ./config/vault:/vault/config:ro
      - ./03-secrets/certificates:/vault/tls:ro

    command: server ${VAULT_MODE:--dev}

    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - security
      - backend

    labels:
      - "com.aurigraph.service=security"
      - "com.aurigraph.component=vault"

  # ================================
  # IAM - Keycloak
  # ================================
  keycloak-db:
    image: postgres:16-alpine
    container_name: aurigraph-keycloak-db
    restart: unless-stopped

    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak123}

    volumes:
      - postgres-keycloak:/var/lib/postgresql/data

    networks:
      - backend

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5

    labels:
      - "com.aurigraph.service=security"
      - "com.aurigraph.component=keycloak-db"

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.0
    container_name: aurigraph-keycloak
    restart: unless-stopped

    command:
      - start-dev
      - --http-port=8180
      - --hostname-strict=false
      - --proxy=edge

    environment:
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://keycloak-db:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak123}
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN_USER:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin123}
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
      - KC_LOG_LEVEL=INFO

    ports:
      - "8180:8180"
      - "8443:8443"

    volumes:
      - keycloak-data:/opt/keycloak/data
      - ./config/keycloak:/opt/keycloak/data/import:ro
      - ./03-secrets/certificates:/opt/keycloak/certs:ro

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8180/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    networks:
      - security
      - backend

    depends_on:
      keycloak-db:
        condition: service_healthy

    labels:
      - "com.aurigraph.service=security"
      - "com.aurigraph.component=keycloak"

  # ================================
  # Certificate Manager
  # ================================
  cert-manager:
    image: certbot/certbot:latest
    container_name: aurigraph-cert-manager
    restart: "no"
    profiles: ["cert-renewal"]

    volumes:
      - ./03-secrets/certificates:/etc/letsencrypt
      - ./logs/certbot:/var/log/letsencrypt

    command: >
      certonly
      --standalone
      --non-interactive
      --agree-tos
      --email ${CERT_EMAIL:-admin@aurigraph.io}
      --domains ${CERT_DOMAINS:-dlt.aurigraph.io}
      --preferred-challenges http
      --keep-until-expiring

    networks:
      - security

    labels:
      - "com.aurigraph.service=security"
      - "com.aurigraph.component=cert-manager"

  # ================================
  # Security Scanner (Trivy)
  # ================================
  trivy:
    image: aquasec/trivy:latest
    container_name: aurigraph-trivy
    restart: "no"
    profiles: ["security-scan"]

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./security-reports:/reports

    command: >
      image
      --severity HIGH,CRITICAL
      --format json
      --output /reports/trivy-scan-report.json
      aurigraph/v11-native:latest

    networks:
      - security

    labels:
      - "com.aurigraph.service=security"
      - "com.aurigraph.component=trivy-scanner"

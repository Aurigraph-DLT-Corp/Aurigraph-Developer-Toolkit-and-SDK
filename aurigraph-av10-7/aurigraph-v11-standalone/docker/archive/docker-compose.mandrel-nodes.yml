# Aurigraph V12 Mandrel Test Nodes
# Testing fork for Native GraalVM/Mandrel 24.2 containers
#
# Purpose: Test native executables alongside existing JVM containers
# These run on separate ports to allow A/B testing
#
# Deploy:
#   docker-compose -f docker-compose.mandrel-nodes.yml up -d
#
# Compare with JVM:
#   - Mandrel ports: 19500-19599 (HTTP), 19600-19699 (gRPC)
#   - JVM ports: 19001-19020 (existing)

version: '3.8'

x-mandrel-common: &mandrel-common
  image: aurigraph/v12-mandrel:latest
  restart: unless-stopped
  networks:
    - mandrel-test-network
  extra_hosts:
    - "host.docker.internal:host-gateway"
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 512M
      reservations:
        cpus: '0.1'
        memory: 128M
  healthcheck:
    test: ["CMD", "curl", "-sf", "http://localhost:9003/api/v11/health"]
    interval: 10s
    timeout: 3s
    retries: 3
    start_period: 5s
  logging:
    driver: "json-file"
    options:
      max-size: "30m"
      max-file: "2"
  labels:
    - "aurigraph.runtime=mandrel"
    - "aurigraph.version=12.0.0"
    - "aurigraph.test=true"

services:
  #############################################
  # MANDREL BUSINESS NODES (Transaction Processing)
  #############################################
  mandrel-business-1:
    <<: *mandrel-common
    container_name: mandrel-business-1
    hostname: mandrel-business-1
    ports:
      - "19501:9003"
      - "19601:9004"
    environment:
      - NODE_TYPE=BUSINESS
      - NODE_ID=mandrel-business-1
      - NODE_ROLE=transaction-processor
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod
      - MANDREL_TEST=true
    labels:
      - "aurigraph.node.type=business"
      - "aurigraph.node.id=mandrel-business-1"

  mandrel-business-2:
    <<: *mandrel-common
    container_name: mandrel-business-2
    hostname: mandrel-business-2
    ports:
      - "19502:9003"
      - "19602:9004"
    environment:
      - NODE_TYPE=BUSINESS
      - NODE_ID=mandrel-business-2
      - NODE_ROLE=transaction-processor
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod
      - MANDREL_TEST=true
    labels:
      - "aurigraph.node.type=business"
      - "aurigraph.node.id=mandrel-business-2"

  mandrel-business-3:
    <<: *mandrel-common
    container_name: mandrel-business-3
    hostname: mandrel-business-3
    ports:
      - "19503:9003"
      - "19603:9004"
    environment:
      - NODE_TYPE=BUSINESS
      - NODE_ID=mandrel-business-3
      - NODE_ROLE=transaction-processor
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod
      - MANDREL_TEST=true
    labels:
      - "aurigraph.node.type=business"
      - "aurigraph.node.id=mandrel-business-3"

  #############################################
  # MANDREL VALIDATOR NODES (Consensus)
  #############################################
  mandrel-validator-1:
    <<: *mandrel-common
    container_name: mandrel-validator-1
    hostname: mandrel-validator-1
    ports:
      - "19511:9003"
      - "19611:9004"
    environment:
      - NODE_TYPE=VALIDATOR
      - NODE_ID=mandrel-validator-1
      - NODE_ROLE=consensus-validator
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod
      - MANDREL_TEST=true
    labels:
      - "aurigraph.node.type=validator"
      - "aurigraph.node.id=mandrel-validator-1"

  mandrel-validator-2:
    <<: *mandrel-common
    container_name: mandrel-validator-2
    hostname: mandrel-validator-2
    ports:
      - "19512:9003"
      - "19612:9004"
    environment:
      - NODE_TYPE=VALIDATOR
      - NODE_ID=mandrel-validator-2
      - NODE_ROLE=consensus-validator
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod
      - MANDREL_TEST=true
    labels:
      - "aurigraph.node.type=validator"
      - "aurigraph.node.id=mandrel-validator-2"

  mandrel-validator-3:
    <<: *mandrel-common
    container_name: mandrel-validator-3
    hostname: mandrel-validator-3
    ports:
      - "19513:9003"
      - "19613:9004"
    environment:
      - NODE_TYPE=VALIDATOR
      - NODE_ID=mandrel-validator-3
      - NODE_ROLE=consensus-validator
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod
      - MANDREL_TEST=true
    labels:
      - "aurigraph.node.type=validator"
      - "aurigraph.node.id=mandrel-validator-3"

  #############################################
  # MANDREL EI NODES (Light Clients)
  #############################################
  mandrel-ei-1:
    <<: *mandrel-common
    container_name: mandrel-ei-1
    hostname: mandrel-ei-1
    ports:
      - "19521:9003"
      - "19621:9004"
    environment:
      - NODE_TYPE=EI
      - NODE_ID=mandrel-ei-1
      - NODE_ROLE=light-client
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod
      - MANDREL_TEST=true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M
    labels:
      - "aurigraph.node.type=ei"
      - "aurigraph.node.id=mandrel-ei-1"

  mandrel-ei-2:
    <<: *mandrel-common
    container_name: mandrel-ei-2
    hostname: mandrel-ei-2
    ports:
      - "19522:9003"
      - "19622:9004"
    environment:
      - NODE_TYPE=EI
      - NODE_ID=mandrel-ei-2
      - NODE_ROLE=light-client
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_PORT=9004
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://host.docker.internal:5432/j4c_db
      - QUARKUS_DATASOURCE_USERNAME=j4c_user
      - QUARKUS_DATASOURCE_PASSWORD=j4c_password
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_PROFILE=prod
      - MANDREL_TEST=true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M
    labels:
      - "aurigraph.node.type=ei"
      - "aurigraph.node.id=mandrel-ei-2"

networks:
  mandrel-test-network:
    driver: bridge
    name: mandrel-test-network
    ipam:
      config:
        - subnet: 172.29.0.0/16

# Aurigraph V11 - Database Migration Module
# Description: Flyway/Liquibase migrations, schema updates, data migrations
version: '3.8'

networks:
  migration:
    driver: bridge

services:
  # ================================
  # Flyway Database Migration
  # ================================
  flyway-migrate:
    image: flyway/flyway:10-alpine
    container_name: aurigraph-flyway-migrate
    restart: "no"
    profiles: ["flyway"]

    environment:
      - FLYWAY_URL=jdbc:postgresql://${POSTGRES_HOST:-postgres}:5432/${POSTGRES_DB:-aurigraph}
      - FLYWAY_USER=${POSTGRES_USER:-postgres}
      - FLYWAY_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - FLYWAY_SCHEMAS=public
      - FLYWAY_LOCATIONS=filesystem:/flyway/sql
      - FLYWAY_BASELINE_ON_MIGRATE=true
      - FLYWAY_OUT_OF_ORDER=false
      - FLYWAY_VALIDATE_ON_MIGRATE=true

    volumes:
      - ./migrations/sql:/flyway/sql:ro
      - ./migrations/conf:/flyway/conf:ro

    command: migrate

    networks:
      - migration

    labels:
      - "com.aurigraph.service=migration"
      - "com.aurigraph.component=flyway"

  flyway-info:
    image: flyway/flyway:10-alpine
    container_name: aurigraph-flyway-info
    restart: "no"
    profiles: ["flyway-info"]

    environment:
      - FLYWAY_URL=jdbc:postgresql://${POSTGRES_HOST:-postgres}:5432/${POSTGRES_DB:-aurigraph}
      - FLYWAY_USER=${POSTGRES_USER:-postgres}
      - FLYWAY_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - FLYWAY_SCHEMAS=public

    volumes:
      - ./migrations/sql:/flyway/sql:ro

    command: info

    networks:
      - migration

    labels:
      - "com.aurigraph.service=migration"
      - "com.aurigraph.component=flyway-info"

  flyway-validate:
    image: flyway/flyway:10-alpine
    container_name: aurigraph-flyway-validate
    restart: "no"
    profiles: ["flyway-validate"]

    environment:
      - FLYWAY_URL=jdbc:postgresql://${POSTGRES_HOST:-postgres}:5432/${POSTGRES_DB:-aurigraph}
      - FLYWAY_USER=${POSTGRES_USER:-postgres}
      - FLYWAY_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - FLYWAY_SCHEMAS=public

    volumes:
      - ./migrations/sql:/flyway/sql:ro

    command: validate

    networks:
      - migration

    labels:
      - "com.aurigraph.service=migration"
      - "com.aurigraph.component=flyway-validate"

  # ================================
  # Liquibase Database Migration
  # ================================
  liquibase-update:
    image: liquibase/liquibase:latest
    container_name: aurigraph-liquibase-update
    restart: "no"
    profiles: ["liquibase"]

    environment:
      - LIQUIBASE_COMMAND_URL=jdbc:postgresql://${POSTGRES_HOST:-postgres}:5432/${POSTGRES_DB:-aurigraph}
      - LIQUIBASE_COMMAND_USERNAME=${POSTGRES_USER:-postgres}
      - LIQUIBASE_COMMAND_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - LIQUIBASE_COMMAND_CHANGELOG_FILE=db.changelog-master.xml
      - LIQUIBASE_SEARCH_PATH=/liquibase/changelog

    volumes:
      - ./migrations/liquibase:/liquibase/changelog:ro

    command: update

    networks:
      - migration

    labels:
      - "com.aurigraph.service=migration"
      - "com.aurigraph.component=liquibase"

  liquibase-rollback:
    image: liquibase/liquibase:latest
    container_name: aurigraph-liquibase-rollback
    restart: "no"
    profiles: ["liquibase-rollback"]

    environment:
      - LIQUIBASE_COMMAND_URL=jdbc:postgresql://${POSTGRES_HOST:-postgres}:5432/${POSTGRES_DB:-aurigraph}
      - LIQUIBASE_COMMAND_USERNAME=${POSTGRES_USER:-postgres}
      - LIQUIBASE_COMMAND_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - LIQUIBASE_COMMAND_CHANGELOG_FILE=db.changelog-master.xml
      - ROLLBACK_TAG=${ROLLBACK_TAG}

    volumes:
      - ./migrations/liquibase:/liquibase/changelog:ro

    command: rollback ${ROLLBACK_TAG}

    networks:
      - migration

    labels:
      - "com.aurigraph.service=migration"
      - "com.aurigraph.component=liquibase-rollback"

  # ================================
  # Data Migration Script Runner
  # ================================
  data-migration:
    image: postgres:16-alpine
    container_name: aurigraph-data-migration
    restart: "no"
    profiles: ["data-migration"]

    environment:
      - PGHOST=${POSTGRES_HOST:-postgres}
      - PGPORT=5432
      - PGDATABASE=${POSTGRES_DB:-aurigraph}
      - PGUSER=${POSTGRES_USER:-postgres}
      - PGPASSWORD=${POSTGRES_PASSWORD:-postgres}

    volumes:
      - ./migrations/data:/migrations:ro
      - ./logs/migration:/logs

    command: >
      sh -c "
      echo 'Starting data migration...';
      for script in /migrations/*.sql; do
        echo 'Running: '$$script;
        psql -f $$script >> /logs/migration.log 2>&1 || exit 1;
      done;
      echo 'Data migration completed';
      "

    networks:
      - migration

    labels:
      - "com.aurigraph.service=migration"
      - "com.aurigraph.component=data-migration"

  # ================================
  # Schema Version Check
  # ================================
  schema-version:
    image: postgres:16-alpine
    container_name: aurigraph-schema-version
    restart: "no"
    profiles: ["schema-check"]

    environment:
      - PGHOST=${POSTGRES_HOST:-postgres}
      - PGPORT=5432
      - PGDATABASE=${POSTGRES_DB:-aurigraph}
      - PGUSER=${POSTGRES_USER:-postgres}
      - PGPASSWORD=${POSTGRES_PASSWORD:-postgres}

    command: >
      sh -c "
      echo 'Checking schema version...';
      psql -c \"SELECT * FROM flyway_schema_history ORDER BY installed_rank DESC LIMIT 5;\";
      psql -c \"SELECT version, description, installed_on FROM flyway_schema_history WHERE success = true ORDER BY installed_rank DESC LIMIT 1;\";
      "

    networks:
      - migration

    labels:
      - "com.aurigraph.service=migration"
      - "com.aurigraph.component=schema-version"

  # ================================
  # Pre-Migration Backup
  # ================================
  pre-migration-backup:
    image: postgres:16-alpine
    container_name: aurigraph-pre-migration-backup
    restart: "no"
    profiles: ["pre-migration-backup"]

    environment:
      - PGHOST=${POSTGRES_HOST:-postgres}
      - PGPORT=5432
      - PGDATABASE=${POSTGRES_DB:-aurigraph}
      - PGUSER=${POSTGRES_USER:-postgres}
      - PGPASSWORD=${POSTGRES_PASSWORD:-postgres}

    volumes:
      - ./backups:/backups

    command: >
      sh -c "
      TIMESTAMP=$$(date +%Y%m%d_%H%M%S);
      echo 'Creating pre-migration backup: pre_migration_'$$TIMESTAMP'.sql';
      pg_dump -Fc > /backups/pre_migration_$$TIMESTAMP.sql;
      echo 'Backup completed successfully';
      "

    networks:
      - migration

    labels:
      - "com.aurigraph.service=migration"
      - "com.aurigraph.component=pre-migration-backup"

################################################################################
# HAProxy Configuration for Aurigraph V11 Native Cluster
# Load balancing for 2M+ TPS across native nodes
################################################################################

global
    maxconn 10000
    log stdout local0
    tune.ssl.default-dh-param 2048
    nbthread 4
    cpu-map auto:1/1-4 0-3

defaults
    mode http
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    log global

# Statistics
stats enable
stats uri /stats
stats refresh 10s
stats admin if TRUE

# HTTP API Load Balancing
frontend http_front
    bind *:8080
    option httplog
    default_backend http_nodes

backend http_nodes
    balance leastconn
    option httpchk GET /q/health/ready
    
    server node1 aurigraph-node-1:9003 check inter 5s fall 3 rise 2 weight 100
    server node2 aurigraph-node-2:9003 check inter 5s fall 3 rise 2 weight 100
    server node3 aurigraph-node-3:9003 check inter 5s fall 3 rise 2 weight 100

# gRPC Load Balancing
frontend grpc_front
    bind *:8081 proto h2
    mode tcp
    default_backend grpc_nodes

backend grpc_nodes
    mode tcp
    balance leastconn
    
    server node1 aurigraph-node-1:9004 check inter 5s fall 3 rise 2
    server node2 aurigraph-node-2:9004 check inter 5s fall 3 rise 2
    server node3 aurigraph-node-3:9004 check inter 5s fall 3 rise 2

# Stats Interface
frontend stats_front
    bind *:8082
    stats enable
    stats uri /
    stats refresh 5s
    stats show-legends
    stats show-node
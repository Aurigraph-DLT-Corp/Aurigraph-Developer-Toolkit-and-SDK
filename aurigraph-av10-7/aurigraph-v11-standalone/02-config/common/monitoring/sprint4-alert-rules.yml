# Aurigraph V11 Sprint 4 - Alert Rules Configuration
# ==================================================
# Production alerting thresholds for 15-core system targeting 1.6M+ TPS

groups:
  - name: aurigraph-v11-performance
    rules:
      # Critical TPS thresholds
      - alert: CriticalThroughputDrop
        expr: rate(aurigraph_transactions_processed_total[1m]) < 500000
        for: 15s
        labels:
          severity: critical
          team: dda
          sprint: sprint4
        annotations:
          summary: "CRITICAL: TPS below 500K"
          description: "Transaction throughput has dropped to {{ $value | printf \"%.0f\" }} TPS, below critical threshold of 500K TPS"
          runbook: "https://docs.aurigraph.io/runbooks/low-throughput"

      - alert: WarningThroughputDrop
        expr: rate(aurigraph_transactions_processed_total[1m]) < 1000000
        for: 30s
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "WARNING: TPS below 1M"
          description: "Transaction throughput is {{ $value | printf \"%.0f\" }} TPS, below warning threshold of 1M TPS"

      - alert: TargetThroughputMiss
        expr: rate(aurigraph_transactions_processed_total[5m]) < 1600000
        for: 2m
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "Target TPS not achieved"
          description: "5-minute average TPS is {{ $value | printf \"%.0f\" }}, below Sprint 4 target of 1.6M TPS"

  - name: aurigraph-v11-availability
    rules:
      # Service availability
      - alert: ServiceDown
        expr: up{job="aurigraph-v11-main"} == 0
        for: 10s
        labels:
          severity: critical
          team: dda
          sprint: sprint4
        annotations:
          summary: "CRITICAL: Aurigraph V11 service is down"
          description: "Main Aurigraph V11 service is not responding"
          runbook: "https://docs.aurigraph.io/runbooks/service-down"

      - alert: HealthCheckFailing
        expr: aurigraph_health_status != 1
        for: 30s
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "Health check failing"
          description: "Health check endpoint is reporting unhealthy status"

      # gRPC service availability
      - alert: GrpcServiceDown
        expr: up{job="aurigraph-v11-grpc"} == 0
        for: 30s
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "gRPC service unavailable"
          description: "Aurigraph V11 gRPC service is not responding"

  - name: aurigraph-v11-resource-utilization
    rules:
      # CPU utilization (15-core system)
      - alert: HighCpuUtilization
        expr: (100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[2m])) * 100)) > 90
        for: 1m
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "High CPU utilization"
          description: "CPU utilization is {{ $value | printf \"%.1f\" }}% on 15-core system"

      - alert: CriticalCpuUtilization
        expr: (100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[2m])) * 100)) > 95
        for: 30s
        labels:
          severity: critical
          team: dda
          sprint: sprint4
        annotations:
          summary: "CRITICAL: CPU utilization critical"
          description: "CPU utilization is {{ $value | printf \"%.1f\" }}% - performance may be impacted"

      # Memory utilization (64GB system)
      - alert: HighMemoryUtilization
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.85
        for: 2m
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "High memory utilization"
          description: "Memory utilization is {{ $value | printf \"%.1f\" }}% on 64GB system"

      - alert: CriticalMemoryUtilization
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.95
        for: 1m
        labels:
          severity: critical
          team: dda
          sprint: sprint4
        annotations:
          summary: "CRITICAL: Memory utilization critical"
          description: "Memory utilization is {{ $value | printf \"%.1f\" }}% - system may become unstable"

  - name: aurigraph-v11-latency
    rules:
      # Response time monitoring
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[2m])) > 0.1
        for: 1m
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "High response latency"
          description: "95th percentile latency is {{ $value | printf \"%.3f\" }}s"

      - alert: CriticalLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[2m])) > 0.5
        for: 30s
        labels:
          severity: critical
          team: dda
          sprint: sprint4
        annotations:
          summary: "CRITICAL: Response latency critical"
          description: "95th percentile latency is {{ $value | printf \"%.3f\" }}s - user experience impacted"

  - name: aurigraph-v11-consensus
    rules:
      # Consensus performance
      - alert: ConsensusLatencyHigh
        expr: aurigraph_consensus_latency_seconds > 0.050
        for: 1m
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "High consensus latency"
          description: "Consensus latency is {{ $value | printf \"%.3f\" }}s"

      - alert: LeaderElectionFrequent
        expr: rate(aurigraph_leader_elections_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "Frequent leader elections"
          description: "Leader election rate is {{ $value | printf \"%.2f\" }} elections per second"

  - name: aurigraph-v11-network
    rules:
      # Network performance
      - alert: HighNetworkErrors
        expr: rate(node_network_transmit_errs_total[2m]) + rate(node_network_receive_errs_total[2m]) > 10
        for: 1m
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "High network error rate"
          description: "Network error rate is {{ $value | printf \"%.1f\" }} errors/second"

      - alert: NetworkSaturation
        expr: rate(node_network_transmit_bytes_total[2m]) + rate(node_network_receive_bytes_total[2m]) > 1000000000
        for: 2m
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "High network utilization"
          description: "Network throughput is {{ $value | humanizeBytes }}/sec"

  - name: aurigraph-v11-ssl-security
    rules:
      # SSL certificate monitoring
      - alert: SslCertificateExpiring
        expr: (probe_ssl_earliest_cert_expiry - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "SSL certificate expiring soon"
          description: "SSL certificate for dlt.aurigraph.io expires in {{ $value | printf \"%.0f\" }} days"

      - alert: SslCertificateExpiringSoon
        expr: (probe_ssl_earliest_cert_expiry - time()) / 86400 < 7
        for: 30m
        labels:
          severity: critical
          team: dda
          sprint: sprint4
        annotations:
          summary: "CRITICAL: SSL certificate expiring very soon"
          description: "SSL certificate for dlt.aurigraph.io expires in {{ $value | printf \"%.0f\" }} days - immediate action required"

  - name: aurigraph-v11-disk-storage
    rules:
      # Disk space monitoring
      - alert: DiskSpaceHigh
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) > 0.8
        for: 5m
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "High disk utilization"
          description: "Disk utilization is {{ $value | printf \"%.1f\" }}% on {{ $labels.mountpoint }}"

      - alert: DiskSpaceCritical
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) > 0.95
        for: 2m
        labels:
          severity: critical
          team: dda
          sprint: sprint4
        annotations:
          summary: "CRITICAL: Disk space critical"
          description: "Disk utilization is {{ $value | printf \"%.1f\" }}% on {{ $labels.mountpoint }} - service may fail"

  - name: aurigraph-v11-jvm-native
    rules:
      # Native executable monitoring
      - alert: HighGCTime
        expr: rate(jvm_gc_collection_seconds_sum[2m]) > 0.05
        for: 1m
        labels:
          severity: warning
          team: dda
          sprint: sprint4
        annotations:
          summary: "High GC time"
          description: "GC time is {{ $value | printf \"%.3f\" }}s per second"

      - alert: ProcessCrash
        expr: changes(process_start_time_seconds[5m]) > 0
        for: 0s
        labels:
          severity: critical
          team: dda
          sprint: sprint4
        annotations:
          summary: "CRITICAL: Process restart detected"
          description: "Aurigraph V11 process has restarted - investigating crash"
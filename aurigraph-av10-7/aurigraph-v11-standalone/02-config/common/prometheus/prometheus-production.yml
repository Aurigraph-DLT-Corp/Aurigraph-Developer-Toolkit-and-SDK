# Prometheus Configuration for Aurigraph V11 Production Monitoring\n# Optimized for high-performance blockchain platform monitoring\n\nglobal:\n  scrape_interval: 10s\n  evaluation_interval: 10s\n  scrape_timeout: 8s\n  external_labels:\n    cluster: 'aurigraph-production'\n    environment: 'production'\n    region: 'us-west-2'\n    version: 'v11.0.0'\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets:\n          - alertmanager:9093\n      scheme: http\n      timeout: 10s\n      api_version: v2\n\n# Rules configuration\nrule_files:\n  - \"/etc/prometheus/rules/*.yml\"\n  - \"/etc/prometheus/rules/aurigraph/*.yml\"\n\n# Scrape configurations\nscrape_configs:\n\n  # ==========================================================================\n  # Aurigraph V11 Application Metrics\n  # ==========================================================================\n  \n  - job_name: 'aurigraph-v11-production'\n    scrape_interval: 5s\n    scrape_timeout: 4s\n    metrics_path: '/q/metrics'\n    honor_labels: true\n    kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n        - aurigraph-production\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_name]\n      action: keep\n      regex: 'aurigraph-v11-production-service'\n    - source_labels: [__meta_kubernetes_endpoint_port_name]\n      action: keep\n      regex: 'metrics'\n    - source_labels: [__meta_kubernetes_pod_name]\n      target_label: pod\n    - source_labels: [__meta_kubernetes_pod_node_name]\n      target_label: node\n    - source_labels: [__meta_kubernetes_namespace]\n      target_label: kubernetes_namespace\n    - source_labels: [__meta_kubernetes_service_name]\n      target_label: kubernetes_service_name\n    - target_label: service\n      replacement: 'aurigraph-v11'\n    - target_label: tier\n      replacement: 'production'\n    metric_relabel_configs:\n    # Keep only Aurigraph-specific metrics and standard metrics\n    - source_labels: [__name__]\n      regex: '^(aurigraph_.*|http_.*|grpc_.*|jvm_.*|system_.*|process_.*|up)$'\n      action: keep\n    # Add custom labels for Aurigraph metrics\n    - source_labels: [__name__]\n      regex: '^aurigraph_.*'\n      target_label: metric_type\n      replacement: 'aurigraph_custom'\n  \n  # Health check endpoints\n  - job_name: 'aurigraph-v11-health'\n    scrape_interval: 30s\n    scrape_timeout: 10s\n    metrics_path: '/q/health'\n    honor_labels: true\n    kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n        - aurigraph-production\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_name]\n      action: keep\n      regex: 'aurigraph-v11-production-service'\n    - source_labels: [__meta_kubernetes_endpoint_port_name]\n      action: keep\n      regex: 'http'\n    - source_labels: [__meta_kubernetes_pod_name]\n      target_label: pod\n    - source_labels: [__meta_kubernetes_pod_node_name]\n      target_label: node\n    - target_label: service\n      replacement: 'aurigraph-v11-health'\n    - target_label: tier\n      replacement: 'production'\n    # Custom metric for health status\n    metric_relabel_configs:\n    - source_labels: [__name__]\n      regex: '^up$'\n      target_label: __name__\n      replacement: 'aurigraph_health_status'\n  \n  # Performance and stats endpoints\n  - job_name: 'aurigraph-v11-performance'\n    scrape_interval: 15s\n    scrape_timeout: 12s\n    metrics_path: '/api/v11/stats'\n    honor_labels: true\n    kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n        - aurigraph-production\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_name]\n      action: keep\n      regex: 'aurigraph-v11-production-service'\n    - source_labels: [__meta_kubernetes_endpoint_port_name]\n      action: keep\n      regex: 'http'\n    - source_labels: [__meta_kubernetes_pod_name]\n      target_label: pod\n    - target_label: service\n      replacement: 'aurigraph-v11-performance'\n    - target_label: tier\n      replacement: 'production'\n    metric_relabel_configs:\n    - source_labels: [__name__]\n      regex: '^(aurigraph_tps_.*|aurigraph_latency_.*|aurigraph_consensus_.*|aurigraph_ai_.*|aurigraph_crypto_.*)$'\n      action: keep\n  \n  # ==========================================================================\n  # Kubernetes Infrastructure Metrics\n  # ==========================================================================\n  \n  # Kubernetes API server\n  - job_name: 'kubernetes-apiservers'\n    scrape_interval: 30s\n    scrape_timeout: 10s\n    kubernetes_sd_configs:\n    - role: endpoints\n    scheme: https\n    tls_config:\n      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n      action: keep\n      regex: default;kubernetes;https\n    - target_label: __address__\n      replacement: kubernetes.default.svc:443\n    metric_relabel_configs:\n    - source_labels: [__name__]\n      regex: '^(apiserver_.*|etcd_.*|kubernetes_.*)$'\n      action: keep\n  \n  # Kubernetes nodes\n  - job_name: 'kubernetes-nodes'\n    scrape_interval: 30s\n    scrape_timeout: 10s\n    kubernetes_sd_configs:\n    - role: node\n    scheme: https\n    tls_config:\n      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n    relabel_configs:\n    - action: labelmap\n      regex: __meta_kubernetes_node_label_(.+)\n    - target_label: __address__\n      replacement: kubernetes.default.svc:443\n    - source_labels: [__meta_kubernetes_node_name]\n      regex: (.+)\n      target_label: __metrics_path__\n      replacement: /api/v1/nodes/${1}/proxy/metrics\n    metric_relabel_configs:\n    - source_labels: [__name__]\n      regex: '^(node_.*|kubelet_.*)$'\n      action: keep\n  \n  # Kubernetes cadvisor (container metrics)\n  - job_name: 'kubernetes-cadvisor'\n    scrape_interval: 30s\n    scrape_timeout: 10s\n    kubernetes_sd_configs:\n    - role: node\n    scheme: https\n    tls_config:\n      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n    relabel_configs:\n    - action: labelmap\n      regex: __meta_kubernetes_node_label_(.+)\n    - target_label: __address__\n      replacement: kubernetes.default.svc:443\n    - source_labels: [__meta_kubernetes_node_name]\n      regex: (.+)\n      target_label: __metrics_path__\n      replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor\n    metric_relabel_configs:\n    # Keep only container metrics for Aurigraph pods\n    - source_labels: [container_label_io_kubernetes_pod_namespace]\n      regex: 'aurigraph-production'\n      action: keep\n    - source_labels: [__name__]\n      regex: '^container_.*'\n      action: keep\n    # Relabel for better visualization\n    - source_labels: [container_label_io_kubernetes_pod_name]\n      target_label: pod_name\n    - source_labels: [container_label_io_kubernetes_container_name]\n      target_label: container_name\n  \n  # Kubernetes service endpoints\n  - job_name: 'kubernetes-service-endpoints'\n    scrape_interval: 30s\n    scrape_timeout: 10s\n    kubernetes_sd_configs:\n    - role: endpoints\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n      action: keep\n      regex: true\n    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n      action: replace\n      target_label: __scheme__\n      regex: (https?)\n    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n      action: replace\n      target_label: __metrics_path__\n      regex: (.+)\n    - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]\n      action: replace\n      target_label: __address__\n      regex: ([^:]+)(?::\\d+)?;(\\d+)\n      replacement: $1:$2\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_(.+)\n    - source_labels: [__meta_kubernetes_namespace]\n      action: replace\n      target_label: kubernetes_namespace\n    - source_labels: [__meta_kubernetes_service_name]\n      action: replace\n      target_label: kubernetes_name\n    # Filter for production namespace\n    - source_labels: [__meta_kubernetes_namespace]\n      regex: 'aurigraph-production'\n      action: keep\n  \n  # ==========================================================================\n  # Infrastructure Components\n  # ==========================================================================\n  \n  # Node Exporter\n  - job_name: 'node-exporter'\n    scrape_interval: 30s\n    scrape_timeout: 10s\n    static_configs:\n      - targets:\n        - 'node-exporter:9100'\n    metric_relabel_configs:\n    - source_labels: [__name__]\n      regex: '^node_.*'\n      action: keep\n    - target_label: service\n      replacement: 'node-exporter'\n  \n  # PostgreSQL database\n  - job_name: 'postgres-exporter'\n    scrape_interval: 30s\n    scrape_timeout: 10s\n    static_configs:\n      - targets:\n        - 'postgres-exporter:9187'\n    metric_relabel_configs:\n    - source_labels: [__name__]\n      regex: '^pg_.*'\n      action: keep\n    - target_label: service\n      replacement: 'postgresql'\n  \n  # Redis cache\n  - job_name: 'redis-exporter'\n    scrape_interval: 30s\n    scrape_timeout: 10s\n    static_configs:\n      - targets:\n        - 'redis-exporter:9121'\n    metric_relabel_configs:\n    - source_labels: [__name__]\n      regex: '^redis_.*'\n      action: keep\n    - target_label: service\n      replacement: 'redis'\n  \n  # ==========================================================================\n  # Monitoring Stack Self-Monitoring\n  # ==========================================================================\n  \n  # Prometheus self-monitoring\n  - job_name: 'prometheus'\n    scrape_interval: 30s\n    scrape_timeout: 10s\n    static_configs:\n      - targets:\n        - 'localhost:9090'\n    metric_relabel_configs:\n    - source_labels: [__name__]\n      regex: '^prometheus_.*'\n      action: keep\n  \n  # Alertmanager\n  - job_name: 'alertmanager'\n    scrape_interval: 30s\n    scrape_timeout: 10s\n    static_configs:\n      - targets:\n        - 'alertmanager:9093'\n    metric_relabel_configs:\n    - source_labels: [__name__]\n      regex: '^alertmanager_.*'\n      action: keep\n  \n  # Grafana\n  - job_name: 'grafana'\n    scrape_interval: 60s\n    scrape_timeout: 10s\n    static_configs:\n      - targets:\n        - 'grafana:3000'\n    metric_relabel_configs:\n    - source_labels: [__name__]\n      regex: '^grafana_.*'\n      action: keep\n  \n  # ==========================================================================\n  # External Service Monitoring\n  # ==========================================================================\n  \n  # Blackbox exporter for external endpoint monitoring\n  - job_name: 'blackbox-http'\n    scrape_interval: 60s\n    scrape_timeout: 30s\n    metrics_path: /probe\n    params:\n      module: [http_2xx]\n    static_configs:\n      - targets:\n        - https://api.aurigraph.io/q/health\n        - https://grafana.aurigraph.io\n        - https://prometheus.aurigraph.io\n    relabel_configs:\n    - source_labels: [__address__]\n      target_label: __param_target\n    - source_labels: [__param_target]\n      target_label: instance\n    - target_label: __address__\n      replacement: blackbox-exporter:9115\n    - target_label: service\n      replacement: 'blackbox-http'\n  \n  # Blackbox exporter for TCP endpoint monitoring\n  - job_name: 'blackbox-tcp'\n    scrape_interval: 60s\n    scrape_timeout: 30s\n    metrics_path: /probe\n    params:\n      module: [tcp_connect]\n    static_configs:\n      - targets:\n        - aurigraph-v11-production-service.aurigraph-production.svc.cluster.local:9003\n        - aurigraph-v11-production-service.aurigraph-production.svc.cluster.local:9004\n    relabel_configs:\n    - source_labels: [__address__]\n      target_label: __param_target\n    - source_labels: [__param_target]\n      target_label: instance\n    - target_label: __address__\n      replacement: blackbox-exporter:9115\n    - target_label: service\n      replacement: 'blackbox-tcp'\n\n# Storage configuration\nstorage:\n  tsdb:\n    path: /prometheus/\n    retention.time: 30d\n    retention.size: 50GB\n    min-block-duration: 2h\n    max-block-duration: 25h\n    no-lockfile: true\n    wal-compression: true\n\n# Remote write configuration (optional - for long-term storage)\n# remote_write:\n#   - url: \"https://prometheus-remote-write.example.com/api/v1/write\"\n#     write_relabel_configs:\n#     - source_labels: [__name__]\n#       regex: '^aurigraph_.*'\n#       action: keep\n\n# Remote read configuration (optional)\n# remote_read:\n#   - url: \"https://prometheus-remote-read.example.com/api/v1/read\"\n\n# Feature flags\nfeature_flags:\n  - exemplar-storage\n  - expand-external-labels\n  - memory-snapshot-on-shutdown\n  - promql-at-modifier\n  - promql-negative-offset\n"
# Aurigraph V11 - Staging Environment Module
# Description: Pre-production staging environment configuration
version: '3.8'

networks:
  staging-frontend:
    driver: bridge
  staging-backend:
    driver: bridge
    internal: true

volumes:
  staging-data:
    driver: local
  staging-postgres:
    driver: local
  staging-redis:
    driver: local

services:
  # ================================
  # Staging V11 Application
  # ================================
  aurigraph-staging:
    image: aurigraph/v11-native:staging
    container_name: aurigraph-staging
    restart: unless-stopped

    environment:
      - QUARKUS_PROFILE=staging
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_PORT=9004
      - CONSENSUS_NODE_ID=staging-node-1
      - CONSENSUS_CLUSTER_SIZE=1
      - AI_OPTIMIZATION_ENABLED=true
      - AI_OPTIMIZATION_TARGET_TPS=1000000
      - LOG_LEVEL=DEBUG
      - ENABLE_METRICS=true
      - POSTGRES_HOST=postgres-staging
      - POSTGRES_DB=aurigraph_staging
      - REDIS_HOST=redis-staging

    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M

    ports:
      - "9003:9003"  # HTTP API
      - "9004:9004"  # gRPC

    volumes:
      - staging-data:/deployments/data
      - ./logs/staging:/deployments/logs
      - ./02-config/staging:/deployments/config:ro

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9003/q/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - staging-frontend
      - staging-backend

    labels:
      - "com.aurigraph.environment=staging"
      - "com.aurigraph.component=app"

  # ================================
  # Staging Database
  # ================================
  postgres-staging:
    image: postgres:16-alpine
    container_name: aurigraph-postgres-staging
    restart: unless-stopped

    environment:
      - POSTGRES_DB=aurigraph_staging
      - POSTGRES_USER=aurigraph
      - POSTGRES_PASSWORD=${STAGING_DB_PASSWORD:-staging_password}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C

    ports:
      - "5433:5432"

    volumes:
      - staging-postgres:/var/lib/postgresql/data
      - ./scripts/sql:/docker-entrypoint-initdb.d:ro

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aurigraph"]
      interval: 10s
      timeout: 5s
      retries: 5

    networks:
      - staging-backend

    labels:
      - "com.aurigraph.environment=staging"
      - "com.aurigraph.component=postgres"

  # ================================
  # Staging Redis Cache
  # ================================
  redis-staging:
    image: redis:7.2.4-alpine
    container_name: aurigraph-redis-staging
    restart: unless-stopped

    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${STAGING_REDIS_PASSWORD:-staging_redis}

    ports:
      - "6380:6379"

    volumes:
      - staging-redis:/data

    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${STAGING_REDIS_PASSWORD:-staging_redis}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

    networks:
      - staging-backend

    labels:
      - "com.aurigraph.environment=staging"
      - "com.aurigraph.component=redis"

  # ================================
  # Staging Enterprise Portal
  # ================================
  enterprise-portal-staging:
    image: aurigraph/enterprise-portal:staging
    container_name: aurigraph-portal-staging
    restart: unless-stopped

    environment:
      - NODE_ENV=staging
      - API_BASE_URL=http://aurigraph-staging:9003
      - REACT_APP_API_URL=http://aurigraph-staging:9003/api/v11
      - PORT=3000

    ports:
      - "3001:3000"

    depends_on:
      aurigraph-staging:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    networks:
      - staging-frontend

    labels:
      - "com.aurigraph.environment=staging"
      - "com.aurigraph.component=portal"

  # ================================
  # Staging NGINX Reverse Proxy
  # ================================
  nginx-staging:
    image: nginx:1.25.3-alpine
    container_name: aurigraph-nginx-staging
    restart: unless-stopped

    ports:
      - "8080:80"

    volumes:
      - ./config/nginx/staging.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/conf.d/staging:/etc/nginx/conf.d:ro

    depends_on:
      - aurigraph-staging
      - enterprise-portal-staging

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    networks:
      - staging-frontend

    labels:
      - "com.aurigraph.environment=staging"
      - "com.aurigraph.component=nginx"

  # ================================
  # Staging Smoke Tests
  # ================================
  smoke-tests:
    image: curlimages/curl:latest
    container_name: aurigraph-smoke-tests
    restart: "no"
    profiles: ["smoke-tests"]

    command: >
      sh -c "
      echo 'Running staging smoke tests...';
      sleep 10;
      curl -f http://aurigraph-staging:9003/q/health || exit 1;
      curl -f http://aurigraph-staging:9003/api/v11/info || exit 1;
      curl -f http://enterprise-portal-staging:3000 || exit 1;
      echo 'All smoke tests passed';
      "

    depends_on:
      aurigraph-staging:
        condition: service_healthy
      enterprise-portal-staging:
        condition: service_healthy

    networks:
      - staging-frontend
      - staging-backend

    labels:
      - "com.aurigraph.environment=staging"
      - "com.aurigraph.component=smoke-tests"

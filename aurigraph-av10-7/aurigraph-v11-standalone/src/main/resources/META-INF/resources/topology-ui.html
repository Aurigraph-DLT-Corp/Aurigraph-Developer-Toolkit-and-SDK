<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aurigraph V12 - Token Topology Visualization</title>

    <!-- React 18 and dependencies -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- D3.js v7 for force-directed graph -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom styling -->
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="css/topology-styles.css" />
  </head>
  <body>
    <div id="topology-root"></div>

    <!-- Load external components -->
    <script src="js/topology-api.js"></script>
    <script src="js/components/TopologyGraph.jsx" type="text/babel"></script>
    <script src="js/components/NodeDetailPanel.jsx" type="text/babel"></script>

    <script type="text/babel">
      /**
       * Aurigraph V12 Token Topology Visualization
       * Sprint 10-11 Implementation (AV11-605)
       *
       * Features:
       * - D3.js v7 Force-Directed Graph
       * - Real-time WebSocket Updates
       * - Node Type Filtering (5 types)
       * - Interactive Node Selection
       * - Zoom/Pan/Drag Support
       * - Performance optimized for 500+ nodes
       *
       * @author J4C Development Agent
       * @version 12.2.0
       * @since AV11-605-01
       */

      const { useState, useEffect, useCallback, useRef, useMemo } = React;

      // ==================== Constants ====================
      const NODE_TYPES = {
        ACTIVE_CONTRACT: { color: '#3B82F6', shape: 'hexagon', label: 'Active Contract', size: 40 },
        COMPOSITE_TOKEN: { color: '#10B981', shape: 'diamond', label: 'Composite Token', size: 35 },
        PRIMARY_TOKEN: { color: '#8B5CF6', shape: 'circle', label: 'Primary Token', size: 30 },
        SECONDARY_TOKEN: { color: '#F59E0B', shape: 'square', label: 'Secondary Token', size: 25 },
        DERIVED_TOKEN: { color: '#EC4899', shape: 'triangle', label: 'Derived Token', size: 25 },
        DOCUMENT_TOKEN: { color: '#6366F1', shape: 'rect', label: 'Document Token', size: 20 },
        MEDIA_TOKEN: { color: '#14B8A6', shape: 'ellipse', label: 'Media Token', size: 20 },
        VVB_VERIFIER: { color: '#EF4444', shape: 'star', label: 'VVB Verifier', size: 25 }
      };

      const EDGE_TYPES = {
        BINDS_TO: { color: '#3B82F6', style: 'solid', label: 'Binds To' },
        CONTAINS: { color: '#10B981', style: 'solid', label: 'Contains' },
        DERIVES_FROM: { color: '#8B5CF6', style: 'dashed', label: 'Derives From' },
        VERIFIES: { color: '#EF4444', style: 'solid', label: 'Verifies' },
        REFERENCES: { color: '#6B7280', style: 'dotted', label: 'References' },
        DEPENDS_ON: { color: '#F59E0B', style: 'solid', label: 'Depends On' }
      };

      // ==================== Navbar Component ====================
      function Navbar({ activePage }) {
        return (
          <nav className="navbar glass">
            <a href="dashboard.html" className="nav-logo">
              <div className="logo-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="white"
                  strokeWidth="2.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                >
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
              </div>
              <span>
                Aurigraph <span className="text-indigo-400">V12</span>
              </span>
            </a>
            <div className="nav-links">
              <a
                href="dashboard.html"
                className={`nav-link ${activePage === "dashboard" ? "active" : ""}`}
              >
                Monitoring
              </a>
              <a
                href="datafeed-ui.html"
                className={`nav-link ${activePage === "datafeeds" ? "active" : ""}`}
              >
                Data Feeds
              </a>
              <a
                href="feed-tokens-ui.html"
                className={`nav-link ${activePage === "tokens" ? "active" : ""}`}
              >
                Asset Tokens
              </a>
              <a
                href="topology-ui.html"
                className={`nav-link ${activePage === "topology" ? "active" : ""}`}
              >
                Token Topology
              </a>
            </div>
            <div className="flex items-center gap-4">
              <div className="text-right hidden md:block">
                <div className="text-xs text-slate-400">Topology Status</div>
                <div className="text-sm font-semibold text-emerald-400 flex items-center gap-1">
                  <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                  Real-time
                </div>
              </div>
            </div>
          </nav>
        );
      }

      // ==================== Filter Panel Component ====================
      function FilterPanel({ filters, onFilterChange, stats }) {
        const handleTypeToggle = (type) => {
          const newTypes = filters.nodeTypes.includes(type)
            ? filters.nodeTypes.filter(t => t !== type)
            : [...filters.nodeTypes, type];
          onFilterChange({ ...filters, nodeTypes: newTypes });
        };

        const handleSelectAll = () => {
          onFilterChange({ ...filters, nodeTypes: Object.keys(NODE_TYPES) });
        };

        const handleDeselectAll = () => {
          onFilterChange({ ...filters, nodeTypes: [] });
        };

        return (
          <div className="glass p-4 mb-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold flex items-center gap-2">
                <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24" className="text-indigo-400">
                  <path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                Node Filters
              </h3>
              <div className="flex gap-2">
                <button
                  onClick={handleSelectAll}
                  className="text-xs px-2 py-1 bg-indigo-500/20 text-indigo-300 rounded hover:bg-indigo-500/30 transition"
                >
                  Select All
                </button>
                <button
                  onClick={handleDeselectAll}
                  className="text-xs px-2 py-1 bg-slate-500/20 text-slate-300 rounded hover:bg-slate-500/30 transition"
                >
                  Clear
                </button>
              </div>
            </div>

            <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
              {Object.entries(NODE_TYPES).map(([type, config]) => (
                <label
                  key={type}
                  className={`flex items-center gap-2 p-2 rounded-lg cursor-pointer transition ${
                    filters.nodeTypes.includes(type)
                      ? 'bg-slate-700/50 border border-slate-600'
                      : 'bg-slate-800/30 border border-transparent hover:border-slate-700'
                  }`}
                >
                  <input
                    type="checkbox"
                    checked={filters.nodeTypes.includes(type)}
                    onChange={() => handleTypeToggle(type)}
                    className="sr-only"
                  />
                  <div
                    className="w-4 h-4 rounded-sm flex-shrink-0"
                    style={{ backgroundColor: config.color }}
                  ></div>
                  <span className="text-xs truncate">{config.label}</span>
                  {stats?.nodesByType?.[type] && (
                    <span className="text-xs text-slate-500 ml-auto">
                      {stats.nodesByType[type]}
                    </span>
                  )}
                </label>
              ))}
            </div>

            <div className="mt-4 flex gap-4">
              <label className="flex items-center gap-2 text-sm">
                <input
                  type="checkbox"
                  checked={filters.showVerifiedOnly}
                  onChange={(e) => onFilterChange({ ...filters, showVerifiedOnly: e.target.checked })}
                  className="rounded border-slate-600 bg-slate-800 text-indigo-500 focus:ring-indigo-500"
                />
                Show verified only
              </label>
              <label className="flex items-center gap-2 text-sm">
                <input
                  type="checkbox"
                  checked={filters.showLabels}
                  onChange={(e) => onFilterChange({ ...filters, showLabels: e.target.checked })}
                  className="rounded border-slate-600 bg-slate-800 text-indigo-500 focus:ring-indigo-500"
                />
                Show labels
              </label>
            </div>
          </div>
        );
      }

      // ==================== Stats Bar Component ====================
      function StatsBar({ stats, isConnected, lastUpdate }) {
        return (
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
            <div className="glass p-4">
              <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">Total Nodes</span>
              <div className="mt-1 text-2xl font-bold">{stats?.totalNodes || 0}</div>
            </div>
            <div className="glass p-4">
              <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">Total Edges</span>
              <div className="mt-1 text-2xl font-bold">{stats?.totalEdges || 0}</div>
            </div>
            <div className="glass p-4">
              <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">Verified</span>
              <div className="mt-1 text-2xl font-bold text-emerald-400">{stats?.verifiedNodes || 0}</div>
            </div>
            <div className="glass p-4">
              <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">Depth</span>
              <div className="mt-1 text-2xl font-bold">{stats?.depth || 0}</div>
            </div>
            <div className="glass p-4">
              <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">Connection</span>
              <div className={`mt-1 text-lg font-bold flex items-center gap-2 ${isConnected ? 'text-emerald-400' : 'text-red-400'}`}>
                <span className={`w-2 h-2 rounded-full ${isConnected ? 'bg-emerald-400 animate-pulse' : 'bg-red-400'}`}></span>
                {isConnected ? 'Live' : 'Offline'}
              </div>
            </div>
          </div>
        );
      }

      // ==================== Search Component ====================
      function SearchBar({ onSearch, onSearchClear, searchResults }) {
        const [query, setQuery] = useState('');

        const handleSearch = (e) => {
          e.preventDefault();
          onSearch(query);
        };

        const handleClear = () => {
          setQuery('');
          onSearchClear();
        };

        return (
          <div className="glass p-4 mb-4">
            <form onSubmit={handleSearch} className="flex gap-2">
              <div className="relative flex-1">
                <svg
                  className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  type="text"
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  placeholder="Search nodes by ID, label, or type..."
                  className="w-full pl-10 pr-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                />
              </div>
              <button
                type="submit"
                className="btn btn-primary px-4"
              >
                Search
              </button>
              {searchResults && searchResults.length > 0 && (
                <button
                  type="button"
                  onClick={handleClear}
                  className="px-4 py-2 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 transition"
                >
                  Clear ({searchResults.length})
                </button>
              )}
            </form>
          </div>
        );
      }

      // ==================== Composite Token Selector ====================
      function CompositeTokenSelector({ tokens, selectedToken, onSelect, onRefresh }) {
        return (
          <div className="glass p-4 mb-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-lg font-bold">Select Composite Token</h3>
              <button
                onClick={onRefresh}
                className="p-2 hover:bg-slate-700 rounded-lg transition"
                title="Refresh token list"
              >
                <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                  <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
              </button>
            </div>

            <div className="flex flex-wrap gap-2">
              {tokens.length === 0 ? (
                <div className="text-sm text-slate-500">No composite tokens available. Create one to visualize topology.</div>
              ) : (
                tokens.map((token) => (
                  <button
                    key={token.compositeId}
                    onClick={() => onSelect(token.compositeId)}
                    className={`px-3 py-2 rounded-lg text-sm transition ${
                      selectedToken === token.compositeId
                        ? 'bg-indigo-500 text-white'
                        : 'bg-slate-700/50 text-slate-300 hover:bg-slate-700'
                    }`}
                  >
                    <div className="font-medium">{token.compositeId.substring(0, 12)}...</div>
                    <div className="text-xs opacity-70">{token.assetType || 'Unknown'}</div>
                  </button>
                ))
              )}
            </div>
          </div>
        );
      }

      // ==================== Legend Component ====================
      function Legend({ nodeTypes, edgeTypes }) {
        return (
          <div className="glass p-4">
            <h4 className="text-sm font-bold mb-3 text-slate-300">Legend</h4>

            <div className="mb-4">
              <h5 className="text-xs font-medium text-slate-400 mb-2">Node Types</h5>
              <div className="grid grid-cols-2 gap-1">
                {Object.entries(nodeTypes).slice(0, 6).map(([type, config]) => (
                  <div key={type} className="flex items-center gap-2 text-xs">
                    <div
                      className="w-3 h-3 rounded-sm"
                      style={{ backgroundColor: config.color }}
                    ></div>
                    <span className="text-slate-400 truncate">{config.label}</span>
                  </div>
                ))}
              </div>
            </div>

            <div>
              <h5 className="text-xs font-medium text-slate-400 mb-2">Edge Types</h5>
              <div className="space-y-1">
                {Object.entries(edgeTypes).slice(0, 4).map(([type, config]) => (
                  <div key={type} className="flex items-center gap-2 text-xs">
                    <div
                      className="w-6 h-0.5"
                      style={{
                        backgroundColor: config.color,
                        borderStyle: config.style === 'dashed' ? 'dashed' : 'solid'
                      }}
                    ></div>
                    <span className="text-slate-400">{config.label}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      // ==================== Graph Controls Component ====================
      function GraphControls({ onZoomIn, onZoomOut, onReset, onFitToScreen, onExport }) {
        return (
          <div className="absolute top-4 right-4 flex flex-col gap-2 z-10">
            <button
              onClick={onZoomIn}
              className="p-2 bg-slate-800/80 hover:bg-slate-700 rounded-lg transition backdrop-blur-sm"
              title="Zoom In"
            >
              <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
            </button>
            <button
              onClick={onZoomOut}
              className="p-2 bg-slate-800/80 hover:bg-slate-700 rounded-lg transition backdrop-blur-sm"
              title="Zoom Out"
            >
              <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM7 10h6" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
            </button>
            <button
              onClick={onFitToScreen}
              className="p-2 bg-slate-800/80 hover:bg-slate-700 rounded-lg transition backdrop-blur-sm"
              title="Fit to Screen"
            >
              <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
            </button>
            <button
              onClick={onReset}
              className="p-2 bg-slate-800/80 hover:bg-slate-700 rounded-lg transition backdrop-blur-sm"
              title="Reset View"
            >
              <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
            </button>
            <div className="border-t border-slate-700 my-1"></div>
            <button
              onClick={onExport}
              className="p-2 bg-slate-800/80 hover:bg-slate-700 rounded-lg transition backdrop-blur-sm"
              title="Export as PNG"
            >
              <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
            </button>
          </div>
        );
      }

      // ==================== Main Topology Dashboard Component ====================
      function TopologyDashboard() {
        // State management
        const [topology, setTopology] = useState(null);
        const [selectedNode, setSelectedNode] = useState(null);
        const [selectedCompositeToken, setSelectedCompositeToken] = useState(null);
        const [compositeTokens, setCompositeTokens] = useState([]);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);
        const [isConnected, setIsConnected] = useState(false);
        const [lastUpdate, setLastUpdate] = useState(null);
        const [searchResults, setSearchResults] = useState(null);
        const [highlightedNodes, setHighlightedNodes] = useState([]);

        // Filter state
        const [filters, setFilters] = useState({
          nodeTypes: Object.keys(NODE_TYPES),
          showVerifiedOnly: false,
          showLabels: true
        });

        // Graph control refs
        const graphRef = useRef(null);
        const wsRef = useRef(null);

        // Initialize API and WebSocket
        useEffect(() => {
          // Load available composite tokens
          loadCompositeTokens();

          // Setup WebSocket connection
          setupWebSocket();

          return () => {
            if (wsRef.current) {
              wsRef.current.close();
            }
          };
        }, []);

        // Load composite tokens
        const loadCompositeTokens = async () => {
          try {
            const tokens = await window.TopologyAPI.getCompositeTokens();
            setCompositeTokens(tokens || []);

            // Auto-select first token if available
            if (tokens && tokens.length > 0 && !selectedCompositeToken) {
              setSelectedCompositeToken(tokens[0].compositeId);
            }
          } catch (err) {
            console.error('Failed to load composite tokens:', err);
            // Use demo data if API fails
            setCompositeTokens(getDemoTokens());
          }
        };

        // Load topology for selected token
        useEffect(() => {
          if (selectedCompositeToken) {
            loadTopology(selectedCompositeToken);
          }
        }, [selectedCompositeToken]);

        // Load topology data
        const loadTopology = async (compositeId) => {
          setIsLoading(true);
          setError(null);

          try {
            const data = await window.TopologyAPI.getTopology(compositeId, {
              depth: 4,
              includeVerifiers: true,
              format: 'd3'
            });

            if (data) {
              setTopology(data);
              setLastUpdate(new Date());
            }
          } catch (err) {
            console.error('Failed to load topology:', err);
            setError(err.message);
            // Load demo topology
            setTopology(getDemoTopology());
          } finally {
            setIsLoading(false);
          }
        };

        // Setup WebSocket for real-time updates
        const setupWebSocket = () => {
          const wsUrl = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/topology-ws`;

          try {
            wsRef.current = new WebSocket(wsUrl);

            wsRef.current.onopen = () => {
              setIsConnected(true);
              console.log('WebSocket connected');
            };

            wsRef.current.onmessage = (event) => {
              const message = JSON.parse(event.data);
              handleWebSocketMessage(message);
            };

            wsRef.current.onclose = () => {
              setIsConnected(false);
              // Attempt reconnection after 5 seconds
              setTimeout(setupWebSocket, 5000);
            };

            wsRef.current.onerror = (err) => {
              console.error('WebSocket error:', err);
              setIsConnected(false);
            };
          } catch (err) {
            console.error('WebSocket setup failed:', err);
            setIsConnected(false);
          }
        };

        // Handle WebSocket messages
        const handleWebSocketMessage = (message) => {
          switch (message.type) {
            case 'TOPOLOGY_UPDATE':
              if (message.compositeId === selectedCompositeToken) {
                setTopology(prev => ({
                  ...prev,
                  nodes: message.nodes || prev?.nodes,
                  links: message.links || prev?.links
                }));
                setLastUpdate(new Date());
              }
              break;
            case 'NODE_ADDED':
              if (message.compositeId === selectedCompositeToken) {
                setTopology(prev => ({
                  ...prev,
                  nodes: [...(prev?.nodes || []), message.node]
                }));
              }
              break;
            case 'NODE_UPDATED':
              if (message.compositeId === selectedCompositeToken) {
                setTopology(prev => ({
                  ...prev,
                  nodes: (prev?.nodes || []).map(n =>
                    n.id === message.node.id ? { ...n, ...message.node } : n
                  )
                }));
              }
              break;
            case 'EDGE_ADDED':
              if (message.compositeId === selectedCompositeToken) {
                setTopology(prev => ({
                  ...prev,
                  links: [...(prev?.links || []), message.edge]
                }));
              }
              break;
            default:
              console.log('Unknown message type:', message.type);
          }
        };

        // Handle node selection
        const handleNodeSelect = async (nodeId) => {
          if (!selectedCompositeToken || !nodeId) {
            setSelectedNode(null);
            return;
          }

          try {
            const nodeDetails = await window.TopologyAPI.getNodeDetails(
              selectedCompositeToken,
              nodeId
            );
            setSelectedNode(nodeDetails);
          } catch (err) {
            console.error('Failed to load node details:', err);
            // Find node from current topology
            const node = topology?.nodes?.find(n => n.id === nodeId);
            setSelectedNode(node ? { ...node, error: 'Failed to load full details' } : null);
          }
        };

        // Handle search
        const handleSearch = (query) => {
          if (!query || !topology?.nodes) {
            setSearchResults(null);
            setHighlightedNodes([]);
            return;
          }

          const lowerQuery = query.toLowerCase();
          const results = topology.nodes.filter(node =>
            node.id?.toLowerCase().includes(lowerQuery) ||
            node.label?.toLowerCase().includes(lowerQuery) ||
            node.group?.toLowerCase().includes(lowerQuery)
          );

          setSearchResults(results);
          setHighlightedNodes(results.map(n => n.id));
        };

        // Clear search
        const handleSearchClear = () => {
          setSearchResults(null);
          setHighlightedNodes([]);
        };

        // Graph control handlers
        const handleZoomIn = () => {
          graphRef.current?.zoomIn();
        };

        const handleZoomOut = () => {
          graphRef.current?.zoomOut();
        };

        const handleReset = () => {
          graphRef.current?.resetView();
        };

        const handleFitToScreen = () => {
          graphRef.current?.fitToScreen();
        };

        const handleExport = () => {
          graphRef.current?.exportAsPNG();
        };

        // Filter topology data
        const filteredTopology = useMemo(() => {
          if (!topology) return null;

          let nodes = topology.nodes || [];
          let links = topology.links || [];

          // Filter by node types
          if (filters.nodeTypes.length < Object.keys(NODE_TYPES).length) {
            nodes = nodes.filter(n => filters.nodeTypes.includes(n.group));
            const nodeIds = new Set(nodes.map(n => n.id));
            links = links.filter(l =>
              nodeIds.has(l.source?.id || l.source) &&
              nodeIds.has(l.target?.id || l.target)
            );
          }

          // Filter verified only
          if (filters.showVerifiedOnly) {
            nodes = nodes.filter(n => n.verified);
            const nodeIds = new Set(nodes.map(n => n.id));
            links = links.filter(l =>
              nodeIds.has(l.source?.id || l.source) &&
              nodeIds.has(l.target?.id || l.target)
            );
          }

          return { ...topology, nodes, links };
        }, [topology, filters]);

        // Calculate stats
        const stats = useMemo(() => {
          if (!filteredTopology) return null;

          const nodesByType = {};
          filteredTopology.nodes.forEach(n => {
            nodesByType[n.group] = (nodesByType[n.group] || 0) + 1;
          });

          return {
            totalNodes: filteredTopology.nodes.length,
            totalEdges: filteredTopology.links.length,
            verifiedNodes: filteredTopology.nodes.filter(n => n.verified).length,
            depth: topology?.metadata?.depth || 4,
            nodesByType
          };
        }, [filteredTopology, topology]);

        // Demo data generators
        function getDemoTokens() {
          return [
            { compositeId: 'CT-DEMO-001-REALESTATE', assetType: 'Real Estate' },
            { compositeId: 'CT-DEMO-002-CARBON', assetType: 'Carbon Credit' },
            { compositeId: 'CT-DEMO-003-COMMODITY', assetType: 'Commodity' }
          ];
        }

        function getDemoTopology() {
          return {
            nodes: [
              { id: 'AC-001', label: 'Active Contract', group: 'ACTIVE_CONTRACT', verified: true, status: 'ACTIVE' },
              { id: 'CT-001', label: 'Composite Token', group: 'COMPOSITE_TOKEN', verified: true, status: 'VERIFIED' },
              { id: 'PT-001', label: 'Primary Token', group: 'PRIMARY_TOKEN', verified: true, status: 'VERIFIED' },
              { id: 'ST-001', label: 'Tax Document', group: 'DOCUMENT_TOKEN', verified: true },
              { id: 'ST-002', label: 'Property Photo', group: 'MEDIA_TOKEN', verified: true },
              { id: 'ST-003', label: 'Valuation Report', group: 'SECONDARY_TOKEN', verified: false },
              { id: 'DT-001', label: 'Fractional Share 1', group: 'DERIVED_TOKEN', verified: true },
              { id: 'DT-002', label: 'Fractional Share 2', group: 'DERIVED_TOKEN', verified: true },
              { id: 'VVB-001', label: 'VVB Verifier', group: 'VVB_VERIFIER', verified: true }
            ],
            links: [
              { source: 'AC-001', target: 'CT-001', type: 'BINDS_TO' },
              { source: 'CT-001', target: 'PT-001', type: 'CONTAINS' },
              { source: 'CT-001', target: 'ST-001', type: 'CONTAINS' },
              { source: 'CT-001', target: 'ST-002', type: 'CONTAINS' },
              { source: 'CT-001', target: 'ST-003', type: 'CONTAINS' },
              { source: 'PT-001', target: 'DT-001', type: 'DERIVES_FROM' },
              { source: 'PT-001', target: 'DT-002', type: 'DERIVES_FROM' },
              { source: 'VVB-001', target: 'CT-001', type: 'VERIFIES' }
            ],
            metadata: {
              topologyId: 'TOPO-DEMO-001',
              type: 'ACTIVE_CONTRACT',
              depth: 4
            }
          };
        }

        return (
          <div className="min-h-screen">
            <Navbar activePage="topology" />

            <main className="content-wrapper">
              {/* Header */}
              <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 animate-fade-in">
                <div>
                  <h1 className="text-3xl font-bold tracking-tight mb-2">Token Topology</h1>
                  <p className="text-slate-400 max-w-2xl">
                    Interactive visualization of Composite Token relationships using D3.js force-directed graphs.
                    Explore token hierarchies, VVB verifications, and derived token chains.
                  </p>
                </div>
                <div className="flex items-center gap-3">
                  <button
                    className="btn btn-primary"
                    onClick={() => loadTopology(selectedCompositeToken)}
                    disabled={!selectedCompositeToken || isLoading}
                  >
                    {isLoading ? (
                      <>
                        <svg className="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading...
                      </>
                    ) : (
                      <>
                        <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                          <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" strokeLinecap="round" strokeLinejoin="round" />
                        </svg>
                        Refresh
                      </>
                    )}
                  </button>
                  {lastUpdate && (
                    <div className="text-right">
                      <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Last Update</p>
                      <p className="text-sm font-medium">{lastUpdate.toLocaleTimeString()}</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Error Banner */}
              {error && (
                <div className="glass border-red-500/30 bg-red-500/10 p-4 rounded-xl mb-6 flex items-center gap-3 animate-fade-in">
                  <div className="p-2 rounded-lg bg-red-500">
                    <svg width="20" height="20" fill="none" stroke="white" strokeWidth="2" viewBox="0 0 24 24">
                      <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" strokeLinecap="round" strokeLinejoin="round" />
                    </svg>
                  </div>
                  <div>
                    <p className="font-semibold text-red-200">Error Loading Topology</p>
                    <p className="text-sm text-red-200/70">{error}</p>
                  </div>
                </div>
              )}

              {/* Stats Bar */}
              <StatsBar stats={stats} isConnected={isConnected} lastUpdate={lastUpdate} />

              {/* Token Selector */}
              <CompositeTokenSelector
                tokens={compositeTokens}
                selectedToken={selectedCompositeToken}
                onSelect={setSelectedCompositeToken}
                onRefresh={loadCompositeTokens}
              />

              {/* Search Bar */}
              <SearchBar
                onSearch={handleSearch}
                onSearchClear={handleSearchClear}
                searchResults={searchResults}
              />

              {/* Filters */}
              <FilterPanel
                filters={filters}
                onFilterChange={setFilters}
                stats={stats}
              />

              {/* Main Content Area */}
              <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                {/* Graph Container */}
                <div className="lg:col-span-3">
                  <div className="glass overflow-hidden relative" style={{ height: '600px' }}>
                    {isLoading ? (
                      <div className="absolute inset-0 flex items-center justify-center bg-slate-900/50">
                        <div className="text-center">
                          <svg className="animate-spin h-12 w-12 mx-auto mb-4 text-indigo-500" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                          <p className="text-slate-400">Loading topology...</p>
                        </div>
                      </div>
                    ) : filteredTopology ? (
                      <>
                        <GraphControls
                          onZoomIn={handleZoomIn}
                          onZoomOut={handleZoomOut}
                          onReset={handleReset}
                          onFitToScreen={handleFitToScreen}
                          onExport={handleExport}
                        />
                        <TopologyGraph
                          ref={graphRef}
                          data={filteredTopology}
                          nodeTypes={NODE_TYPES}
                          edgeTypes={EDGE_TYPES}
                          selectedNode={selectedNode?.id}
                          highlightedNodes={highlightedNodes}
                          showLabels={filters.showLabels}
                          onNodeSelect={handleNodeSelect}
                        />
                      </>
                    ) : (
                      <div className="absolute inset-0 flex items-center justify-center">
                        <div className="text-center">
                          <svg className="w-16 h-16 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
                          </svg>
                          <p className="text-slate-400">Select a Composite Token to view its topology</p>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Side Panel */}
                <div className="lg:col-span-1 space-y-4">
                  {/* Node Detail Panel */}
                  <NodeDetailPanel
                    node={selectedNode}
                    nodeTypes={NODE_TYPES}
                    onClose={() => setSelectedNode(null)}
                  />

                  {/* Legend */}
                  <Legend nodeTypes={NODE_TYPES} edgeTypes={EDGE_TYPES} />
                </div>
              </div>
            </main>

            {/* Footer */}
            <footer className="border-t border-slate-800 p-8 text-center text-slate-500 mt-10">
              <div className="flex items-center justify-center gap-6 mb-4">
                <span className="text-xs uppercase tracking-[0.2em] font-bold">D3.js v7</span>
                <span className="text-xs uppercase tracking-[0.2em] font-bold">React 18</span>
                <span className="text-xs uppercase tracking-[0.2em] font-bold">WebSocket</span>
              </div>
              <p className="text-sm">&copy; 2025 Aurigraph DLT. Sprint 10-11 - Token Topology Visualization</p>
            </footer>
          </div>
        );
      }

      // ==================== Render Application ====================
      const root = ReactDOM.createRoot(document.getElementById('topology-root'));
      root.render(<TopologyDashboard />);
    </script>
  </body>
</html>

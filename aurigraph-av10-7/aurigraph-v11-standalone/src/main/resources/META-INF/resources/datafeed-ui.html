<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurigraph V11 - Data Feed Manager</title>
    
    <!-- React and dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom styling -->
    <link rel="stylesheet" href="styles.css">
    
    <style>
        .feed-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .feed-card:hover {
            background: rgba(30, 41, 59, 0.6);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
        }
        .feed-card.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: inset 0 0 20px rgba(99, 102, 241, 0.1);
        }
        .data-preview {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.8rem;
            color: #94a3b8;
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
    </style>
</head>
<body>
    <div id="feeds-root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Navbar Component
        function Navbar({ activePage }) {
            return (
                <nav className="navbar glass">
                    <a href="dashboard.html" className="nav-logo">
                        <div className="logo-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <span>Aurigraph <span className="text-indigo-400">V11</span></span>
                    </a>
                    <div className="nav-links">
                        <a href="dashboard.html" className={`nav-link ${activePage === 'dashboard' ? 'active' : ''}`}>Monitoring</a>
                        <a href="datafeed-ui.html" className={`nav-link ${activePage === 'datafeeds' ? 'active' : ''}`}>Data Feeds</a>
                        <a href="feed-tokens-ui.html" className={`nav-link ${activePage === 'tokens' ? 'active' : ''}`}>Asset Tokens</a>
                    </div>
                </nav>
            );
        }

        function DataFeedManager() {
            const [feeds, setFeeds] = useState([]);
            const [selectedFeed, setSelectedFeed] = useState(null);
            const [activeTab, setActiveTab] = useState('details');
            const [stats, setStats] = useState({});
            const [loading, setLoading] = useState(true);

            const fetchData = useCallback(async () => {
                try {
                    const [feedsRes, statsRes] = await Promise.all([
                        fetch('/api/v11/datafeeds'),
                        fetch('/api/v11/datafeeds/stats')
                    ]);
                    
                    if (feedsRes.ok && statsRes.ok) {
                        const feedsData = await feedsRes.json();
                        const statsData = await statsRes.json();
                        setFeeds(feedsData.feeds || []);
                        setStats(statsData);
                    }
                } catch (err) {
                    console.error('Error fetching feeds:', err);
                } finally {
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 10000);
                return () => clearInterval(interval);
            }, [fetchData]);

            return (
                <div className="min-h-screen">
                    <Navbar activePage="datafeeds" />
                    
                    <main className="content-wrapper">
                        {/* Header */}
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10 animate-fade-in">
                            <div>
                                <h1 className="text-3xl font-bold tracking-tight mb-2">External Data Feeds</h1>
                                <p className="text-slate-400">Manage and monitor high-fidelity data streams for Aurigraph slim agents.</p>
                            </div>
                            <div className="flex gap-4">
                                <button className="btn btn-primary">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                                        <path d="M12 4v16m8-8H4" strokeLinecap="round" strokeLinejoin="round"/>
                                    </svg>
                                    Provision New Feed
                                </button>
                            </div>
                        </div>

                        {/* Stats Bar */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                            {[
                                { label: 'Active Streams', value: stats.activeFeeds || 0, icon: 'bg-emerald-500' },
                                { label: 'Total Volume', value: (stats.totalDataPoints || 0).toLocaleString(), icon: 'bg-indigo-500' },
                                { label: 'Subscribers', value: stats.totalSubscriptions || 0, icon: 'bg-violet-500' },
                                { label: 'Avg Latency', value: '14ms', icon: 'bg-amber-500' }
                            ].map((stat, i) => (
                                <div key={i} className="glass p-5 animate-fade-in" style={{animationDelay: `${i * 0.1}s`}}>
                                    <p className="text-xs text-slate-500 font-bold uppercase mb-2">{stat.label}</p>
                                    <div className="flex items-center gap-3">
                                        <div className={`w-1.5 h-6 rounded-full ${stat.icon}`}></div>
                                        <span className="text-2xl font-bold">{stat.value}</span>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            {/* Feed List */}
                            <div className="lg:col-span-5 space-y-4">
                                <h2 className="text-sm font-bold uppercase tracking-widest text-slate-500 mb-4 px-2">Managed Streams</h2>
                                {loading ? (
                                    <div className="py-10 text-center text-slate-500">Scanning network...</div>
                                ) : feeds.length === 0 ? (
                                    <div className="glass p-10 text-center text-slate-500">No active feeds found.</div>
                                ) : (
                                    feeds.map((feed) => (
                                        <div 
                                            key={feed.feedId} 
                                            className={`feed-card glass p-5 ${selectedFeed?.feedId === feed.feedId ? 'selected' : ''}`}
                                            onClick={() => setSelectedFeed(feed)}
                                        >
                                            <div className="flex justify-between items-start mb-3">
                                                <h3 className="font-bold text-slate-200">{feed.name}</h3>
                                                <span className={`badge ${feed.status === 'ACTIVE' ? 'badge-success' : 'badge-warning'}`}>
                                                    {feed.status}
                                                </span>
                                            </div>
                                            <div className="flex items-center gap-4 text-xs text-slate-500">
                                                <span className="flex items-center gap-1">
                                                    <svg width="12" height="12" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                                    {feed.type}
                                                </span>
                                                <span className="flex items-center gap-1">
                                                    <svg width="12" height="12" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                                                    {feed.subscribedAgents} Agents
                                                </span>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>

                            {/* Details Panel */}
                            <div className="lg:col-span-7">
                                {selectedFeed ? (
                                    <div className="glass h-full flex flex-col overflow-hidden animate-fade-in">
                                        <div className="border-b border-slate-800 px-6 pt-4 flex gap-6">
                                            <button 
                                                className={`tab-btn ${activeTab === 'details' ? 'active' : ''}`}
                                                onClick={() => setActiveTab('details')}
                                            >Details</button>
                                            <button 
                                                className={`tab-btn ${activeTab === 'data' ? 'active' : ''}`}
                                                onClick={() => setActiveTab('data')}
                                            >Raw Stream</button>
                                        </div>
                                        
                                        <div className="p-8 flex-1 overflow-y-auto">
                                            {activeTab === 'details' ? (
                                                <div className="space-y-8">
                                                    <div>
                                                        <h3 className="text-2xl font-bold mb-1">{selectedFeed.name}</h3>
                                                        <p className="text-sm font-mono text-slate-500">{selectedFeed.feedId}</p>
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-2 gap-8">
                                                        <div>
                                                            <p className="text-xs text-slate-500 font-bold uppercase mb-2">Endpoint</p>
                                                            <p className="text-sm bg-slate-800/50 p-3 rounded-lg border border-slate-700 font-mono overflow-x-auto">
                                                                {selectedFeed.endpoint}
                                                            </p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-slate-500 font-bold uppercase mb-2">Refresh Interval</p>
                                                            <p className="text-sm font-medium">{selectedFeed.updateFrequency}ms</p>
                                                        </div>
                                                    </div>

                                                    <div>
                                                        <p className="text-xs text-slate-500 font-bold uppercase mb-4">Subscriber Nodes</p>
                                                        <div className="space-y-2">
                                                            <div className="p-3 bg-slate-800/30 rounded-lg flex justify-between items-center">
                                                                <span className="text-xs font-mono">NODE-ALPHA-293</span>
                                                                <span className="text-[10px] text-emerald-400 font-bold">HEALTHY</span>
                                                            </div>
                                                            <div className="p-3 bg-slate-800/30 rounded-lg flex justify-between items-center">
                                                                <span className="text-xs font-mono">NODE-KAPPA-411</span>
                                                                <span className="text-[10px] text-emerald-400 font-bold">HEALTHY</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="h-full flex flex-col">
                                                    <div className="flex justify-between items-center mb-4">
                                                        <h4 className="text-sm font-bold text-slate-400">Live JSON Payload</h4>
                                                        <div className="flex items-center gap-2">
                                                            <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                                            <span className="text-[10px] uppercase font-bold text-emerald-500 tracking-wider">Streaming</span>
                                                        </div>
                                                    </div>
                                                    <pre className="data-preview flex-1 p-6 overflow-auto">
                                                        {`{
  "timestamp": "${new Date().toISOString()}",
  "feedId": "${selectedFeed.feedId}",
  "type": "${selectedFeed.type}",
  "payload": {
    "value": ${(Math.random() * 1000).toFixed(4)},
    "unit": "USD/kW",
    "precision": 8,
    "confidence": 0.9998
  },
  "signature": "0x4b2...9f2"
}`}
                                                    </pre>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="glass h-full flex items-center justify-center p-20 text-center border-dashed border-2 border-slate-800">
                                        <div>
                                            <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6">
                                                <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24" className="text-slate-600">
                                                    <path d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" strokeLinecap="round" strokeLinejoin="round"/>
                                                </svg>
                                            </div>
                                            <h3 className="text-slate-300 font-bold mb-2">No Feed Selected</h3>
                                            <p className="text-sm text-slate-500 max-w-xs">Select a data stream from the list to view detailed telemetry and raw network traffic.</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('feeds-root'));
        root.render(<DataFeedManager />);
    </script>
</body>
</html>

package io.aurigraph.v11.unit;

import io.aurigraph.v11.hms.HMSIntegrationService;
import io.aurigraph.v11.hms.HMSIntegrationService.*;
import io.quarkus.test.junit.QuarkusTest;
import jakarta.inject.Inject;
import org.junit.jupiter.api.*;

import java.math.BigDecimal;
import java.time.Duration;
import java.util.*;

import static org.assertj.core.api.Assertions.*;

/**
 * Comprehensive unit tests for HMSIntegrationService
 *
 * Tests healthcare asset tokenization and management:
 * - Asset tokenization workflows
 * - Asset retrieval and listing
 * - Asset ownership transfers
 * - Asset validation
 * - Statistics tracking
 * - Error handling and edge cases
 *
 * Coverage Target: 90% line, 85% branch (Phase 4 Critical Package)
 *
 * @version 3.10.0 (Phase 4 Day 3-4)
 */
@QuarkusTest
@TestMethodOrder(MethodOrderer.OrderAnnotation.class)
class HMSIntegrationServiceTest {

    @Inject
    HMSIntegrationService hmsService;

    private static final String TEST_OWNER = "0xOwner123";
    private static final String TEST_OWNER_2 = "0xOwner456";
    private static String testAssetId;

    // ==================== ASSET TOKENIZATION ====================

    @Test
    @Order(1)
    @DisplayName("UT-HMS-01: Should tokenize healthcare asset successfully")
    void testTokenizeAssetSuccess() {
        // Arrange
        Map<String, Object> metadata = new HashMap<>();
        metadata.put("patientId", "PAT-001");
        metadata.put("recordType", "MRI");
        metadata.put("description", "Brain MRI scan");

        TokenizationRequest request = new TokenizationRequest(
                "MEDICAL_RECORD",
                TEST_OWNER,
                new BigDecimal("1000.00"),
                metadata
        );

        // Act
        TokenizationResponse response = hmsService.tokenizeAsset(request)
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(response).isNotNull();
        assertThat(response.assetId).isNotNull().isNotEmpty();
        assertThat(response.tokenId).isNotNull().isNotEmpty();
        assertThat(response.status).isEqualTo("SUCCESS");
        assertThat(response.timestamp).isNotNull();

        testAssetId = response.assetId;
    }

    @Test
    @Order(2)
    @DisplayName("UT-HMS-02: Should tokenize multiple assets")
    void testTokenizeMultipleAssets() {
        // Arrange & Act
        List<TokenizationResponse> responses = new ArrayList<>();

        for (int i = 0; i < 3; i++) {
            Map<String, Object> metadata = new HashMap<>();
            metadata.put("recordId", "REC-" + i);
            metadata.put("type", "X-RAY");

            TokenizationRequest request = new TokenizationRequest(
                    "MEDICAL_RECORD",
                    TEST_OWNER,
                    new BigDecimal("500.00"),
                    metadata
            );

            TokenizationResponse response = hmsService.tokenizeAsset(request)
                    .await().atMost(Duration.ofSeconds(5));

            responses.add(response);
        }

        // Assert
        assertThat(responses).hasSize(3);
        assertThat(responses).allMatch(r -> r.status.equals("SUCCESS"));
        assertThat(responses).extracting(r -> r.assetId).doesNotContainNull();
    }

    @Test
    @Order(3)
    @DisplayName("UT-HMS-03: Should tokenize asset with minimal metadata")
    void testTokenizeAssetMinimalMetadata() {
        // Arrange
        TokenizationRequest request = new TokenizationRequest(
                "EQUIPMENT",
                TEST_OWNER,
                new BigDecimal("50000.00"),
                null  // No metadata
        );

        // Act
        TokenizationResponse response = hmsService.tokenizeAsset(request)
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(response).isNotNull();
        assertThat(response.status).isEqualTo("SUCCESS");
    }

    @Test
    @Order(4)
    @DisplayName("UT-HMS-04: Should tokenize high-value pharmaceutical asset")
    void testTokenizeHighValueAsset() {
        // Arrange
        Map<String, Object> metadata = new HashMap<>();
        metadata.put("drugName", "Cancer Treatment Drug");
        metadata.put("batchNumber", "BATCH-2025-001");
        metadata.put("expiryDate", "2027-12-31");

        TokenizationRequest request = new TokenizationRequest(
                "PHARMACEUTICAL",
                TEST_OWNER,
                new BigDecimal("1000000.00"),
                metadata
        );

        // Act
        TokenizationResponse response = hmsService.tokenizeAsset(request)
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(response).isNotNull();
        assertThat(response.status).isEqualTo("SUCCESS");
    }

    // ==================== ASSET RETRIEVAL ====================

    @Test
    @Order(5)
    @DisplayName("UT-HMS-05: Should get asset by ID")
    void testGetAsset() {
        // Act
        RealWorldAsset asset = hmsService.getAsset(testAssetId)
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(asset).isNotNull();
        assertThat(asset.assetId).isEqualTo(testAssetId);
        assertThat(asset.owner).isEqualTo(TEST_OWNER);
        assertThat(asset.assetType).isEqualTo("MEDICAL_RECORD");
        assertThat(asset.value).isEqualByComparingTo(new BigDecimal("1000.00"));
        assertThat(asset.status).isEqualTo("ACTIVE");
        assertThat(asset.metadata).isNotNull();
        assertThat(asset.createdAt).isNotNull();
    }

    @Test
    @Order(6)
    @DisplayName("UT-HMS-06: Should throw exception for non-existent asset")
    void testGetAssetNotFound() {
        // Act & Assert
        assertThatThrownBy(() ->
                hmsService.getAsset("non-existent-asset-id")
                        .await().atMost(Duration.ofSeconds(5))
        ).isInstanceOf(Exception.class)
                .hasMessageContaining("not found");
    }

    @Test
    @Order(7)
    @DisplayName("UT-HMS-07: Should list all assets")
    void testListAssets() {
        // Act
        List<RealWorldAsset> assets = hmsService.listAssets()
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(assets).isNotEmpty();
        assertThat(assets).hasSizeGreaterThanOrEqualTo(5); // From previous tests
        assertThat(assets).allMatch(asset -> asset.assetId != null);
        assertThat(assets).allMatch(asset -> asset.status.equals("ACTIVE"));
    }

    @Test
    @Order(8)
    @DisplayName("UT-HMS-08: Should verify asset metadata in list")
    void testListAssetsMetadata() {
        // Act
        List<RealWorldAsset> assets = hmsService.listAssets()
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        Optional<RealWorldAsset> testAsset = assets.stream()
                .filter(a -> a.assetId.equals(testAssetId))
                .findFirst();

        assertThat(testAsset).isPresent();
        assertThat(testAsset.get().metadata).containsKeys("patientId", "recordType", "description");
        assertThat(testAsset.get().metadata.get("recordType")).isEqualTo("MRI");
    }

    // ==================== ASSET TRANSFER ====================

    @Test
    @Order(9)
    @DisplayName("UT-HMS-09: Should transfer asset ownership")
    void testTransferAsset() {
        // Act
        Boolean result = hmsService.transferAsset(testAssetId, TEST_OWNER_2)
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(result).isTrue();

        // Verify new ownership
        RealWorldAsset asset = hmsService.getAsset(testAssetId)
                .await().atMost(Duration.ofSeconds(5));

        assertThat(asset.owner).isEqualTo(TEST_OWNER_2);
    }

    @Test
    @Order(10)
    @DisplayName("UT-HMS-10: Should fail to transfer non-existent asset")
    void testTransferAssetNotFound() {
        // Act & Assert
        assertThatThrownBy(() ->
                hmsService.transferAsset("non-existent-asset", TEST_OWNER_2)
                        .await().atMost(Duration.ofSeconds(5))
        ).isInstanceOf(Exception.class)
                .hasMessageContaining("not found");
    }

    @Test
    @Order(11)
    @DisplayName("UT-HMS-11: Should transfer asset back to original owner")
    void testTransferAssetBack() {
        // Act
        Boolean result = hmsService.transferAsset(testAssetId, TEST_OWNER)
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(result).isTrue();

        RealWorldAsset asset = hmsService.getAsset(testAssetId)
                .await().atMost(Duration.ofSeconds(5));

        assertThat(asset.owner).isEqualTo(TEST_OWNER);
    }

    // ==================== ASSET VALIDATION ====================

    @Test
    @Order(12)
    @DisplayName("UT-HMS-12: Should validate existing asset")
    void testValidateAsset() {
        // Act
        Boolean isValid = hmsService.validateAsset(testAssetId)
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(isValid).isTrue();
    }

    @Test
    @Order(13)
    @DisplayName("UT-HMS-13: Should invalidate non-existent asset")
    void testValidateAssetNotFound() {
        // Act
        Boolean isValid = hmsService.validateAsset("non-existent-asset")
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(isValid).isFalse();
    }

    @Test
    @Order(14)
    @DisplayName("UT-HMS-14: Should validate all tokenized assets")
    void testValidateMultipleAssets() {
        // Arrange
        List<RealWorldAsset> assets = hmsService.listAssets()
                .await().atMost(Duration.ofSeconds(5));

        // Act & Assert
        for (RealWorldAsset asset : assets) {
            Boolean isValid = hmsService.validateAsset(asset.assetId)
                    .await().atMost(Duration.ofSeconds(5));

            assertThat(isValid).isTrue();
        }
    }

    // ==================== STATISTICS ====================

    @Test
    @Order(15)
    @DisplayName("UT-HMS-15: Should get HMS statistics")
    void testGetStats() {
        // Act
        HMSStats stats = hmsService.getStats()
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(stats).isNotNull();
        assertThat(stats.totalAssets).isGreaterThan(0);
        assertThat(stats.totalTransactions).isGreaterThan(0);
        assertThat(stats.successfulTransactions).isGreaterThan(0);
        assertThat(stats.totalValue).isGreaterThan(BigDecimal.ZERO);
    }

    @Test
    @Order(16)
    @DisplayName("UT-HMS-16: Should track tokenization in statistics")
    void testStatsAfterTokenization() {
        // Arrange - Get baseline stats
        HMSStats beforeStats = hmsService.getStats()
                .await().atMost(Duration.ofSeconds(5));

        // Act - Tokenize new asset
        TokenizationRequest request = new TokenizationRequest(
                "EQUIPMENT",
                TEST_OWNER,
                new BigDecimal("25000.00"),
                Map.of("type", "MRI Machine")
        );

        hmsService.tokenizeAsset(request)
                .await().atMost(Duration.ofSeconds(5));

        // Get updated stats
        HMSStats afterStats = hmsService.getStats()
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(afterStats.totalAssets).isEqualTo(beforeStats.totalAssets + 1);
        assertThat(afterStats.totalTransactions).isGreaterThan(beforeStats.totalTransactions);
    }

    // ==================== ASSET TYPES ====================

    @Test
    @Order(17)
    @DisplayName("UT-HMS-17: Should tokenize different asset types")
    void testTokenizeDifferentAssetTypes() {
        // Arrange
        String[] assetTypes = {"MEDICAL_RECORD", "EQUIPMENT", "PHARMACEUTICAL", "FACILITY", "RESEARCH_DATA"};
        List<TokenizationResponse> responses = new ArrayList<>();

        // Act
        for (String assetType : assetTypes) {
            TokenizationRequest request = new TokenizationRequest(
                    assetType,
                    TEST_OWNER,
                    new BigDecimal("10000.00"),
                    Map.of("type", assetType)
            );

            TokenizationResponse response = hmsService.tokenizeAsset(request)
                    .await().atMost(Duration.ofSeconds(5));

            responses.add(response);
        }

        // Assert
        assertThat(responses).hasSize(5);
        assertThat(responses).allMatch(r -> r.status.equals("SUCCESS"));
    }

    @Test
    @Order(18)
    @DisplayName("UT-HMS-18: Should filter assets by type from listing")
    void testFilterAssetsByType() {
        // Act
        List<RealWorldAsset> allAssets = hmsService.listAssets()
                .await().atMost(Duration.ofSeconds(5));

        // Filter by type
        List<RealWorldAsset> medicalRecords = allAssets.stream()
                .filter(asset -> asset.assetType.equals("MEDICAL_RECORD"))
                .toList();

        // Assert
        assertThat(medicalRecords).isNotEmpty();
        assertThat(medicalRecords).allMatch(asset -> asset.assetType.equals("MEDICAL_RECORD"));
    }

    // ==================== EDGE CASES ====================

    @Test
    @Order(19)
    @DisplayName("UT-HMS-19: Should handle tokenization with empty string values")
    void testTokenizeWithEmptyStrings() {
        // Arrange
        TokenizationRequest request = new TokenizationRequest(
                "",  // Empty asset type
                TEST_OWNER,
                new BigDecimal("100.00"),
                Map.of()
        );

        // Act
        TokenizationResponse response = hmsService.tokenizeAsset(request)
                .await().atMost(Duration.ofSeconds(5));

        // Assert - Service should still create asset with empty type
        assertThat(response).isNotNull();
        assertThat(response.status).isEqualTo("SUCCESS");
    }

    @Test
    @Order(20)
    @DisplayName("UT-HMS-20: Should handle zero value assets")
    void testTokenizeZeroValueAsset() {
        // Arrange
        TokenizationRequest request = new TokenizationRequest(
                "TEST_ASSET",
                TEST_OWNER,
                BigDecimal.ZERO,
                Map.of("note", "Zero value test")
        );

        // Act
        TokenizationResponse response = hmsService.tokenizeAsset(request)
                .await().atMost(Duration.ofSeconds(5));

        // Assert
        assertThat(response).isNotNull();
        assertThat(response.status).isEqualTo("SUCCESS");

        RealWorldAsset asset = hmsService.getAsset(response.assetId)
                .await().atMost(Duration.ofSeconds(5));

        assertThat(asset.value).isEqualByComparingTo(BigDecimal.ZERO);
    }
}

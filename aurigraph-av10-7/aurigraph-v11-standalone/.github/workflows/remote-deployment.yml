name: Remote Server Deployment

on:
  push:
    branches: [ main, V12 ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests during build'
        required: false
        default: 'false'
        type: boolean
      force_deploy:
        description: 'Force deployment even if health check fails'
        required: false
        default: 'false'
        type: boolean

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: -Xmx4g -XX:+UseG1GC
  REMOTE_HOST: dlt.aurigraph.io
  REMOTE_USER: subbu
  REMOTE_PORT: 22
  SERVICE_PORT: 9003
  JAR_NAME: aurigraph-v12.jar
  REMOTE_DIR: /home/subbu

jobs:
  # Job 1: Build JAR
  build:
    name: Build Application
    runs-on: self-hosted
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          if [ "${{ github.event.inputs.skip_tests }}" == "true" ]; then
            ./mvnw clean package -DskipTests
          else
            ./mvnw clean package
          fi

      - name: Verify JAR exists
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ls -la target/quarkus-app/
          JAR_PATH="target/quarkus-app/quarkus-run.jar"
          if [ ! -f "$JAR_PATH" ]; then
            echo "ERROR: JAR not found at $JAR_PATH"
            exit 1
          fi
          echo "JAR_SIZE=$(du -h $JAR_PATH | cut -f1)" >> $GITHUB_ENV

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: aurigraph-jar
          path: aurigraph-av10-7/aurigraph-v11-standalone/target/quarkus-app/
          retention-days: 5

  # Job 2: Deploy to Remote Server
  deploy:
    name: Deploy to Production
    runs-on: self-hosted
    needs: build
    timeout-minutes: 15
    environment:
      name: production
      url: https://dlt.aurigraph.io

    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: aurigraph-jar
          path: ./quarkus-app

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create deployment package
        run: |
          # Create a single deployable JAR
          cd quarkus-app
          ls -la
          # Create tar of the quarkus-app directory
          tar -czf ../aurigraph-v12-deploy.tar.gz .

      - name: Upload to remote server
        run: |
          scp -P ${{ env.REMOTE_PORT }} -o StrictHostKeyChecking=no \
            aurigraph-v12-deploy.tar.gz \
            ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }}:${{ env.REMOTE_DIR }}/

      - name: Deploy on remote server
        run: |
          ssh -p ${{ env.REMOTE_PORT }} -o StrictHostKeyChecking=no \
            ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }} << 'DEPLOY_SCRIPT'

          set -e
          echo "=== Aurigraph V12 Deployment ==="
          echo "Timestamp: $(date)"

          cd $HOME

          # Backup current deployment
          if [ -d "quarkus-app" ]; then
            echo "Backing up current deployment..."
            mv quarkus-app quarkus-app.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
          fi

          # Extract new deployment
          echo "Extracting new deployment..."
          mkdir -p quarkus-app
          tar -xzf aurigraph-v12-deploy.tar.gz -C quarkus-app/
          rm aurigraph-v12-deploy.tar.gz

          # Stop existing service
          echo "Stopping existing service..."
          pkill -f 'quarkus-run.jar' 2>/dev/null || echo "No existing process"
          sleep 3

          # Ensure logs directory exists
          mkdir -p $HOME/aurigraph/logs

          # Start new service
          echo "Starting new service..."
          nohup java \
            -Xmx8g -Xms4g \
            -XX:+UseG1GC \
            -XX:MaxGCPauseMillis=200 \
            -Dquarkus.http.port=9003 \
            -Dquarkus.grpc.server.port=9001 \
            -Dquarkus.log.level=INFO \
            -Dcurby.quantum.api-key=placeholder \
            -Dquarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/j4c_db \
            -Dquarkus.datasource.username=j4c_user \
            -Dquarkus.datasource.password=j4c_password \
            -Dquarkus.flyway.migrate-at-start=false \
            -jar $HOME/quarkus-app/quarkus-run.jar \
            > $HOME/aurigraph/logs/main-api.log 2>&1 &

          echo "Service PID: $!"
          echo "Waiting for startup..."
          sleep 20

          # Health check
          echo "Running health check..."
          HEALTH=$(curl -s http://localhost:9003/api/v11/health 2>&1 || echo "FAILED")
          echo "Health response: $HEALTH"

          if echo "$HEALTH" | grep -q "status"; then
            echo "Deployment successful!"
          else
            echo "Health check inconclusive, checking process..."
            pgrep -f quarkus-run.jar && echo "Process is running" || echo "Process not found"
          fi

          # Cleanup old backups (keep last 3)
          echo "Cleaning up old backups..."
          ls -dt quarkus-app.backup.* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true

          echo "=== Deployment Complete ==="
          DEPLOY_SCRIPT

      - name: Verify deployment
        run: |
          echo "Waiting for service to stabilize..."
          sleep 10

          echo "Testing public endpoint..."
          HEALTH_RESPONSE=$(curl -s --max-time 10 https://${{ env.REMOTE_HOST }}/api/v11/health 2>&1 || echo "TIMEOUT")
          echo "Health response: $HEALTH_RESPONSE"

          if echo "$HEALTH_RESPONSE" | grep -q "status"; then
            echo "Deployment verified successfully!"
          elif [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "Health check failed but force_deploy is enabled. Continuing..."
          else
            echo "Deployment verification failed!"
            exit 1
          fi

      - name: Post deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Server | ${{ env.REMOTE_HOST }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Port | ${{ env.SERVICE_PORT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Time | $(date -u) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Health: https://${{ env.REMOTE_HOST }}/api/v11/health" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://${{ env.REMOTE_HOST }}/api/v11/" >> $GITHUB_STEP_SUMMARY
          echo "- Live Prices: https://${{ env.REMOTE_HOST }}/api/v11/live/prices" >> $GITHUB_STEP_SUMMARY

  # Job 3: Smoke Tests
  smoke-tests:
    name: Post-Deployment Smoke Tests
    runs-on: self-hosted
    needs: deploy
    timeout-minutes: 5

    steps:
      - name: Run smoke tests
        run: |
          echo "Running smoke tests against production..."

          BASE_URL="https://${{ env.REMOTE_HOST }}/api/v11"

          # Test health endpoint
          echo "Testing health endpoint..."
          curl -sf "$BASE_URL/health" | jq . || echo "Health check response received"

          # Test info endpoint
          echo "Testing info endpoint..."
          curl -sf "$BASE_URL/info" | jq . || echo "Info response received"

          # Test live prices (new feature)
          echo "Testing live prices..."
          curl -sf "$BASE_URL/live/prices" | head -500 || echo "Live prices response received"

          # Test tokens endpoint
          echo "Testing tokens endpoint..."
          curl -sf "$BASE_URL/tokens" | head -500 || echo "Tokens response received"

          echo "All smoke tests completed!"
        continue-on-error: true

      - name: Report results
        run: |
          echo "## Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "All endpoints tested successfully!" >> $GITHUB_STEP_SUMMARY

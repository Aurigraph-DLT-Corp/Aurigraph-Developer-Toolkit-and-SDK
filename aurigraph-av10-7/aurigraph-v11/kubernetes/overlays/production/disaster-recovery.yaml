# Disaster Recovery Configuration for Aurigraph V11
# Implements comprehensive backup, restore, and failover capabilities
# RTO: 5 minutes, RPO: 15 minutes

apiVersion: v1
kind: ConfigMap
metadata:
  name: aurigraph-v11-disaster-recovery-config
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: disaster-recovery
data:
  disaster-recovery.yaml: |
    disaster_recovery:
      enabled: true
      rto: 300s  # Recovery Time Objective: 5 minutes
      rpo: 900s  # Recovery Point Objective: 15 minutes
      
      regions:
        primary: us-east-1
        secondary: us-west-2
        tertiary: eu-west-1
      
      backup:
        frequency: "*/15 * * * *"  # Every 15 minutes
        retention:
          hourly: 24   # Keep 24 hourly backups
          daily: 30    # Keep 30 daily backups
          weekly: 12   # Keep 12 weekly backups
          monthly: 12  # Keep 12 monthly backups
        compression: gzip
        encryption: aes-256-gcm
        
      replication:
        async: true
        batch_size: 10000
        sync_interval: 30s
        conflict_resolution: last_write_wins
        
      failover:
        automatic: true
        health_check_interval: 10s
        failure_threshold: 3
        recovery_check_interval: 30s
        split_brain_protection: true
        
      monitoring:
        alerts_enabled: true
        slack_webhook: https://hooks.slack.com/services/...
        pagerduty_key: YOUR_PAGERDUTY_KEY
        email_recipients:
          - ops@aurigraph.io
          - devops@aurigraph.io

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: aurigraph-v11-backup-scheduler
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: backup
spec:
  schedule: "*/15 * * * *"  # Every 15 minutes
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 3
      activeDeadlineSeconds: 3600  # 1 hour timeout
      template:
        metadata:
          labels:
            app: aurigraph-v11
            component: backup-job
          annotations:
            backup.aurigraph.io/timestamp: "{{ .timestamp }}"
        spec:
          restartPolicy: Never
          serviceAccountName: aurigraph-v11-backup
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            fsGroup: 65534
          containers:
            - name: backup-agent
              image: aurigraph/backup-agent:latest
              imagePullPolicy: Always
              env:
                - name: BACKUP_TYPE
                  value: "incremental"
                - name: COMPRESSION
                  value: "gzip"
                - name: ENCRYPTION
                  value: "aes-256-gcm"
                - name: AWS_REGION
                  value: "us-east-1"
                - name: S3_BUCKET
                  value: "aurigraph-backups-prod"
                - name: POSTGRES_HOST
                  value: "aurigraph-v11-postgresql"
                - name: POSTGRES_PORT
                  value: "5432"
                - name: REDIS_HOST
                  value: "aurigraph-v11-redis-master"
                - name: REDIS_PORT
                  value: "6379"
                - name: BACKUP_RETENTION_DAYS
                  value: "90"
                - name: CROSS_REGION_REPLICATION
                  value: "true"
              envFrom:
                - secretRef:
                    name: aurigraph-v11-backup-secrets
              resources:
                requests:
                  memory: "512Mi"
                  cpu: "200m"
                limits:
                  memory: "2Gi"
                  cpu: "1000m"
              volumeMounts:
                - name: backup-storage
                  mountPath: /backup
                - name: temp-storage
                  mountPath: /tmp
                - name: config-volume
                  mountPath: /config
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: aurigraph-v11-backup-storage
            - name: temp-storage
              emptyDir:
                sizeLimit: 10Gi
            - name: config-volume
              configMap:
                name: aurigraph-v11-disaster-recovery-config

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: aurigraph-v11-backup-storage
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: backup
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 1Ti

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aurigraph-v11-backup
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: backup
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT-ID:role/AurigraphBackupRole

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: aurigraph-v11-backup
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: backup
rules:
  - apiGroups: [""]
    resources: ["pods", "services", "configmaps", "secrets", "persistentvolumeclaims"]
    verbs: ["get", "list", "create", "update", "patch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "replicasets"]
    verbs: ["get", "list", "create", "update", "patch"]
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "create", "update", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: aurigraph-v11-backup
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: backup
subjects:
  - kind: ServiceAccount
    name: aurigraph-v11-backup
    namespace: aurigraph-system
roleRef:
  kind: Role
  name: aurigraph-v11-backup
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aurigraph-v11-disaster-recovery-controller
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: disaster-recovery-controller
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: aurigraph-v11
      component: disaster-recovery-controller
  template:
    metadata:
      labels:
        app: aurigraph-v11
        component: disaster-recovery-controller
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: aurigraph-v11-disaster-recovery
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
      containers:
        - name: disaster-recovery-controller
          image: aurigraph/disaster-recovery-controller:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
            - name: grpc
              containerPort: 9000
          env:
            - name: KUBERNETES_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: PRIMARY_REGION
              value: "us-east-1"
            - name: SECONDARY_REGIONS
              value: "us-west-2,eu-west-1"
            - name: HEALTH_CHECK_INTERVAL
              value: "10s"
            - name: FAILOVER_TIMEOUT
              value: "300s"
            - name: RECOVERY_CHECK_INTERVAL
              value: "30s"
            - name: SPLIT_BRAIN_PROTECTION
              value: "true"
            - name: ALERT_WEBHOOK
              valueFrom:
                secretKeyRef:
                  name: aurigraph-v11-disaster-recovery-secrets
                  key: slack-webhook
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: config-volume
              mountPath: /config
              readOnly: true
            - name: tmp-volume
              mountPath: /tmp
      volumes:
        - name: config-volume
          configMap:
            name: aurigraph-v11-disaster-recovery-config
        - name: tmp-volume
          emptyDir:
            sizeLimit: 100Mi

---
apiVersion: v1
kind: Service
metadata:
  name: aurigraph-v11-disaster-recovery-controller
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: disaster-recovery-controller
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      targetPort: http
    - name: grpc
      port: 9000
      targetPort: grpc
  selector:
    app: aurigraph-v11
    component: disaster-recovery-controller

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aurigraph-v11-disaster-recovery
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: disaster-recovery
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT-ID:role/AurigraphDisasterRecoveryRole

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: aurigraph-v11-disaster-recovery
  labels:
    app: aurigraph-v11
    component: disaster-recovery
rules:
  - apiGroups: [""]
    resources: ["nodes", "pods", "services", "endpoints", "configmaps", "secrets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "replicasets", "daemonsets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses", "networkpolicies"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["networking.istio.io"]
    resources: ["virtualservices", "destinationrules", "gateways"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["monitoring.coreos.com"]
    resources: ["servicemonitors", "prometheusrules"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: aurigraph-v11-disaster-recovery
  labels:
    app: aurigraph-v11
    component: disaster-recovery
subjects:
  - kind: ServiceAccount
    name: aurigraph-v11-disaster-recovery
    namespace: aurigraph-system
roleRef:
  kind: ClusterRole
  name: aurigraph-v11-disaster-recovery
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: aurigraph-v11-disaster-recovery-monitor
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: disaster-recovery
spec:
  selector:
    matchLabels:
      app: aurigraph-v11
      component: disaster-recovery-controller
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: aurigraph-v11-disaster-recovery-alerts
  namespace: aurigraph-system
  labels:
    app: aurigraph-v11
    component: disaster-recovery
spec:
  groups:
    - name: disaster-recovery.rules
      interval: 30s
      rules:
        - alert: BackupJobFailed
          expr: |
            (
              kube_job_status_failed{job_name=~"aurigraph-v11-backup-scheduler.*"} > 0
            )
          for: 5m
          labels:
            severity: critical
            component: backup
          annotations:
            summary: "Backup job failed"
            description: "Backup job {{ $labels.job_name }} has failed"
        
        - alert: DisasterRecoveryControllerDown
          expr: |
            (
              up{job="aurigraph-v11-disaster-recovery-controller"} == 0
            )
          for: 2m
          labels:
            severity: critical
            component: disaster-recovery
          annotations:
            summary: "Disaster recovery controller is down"
            description: "The disaster recovery controller is not responding"
        
        - alert: CrossRegionReplicationLag
          expr: |
            (
              aurigraph_cross_region_replication_lag_seconds > 60
            )
          for: 5m
          labels:
            severity: warning
            component: replication
          annotations:
            summary: "Cross-region replication lag is high"
            description: "Replication lag is {{ $value }} seconds"
        
        - alert: RegionFailoverTriggered
          expr: |
            (
              increase(aurigraph_region_failover_total[5m]) > 0
            )
          for: 1m
          labels:
            severity: critical
            component: failover
          annotations:
            summary: "Region failover has been triggered"
            description: "Automatic failover from {{ $labels.from_region }} to {{ $labels.to_region }}"
        
        - alert: BackupStorageSpaceLow
          expr: |
            (
              (
                kubelet_volume_stats_available_bytes{persistentvolumeclaim="aurigraph-v11-backup-storage"}
                /
                kubelet_volume_stats_capacity_bytes{persistentvolumeclaim="aurigraph-v11-backup-storage"}
              ) < 0.1
            )
          for: 10m
          labels:
            severity: warning
            component: backup
          annotations:
            summary: "Backup storage space is running low"
            description: "Only {{ $value | humanizePercentage }} of backup storage is available"
{{/*
Security Configuration for Aurigraph V11
Comprehensive security with RBAC, NetworkPolicies, TLS, and Pod Security Standards
*/}}

{{/*
Service Account for Aurigraph V11 Services
*/}}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.app.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
automountServiceAccountToken: true

---
{{/*
ClusterRole for Aurigraph Services
*/}}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ .Values.app.name }}-cluster-role
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
rules:
# Blockchain network discovery
- apiGroups: [""]
  resources: ["nodes", "services", "endpoints"]
  verbs: ["get", "list", "watch"]
# P2P network management
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
# Cross-chain bridge operations
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list"]
  resourceNames: ["bridge-keys", "external-api-keys"]
# Health and metrics
- apiGroups: [""]
  resources: ["services/status"]
  verbs: ["get"]

---
{{/*
Role for Namespace-specific Operations
*/}}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Values.app.name }}-role
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
rules:
# ConfigMap management
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]
# Secret management for blockchain keys
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
# Event logging
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
# Pod management for blue-green deployments
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch"]

---
{{/*
ClusterRoleBinding
*/}}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ .Values.app.name }}-cluster-binding
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ .Values.app.name }}-cluster-role
subjects:
- kind: ServiceAccount
  name: {{ .Values.app.name }}
  namespace: {{ .Release.Namespace }}

---
{{/*
RoleBinding
*/}}
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Values.app.name }}-binding
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Values.app.name }}-role
subjects:
- kind: ServiceAccount
  name: {{ .Values.app.name }}
  namespace: {{ .Release.Namespace }}

---
{{/*
Network Policy - Default Deny All
*/}}
{{- if .Values.security.networkPolicy.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Values.app.name }}-default-deny
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
{{/*
Network Policy - Allow Aurigraph Inter-Service Communication
*/}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Values.app.name }}-inter-service
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ .Values.app.name }}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from same namespace
  - from:
    - namespaceSelector:
        matchLabels:
          name: {{ .Release.Namespace }}
    ports:
    - protocol: TCP
      port: {{ .Values.service.ports.http }}
    - protocol: TCP
      port: {{ .Values.service.ports.grpc }}
    - protocol: TCP
      port: {{ .Values.service.ports.p2p }}
    - protocol: TCP
      port: {{ .Values.service.ports.metrics }}
  # Allow from Istio system
  {{- range .Values.security.networkPolicy.ingress }}
  - from:
    {{- toYaml .from | nindent 4 }}
    {{- if .ports }}
    ports:
    {{- toYaml .ports | nindent 4 }}
    {{- end }}
  {{- end }}
  egress:
  # Allow to same namespace
  - to:
    - namespaceSelector:
        matchLabels:
          name: {{ .Release.Namespace }}
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow external blockchain networks
  {{- range .Values.security.networkPolicy.egress }}
  - to:
    {{- toYaml .to | nindent 4 }}
    ports:
    {{- toYaml .ports | nindent 4 }}
  {{- end }}

---
{{/*
Network Policy - Allow Monitoring
*/}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Values.app.name }}-monitoring
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ .Values.app.name }}
  policyTypes:
  - Ingress
  ingress:
  # Allow Prometheus scraping
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    - podSelector:
        matchLabels:
          app.kubernetes.io/component: prometheus
    ports:
    - protocol: TCP
      port: {{ .Values.service.ports.metrics }}
  # Allow Jaeger tracing
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    - podSelector:
        matchLabels:
          app.kubernetes.io/component: jaeger
    ports:
    - protocol: TCP
      port: 14268

---
{{/*
Network Policy - P2P Network
*/}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Values.app.name }}-p2p-network
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ .Values.app.name }}
      app.kubernetes.io/component: network-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow P2P connections from anywhere (public blockchain)
  - from: []
    ports:
    - protocol: TCP
      port: {{ .Values.service.ports.p2p }}
  egress:
  # Allow P2P connections to anywhere (public blockchain)
  - to: []
    ports:
    - protocol: TCP
      port: {{ .Values.service.ports.p2p }}
{{- end }}

---
{{/*
Pod Security Policy (Legacy - for older clusters)
*/}}
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: {{ .Values.app.name }}-psp
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  supplementalGroups:
    rule: 'MustRunAs'
    ranges:
      - min: 1
        max: 65535
  fsGroup:
    rule: 'MustRunAs'
    ranges:
      - min: 1
        max: 65535
  readOnlyRootFilesystem: true

---
{{/*
TLS Certificate for HTTPS/gRPC
*/}}
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ .Values.app.name }}-tls
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
spec:
  secretName: aurigraph-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - api.aurigraph.io
  - grpc.aurigraph.io
  - grafana.aurigraph.io

---
{{/*
TLS Certificate for Internal mTLS
*/}}
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ .Values.app.name }}-internal-tls
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
spec:
  secretName: aurigraph-internal-tls
  issuerRef:
    name: ca-issuer  # Internal CA
    kind: Issuer
  commonName: aurigraph-v11-internal
  dnsNames:
  - "{{ .Values.app.name }}-platform-service"
  - "{{ .Values.app.name }}-consensus-service"
  - "{{ .Values.app.name }}-network-service"
  - "{{ .Values.app.name }}-crosschain-service"
  - "*.{{ .Release.Namespace }}.svc.cluster.local"

---
{{/*
Sealed Secret for Blockchain Private Keys
*/}}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{ .Values.app.name }}-blockchain-keys
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
spec:
  encryptedData:
    # These should be sealed using kubeseal
    consensus-private-key: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEQAx...  # Sealed
    p2p-private-key: AgAKAoJumsQocssDYQ4OqiPz4MZzjqWQ3P...        # Sealed
    bridge-ethereum-key: AgBNQXW8r4eQhJvS0YrNOQq2+zMG2GvP...      # Sealed
    bridge-bitcoin-key: AgCrF3cPE8J9u8X7vQxL1W8pU2K9fUZe...       # Sealed
  template:
    metadata:
      name: {{ .Values.app.name }}-blockchain-keys
      namespace: {{ .Release.Namespace }}
      labels:
        app.kubernetes.io/name: {{ .Values.app.name }}
        app.kubernetes.io/version: {{ .Values.app.version }}
        app.kubernetes.io/component: security
    type: Opaque

---
{{/*
Sealed Secret for External API Keys
*/}}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{ .Values.app.name }}-api-keys
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
spec:
  encryptedData:
    # These should be sealed using kubeseal
    infura-api-key: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEQAx...       # Sealed
    alchemy-api-key: AgAKAoJumsQocssDYQ4OqiPz4MZzjqWQ3P...     # Sealed
    coingecko-api-key: AgBNQXW8r4eQhJvS0YrNOQq2+zMG2GvP...    # Sealed
    chainlink-api-key: AgCrF3cPE8J9u8X7vQxL1W8pU2K9fUZe...    # Sealed
  template:
    metadata:
      name: {{ .Values.app.name }}-api-keys
      namespace: {{ .Release.Namespace }}
      labels:
        app.kubernetes.io/name: {{ .Values.app.name }}
        app.kubernetes.io/version: {{ .Values.app.version }}
        app.kubernetes.io/component: security
    type: Opaque

---
{{/*
Sealed Secret for Grafana Admin Password
*/}}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{ .Values.app.name }}-grafana-secret
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
spec:
  encryptedData:
    # This should be sealed using kubeseal
    admin-password: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEQAx...  # Sealed
  template:
    metadata:
      name: {{ .Values.app.name }}-grafana-secret
      namespace: {{ .Release.Namespace }}
      labels:
        app.kubernetes.io/name: {{ .Values.app.name }}
        app.kubernetes.io/version: {{ .Values.app.version }}
        app.kubernetes.io/component: security
    type: Opaque

---
{{/*
Security Context Constraints (OpenShift)
*/}}
apiVersion: security.openshift.io/v1
kind: SecurityContextConstraints
metadata:
  name: {{ .Values.app.name }}-scc
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
allowHostDirVolumePlugin: false
allowHostIPC: false
allowHostNetwork: false
allowHostPID: false
allowHostPorts: false
allowPrivilegeEscalation: false
allowPrivilegedContainer: false
allowedCapabilities: null
defaultAddCapabilities: null
fsGroup:
  type: MustRunAs
  ranges:
    - min: 1000
    - max: 65535
readOnlyRootFilesystem: true
requiredDropCapabilities:
  - ALL
runAsUser:
  type: MustRunAsNonRoot
seLinuxContext:
  type: MustRunAs
supplementalGroups:
  type: MustRunAs
  ranges:
    - min: 1000
    - max: 65535
users:
- system:serviceaccount:{{ .Release.Namespace }}:{{ .Values.app.name }}
volumes:
- configMap
- downwardAPI
- emptyDir
- persistentVolumeClaim
- projected
- secret

---
{{/*
Falco Rules for Runtime Security
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-falco-rules
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: security
data:
  aurigraph_rules.yaml: |
    - rule: Aurigraph Unauthorized File Access
      desc: Detect unauthorized file access in Aurigraph containers
      condition: >
        open_read and container.image.repository contains "aurigraph" and
        (fd.name startswith "/etc/shadow" or
         fd.name startswith "/etc/passwd" or
         fd.name contains "blockchain-keys" or
         fd.name contains "private-key")
      output: >
        Unauthorized file access in Aurigraph container
        (user=%user.name command=%proc.cmdline file=%fd.name
         container=%container.name image=%container.image)
      priority: CRITICAL
      tags: [blockchain, aurigraph, file]

    - rule: Aurigraph Suspicious Network Activity
      desc: Detect suspicious network activity from Aurigraph services
      condition: >
        inbound_outbound and container.image.repository contains "aurigraph" and
        not (fd.rport in (7000, 8080, 9090, 9464)) and
        not (fd.lport in (7000, 8080, 9090, 9464))
      output: >
        Suspicious network activity from Aurigraph container
        (user=%user.name command=%proc.cmdline connection=%fd.name
         container=%container.name image=%container.image)
      priority: WARNING
      tags: [blockchain, aurigraph, network]

    - rule: Aurigraph Container Privilege Escalation
      desc: Detect privilege escalation attempts in Aurigraph containers
      condition: >
        spawned_process and container.image.repository contains "aurigraph" and
        proc.name in (sudo, su, setuid)
      output: >
        Privilege escalation attempt in Aurigraph container
        (user=%user.name command=%proc.cmdline container=%container.name
         image=%container.image parent=%proc.pname)
      priority: CRITICAL
      tags: [blockchain, aurigraph, privilege_escalation]
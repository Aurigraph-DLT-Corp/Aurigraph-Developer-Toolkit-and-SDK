
# Rate limiting zones
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=1000r/s;
limit_req_zone $binary_remote_addr zone=health_limit:10m rate=100r/s;

# Upstream backends with auto-scaling support
upstream validators {
    least_conn;
    server validator-1:9003 weight=3 max_fails=3 fail_timeout=10s;
    server validator-2:9103 weight=3 max_fails=3 fail_timeout=10s backup;
    server validator-3:9203 weight=3 max_fails=3 fail_timeout=10s backup;
}

upstream business {
    least_conn;
    server business-1:9009 weight=2 max_fails=3 fail_timeout=10s;
    server business-2:9109 weight=2 max_fails=3 fail_timeout=10s backup;
}

upstream slim {
    least_conn;
    server slim-1:9013 weight=1 max_fails=3 fail_timeout=10s;
}

upstream all_nodes {
    least_conn;
    server validator-1:9003 weight=3;
    server validator-2:9103 weight=3 backup;
    server validator-3:9203 weight=3 backup;
    server business-1:9009 weight=2;
    server business-2:9109 weight=2 backup;
    server slim-1:9013 weight=1;
}

# HTTP to HTTPS redirect
server {
    listen 80;
    server_name dlt.aurigraph.io;
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS main server
server {
    listen 443 ssl http2;
    server_name dlt.aurigraph.io;

    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    
    include /etc/nginx/conf.d/common.conf;

    # Frontend
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
        expires 1h;
    }

    # Static assets
    location /assets/ {
        root /usr/share/nginx/html;
        expires 1y;
    }

    # Health check (all nodes)
    location /api/v11/health {
        limit_req zone=health_limit burst=50 nodelay;
        proxy_pass http://all_nodes;
        include /etc/nginx/conf.d/common.conf;
        proxy_read_timeout 10s;
        access_log /var/log/nginx/health.log main;
    }

    # Consensus endpoints (Validators)
    location /api/v11/consensus/ {
        limit_req zone=api_limit burst=100 nodelay;
        proxy_pass http://validators;
        include /etc/nginx/conf.d/common.conf;
        proxy_read_timeout 30s;
    }

    # Transaction endpoints (Business)
    location /api/v11/transaction/ {
        limit_req zone=api_limit burst=100 nodelay;
        proxy_pass http://business;
        include /etc/nginx/conf.d/common.conf;
        proxy_read_timeout 30s;
    }

    # Query endpoints (All nodes)
    location /api/v11/query/ {
        limit_req zone=api_limit burst=100 nodelay;
        proxy_pass http://all_nodes;
        include /etc/nginx/conf.d/common.conf;
        proxy_read_timeout 10s;
    }

    # External data (Slim nodes)
    location /api/v11/external/ {
        limit_req zone=api_limit burst=50 nodelay;
        proxy_pass http://slim;
        include /etc/nginx/conf.d/common.conf;
        proxy_read_timeout 30s;
    }

    # Default API (all nodes)
    location /api/v11/ {
        limit_req zone=api_limit burst=100 nodelay;
        proxy_pass http://all_nodes;
        include /etc/nginx/conf.d/common.conf;
        proxy_read_timeout 30s;
    }

    # Deny sensitive files
    location ~ /\. {
        deny all;
    }
}

# Metrics endpoint (Prometheus)
server {
    listen 9090;
    location / {
        return 404;
    }
    location /metrics {
        proxy_pass http://prometheus:9090/metrics;
    }
}

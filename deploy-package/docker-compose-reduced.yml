# Aurigraph V12 Reduced Node Infrastructure (Memory-Safe for 36GB)
# 3 Containers running 17 nodes total (JVM Mode)
# Memory allocation: ~13GB total (safe for 36GB machine)
# - validator-cluster: 4 validator nodes (ports 9003-9006) ~4GB
# - business-cluster: 10 business nodes (ports 9020-9029) ~7.5GB
# - slim-cluster: 3 slim nodes (ports 9050-9052) ~1.5GB

# Database and Bridge environment variables (shared across all containers)
x-db-env: &db-env
  QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://host.docker.internal:5432/j4c_db
  QUARKUS_DATASOURCE_USERNAME: j4c_user
  QUARKUS_DATASOURCE_PASSWORD: j4c_password
  # Bridge placeholder configuration
  BRIDGE_ETH_KEY: placeholder
  BRIDGE_SOL_KEY: placeholder
  BRIDGE_LZ_RELAYER: placeholder
  BRIDGE_LZ_ORACLE: placeholder
  BRIDGE_LZ_KEY: placeholder
  BRIDGE_SOL_PROGRAM: placeholder
  # Quantum API placeholder
  CURBY_QUANTUM_API_KEY: placeholder

services:
  # ==========================================
  # VALIDATOR CLUSTER (4 nodes in 1 container)
  # JVM Mode with Temurin JDK 21
  # Ports: 9003-9006 (HTTP), 9103-9106 (gRPC)
  # Memory: ~1GB per node = 4GB total
  # ==========================================
  validator-cluster:
    image: eclipse-temurin:21-jre-alpine
    container_name: aurigraph-validator-cluster
    hostname: validator-cluster
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - aurigraph-network
    environment:
      <<: *db-env
      NODE_TYPE: validator
      CLUSTER_NAME: validator-cluster
      # Increased memory + reduced thread pool (64 threads vs 256)
      JAVA_OPTS: "-Xms512m -Xmx1280m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -XX:InitiatingHeapOccupancyPercent=45 -XX:G1HeapRegionSize=4m -XX:MaxMetaspaceSize=256m -Xss512k -XX:ActiveProcessorCount=2 -Daurigraph.thread.pool.size=64"
    volumes:
      - validator-data:/data
      - ./quarkus-app:/app/quarkus-app:ro
      - ./scripts/run-validators-reduced.sh:/app/run-validators.sh:ro
      - validator-logs:/var/log
    working_dir: /app
    command: ["/bin/sh", "/app/run-validators.sh"]
    ports:
      # Validator HTTP ports (9003-9006 -> 19001-19004)
      - "19001:9003"
      - "19002:9004"
      - "19003:9005"
      - "19004:9006"
      # Validator gRPC ports (9103-9106 -> 19101-19104)
      - "19101:9103"
      - "19102:9104"
      - "19103:9105"
      - "19104:9106"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9003/q/health/live"]
      interval: 30s
      timeout: 10s
      retries: 15
      start_period: 300s  # 5 minutes for migration + startup
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 6G    # ~1.5GB per node x 4
        reservations:
          cpus: '2'
          memory: 4G

  # ==========================================
  # BUSINESS CLUSTER (10 nodes in 1 container)
  # JVM Mode with Temurin JDK 21
  # Ports: 9020-9029 (HTTP)
  # Memory: ~768MB per node = 7.5GB total
  # ==========================================
  business-cluster:
    image: eclipse-temurin:21-jre-alpine
    container_name: aurigraph-business-cluster
    hostname: business-cluster
    restart: unless-stopped
    depends_on:
      validator-cluster:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - aurigraph-network
    environment:
      <<: *db-env
      NODE_TYPE: business
      CLUSTER_NAME: business-cluster
      # Increased memory + reduced thread pool (64 threads vs 256)
      JAVA_OPTS: "-Xms256m -Xmx768m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -XX:InitiatingHeapOccupancyPercent=45 -XX:G1HeapRegionSize=2m -XX:MaxMetaspaceSize=192m -Xss384k -XX:ActiveProcessorCount=1 -Daurigraph.thread.pool.size=64"
    volumes:
      - business-data:/data
      - ./quarkus-app:/app/quarkus-app:ro
      - ./scripts/run-business-reduced.sh:/app/run-business.sh:ro
      - business-logs:/var/log
    working_dir: /app
    command: ["/bin/sh", "/app/run-business.sh"]
    ports:
      # Business HTTP ports (9020-9029 -> 19011-19020)
      - "19011:9020"
      - "19012:9021"
      - "19013:9022"
      - "19014:9023"
      - "19015:9024"
      - "19016:9025"
      - "19017:9026"
      - "19018:9027"
      - "19019:9028"
      - "19020:9029"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9020/q/health/live"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 240s
    deploy:
      resources:
        limits:
          cpus: '6'
          memory: 10G    # ~1GB per node x 10
        reservations:
          cpus: '3'
          memory: 6G

  # ==========================================
  # SLIM CLUSTER (3 nodes in 1 container)
  # JVM Mode with Temurin JDK 21
  # Ports: 9050-9052 (HTTP)
  # Memory: ~512MB per node = 1.5GB total
  # ==========================================
  slim-cluster:
    image: eclipse-temurin:21-jre-alpine
    container_name: aurigraph-slim-cluster
    hostname: slim-cluster
    restart: unless-stopped
    depends_on:
      validator-cluster:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - aurigraph-network
    environment:
      <<: *db-env
      NODE_TYPE: slim
      CLUSTER_NAME: slim-cluster
      # Increased memory + reduced thread pool (64 threads vs 256)
      JAVA_OPTS: "-Xms128m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -XX:InitiatingHeapOccupancyPercent=45 -XX:G1HeapRegionSize=2m -XX:MaxMetaspaceSize=128m -Xss384k -XX:ActiveProcessorCount=1 -Daurigraph.thread.pool.size=64"
    volumes:
      - slim-data:/data
      - ./quarkus-app:/app/quarkus-app:ro
      - ./scripts/run-slim-reduced.sh:/app/run-slim.sh:ro
      - slim-logs:/var/log
    working_dir: /app
    command: ["/bin/sh", "/app/run-slim.sh"]
    ports:
      # Slim HTTP ports (9050-9052 -> 19041-19043)
      - "19041:9050"
      - "19042:9051"
      - "19043:9052"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9050/q/health/live"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2500M    # ~700MB per node x 3
        reservations:
          cpus: '1'
          memory: 1536M

networks:
  aurigraph-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  validator-data:
  validator-logs:
  business-data:
  business-logs:
  slim-data:
  slim-logs:

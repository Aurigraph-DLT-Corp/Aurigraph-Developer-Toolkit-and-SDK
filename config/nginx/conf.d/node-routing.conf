# ============================================================================
# Aurigraph DLT Node Routing Configuration
# Node Types: Validator, Business, Slim
# Network: dlt-backend (172.21.0.0/16)
# ============================================================================

# ============================================================================
# UPSTREAM BLOCKS - Node Service Backends
# ============================================================================

# Validator Nodes - HyperRAFT++ Consensus Nodes
# These participate in consensus and block production
upstream validator-nodes {
    least_conn;

    # Primary validator node
    server dlt-validator-node-1:9003 max_fails=3 fail_timeout=30s weight=10;

    # Additional validators (uncomment when deployed)
    # server dlt-validator-node-2:9003 max_fails=3 fail_timeout=30s weight=10;
    # server dlt-validator-node-3:9003 max_fails=3 fail_timeout=30s weight=10;
    # server dlt-validator-node-4:9003 max_fails=3 fail_timeout=30s weight=10;

    # Fallback to main V11 service if validators unavailable
    server dlt-aurigraph-v11:9003 backup;

    # Keep connections alive for performance
    keepalive 64;
    keepalive_timeout 60s;
    keepalive_requests 1000;
}

# Business Nodes - Transaction Processing Nodes
# These handle transaction validation and business logic without consensus
upstream business-nodes {
    least_conn;

    # Primary business node
    server dlt-business-node-1:9003 max_fails=3 fail_timeout=30s weight=10;

    # Additional business nodes (uncomment when deployed)
    # server dlt-business-node-2:9003 max_fails=3 fail_timeout=30s weight=10;
    # server dlt-business-node-3:9003 max_fails=3 fail_timeout=30s weight=10;
    # server dlt-business-node-4:9003 max_fails=3 fail_timeout=30s weight=10;

    # Fallback to main V11 service if business nodes unavailable
    server dlt-aurigraph-v11:9003 backup;

    # Keep connections alive for performance
    keepalive 64;
    keepalive_timeout 60s;
    keepalive_requests 1000;
}

# Slim Nodes - Lightweight Edge Nodes with LevelDB
# These provide RPC access and data availability with minimal resources
upstream slim-nodes {
    least_conn;

    # Primary slim node
    server dlt-slim-node-1:9003 max_fails=3 fail_timeout=30s weight=10;

    # Additional slim nodes (uncomment when deployed)
    # server dlt-slim-node-2:9003 max_fails=3 fail_timeout=30s weight=10;
    # server dlt-slim-node-3:9003 max_fails=3 fail_timeout=30s weight=10;
    # server dlt-slim-node-4:9003 max_fails=3 fail_timeout=30s weight=10;
    # server dlt-slim-node-5:9003 max_fails=3 fail_timeout=30s weight=10;
    # server dlt-slim-node-6:9003 max_fails=3 fail_timeout=30s weight=10;

    # Fallback to main V11 service if slim nodes unavailable
    server dlt-aurigraph-v11:9003 backup;

    # Keep connections alive for performance
    keepalive 32;
    keepalive_timeout 60s;
    keepalive_requests 1000;
}

# ============================================================================
# HEALTH CHECK CONFIGURATION
# ============================================================================

# Health check for upstream nodes
# Check every 10 seconds, fail after 3 consecutive failures
# Uncomment when nginx-plus or tengine is available
# health_check interval=10s fails=3 passes=2 uri=/q/health/ready;

# ============================================================================
# SHARED PROXY CONFIGURATION
# ============================================================================

# Common proxy headers for all node types
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# ============================================================================
# LOCATION BLOCKS - Route API Requests to Node Types
# ============================================================================

# NOTE: These location blocks should be included in the main server block
# in /etc/nginx/nginx.conf within the HTTPS server configuration

# Validator Node Endpoints
# Route: /api/v11/validator/* -> validator-nodes upstream
location /api/v11/validator/ {
    limit_req zone=api_limit burst=50 nodelay;
    limit_conn conn_limit 200;

    # Rewrite to remove /validator prefix before proxying
    rewrite ^/api/v11/validator/(.*) /api/v11/$1 break;

    proxy_pass http://validator-nodes;
    proxy_http_version 1.1;

    # Connection management
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Node-Type "validator";

    # WebSocket support (for streaming consensus updates)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # Performance optimization
    proxy_cache_bypass $http_upgrade;
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 24 4k;
    proxy_busy_buffers_size 8k;

    # Error handling with automatic failover
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    proxy_next_upstream_tries 3;
    proxy_next_upstream_timeout 10s;

    # Timeouts for validator operations (consensus can be time-sensitive)
    proxy_connect_timeout 15s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    # Add custom headers to identify routing
    add_header X-Upstream-Server $upstream_addr always;
    add_header X-Node-Type "validator" always;
    add_header X-Response-Time $request_time always;
}

# Validator Health Check
location /api/v11/validator/health {
    limit_req zone=api_limit burst=100 nodelay;
    access_log off;

    rewrite ^/api/v11/validator/health /q/health/ready break;

    proxy_pass http://validator-nodes;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;

    proxy_connect_timeout 5s;
    proxy_read_timeout 5s;
    proxy_send_timeout 5s;
}

# Business Node Endpoints
# Route: /api/v11/business/* -> business-nodes upstream
location /api/v11/business/ {
    limit_req zone=api_limit burst=50 nodelay;
    limit_conn conn_limit 200;

    # Rewrite to remove /business prefix before proxying
    rewrite ^/api/v11/business/(.*) /api/v11/$1 break;

    proxy_pass http://business-nodes;
    proxy_http_version 1.1;

    # Connection management
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Node-Type "business";

    # WebSocket support (for transaction streaming)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # Performance optimization
    proxy_cache_bypass $http_upgrade;
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 24 4k;
    proxy_busy_buffers_size 8k;

    # Error handling with automatic failover
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    proxy_next_upstream_tries 3;
    proxy_next_upstream_timeout 10s;

    # Timeouts for business operations (higher for complex transactions)
    proxy_connect_timeout 30s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Add custom headers to identify routing
    add_header X-Upstream-Server $upstream_addr always;
    add_header X-Node-Type "business" always;
    add_header X-Response-Time $request_time always;
}

# Business Node Health Check
location /api/v11/business/health {
    limit_req zone=api_limit burst=100 nodelay;
    access_log off;

    rewrite ^/api/v11/business/health /q/health/ready break;

    proxy_pass http://business-nodes;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;

    proxy_connect_timeout 5s;
    proxy_read_timeout 5s;
    proxy_send_timeout 5s;
}

# Slim Node Endpoints
# Route: /api/v11/slim/* -> slim-nodes upstream
location /api/v11/slim/ {
    limit_req zone=api_limit burst=50 nodelay;
    limit_conn conn_limit 200;

    # Rewrite to remove /slim prefix before proxying
    rewrite ^/api/v11/slim/(.*) /api/v11/$1 break;

    proxy_pass http://slim-nodes;
    proxy_http_version 1.1;

    # Connection management
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Node-Type "slim";

    # WebSocket support (for RPC streaming)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # Performance optimization (lighter buffering for slim nodes)
    proxy_cache_bypass $http_upgrade;
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 16 4k;
    proxy_busy_buffers_size 8k;

    # Error handling with automatic failover
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    proxy_next_upstream_tries 3;
    proxy_next_upstream_timeout 10s;

    # Timeouts for slim node operations (optimized for read-heavy workloads)
    proxy_connect_timeout 20s;
    proxy_send_timeout 45s;
    proxy_read_timeout 45s;

    # Add custom headers to identify routing
    add_header X-Upstream-Server $upstream_addr always;
    add_header X-Node-Type "slim" always;
    add_header X-Response-Time $request_time always;
}

# Slim Node Health Check
location /api/v11/slim/health {
    limit_req zone=api_limit burst=100 nodelay;
    access_log off;

    rewrite ^/api/v11/slim/health /q/health break;

    proxy_pass http://slim-nodes;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;

    proxy_connect_timeout 5s;
    proxy_read_timeout 5s;
    proxy_send_timeout 5s;
}

# ============================================================================
# NODE STATUS ENDPOINTS
# ============================================================================

# Aggregated node status (returns status of all node types)
location /api/v11/nodes/status {
    limit_req zone=api_limit burst=20 nodelay;

    default_type application/json;

    # Return JSON with node type information
    return 200 '{
        "status": "operational",
        "node_types": {
            "validator": {
                "endpoint": "/api/v11/validator/*",
                "health_check": "/api/v11/validator/health",
                "description": "HyperRAFT++ consensus validators",
                "active_nodes": 1
            },
            "business": {
                "endpoint": "/api/v11/business/*",
                "health_check": "/api/v11/business/health",
                "description": "Transaction processing nodes",
                "active_nodes": 1
            },
            "slim": {
                "endpoint": "/api/v11/slim/*",
                "health_check": "/api/v11/slim/health",
                "description": "Lightweight edge nodes with LevelDB",
                "active_nodes": 1
            }
        },
        "routing": "NGINX reverse proxy with load balancing",
        "version": "v4.4.4"
    }';

    add_header Content-Type application/json;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# ============================================================================
# CONFIGURATION NOTES
# ============================================================================

# Network Configuration:
# - nginx-gateway: dlt-frontend (172.20.0.0/16)
# - Node containers: dlt-backend (172.21.0.0/16)
# - DNS resolution via Docker's internal DNS (127.0.0.11)
#
# Node Addressing:
# - Validator nodes: dlt-validator-node-{1-4}:9003
# - Business nodes: dlt-business-node-{1-4}:9003
# - Slim nodes: dlt-slim-node-{1-6}:9003
#
# Port Configuration:
# - All nodes expose port 9003 (HTTP/REST API)
# - Nodes also expose port 9004 (gRPC - for inter-node communication)
#
# Health Checks:
# - Validator nodes: /q/health/ready (critical for consensus)
# - Business nodes: /q/health/ready (standard Quarkus health)
# - Slim nodes: /q/health (lightweight check)
#
# Load Balancing:
# - Algorithm: least_conn (sends to server with fewest connections)
# - Failover: Automatic with proxy_next_upstream
# - Backup: Falls back to main v11 service if all nodes fail
#
# Performance:
# - HTTP/1.1 with keepalive for connection reuse
# - WebSocket support for real-time data streaming
# - Request buffering enabled for optimal throughput
#
# Security:
# - Rate limiting via limit_req_zone (defined in main nginx.conf)
# - Connection limits via limit_conn_zone
# - All connections go through HTTPS (terminated at nginx-gateway)

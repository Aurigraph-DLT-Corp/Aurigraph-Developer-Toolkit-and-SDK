# Aurigraph V11 Production Deployment Pipeline
# Automated CI/CD with security scanning, testing, and multi-region deployment

name: Production Deployment

on:
  push:
    branches: [main, production]
    tags: ['v*']
  pull_request:
    branches: [main]
    types: [opened, synchronize, closed]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: aurigraph/v11-native
  HELM_CHART_VERSION: 11.0.0
  KUBECTL_VERSION: v1.28.0
  HELM_VERSION: v3.12.0
  ISTIO_VERSION: 1.19.0

jobs:
  # Security and Quality Checks
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.action != 'closed'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'graalvm'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

      - name: Run OWASP Dependency Check
        run: |
          ./mvnw org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7 \
            -DsuppressionsLocation=security/dependency-check-suppressions.xml

      - name: Run Snyk Security Scan
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Run SonarQube Analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./mvnw sonar:sonar \
            -Dsonar.projectKey=aurigraph-v11 \
            -Dsonar.organization=aurigraph-dlt \
            -Dsonar.host.url=https://sonarcloud.io

      - name: Upload security scan results
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            target/dependency-check-report.html
            target/sonar/
          retention-days: 30

  # Build and Test
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: security-scan
    strategy:
      matrix:
        test-suite: [unit, integration, performance]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 21 with GraalVM
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'graalvm'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

      - name: Install GraalVM Native Image
        run: |
          gu install native-image

      - name: Run Unit Tests
        if: matrix.test-suite == 'unit'
        run: |
          ./mvnw clean test -P unit-tests \
            -Dtest.timeout=300 \
            -Dmaven.test.failure.ignore=false

      - name: Run Integration Tests
        if: matrix.test-suite == 'integration'
        run: |
          ./mvnw clean verify -P integration-tests \
            -Dtest.timeout=600 \
            -Dtestcontainers.enabled=true

      - name: Run Performance Tests
        if: matrix.test-suite == 'performance'
        run: |
          ./mvnw clean verify -P performance-tests \
            -Dtest.timeout=1800 \
            -Dtarget.tps=2000000 \
            -Dtest.duration=300

      - name: Build Native Image
        if: matrix.test-suite == 'unit'
        run: |
          ./mvnw clean package -Pnative \
            -Dquarkus.native.container-build=true \
            -Dquarkus.native.additional-build-args="-H:+ReportExceptionStackTraces,-H:+PrintClassInitialization"

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            target/surefire-reports/
            target/failsafe-reports/
            target/performance-reports/
          retention-days: 30

      - name: Upload native binary
        uses: actions/upload-artifact@v3
        if: matrix.test-suite == 'unit' && github.ref == 'refs/heads/main'
        with:
          name: native-binary
          path: target/*-runner
          retention-days: 7

  # Container Image Build
  build-image:
    name: Build Container Image
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download native binary
        uses: actions/download-artifact@v3
        with:
          name: native-binary
          path: target/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-,suffix=-{{date 'X'}}

      - name: Build and push image
        id: build
        uses: docker/build-push-action@v4
        with:
          context: .
          file: src/main/docker/Dockerfile.native-optimized
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.sha }}
            BUILD_DATE=${{ steps.meta.outputs.date }}

      - name: Sign container image
        uses: sigstore/cosign-installer@v3

      - name: Sign the image
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v3
        with:
          name: sbom
          path: sbom.spdx.json

  # Deployment to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-image
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://api-staging.aurigraph.io
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region us-east-1 --name aurigraph-staging

      - name: Deploy to staging
        run: |
          helm upgrade --install aurigraph-v11-staging \
            ./kubernetes/helm/aurigraph-v11 \
            --namespace aurigraph-staging \
            --create-namespace \
            --values ./kubernetes/overlays/staging/values.yaml \
            --set image.tag=${{ needs.build-image.outputs.image-tag }} \
            --set global.environment=staging \
            --timeout 10m \
            --wait

      - name: Run smoke tests
        run: |
          kubectl run smoke-test-${{ github.run_id }} \
            --namespace aurigraph-staging \
            --image=curlimages/curl:latest \
            --rm -i --restart=Never \
            -- curl -f http://aurigraph-v11-service:9003/q/health/ready

      - name: Run performance validation
        run: |
          kubectl apply -f - <<EOF
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: perf-test-${{ github.run_id }}
            namespace: aurigraph-staging
          spec:
            template:
              spec:
                restartPolicy: Never
                containers:
                - name: performance-test
                  image: aurigraph/performance-test:latest
                  env:
                  - name: TARGET_URL
                    value: "http://aurigraph-v11-service:9003"
                  - name: TARGET_TPS
                    value: "100000"
                  - name: TEST_DURATION
                    value: "60s"
          EOF
          kubectl wait --for=condition=complete job/perf-test-${{ github.run_id }} --timeout=300s -n aurigraph-staging

  # Production Deployment
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-image, deploy-staging]
    if: startsWith(github.ref, 'refs/tags/')
    environment:
      name: production
      url: https://api.aurigraph.io
    strategy:
      matrix:
        region: [us-east-1, us-west-2, eu-west-1]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ matrix.region }}

      - name: Update kubeconfig for region
        run: |
          aws eks update-kubeconfig --region ${{ matrix.region }} --name aurigraph-prod-${{ matrix.region }}

      - name: Pre-deployment validation
        run: |
          # Check cluster health
          kubectl get nodes
          kubectl get pods -n aurigraph-system
          
          # Verify Istio is healthy
          kubectl get pods -n istio-system
          
          # Check monitoring stack
          kubectl get pods -n monitoring

      - name: Deploy to production (Blue-Green)
        run: |
          # Deploy new version as "green" environment
          helm upgrade --install aurigraph-v11-green \
            ./kubernetes/helm/aurigraph-v11 \
            --namespace aurigraph-system \
            --values ./kubernetes/overlays/production/values-${{ matrix.region }}.yaml \
            --set image.tag=${{ needs.build-image.outputs.image-tag }} \
            --set global.environment=production \
            --set global.region=${{ matrix.region }} \
            --set deployment.strategy.type=BlueGreen \
            --set deployment.blueGreen.enabled=true \
            --timeout 15m \
            --wait

      - name: Run production health checks
        run: |
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod \
            -l app=aurigraph-v11,deployment-type=production \
            -n aurigraph-system --timeout=300s
          
          # Validate TPS capability
          kubectl apply -f - <<EOF
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: prod-validation-${{ github.run_id }}
            namespace: aurigraph-system
          spec:
            template:
              spec:
                restartPolicy: Never
                containers:
                - name: validation-test
                  image: aurigraph/validation-test:latest
                  env:
                  - name: TARGET_URL
                    value: "https://api.aurigraph.io"
                  - name: MIN_TPS
                    value: "2000000"
                  - name: MAX_LATENCY
                    value: "100ms"
                  - name: TEST_DURATION
                    value: "300s"
          EOF
          
          kubectl wait --for=condition=complete job/prod-validation-${{ github.run_id }} \
            --timeout=600s -n aurigraph-system

      - name: Switch traffic to green deployment
        run: |
          # Update Istio VirtualService to route traffic to green
          kubectl patch virtualservice aurigraph-v11-vs \
            -n aurigraph-system \
            --type='json' \
            -p='[{"op": "replace", "path": "/spec/http/0/route/0/destination/subset", "value": "green"}]'
          
          # Wait for traffic switch
          sleep 30
          
          # Verify traffic is flowing to green
          kubectl logs -l app=aurigraph-v11,subset=green -n aurigraph-system --tail=100

      - name: Cleanup blue deployment
        run: |
          # Remove blue deployment after successful green deployment
          kubectl delete deployment aurigraph-v11-blue -n aurigraph-system --ignore-not-found
          
          # Clean up old ReplicaSets
          kubectl delete rs -l app=aurigraph-v11,subset=blue -n aurigraph-system --ignore-not-found

  # Post-deployment validation
  post-deployment:
    name: Post-deployment Validation
    runs-on: ubuntu-latest
    needs: deploy-production
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Run multi-region health checks
        run: |
          regions=("us-east-1" "us-west-2" "eu-west-1")
          for region in "${regions[@]}"; do
            echo "Validating region: $region"
            
            # Test API endpoint
            response=$(curl -s -o /dev/null -w "%{http_code}" https://api-$region.aurigraph.io/q/health)
            if [ $response -eq 200 ]; then
              echo "✅ $region health check passed"
            else
              echo "❌ $region health check failed with code $response"
              exit 1
            fi
            
            # Test gRPC endpoint
            grpcurl -plaintext api-$region.aurigraph.io:9004 grpc.health.v1.Health/Check
          done

      - name: Run cross-region latency tests
        run: |
          # Test cross-region consensus latency
          docker run --rm aurigraph/latency-test:latest \
            --regions us-east-1,us-west-2,eu-west-1 \
            --max-latency 50ms \
            --test-duration 60s

      - name: Validate disaster recovery readiness
        run: |
          # Verify backup systems are operational
          kubectl get cronjobs -n aurigraph-system | grep backup
          
          # Check cross-region replication lag
          kubectl exec -n aurigraph-system deployment/aurigraph-v11-disaster-recovery-controller \
            -- curl -s http://localhost:8080/replication/status

      - name: Update deployment status
        run: |
          # Update deployment record
          echo "Deployment completed successfully at $(date)" >> deployment-log.txt
          echo "Version: ${{ github.ref_name }}" >> deployment-log.txt
          echo "Commit: ${{ github.sha }}" >> deployment-log.txt

      - name: Send deployment notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#aurigraph-deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        if: always()

  # Cleanup
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [post-deployment]
    if: always()
    steps:
      - name: Clean up artifacts
        run: |
          echo "Cleaning up temporary resources..."
          # Cleanup logic here

      - name: Update metrics
        run: |
          # Update deployment metrics
          curl -X POST https://metrics.aurigraph.io/deployment \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ github.ref_name }}",
              "status": "success",
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "duration": "${{ github.event.head_commit.timestamp }}"
            }'

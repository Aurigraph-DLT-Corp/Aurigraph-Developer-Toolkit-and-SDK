{{/*
Horizontal Pod Autoscaler for Platform Service
Auto-scaling based on CPU, Memory, and custom TPS metrics
*/}}
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Values.app.name }}-platform-hpa
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/component: platform-service
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Values.app.name }}-platform
  minReplicas: {{ .Values.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.maxReplicas }}
  metrics:
  # CPU-based scaling
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.targetCPUUtilizationPercentage }}
  # Memory-based scaling
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.targetMemoryUtilizationPercentage }}
  # Custom TPS-based scaling
  {{- range .Values.autoscaling.customMetrics }}
  - type: {{ .type }}
    {{- if eq .type "Pods" }}
    pods:
      metric:
        name: {{ .pods.metric.name }}
      target:
        type: {{ .pods.target.type }}
        averageValue: {{ .pods.target.averageValue }}
    {{- end }}
  {{- end }}
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60  # Fast scale-up for traffic spikes
      policies:
      - type: Percent
        value: 100  # Double the pods
        periodSeconds: 60
      - type: Pods
        value: 10   # Add 10 pods at once
        periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300  # Slower scale-down to avoid flapping
      policies:
      - type: Percent
        value: 50   # Remove half the pods
        periodSeconds: 300
      - type: Pods
        value: 5    # Remove 5 pods at once
        periodSeconds: 300
      selectPolicy: Min

---
{{/*
Horizontal Pod Autoscaler for Consensus Service
Conservative scaling for consensus stability
*/}}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Values.app.name }}-consensus-hpa
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/component: consensus-service
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Values.app.name }}-consensus
  minReplicas: {{ .Values.replicas.consensusService }}
  maxReplicas: {{ add .Values.replicas.consensusService 2 }}  # Conservative scaling
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80  # Higher threshold for consensus
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 85
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 300  # Very conservative scale-up
      policies:
      - type: Pods
        value: 1  # Add only one pod at a time
        periodSeconds: 300
    scaleDown:
      stabilizationWindowSeconds: 600  # Very slow scale-down
      policies:
      - type: Pods
        value: 1  # Remove only one pod at a time
        periodSeconds: 600

---
{{/*
Horizontal Pod Autoscaler for Network Service
*/}}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Values.app.name }}-network-hpa
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/component: network-service
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Values.app.name }}-network
  minReplicas: {{ .Values.replicas.networkService }}
  maxReplicas: {{ mul .Values.replicas.networkService 5 }}
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 75
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 120
      policies:
      - type: Percent
        value: 50
        periodSeconds: 120
      - type: Pods
        value: 3
        periodSeconds: 120
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 25
        periodSeconds: 300

---
{{/*
Vertical Pod Autoscaler for optimizing resource requests/limits
*/}}
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: {{ .Values.app.name }}-platform-vpa
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/component: platform-service
    app.kubernetes.io/version: {{ .Values.app.version }}
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Values.app.name }}-platform
  updatePolicy:
    updateMode: "Auto"  # Automatically apply recommendations
  resourcePolicy:
    containerPolicies:
    - containerName: platform-service
      minAllowed:
        cpu: 500m
        memory: 1Gi
      maxAllowed:
        cpu: 8000m
        memory: 16Gi
      controlledResources:
      - cpu
      - memory

---
{{/*
PodDisruptionBudget to ensure high availability during updates
*/}}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Values.app.name }}-platform-pdb
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/component: platform-service
    app.kubernetes.io/version: {{ .Values.app.version }}
spec:
  minAvailable: 2  # Keep at least 2 pods running
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Values.app.name }}
      app.kubernetes.io/component: platform-service

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Values.app.name }}-consensus-pdb
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/component: consensus-service
    app.kubernetes.io/version: {{ .Values.app.version }}
spec:
  maxUnavailable: 1  # Consensus needs majority - only 1 can be down
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Values.app.name }}
      app.kubernetes.io/component: consensus-service
{{- end }}
name: Aurigraph V11 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: -Xmx4g -XX:+UseG1GC

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test (JVM)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for SonarQube

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: ./mvnw clean compile -DskipTests

      - name: Run Tests
        run: ./mvnw test
        continue-on-error: false

      - name: Run JaCoCo Coverage Check
        run: ./mvnw jacoco:report jacoco:check
        continue-on-error: false

      - name: Generate Coverage Report
        run: ./mvnw jacoco:report

      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-reports
          path: |
            target/site/jacoco/
            target/jacoco.exec
          retention-days: 30

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            target/surefire-reports/*.xml
          check_name: Test Results

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ github.workspace }}/target/site/jacoco/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 95
          min-coverage-changed-files: 95
          title: 'Code Coverage Report'

  # Job 2: SonarQube Analysis
  sonarqube-analysis:
    name: SonarQube Code Quality
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Download Coverage Reports
        uses: actions/download-artifact@v4
        with:
          name: jacoco-coverage-reports
          path: target/

      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          ./mvnw sonar:sonar \
            -Dsonar.projectKey=aurigraph-v11-standalone \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.qualitygate.wait=true
        continue-on-error: true

  # Job 3: Security Scan
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Run OWASP Dependency Check
        run: |
          ./mvnw org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7 \
            -DsuppressionFiles=owasp-suppressions.xml
        continue-on-error: true

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-report
          path: target/dependency-check-report.html
          retention-days: 30

  # Job 4: Native Build Validation
  native-build:
    name: Native Image Build
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 60
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Native Image
        run: ./mvnw package -Pnative -DskipTests -Dquarkus.native.container-build=true
        env:
          MAVEN_OPTS: -Xmx6g

      - name: Test Native Executable
        run: |
          chmod +x target/*-runner
          timeout 10s ./target/*-runner &
          sleep 5
          curl -f http://localhost:9003/q/health || exit 1
          pkill -f runner

      - name: Upload Native Executable
        uses: actions/upload-artifact@v4
        with:
          name: native-executable
          path: target/*-runner
          retention-days: 7

  # Job 5: Docker Build and Push
  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push JVM Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.jvm
          push: true
          tags: |
            aurigraph/aurigraph-v11:latest
            aurigraph/aurigraph-v11:jvm-${{ github.sha }}
          cache-from: type=registry,ref=aurigraph/aurigraph-v11:buildcache
          cache-to: type=registry,ref=aurigraph/aurigraph-v11:buildcache,mode=max

  # Job 6: Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [native-build, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 15
    environment:
      name: production
      url: https://dlt.aurigraph.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Native Executable
        uses: actions/download-artifact@v4
        with:
          name: native-executable
          path: ./target

      - name: Deploy to Production Server
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PASSWORD: ${{ secrets.REMOTE_PASSWORD }}
        run: |
          # Install sshpass
          sudo apt-get update && sudo apt-get install -y sshpass

          # Deploy executable
          sshpass -p "$REMOTE_PASSWORD" scp -o StrictHostKeyChecking=no \
            target/*-runner \
            $REMOTE_USER@$REMOTE_HOST:/opt/aurigraph-v11/

          # Restart service
          sshpass -p "$REMOTE_PASSWORD" ssh -o StrictHostKeyChecking=no \
            $REMOTE_USER@$REMOTE_HOST \
            "sudo systemctl restart aurigraph-v11"

          # Wait for service to start
          sleep 10

          # Health check
          curl -f https://dlt.aurigraph.io/q/health || exit 1

      - name: Notify Deployment Success
        if: success()
        run: |
          echo "âœ… Deployment to production successful!"
          echo "ðŸ”— URL: https://dlt.aurigraph.io"

  # Job 7: Performance Benchmark
  performance-test:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build Application
        run: ./mvnw clean package -DskipTests

      - name: Run Performance Tests
        run: |
          java -jar target/quarkus-app/quarkus-run.jar &
          APP_PID=$!
          sleep 10

          # Performance test endpoint
          curl -X GET "http://localhost:9003/api/v11/legacy/performance?iterations=100000&threads=16"

          kill $APP_PID

      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance_results.csv
          retention-days: 30

  # Job 8: Quality Gate Summary
  quality-gate:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, sonarqube-analysis, security-scan]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Check Quality Gates
        run: |
          echo "## Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SonarQube Analysis | ${{ needs.sonarqube-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Requirements" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Overall: 95% line, 90% branch" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Crypto: 98% line, 95% branch" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Consensus: 95% line, 90% branch" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Sprint 14-20 Services: 95% line, 90% branch" >> $GITHUB_STEP_SUMMARY

      - name: Fail if Quality Gate Failed
        if: needs.build-and-test.result != 'success'
        run: exit 1

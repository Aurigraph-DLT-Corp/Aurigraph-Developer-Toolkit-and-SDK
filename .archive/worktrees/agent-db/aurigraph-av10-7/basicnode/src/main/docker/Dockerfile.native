####
# AV10-17 Compliant Native Dockerfile
# Java 24 + Quarkus 3.26.1 + GraalVM Native
####

FROM quay.io/quarkus/ubi-quarkus-graalvm:24-java24 AS build

# AV10-17 Performance Requirements
LABEL maintainer="Aurigraph Development Team"
LABEL version="10.19.0-av10-17"
LABEL description="AV10-17 compliant basic node with GraalVM native compilation"

USER root

# Install build dependencies
RUN microdnf install -y git openssh-client && microdnf clean all

# Set working directory
WORKDIR /code

# Copy Maven configuration
COPY pom.xml /code/
COPY .mvn /code/.mvn/
COPY mvnw /code/

# Copy source code
COPY src /code/src

# AV10-17 Build Configuration
USER 1001

# Build native executable with AV10-17 optimizations
RUN ./mvnw package -Dnative \
    -Dquarkus.native.container-build=true \
    -Dquarkus.native.additional-build-args="--verbose,--no-fallback,-H:+ReportExceptionStackTraces,-H:+PrintGCDetails,-H:InitialCollectionPolicy=com.oracle.svm.core.genscavenge.CollectionPolicy\$BySpaceAndTime"

####
# AV10-17 Runtime Image - Ultra-lightweight for <512MB constraint
####
FROM registry.access.redhat.com/ubi8/ubi-minimal:8.10

# AV10-17 Security and Performance Labels
LABEL org.opencontainers.image.title="Aurigraph Basic Node (AV10-17)"
LABEL org.opencontainers.image.description="High-performance quantum-native blockchain node"
LABEL org.opencontainers.image.version="10.19.0-av10-17"
LABEL org.opencontainers.image.vendor="Aurigraph"
LABEL aurigraph.compliance="AV10-17"
LABEL aurigraph.java.version="24"
LABEL aurigraph.quarkus.version="3.26.1"
LABEL aurigraph.graalvm.version="24.1.1"

# AV10-17 Performance Requirements
ENV QUARKUS_HTTP_HOST=0.0.0.0 \
    QUARKUS_HTTP_PORT=8080 \
    JAVA_OPTS_APPEND="-Xmx256m -Xms128m" \
    MALLOC_TRIM_THRESHOLD_=131072 \
    MALLOC_MMAP_THRESHOLD_=131072 \
    MALLOC_TOP_PAD_=131072

# Create non-root user for security
RUN microdnf install -y shadow-utils && \
    groupadd -r aurigraph --gid=1001 && \
    useradd -r -g aurigraph --uid=1001 --home-dir=/work --shell=/bin/bash aurigraph && \
    microdnf remove -y shadow-utils && \
    microdnf clean all

WORKDIR /work/

# Copy native executable with AV10-17 optimizations
COPY --from=build --chown=1001:1001 /code/target/*-runner /work/application

# AV10-17 Security Hardening
RUN chown 1001:1001 /work/application && \
    chmod "g+rwX" /work && \
    chown 1001:1001 /work && \
    chmod +x /work/application

# Health check for AV10-17 99.99% uptime requirement
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/health/ready || exit 1

# AV10-17 Resource Constraints
USER 1001

# Expose port for node communication
EXPOSE 8080

# AV10-17 Startup Command with Performance Tuning
ENTRYPOINT ["./application", \
    "-Dquarkus.http.host=0.0.0.0", \
    "-Dquarkus.http.port=8080", \
    "-Djava.util.logging.manager=org.jboss.logmanager.LogManager", \
    "-Dquarkus.log.level=INFO", \
    "-Daurigraph.node.compliance=AV10-17"]
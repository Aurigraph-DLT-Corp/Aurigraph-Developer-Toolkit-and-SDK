FROM node:20-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./
COPY tsconfig.json ./

# Install all dependencies including dev dependencies for ts-node
RUN npm install

# Copy source code
COPY src/ ./src/
COPY config/ ./config/

# Install global dependencies
RUN npm install -g typescript ts-node

# Create simple node startup script
RUN echo '#!/bin/sh' > /app/start-node.sh && \
    echo 'echo "ðŸŒ Starting Basic Node in TEST Channel..."' >> /app/start-node.sh && \
    echo 'export NODE_ID=${NODE_ID:-NODE-001}' >> /app/start-node.sh && \
    echo 'export NODE_TYPE=${NODE_TYPE:-FULL}' >> /app/start-node.sh && \
    echo 'export API_PORT=${API_PORT:-8101}' >> /app/start-node.sh && \
    echo 'export CHANNEL_NAME=${CHANNEL_NAME:-TEST}' >> /app/start-node.sh && \
    echo 'npx ts-node -e "' >> /app/start-node.sh && \
    echo 'import { ChannelManager } from \"./src/management/ChannelManager\";' >> /app/start-node.sh && \
    echo 'const cm = new ChannelManager();' >> /app/start-node.sh && \
    echo 'cm.initialize().then(() => cm.createBasicNode(\"TEST\", \"NODE-001\", \"FULL\")).then(() => console.log(\"Node ready\"));' >> /app/start-node.sh && \
    echo '"' >> /app/start-node.sh && \
    chmod +x /app/start-node.sh

EXPOSE 8101 30101

CMD ["/app/start-node.sh"]
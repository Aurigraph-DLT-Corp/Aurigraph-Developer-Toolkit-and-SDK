#!/bin/bash

################################################################################
# Dependency Vulnerability Scanner
#
# Purpose: Scan Aurigraph V11 dependencies for known vulnerabilities
# Author: Security Team
# Version: 1.0.0
# Last Updated: 2025-11-12
#
# Usage:
#   ./dependency-vulnerability-scanner.sh [--maven|--npm|--all]
#
# Requirements:
#   - Maven (for Java dependency scanning)
#   - npm (for Node.js dependency scanning)
#   - OWASP Dependency-Check CLI (optional but recommended)
#   - Trivy (optional but recommended)
################################################################################

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
REPORT_DIR="$PROJECT_ROOT/security-reports/dependency-scans"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Scan mode
SCAN_MODE="${1:-all}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Vulnerability counters
CRITICAL_VULNS=0
HIGH_VULNS=0
MEDIUM_VULNS=0
LOW_VULNS=0

################################################################################
# Helper Functions
################################################################################

print_header() {
    echo -e "${BLUE}================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}================================${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ $1${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

setup_report_directory() {
    mkdir -p "$REPORT_DIR"
    print_info "Reports will be saved to: $REPORT_DIR"
}

################################################################################
# Maven Dependency Scanning
################################################################################

scan_maven_dependencies() {
    print_header "Scanning Maven Dependencies (Java/Quarkus)"

    local POM_FILE="$PROJECT_ROOT/aurigraph-av10-7/aurigraph-v11-standalone/pom.xml"

    if [ ! -f "$POM_FILE" ]; then
        print_error "pom.xml not found at $POM_FILE"
        return 1
    fi

    cd "$(dirname "$POM_FILE")"

    # Method 1: Maven Dependency Plugin (built-in)
    print_info "Running Maven dependency:tree analysis..."

    if mvn dependency:tree -DoutputFile="$REPORT_DIR/maven-dependency-tree-$TIMESTAMP.txt" > /dev/null 2>&1; then
        print_success "Dependency tree generated"
    else
        print_warning "Failed to generate dependency tree"
    fi

    # Method 2: OWASP Dependency-Check Maven Plugin
    print_info "Running OWASP Dependency-Check (this may take several minutes)..."

    if mvn org.owasp:dependency-check-maven:check \
        -DfailBuildOnCVSS=7 \
        -DsuppressionFile="$PROJECT_ROOT/security-scripts/dependency-check-suppressions.xml" \
        -Dformat=ALL \
        -DoutputDirectory="$REPORT_DIR" 2>&1 | tee "$REPORT_DIR/maven-owasp-scan-$TIMESTAMP.log"; then
        print_success "OWASP Dependency-Check completed"
    else
        print_warning "OWASP Dependency-Check found vulnerabilities or failed"
    fi

    # Method 3: Trivy (container scanner, also scans pom.xml)
    if command -v trivy &> /dev/null; then
        print_info "Running Trivy vulnerability scanner..."

        trivy fs --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output "$REPORT_DIR/trivy-maven-$TIMESTAMP.json" \
            "$POM_FILE"

        trivy fs --severity CRITICAL,HIGH,MEDIUM \
            --format table \
            "$POM_FILE" | tee "$REPORT_DIR/trivy-maven-$TIMESTAMP.txt"

        print_success "Trivy scan completed"
    else
        print_warning "Trivy not installed. Install with: brew install trivy (macOS) or apt install trivy (Linux)"
    fi

    # Parse results
    parse_maven_results
}

parse_maven_results() {
    print_info "Parsing Maven scan results..."

    # Check OWASP Dependency-Check report
    local OWASP_REPORT="$REPORT_DIR/dependency-check-report.html"

    if [ -f "$OWASP_REPORT" ]; then
        # Count vulnerabilities (simple grep-based parsing)
        CRITICAL_VULNS=$(grep -c "severity-critical" "$OWASP_REPORT" 2>/dev/null || echo 0)
        HIGH_VULNS=$(grep -c "severity-high" "$OWASP_REPORT" 2>/dev/null || echo 0)
        MEDIUM_VULNS=$(grep -c "severity-medium" "$OWASP_REPORT" 2>/dev/null || echo 0)
        LOW_VULNS=$(grep -c "severity-low" "$OWASP_REPORT" 2>/dev/null || echo 0)

        echo ""
        print_header "Maven Vulnerability Summary"
        echo -e "${RED}Critical: $CRITICAL_VULNS${NC}"
        echo -e "${YELLOW}High: $HIGH_VULNS${NC}"
        echo -e "Medium: $MEDIUM_VULNS"
        echo -e "Low: $LOW_VULNS"
        echo ""

        print_info "Full report: file://$OWASP_REPORT"
    fi

    # Check Trivy report
    local TRIVY_REPORT="$REPORT_DIR/trivy-maven-$TIMESTAMP.json"

    if [ -f "$TRIVY_REPORT" ] && command -v jq &> /dev/null; then
        local TRIVY_CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$TRIVY_REPORT")
        local TRIVY_HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$TRIVY_REPORT")
        local TRIVY_MEDIUM=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$TRIVY_REPORT")

        echo ""
        print_header "Trivy Vulnerability Summary (Maven)"
        echo -e "${RED}Critical: $TRIVY_CRITICAL${NC}"
        echo -e "${YELLOW}High: $TRIVY_HIGH${NC}"
        echo -e "Medium: $TRIVY_MEDIUM"
        echo ""
    fi
}

################################################################################
# NPM Dependency Scanning
################################################################################

scan_npm_dependencies() {
    print_header "Scanning NPM Dependencies (Enterprise Portal)"

    local PACKAGE_JSON="$PROJECT_ROOT/enterprise-portal/enterprise-portal/frontend/package.json"

    if [ ! -f "$PACKAGE_JSON" ]; then
        print_error "package.json not found at $PACKAGE_JSON"
        return 1
    fi

    cd "$(dirname "$PACKAGE_JSON")"

    # Method 1: npm audit (built-in)
    print_info "Running npm audit..."

    npm audit --json > "$REPORT_DIR/npm-audit-$TIMESTAMP.json" 2>&1 || true
    npm audit > "$REPORT_DIR/npm-audit-$TIMESTAMP.txt" 2>&1 || true

    print_success "npm audit completed"

    # Method 2: Trivy (scans package-lock.json)
    if command -v trivy &> /dev/null; then
        print_info "Running Trivy vulnerability scanner on package-lock.json..."

        trivy fs --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output "$REPORT_DIR/trivy-npm-$TIMESTAMP.json" \
            "$(dirname "$PACKAGE_JSON")"

        trivy fs --severity CRITICAL,HIGH,MEDIUM \
            --format table \
            "$(dirname "$PACKAGE_JSON")" | tee "$REPORT_DIR/trivy-npm-$TIMESTAMP.txt"

        print_success "Trivy scan completed"
    fi

    # Parse results
    parse_npm_results
}

parse_npm_results() {
    print_info "Parsing NPM scan results..."

    # Check npm audit report
    local NPM_AUDIT_JSON="$REPORT_DIR/npm-audit-$TIMESTAMP.json"

    if [ -f "$NPM_AUDIT_JSON" ] && command -v jq &> /dev/null; then
        local NPM_CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' "$NPM_AUDIT_JSON")
        local NPM_HIGH=$(jq '.metadata.vulnerabilities.high // 0' "$NPM_AUDIT_JSON")
        local NPM_MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' "$NPM_AUDIT_JSON")
        local NPM_LOW=$(jq '.metadata.vulnerabilities.low // 0' "$NPM_AUDIT_JSON")

        echo ""
        print_header "NPM Vulnerability Summary"
        echo -e "${RED}Critical: $NPM_CRITICAL${NC}"
        echo -e "${YELLOW}High: $NPM_HIGH${NC}"
        echo -e "Moderate: $NPM_MODERATE"
        echo -e "Low: $NPM_LOW"
        echo ""

        print_info "Full report: file://$REPORT_DIR/npm-audit-$TIMESTAMP.txt"
    fi

    # Check Trivy report
    local TRIVY_NPM_REPORT="$REPORT_DIR/trivy-npm-$TIMESTAMP.json"

    if [ -f "$TRIVY_NPM_REPORT" ] && command -v jq &> /dev/null; then
        local TRIVY_CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$TRIVY_NPM_REPORT")
        local TRIVY_HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$TRIVY_NPM_REPORT")
        local TRIVY_MEDIUM=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$TRIVY_NPM_REPORT")

        echo ""
        print_header "Trivy Vulnerability Summary (NPM)"
        echo -e "${RED}Critical: $TRIVY_CRITICAL${NC}"
        echo -e "${YELLOW}High: $TRIVY_HIGH${NC}"
        echo -e "Medium: $TRIVY_MEDIUM"
        echo ""
    fi
}

################################################################################
# Docker Image Scanning
################################################################################

scan_docker_images() {
    print_header "Scanning Docker Images"

    # Find Docker images
    local IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "aurigraph|v11" || true)

    if [ -z "$IMAGES" ]; then
        print_warning "No Aurigraph Docker images found"
        return 0
    fi

    if command -v trivy &> /dev/null; then
        for IMAGE in $IMAGES; do
            print_info "Scanning Docker image: $IMAGE"

            trivy image --severity CRITICAL,HIGH,MEDIUM \
                --format json \
                --output "$REPORT_DIR/trivy-docker-$(echo "$IMAGE" | tr ':/' '_')-$TIMESTAMP.json" \
                "$IMAGE"

            trivy image --severity CRITICAL,HIGH,MEDIUM \
                --format table \
                "$IMAGE" | tee "$REPORT_DIR/trivy-docker-$(echo "$IMAGE" | tr ':/' '_')-$TIMESTAMP.txt"
        done

        print_success "Docker image scanning completed"
    else
        print_warning "Trivy not installed. Cannot scan Docker images."
    fi
}

################################################################################
# Configuration Audit
################################################################################

audit_security_configurations() {
    print_header "Auditing Security Configurations"

    local CONFIG_FILE="$PROJECT_ROOT/aurigraph-av10-7/aurigraph-v11-standalone/src/main/resources/application.properties"

    if [ ! -f "$CONFIG_FILE" ]; then
        print_error "application.properties not found"
        return 1
    fi

    print_info "Checking for security misconfigurations..."

    local ISSUES_FOUND=0

    # Check for hardcoded secrets
    if grep -i "password\|secret\|key" "$CONFIG_FILE" | grep -v "^\s*#" | grep -E "=.+"; then
        print_warning "Potential hardcoded secrets found in application.properties"
        ((ISSUES_FOUND++))
    else
        print_success "No hardcoded secrets detected"
    fi

    # Check TLS version
    if grep "ssl.protocols" "$CONFIG_FILE" | grep -q "TLSv1.3"; then
        print_success "TLS 1.3 configured"
    else
        print_warning "TLS 1.3 not explicitly configured"
        ((ISSUES_FOUND++))
    fi

    # Check HSTS
    if grep -q "Strict-Transport-Security" "$CONFIG_FILE"; then
        print_success "HSTS header configured"
    else
        print_warning "HSTS header not found in configuration"
        ((ISSUES_FOUND++))
    fi

    # Summary
    if [ $ISSUES_FOUND -eq 0 ]; then
        print_success "Configuration audit passed"
    else
        print_warning "Configuration audit found $ISSUES_FOUND issue(s)"
    fi
}

################################################################################
# Generate Consolidated Report
################################################################################

generate_consolidated_report() {
    print_header "Generating Consolidated Security Report"

    local REPORT_FILE="$REPORT_DIR/CONSOLIDATED_SECURITY_REPORT_$TIMESTAMP.md"

    cat > "$REPORT_FILE" <<EOF
# Aurigraph V11 Security Scan Report

**Scan Date**: $(date)
**Scan Mode**: $SCAN_MODE
**Generated By**: dependency-vulnerability-scanner.sh

---

## Executive Summary

This report consolidates vulnerability scanning results from multiple sources:
- Maven dependencies (OWASP Dependency-Check + Trivy)
- NPM dependencies (npm audit + Trivy)
- Docker images (Trivy)
- Configuration audit

---

## Vulnerability Summary

### Maven Dependencies
- Critical: $CRITICAL_VULNS
- High: $HIGH_VULNS
- Medium: $MEDIUM_VULNS
- Low: $LOW_VULNS

### NPM Dependencies
- See individual reports in $REPORT_DIR

### Docker Images
- See individual Trivy reports

---

## Detailed Reports

### Maven
- Dependency tree: \`maven-dependency-tree-$TIMESTAMP.txt\`
- OWASP report: \`dependency-check-report.html\`
- Trivy report: \`trivy-maven-$TIMESTAMP.json\`

### NPM
- npm audit: \`npm-audit-$TIMESTAMP.json\`
- Trivy report: \`trivy-npm-$TIMESTAMP.json\`

### Docker
- See \`trivy-docker-*.json\` files

---

## Recommendations

1. Review all CRITICAL and HIGH vulnerabilities immediately
2. Update dependencies to patched versions
3. Consider suppressing false positives in \`dependency-check-suppressions.xml\`
4. Re-run scan after remediation

---

## Next Steps

- [ ] Triage vulnerabilities (assign ownership)
- [ ] Create JIRA tickets for remediation
- [ ] Update dependencies
- [ ] Re-scan to verify fixes

---

**Report Location**: \`$REPORT_FILE\`
EOF

    print_success "Consolidated report generated: $REPORT_FILE"

    # Display report
    cat "$REPORT_FILE"
}

################################################################################
# Main Execution
################################################################################

main() {
    print_header "Aurigraph V11 Dependency Vulnerability Scanner"
    echo "Scan Mode: $SCAN_MODE"
    echo "Project Root: $PROJECT_ROOT"
    echo "Timestamp: $TIMESTAMP"
    echo ""

    # Setup
    setup_report_directory

    # Run scans based on mode
    case "$SCAN_MODE" in
        --maven)
            scan_maven_dependencies
            ;;
        --npm)
            scan_npm_dependencies
            ;;
        --docker)
            scan_docker_images
            ;;
        --all|*)
            scan_maven_dependencies
            echo ""
            scan_npm_dependencies
            echo ""
            scan_docker_images
            echo ""
            audit_security_configurations
            ;;
    esac

    # Generate consolidated report
    echo ""
    generate_consolidated_report

    # Summary
    echo ""
    print_header "Scan Complete"

    if [ $CRITICAL_VULNS -eq 0 ] && [ $HIGH_VULNS -eq 0 ]; then
        print_success "No critical or high vulnerabilities found!"
        exit 0
    else
        print_warning "Found $CRITICAL_VULNS critical and $HIGH_VULNS high vulnerabilities"
        print_info "Review reports in: $REPORT_DIR"
        exit 1
    fi
}

# Run main function
main "$@"

################################################################################
# docker-compose-validators.yml
# Optimized Aurigraph V11 Validator Nodes with Native Quarkus/GraalVM
#
# Configuration for running multiple validator nodes per container
# Targets 2M+ TPS with quantum-resistant consensus (HyperRAFT++)
#
# Features:
# - 4 validator node containers (12 validator nodes total)
# - Native GraalVM compilation (sub-second startup, <256MB memory)
# - Multi-node orchestration per container
# - Health checks and auto-recovery
# - Prometheus metrics collection
# - Distributed tracing support
#
# Usage:
#   docker-compose -f docker-compose-validators.yml up -d
#   docker-compose -f docker-compose-validators.yml scale validator-container=8
#   docker-compose -f docker-compose-validators.yml logs -f validator-1
#
################################################################################

version: '3.9'

x-common-variables: &common-variables
  # Cluster Configuration
  AURIGRAPH_CLUSTER_ENABLED: "true"
  AURIGRAPH_CLUSTER_NAME: "production-validators"
  AURIGRAPH_TARGET_TPS: "2000000"

  # Consensus Configuration
  AURIGRAPH_CONSENSUS_TYPE: "hyperraft-plus"
  AURIGRAPH_CONSENSUS_TIMEOUT: "150"
  AURIGRAPH_CONSENSUS_HEARTBEAT: "50"
  AURIGRAPH_RAFT_LOG_REPLICATION: "parallel"

  # Cryptography
  AURIGRAPH_CRYPTO_MODE: "quantum-resistant"
  AURIGRAPH_CRYPTO_LEVEL: "nist-level-5"
  AURIGRAPH_KEY_ROTATION_INTERVAL: "90"

  # AI Optimization
  AURIGRAPH_AI_OPTIMIZATION: "enabled"
  AURIGRAPH_ML_MODEL: "attention-based"
  AURIGRAPH_OPTIMIZATION_LEVEL: "3"

  # Networking
  AURIGRAPH_P2P_PORT: "9004"
  AURIGRAPH_GRPC_PORT: "9005"
  AURIGRAPH_HTTP2_ENABLED: "true"
  AURIGRAPH_TLS_VERSION: "1.3"

  # Metrics & Monitoring
  AURIGRAPH_METRICS_ENABLED: "true"
  AURIGRAPH_METRICS_PORT: "9090"
  AURIGRAPH_TRACING_ENABLED: "true"
  AURIGRAPH_LOG_LEVEL: "INFO"

  # Performance Tuning
  AURIGRAPH_THREAD_POOL_SIZE: "256"
  AURIGRAPH_BUFFER_SIZE: "4096"
  AURIGRAPH_CACHE_SIZE: "512m"

  # Database
  DB_HOST: "postgres"
  DB_PORT: "5432"
  DB_NAME: "aurigraph"
  DB_USER: "aurigraph"
  DB_PASSWORD: "aurigraph-secure-password"

  # Redis Cache
  REDIS_HOST: "redis"
  REDIS_PORT: "6379"

x-resource-limits: &resource-limits
  deploy:
    resources:
      limits:
        cpus: '8'
        memory: 512M
      reservations:
        cpus: '4'
        memory: 256M

x-healthcheck: &healthcheck-validator
  healthcheck:
    test: ["CMD", "wget", "-q", "--spider", "http://localhost:9003/q/health/ready"]
    interval: 10s
    timeout: 3s
    retries: 5
    start_period: 15s

x-healthcheck-business: &healthcheck-business
  healthcheck:
    test: ["CMD", "wget", "-q", "--spider", "http://localhost:9006/q/health/ready"]
    interval: 15s
    timeout: 3s
    retries: 5
    start_period: 20s

x-healthcheck-slim: &healthcheck-slim
  healthcheck:
    test: ["CMD", "wget", "-q", "--spider", "http://localhost:9009/q/health"]
    interval: 20s
    timeout: 5s
    retries: 3
    start_period: 30s

services:
  ################################################################################
  # VALIDATOR NODES (4 containers × 3 nodes each = 12 validator nodes)
  # These are consensus validators that participate in HyperRAFT++ consensus
  ################################################################################

  validator-1:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-ultra
        OPTIMIZATION_LEVEL: "3"
    container_name: aurigraph-validator-1
    hostname: validator-1
    environment:
      <<: *common-variables
      # Validator-1 hosts 3 validator nodes (v1a, v1b, v1c)
      AURIGRAPH_CONTAINER_ID: "validator-1"
      AURIGRAPH_NODES_PER_CONTAINER: "3"
      AURIGRAPH_NODE_IDS: "validator-1a,validator-1b,validator-1c"
      AURIGRAPH_NODE_ROLES: "leader,follower,follower"
      AURIGRAPH_HTTP_PORT: "9003"
      AURIGRAPH_GRPC_PORT: "9004"
      AURIGRAPH_METRICS_PORT: "9090"
      # Cluster seeds pointing to all validators
      AURIGRAPH_CLUSTER_SEEDS: >
        validator-2:9004,
        validator-3:9004,
        validator-4:9004
      AURIGRAPH_GENESIS_NODE: "true"
    ports:
      - "9003:9003"    # HTTP API (Primary validator node)
      - "9004:9004"    # gRPC (P2P consensus)
      - "9090:9090"    # Metrics (Prometheus)
    volumes:
      - validator-1-data:/app/data
      - validator-1-logs:/app/logs
      - ./config/validators/v1:/app/config:ro
    networks:
      - aurigraph-network
    <<: *resource-limits
    <<: *healthcheck-validator
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  validator-2:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-ultra
        OPTIMIZATION_LEVEL: "3"
    container_name: aurigraph-validator-2
    hostname: validator-2
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "validator-2"
      AURIGRAPH_NODES_PER_CONTAINER: "3"
      AURIGRAPH_NODE_IDS: "validator-2a,validator-2b,validator-2c"
      AURIGRAPH_NODE_ROLES: "follower,leader,follower"
      AURIGRAPH_HTTP_PORT: "9003"
      AURIGRAPH_GRPC_PORT: "9004"
      AURIGRAPH_METRICS_PORT: "9090"
      AURIGRAPH_CLUSTER_SEEDS: >
        validator-1:9004,
        validator-3:9004,
        validator-4:9004
      AURIGRAPH_GENESIS_NODE: "false"
    ports:
      - "9013:9003"
      - "9014:9004"
      - "9091:9090"
    volumes:
      - validator-2-data:/app/data
      - validator-2-logs:/app/logs
      - ./config/validators/v2:/app/config:ro
    networks:
      - aurigraph-network
    <<: *resource-limits
    <<: *healthcheck-validator
    restart: unless-stopped
    depends_on:
      - validator-1

  validator-3:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-ultra
        OPTIMIZATION_LEVEL: "3"
    container_name: aurigraph-validator-3
    hostname: validator-3
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "validator-3"
      AURIGRAPH_NODES_PER_CONTAINER: "3"
      AURIGRAPH_NODE_IDS: "validator-3a,validator-3b,validator-3c"
      AURIGRAPH_NODE_ROLES: "follower,follower,leader"
      AURIGRAPH_HTTP_PORT: "9003"
      AURIGRAPH_GRPC_PORT: "9004"
      AURIGRAPH_METRICS_PORT: "9090"
      AURIGRAPH_CLUSTER_SEEDS: >
        validator-1:9004,
        validator-2:9004,
        validator-4:9004
      AURIGRAPH_GENESIS_NODE: "false"
    ports:
      - "9023:9003"
      - "9024:9004"
      - "9092:9090"
    volumes:
      - validator-3-data:/app/data
      - validator-3-logs:/app/logs
      - ./config/validators/v3:/app/config:ro
    networks:
      - aurigraph-network
    <<: *resource-limits
    <<: *healthcheck-validator
    restart: unless-stopped
    depends_on:
      - validator-1

  validator-4:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-ultra
        OPTIMIZATION_LEVEL: "3"
    container_name: aurigraph-validator-4
    hostname: validator-4
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "validator-4"
      AURIGRAPH_NODES_PER_CONTAINER: "3"
      AURIGRAPH_NODE_IDS: "validator-4a,validator-4b,validator-4c"
      AURIGRAPH_NODE_ROLES: "follower,follower,follower"
      AURIGRAPH_HTTP_PORT: "9003"
      AURIGRAPH_GRPC_PORT: "9004"
      AURIGRAPH_METRICS_PORT: "9090"
      AURIGRAPH_CLUSTER_SEEDS: >
        validator-1:9004,
        validator-2:9004,
        validator-3:9004
      AURIGRAPH_GENESIS_NODE: "false"
    ports:
      - "9033:9003"
      - "9034:9004"
      - "9093:9090"
    volumes:
      - validator-4-data:/app/data
      - validator-4-logs:/app/logs
      - ./config/validators/v4:/app/config:ro
    networks:
      - aurigraph-network
    <<: *resource-limits
    <<: *healthcheck-validator
    restart: unless-stopped
    depends_on:
      - validator-1

  ################################################################################
  # BUSINESS NODES (4 containers × 2 nodes each = 8 business nodes)
  # These are non-consensus business logic nodes for transaction processing
  ################################################################################

  business-1:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-fast
        OPTIMIZATION_LEVEL: "2"
    container_name: aurigraph-business-1
    hostname: business-1
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "business-1"
      AURIGRAPH_NODE_TYPE: "business"
      AURIGRAPH_NODES_PER_CONTAINER: "2"
      AURIGRAPH_NODE_IDS: "business-1a,business-1b"
      AURIGRAPH_HTTP_PORT: "9006"
      AURIGRAPH_GRPC_PORT: "9007"
      AURIGRAPH_METRICS_PORT: "9096"
      # Connect to validator cluster
      AURIGRAPH_VALIDATOR_SEEDS: >
        validator-1:9004,
        validator-2:9004,
        validator-3:9004,
        validator-4:9004
      AURIGRAPH_SYNC_MODE: "fast"
    ports:
      - "9006:9006"
      - "9007:9007"
      - "9096:9090"
    volumes:
      - business-1-data:/app/data
      - business-1-logs:/app/logs
      - ./config/business/b1:/app/config:ro
    networks:
      - aurigraph-network
    <<: *resource-limits
    <<: *healthcheck-business
    restart: unless-stopped
    depends_on:
      - validator-1

  business-2:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-fast
        OPTIMIZATION_LEVEL: "2"
    container_name: aurigraph-business-2
    hostname: business-2
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "business-2"
      AURIGRAPH_NODE_TYPE: "business"
      AURIGRAPH_NODES_PER_CONTAINER: "2"
      AURIGRAPH_NODE_IDS: "business-2a,business-2b"
      AURIGRAPH_HTTP_PORT: "9006"
      AURIGRAPH_GRPC_PORT: "9007"
      AURIGRAPH_METRICS_PORT: "9096"
      AURIGRAPH_VALIDATOR_SEEDS: >
        validator-1:9004,
        validator-2:9004,
        validator-3:9004,
        validator-4:9004
      AURIGRAPH_SYNC_MODE: "fast"
    ports:
      - "9016:9006"
      - "9017:9007"
      - "9097:9090"
    volumes:
      - business-2-data:/app/data
      - business-2-logs:/app/logs
      - ./config/business/b2:/app/config:ro
    networks:
      - aurigraph-network
    <<: *resource-limits
    <<: *healthcheck-business
    restart: unless-stopped
    depends_on:
      - validator-1

  business-3:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-fast
        OPTIMIZATION_LEVEL: "2"
    container_name: aurigraph-business-3
    hostname: business-3
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "business-3"
      AURIGRAPH_NODE_TYPE: "business"
      AURIGRAPH_NODES_PER_CONTAINER: "2"
      AURIGRAPH_NODE_IDS: "business-3a,business-3b"
      AURIGRAPH_HTTP_PORT: "9006"
      AURIGRAPH_GRPC_PORT: "9007"
      AURIGRAPH_METRICS_PORT: "9096"
      AURIGRAPH_VALIDATOR_SEEDS: >
        validator-1:9004,
        validator-2:9004,
        validator-3:9004,
        validator-4:9004
      AURIGRAPH_SYNC_MODE: "fast"
    ports:
      - "9026:9006"
      - "9027:9007"
      - "9098:9090"
    volumes:
      - business-3-data:/app/data
      - business-3-logs:/app/logs
      - ./config/business/b3:/app/config:ro
    networks:
      - aurigraph-network
    <<: *resource-limits
    <<: *healthcheck-business
    restart: unless-stopped
    depends_on:
      - validator-1

  business-4:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-fast
        OPTIMIZATION_LEVEL: "2"
    container_name: aurigraph-business-4
    hostname: business-4
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "business-4"
      AURIGRAPH_NODE_TYPE: "business"
      AURIGRAPH_NODES_PER_CONTAINER: "2"
      AURIGRAPH_NODE_IDS: "business-4a,business-4b"
      AURIGRAPH_HTTP_PORT: "9006"
      AURIGRAPH_GRPC_PORT: "9007"
      AURIGRAPH_METRICS_PORT: "9096"
      AURIGRAPH_VALIDATOR_SEEDS: >
        validator-1:9004,
        validator-2:9004,
        validator-3:9004,
        validator-4:9004
      AURIGRAPH_SYNC_MODE: "fast"
    ports:
      - "9036:9006"
      - "9037:9007"
      - "9099:9090"
    volumes:
      - business-4-data:/app/data
      - business-4-logs:/app/logs
      - ./config/business/b4:/app/config:ro
    networks:
      - aurigraph-network
    <<: *resource-limits
    <<: *healthcheck-business
    restart: unless-stopped
    depends_on:
      - validator-1

  ################################################################################
  # SLIM NODES (6 containers × 1 node each = 6 slim nodes)
  # Lightweight archive nodes for data availability and RPC queries
  ################################################################################

  slim-1:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-fast
        OPTIMIZATION_LEVEL: "1"
    container_name: aurigraph-slim-1
    hostname: slim-1
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "slim-1"
      AURIGRAPH_NODE_TYPE: "slim"
      AURIGRAPH_NODE_IDS: "slim-1"
      AURIGRAPH_HTTP_PORT: "9009"
      AURIGRAPH_GRPC_PORT: "9010"
      AURIGRAPH_METRICS_PORT: "9091"
      AURIGRAPH_VALIDATOR_SEEDS: >
        validator-1:9004,
        validator-2:9004
      AURIGRAPH_SYNC_MODE: "archive"
      AURIGRAPH_ARCHIVE_MODE: "true"
      AURIGRAPH_PRUNE_BLOCKS: "false"
    ports:
      - "9009:9009"
      - "9010:9010"
      - "9109:9090"
    volumes:
      - slim-1-data:/app/data
      - slim-1-logs:/app/logs
      - ./config/slim/s1:/app/config:ro
    networks:
      - aurigraph-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 256M
        reservations:
          cpus: '2'
          memory: 128M
    <<: *healthcheck-slim
    restart: unless-stopped
    depends_on:
      - validator-1

  slim-2:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-fast
        OPTIMIZATION_LEVEL: "1"
    container_name: aurigraph-slim-2
    hostname: slim-2
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "slim-2"
      AURIGRAPH_NODE_TYPE: "slim"
      AURIGRAPH_NODE_IDS: "slim-2"
      AURIGRAPH_HTTP_PORT: "9009"
      AURIGRAPH_GRPC_PORT: "9010"
      AURIGRAPH_METRICS_PORT: "9091"
      AURIGRAPH_VALIDATOR_SEEDS: >
        validator-2:9004,
        validator-3:9004
      AURIGRAPH_SYNC_MODE: "archive"
      AURIGRAPH_ARCHIVE_MODE: "true"
      AURIGRAPH_PRUNE_BLOCKS: "false"
    ports:
      - "9019:9009"
      - "9020:9010"
      - "9119:9090"
    volumes:
      - slim-2-data:/app/data
      - slim-2-logs:/app/logs
      - ./config/slim/s2:/app/config:ro
    networks:
      - aurigraph-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 256M
        reservations:
          cpus: '2'
          memory: 128M
    <<: *healthcheck-slim
    restart: unless-stopped
    depends_on:
      - validator-1

  slim-3:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-fast
        OPTIMIZATION_LEVEL: "1"
    container_name: aurigraph-slim-3
    hostname: slim-3
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "slim-3"
      AURIGRAPH_NODE_TYPE: "slim"
      AURIGRAPH_NODE_IDS: "slim-3"
      AURIGRAPH_HTTP_PORT: "9009"
      AURIGRAPH_GRPC_PORT: "9010"
      AURIGRAPH_METRICS_PORT: "9091"
      AURIGRAPH_VALIDATOR_SEEDS: >
        validator-3:9004,
        validator-4:9004
      AURIGRAPH_SYNC_MODE: "archive"
      AURIGRAPH_ARCHIVE_MODE: "true"
      AURIGRAPH_PRUNE_BLOCKS: "false"
    ports:
      - "9029:9009"
      - "9030:9010"
      - "9129:9090"
    volumes:
      - slim-3-data:/app/data
      - slim-3-logs:/app/logs
      - ./config/slim/s3:/app/config:ro
    networks:
      - aurigraph-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 256M
        reservations:
          cpus: '2'
          memory: 128M
    <<: *healthcheck-slim
    restart: unless-stopped
    depends_on:
      - validator-1

  slim-4:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-fast
        OPTIMIZATION_LEVEL: "1"
    container_name: aurigraph-slim-4
    hostname: slim-4
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "slim-4"
      AURIGRAPH_NODE_TYPE: "slim"
      AURIGRAPH_NODE_IDS: "slim-4"
      AURIGRAPH_HTTP_PORT: "9009"
      AURIGRAPH_GRPC_PORT: "9010"
      AURIGRAPH_METRICS_PORT: "9091"
      AURIGRAPH_VALIDATOR_SEEDS: >
        validator-1:9004,
        validator-3:9004
      AURIGRAPH_SYNC_MODE: "archive"
      AURIGRAPH_ARCHIVE_MODE: "true"
      AURIGRAPH_PRUNE_BLOCKS: "false"
    ports:
      - "9039:9009"
      - "9040:9010"
      - "9139:9090"
    volumes:
      - slim-4-data:/app/data
      - slim-4-logs:/app/logs
      - ./config/slim/s4:/app/config:ro
    networks:
      - aurigraph-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 256M
        reservations:
          cpus: '2'
          memory: 128M
    <<: *healthcheck-slim
    restart: unless-stopped
    depends_on:
      - validator-1

  slim-5:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-fast
        OPTIMIZATION_LEVEL: "1"
    container_name: aurigraph-slim-5
    hostname: slim-5
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "slim-5"
      AURIGRAPH_NODE_TYPE: "slim"
      AURIGRAPH_NODE_IDS: "slim-5"
      AURIGRAPH_HTTP_PORT: "9009"
      AURIGRAPH_GRPC_PORT: "9010"
      AURIGRAPH_METRICS_PORT: "9091"
      AURIGRAPH_VALIDATOR_SEEDS: >
        validator-2:9004,
        validator-4:9004
      AURIGRAPH_SYNC_MODE: "archive"
      AURIGRAPH_ARCHIVE_MODE: "true"
      AURIGRAPH_PRUNE_BLOCKS: "false"
    ports:
      - "9049:9009"
      - "9050:9010"
      - "9149:9090"
    volumes:
      - slim-5-data:/app/data
      - slim-5-logs:/app/logs
      - ./config/slim/s5:/app/config:ro
    networks:
      - aurigraph-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 256M
        reservations:
          cpus: '2'
          memory: 128M
    <<: *healthcheck-slim
    restart: unless-stopped
    depends_on:
      - validator-1

  slim-6:
    image: aurigraph/v11-native:latest
    build:
      context: ./aurigraph-av10-7/aurigraph-v11-standalone
      dockerfile: Dockerfile.native
      args:
        BUILD_PROFILE: native-fast
        OPTIMIZATION_LEVEL: "1"
    container_name: aurigraph-slim-6
    hostname: slim-6
    environment:
      <<: *common-variables
      AURIGRAPH_CONTAINER_ID: "slim-6"
      AURIGRAPH_NODE_TYPE: "slim"
      AURIGRAPH_NODE_IDS: "slim-6"
      AURIGRAPH_HTTP_PORT: "9009"
      AURIGRAPH_GRPC_PORT: "9010"
      AURIGRAPH_METRICS_PORT: "9091"
      AURIGRAPH_VALIDATOR_SEEDS: >
        validator-1:9004,
        validator-4:9004
      AURIGRAPH_SYNC_MODE: "archive"
      AURIGRAPH_ARCHIVE_MODE: "true"
      AURIGRAPH_PRUNE_BLOCKS: "false"
    ports:
      - "9059:9009"
      - "9060:9010"
      - "9159:9090"
    volumes:
      - slim-6-data:/app/data
      - slim-6-logs:/app/logs
      - ./config/slim/s6:/app/config:ro
    networks:
      - aurigraph-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 256M
        reservations:
          cpus: '2'
          memory: 128M
    <<: *healthcheck-slim
    restart: unless-stopped
    depends_on:
      - validator-1

  ################################################################################
  # INFRASTRUCTURE SERVICES
  ################################################################################

  # PostgreSQL Database (Persistent State)
  postgres:
    image: postgres:16-alpine
    container_name: aurigraph-db
    hostname: postgres
    environment:
      POSTGRES_DB: aurigraph
      POSTGRES_USER: aurigraph
      POSTGRES_PASSWORD: aurigraph-secure-password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-scripts/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    networks:
      - aurigraph-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aurigraph"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache (Session & Performance)
  redis:
    image: redis:7-alpine
    container_name: aurigraph-redis
    hostname: redis
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512m
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --stop-writes-on-bgsave-error yes
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - aurigraph-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Prometheus (Metrics Collection)
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: aurigraph-prometheus
    hostname: prometheus
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/prometheus/rules.yml:/etc/prometheus/rules.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9100:9090"
    networks:
      - aurigraph-network
    restart: unless-stopped

  # Grafana (Visualization)
  grafana:
    image: grafana/grafana:10.2.3
    container_name: aurigraph-grafana
    hostname: grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: false
      GF_INSTALL_PLUGINS: grafana-piechart-panel
      GF_LOG_LEVEL: info
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3001:3000"
    networks:
      - aurigraph-network
    depends_on:
      - prometheus
    restart: unless-stopped

  # HAProxy Load Balancer
  load-balancer:
    image: haproxy:2.9-alpine
    container_name: aurigraph-lb
    hostname: load-balancer
    volumes:
      - ./config/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ./config/haproxy/errors:/usr/local/etc/haproxy/errors:ro
    ports:
      - "8080:8080"    # Balanced HTTP (validators + business nodes)
      - "8081:8081"    # Balanced gRPC
      - "8082:8082"    # HAProxy stats
    networks:
      - aurigraph-network
    depends_on:
      - validator-1
      - business-1
    restart: unless-stopped

  # Jaeger for Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:1.49
    container_name: aurigraph-jaeger
    hostname: jaeger
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: ":9411"
    ports:
      - "16686:16686"  # Jaeger UI
      - "6831:6831/udp"  # Jaeger agent
      - "14250:14250"  # gRPC receiver
    networks:
      - aurigraph-network
    restart: unless-stopped

networks:
  aurigraph-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16

volumes:
  # Validator Data Volumes
  validator-1-data:
    driver: local
  validator-1-logs:
    driver: local
  validator-2-data:
    driver: local
  validator-2-logs:
    driver: local
  validator-3-data:
    driver: local
  validator-3-logs:
    driver: local
  validator-4-data:
    driver: local
  validator-4-logs:
    driver: local

  # Business Node Data Volumes
  business-1-data:
    driver: local
  business-1-logs:
    driver: local
  business-2-data:
    driver: local
  business-2-logs:
    driver: local
  business-3-data:
    driver: local
  business-3-logs:
    driver: local
  business-4-data:
    driver: local
  business-4-logs:
    driver: local

  # Slim Node Data Volumes
  slim-1-data:
    driver: local
  slim-1-logs:
    driver: local
  slim-2-data:
    driver: local
  slim-2-logs:
    driver: local
  slim-3-data:
    driver: local
  slim-3-logs:
    driver: local
  slim-4-data:
    driver: local
  slim-4-logs:
    driver: local
  slim-5-data:
    driver: local
  slim-5-logs:
    driver: local
  slim-6-data:
    driver: local
  slim-6-logs:
    driver: local

  # Infrastructure Data Volumes
  postgres-data:
    driver: local
  redis-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

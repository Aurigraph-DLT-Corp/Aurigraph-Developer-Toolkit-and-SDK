# Aurigraph V11 Production-Ready Docker Compose Configuration
version: '3.8'

# Network configuration for service isolation
networks:
  aurigraph-frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  aurigraph-backend:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/16
  monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16

# Persistent volumes for data durability
volumes:
  aurigraph-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/aurigraph
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  consul-data:
    driver: local
  vault-data:
    driver: local

# Service definitions
services:
  # ================================
  # Aurigraph V11 Native Application
  # ================================
  aurigraph-v11-native:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_TYPE: native
        JAVA_VERSION: 21
      target: native-runtime
    image: aurigraph/v11-native:latest
    container_name: aurigraph-v11-native
    restart: unless-stopped
    
    # Resource limits optimized for native deployment
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '4.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    
    # Environment configuration
    environment:
      - QUARKUS_PROFILE=prod
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - AURIGRAPH_NATIVE_MODE=true
      - CONSENSUS_NODE_ID=aurigraph-native-node-1
      - CONSENSUS_CLUSTER_SIZE=3
      - AI_OPTIMIZATION_ENABLED=true
      - AI_OPTIMIZATION_TARGET_TPS=2500000
      - MALLOC_ARENA_MAX=1
      - MALLOC_MMAP_THRESHOLD_=32768
    
    # Port mapping
    ports:
      - "9003:9003"  # HTTP API
      - "9004:9004"  # gRPC
    
    # Volume mounts
    volumes:
      - aurigraph-data:/deployments/data
      - ./logs:/deployments/logs
      - ./config:/deployments/config:ro
    
    # Health checks
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9003/q/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    
    # Network configuration
    networks:
      - aurigraph-frontend
      - aurigraph-backend
    
    # Dependencies
    depends_on:
      consul:
        condition: service_healthy
      vault:
        condition: service_healthy
    
    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:rw,size=100M

  # ================================
  # Aurigraph V11 JVM Application (Backup)
  # ================================
  aurigraph-v11-jvm:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_TYPE: jvm
        JAVA_VERSION: 21
      target: jvm-runtime
    image: aurigraph/v11-jvm:latest
    container_name: aurigraph-v11-jvm
    restart: unless-stopped
    profiles: ["jvm", "backup"]
    
    # Resource limits for JVM deployment
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '4.0'
        reservations:
          memory: 512M
          cpus: '1.0'
    
    # Environment configuration
    environment:
      - QUARKUS_PROFILE=prod
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_GRPC_SERVER_HOST=0.0.0.0
      - CONSENSUS_NODE_ID=aurigraph-jvm-node-1
      - JAVA_OPTS_APPEND=-XX:+UseG1GC -XX:MaxGCPauseMillis=100 -XX:+UseStringDeduplication
      - JAVA_MAX_MEM_RATIO=75
      - JAVA_INITIAL_MEM_RATIO=50
    
    # Port mapping (different ports to avoid conflicts)
    ports:
      - "9013:9003"  # HTTP API
      - "9014:9004"  # gRPC
    
    # Volume mounts
    volumes:
      - aurigraph-data:/deployments/data
      - ./logs:/deployments/logs
      - ./config:/deployments/config:ro
    
    # Health checks (longer startup time for JVM)
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9003/q/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    networks:
      - aurigraph-frontend
      - aurigraph-backend

  # ================================
  # Service Discovery - Consul
  # ================================
  consul:
    image: hashicorp/consul:1.17.1
    container_name: aurigraph-consul
    restart: unless-stopped
    command: >
      agent -server -bootstrap-expect=1 -ui -client=0.0.0.0
      -bind=0.0.0.0 -data-dir=/consul/data
      -config-dir=/consul/config
    
    environment:
      - CONSUL_BIND_INTERFACE=eth0
      - CONSUL_CLIENT_INTERFACE=eth0
    
    ports:
      - "8500:8500"  # HTTP API
      - "8600:8600/udp"  # DNS
    
    volumes:
      - consul-data:/consul/data
      - ./config/consul:/consul/config:ro
    
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    networks:
      - aurigraph-backend
      - monitoring

  # ================================
  # Secrets Management - Vault
  # ================================
  vault:
    image: hashicorp/vault:1.15.4
    container_name: aurigraph-vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=dev-root-token-aurigraph
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://127.0.0.1:8200
      - VAULT_API_ADDR=http://127.0.0.1:8200
      - VAULT_LOG_LEVEL=info
    
    ports:
      - "8200:8200"
    
    volumes:
      - vault-data:/vault/data
      - ./config/vault:/vault/config:ro
    
    command: server -dev
    
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    networks:
      - aurigraph-backend
      - monitoring

  # ================================
  # Metrics Collection - Prometheus
  # ================================
  prometheus:
    image: prom/prometheus:v2.50.1
    container_name: aurigraph-prometheus
    restart: unless-stopped
    
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    
    ports:
      - "9090:9090"
    
    volumes:
      - prometheus-data:/prometheus
      - ./config/prometheus:/etc/prometheus:ro
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    networks:
      - monitoring
      - aurigraph-frontend
    
    depends_on:
      - aurigraph-v11-native

  # ================================
  # Visualization - Grafana
  # ================================
  grafana:
    image: grafana/grafana:10.3.3
    container_name: aurigraph-grafana
    restart: unless-stopped
    
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_DOMAIN=localhost
      - GF_SMTP_ENABLED=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    
    ports:
      - "3000:3000"
    
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro
    
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    networks:
      - monitoring
      - aurigraph-frontend
    
    depends_on:
      - prometheus

  # ================================
  # Load Balancer - NGINX
  # ================================
  nginx:
    image: nginx:1.25.3-alpine
    container_name: aurigraph-nginx
    restart: unless-stopped
    
    ports:
      - "80:80"
      - "443:443"
    
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./config/ssl:/etc/nginx/ssl:ro
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    networks:
      - aurigraph-frontend
    
    depends_on:
      - aurigraph-v11-native

  # ================================
  # Log Aggregation - Fluentd
  # ================================
  fluentd:
    image: fluent/fluentd:v1.16-debian-1
    container_name: aurigraph-fluentd
    restart: unless-stopped
    
    volumes:
      - ./config/fluentd:/fluentd/etc:ro
      - ./logs:/var/log/aurigraph:ro
    
    ports:
      - "24224:24224"
      - "24224:24224/udp"
    
    networks:
      - monitoring
    
    depends_on:
      - aurigraph-v11-native

  # ================================
  # Cache Layer - Redis
  # ================================
  redis:
    image: redis:7.2.4-alpine
    container_name: aurigraph-redis
    restart: unless-stopped
    
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    
    ports:
      - "6379:6379"
    
    volumes:
      - ./data/redis:/data
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    
    networks:
      - aurigraph-backend

# ================================
# Environment-specific overrides
# ================================
# Aurigraph Management Dashboard Dockerfile
# Provides deployment status and service monitoring

FROM node:20.10-alpine
LABEL maintainer="Aurigraph DevOps Team"
LABEL description="Aurigraph Management Dashboard"

WORKDIR /app

# Install dependencies
RUN npm init -y && \
    npm install express cors axios node-cron && \
    mkdir -p /app/logs /app/public

# Create the management dashboard service
RUN cat > /app/server.js << 'EOF'
const express = require('express');
const cors = require('cors');
const axios = require('axios');
const cron = require('node-cron');
const fs = require('fs');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3040;
const PROMETHEUS_URL = process.env.PROMETHEUS_URL || 'http://prometheus:9090';
const V10_ENDPOINT = process.env.V10_ENDPOINT || 'http://aurigraph-v10:4004';
const V11_ENDPOINT = process.env.V11_ENDPOINT || 'http://aurigraph-v11:9003';
const DOMAIN = process.env.DOMAIN || 'aurigraphdlt.dev4.aurex.in';

app.use(cors());
app.use(express.json());
app.use(express.static('public'));

let serviceStatus = {
    v10: { status: 'unknown', lastCheck: null, error: null },
    v11: { status: 'unknown', lastCheck: null, error: null },
    prometheus: { status: 'unknown', lastCheck: null, error: null }
};

let systemMetrics = {
    deployment_time: new Date().toISOString(),
    total_requests: 0,
    successful_checks: 0,
    failed_checks: 0
};

// Service health checker
async function checkService(name, url, healthPath = '/health') {
    try {
        const response = await axios.get(`${url}${healthPath}`, { timeout: 5000 });
        serviceStatus[name] = {
            status: 'healthy',
            lastCheck: new Date().toISOString(),
            error: null,
            responseTime: Date.now(),
            data: response.data
        };
        systemMetrics.successful_checks++;
        return true;
    } catch (error) {
        serviceStatus[name] = {
            status: 'unhealthy',
            lastCheck: new Date().toISOString(),
            error: error.message,
            responseTime: null
        };
        systemMetrics.failed_checks++;
        return false;
    }
}

// Periodic health checks
cron.schedule('*/30 * * * * *', async () => {
    console.log('Running health checks...');
    await Promise.all([
        checkService('v10', V10_ENDPOINT),
        checkService('v11', V11_ENDPOINT, '/q/health'),
        checkService('prometheus', PROMETHEUS_URL, '/-/healthy')
    ]);
});

// Initial health check
(async () => {
    console.log('Running initial health checks...');
    await Promise.all([
        checkService('v10', V10_ENDPOINT),
        checkService('v11', V11_ENDPOINT, '/q/health'),
        checkService('prometheus', PROMETHEUS_URL, '/-/healthy')
    ]);
})();

// Management endpoints
app.get('/health', (req, res) => {
    systemMetrics.total_requests++;
    res.json({
        status: 'healthy',
        service: 'aurigraph-management-dashboard',
        version: '1.0.0',
        timestamp: new Date().toISOString(),
        domain: DOMAIN
    });
});

app.get('/status', (req, res) => {
    systemMetrics.total_requests++;
    
    const overallStatus = Object.values(serviceStatus).some(s => s.status === 'healthy') ? 'operational' : 'degraded';
    
    res.json({
        overall_status: overallStatus,
        domain: DOMAIN,
        environment: 'dev4',
        services: serviceStatus,
        metrics: systemMetrics,
        deployment_info: {
            strategy: 'docker-compose-with-fallbacks',
            primary_service: serviceStatus.v10.status === 'healthy' ? 'v10' : 
                           serviceStatus.v11.status === 'healthy' ? 'v11' : 'mock',
            last_update: new Date().toISOString()
        }
    });
});

app.get('/services', (req, res) => {
    systemMetrics.total_requests++;
    res.json({
        services: {
            'aurigraph-v10': {
                ...serviceStatus.v10,
                endpoint: V10_ENDPOINT,
                expected_port: 4004,
                type: 'TypeScript/Node.js'
            },
            'aurigraph-v11': {
                ...serviceStatus.v11,
                endpoint: V11_ENDPOINT,
                expected_port: 9003,
                type: 'Java/Quarkus'
            },
            'prometheus': {
                ...serviceStatus.prometheus,
                endpoint: PROMETHEUS_URL,
                expected_port: 9090,
                type: 'Monitoring'
            }
        }
    });
});

app.get('/deployment', (req, res) => {
    systemMetrics.total_requests++;
    res.json({
        domain: DOMAIN,
        environment: 'dev4',
        deployment_strategy: 'compilation-bypass-with-fallback',
        docker_compose_file: 'docker-compose.production-dev4.yml',
        services_deployed: [
            'aurigraph-v10 (TypeScript with bypass)',
            'aurigraph-v11 (Quarkus with fallback)',
            'aurigraph-mock (Ultimate fallback)',
            'nginx (Reverse proxy)',
            'prometheus (Monitoring)',
            'grafana (Dashboards)',
            'redis (Caching)',
            'management-dashboard (This service)'
        ],
        ports: {
            nginx: '80, 443',
            'aurigraph-v10': '4004',
            'aurigraph-v11': '9003, 9004',
            'aurigraph-mock': '8080',
            prometheus: '9090',
            grafana: '3000',
            redis: '6379',
            management: '3040'
        },
        timestamp: new Date().toISOString()
    });
});

// Logs endpoint
app.get('/logs', async (req, res) => {
    systemMetrics.total_requests++;
    try {
        const logsDir = '/app/logs';
        const files = fs.existsSync(logsDir) ? fs.readdirSync(logsDir) : [];
        res.json({
            available_logs: files,
            log_directory: logsDir,
            note: 'Use /logs/:filename to view specific log files'
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

app.get('/logs/:filename', (req, res) => {
    systemMetrics.total_requests++;
    const filename = req.params.filename;
    const filepath = path.join('/app/logs', filename);
    
    if (fs.existsSync(filepath)) {
        const content = fs.readFileSync(filepath, 'utf8');
        res.type('text/plain').send(content);
    } else {
        res.status(404).json({ error: 'Log file not found' });
    }
});

// Main dashboard HTML
app.get('/', (req, res) => {
    systemMetrics.total_requests++;
    const healthyServices = Object.values(serviceStatus).filter(s => s.status === 'healthy').length;
    const totalServices = Object.keys(serviceStatus).length;
    
    res.send(`
<!DOCTYPE html>
<html>
<head>
    <title>Aurigraph Management Dashboard - ${DOMAIN}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status-healthy { border-left: 4px solid #28a745; }
        .status-unhealthy { border-left: 4px solid #dc3545; }
        .status-unknown { border-left: 4px solid #ffc107; }
        .metric { display: flex; justify-content: space-between; margin: 10px 0; }
        .btn { padding: 8px 16px; background: #007acc; color: white; text-decoration: none; border-radius: 4px; display: inline-block; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .refresh-btn { background: #28a745; }
        .logs-btn { background: #6c757d; }
        h2 { margin-top: 0; }
        .timestamp { color: #666; font-size: 0.9em; }
        .error { color: #dc3545; font-size: 0.9em; }
    </style>
    <script>
        function refreshStatus() {
            location.reload();
        }
        
        setInterval(refreshStatus, 30000); // Auto-refresh every 30 seconds
    </script>
</head>
<body>
    <div class="header">
        <h1>üöÄ Aurigraph Management Dashboard</h1>
        <p><strong>Domain:</strong> ${DOMAIN} | <strong>Environment:</strong> dev4 | <strong>Services:</strong> ${healthyServices}/${totalServices} healthy</p>
    </div>

    <div class="status-grid">
        ${Object.entries(serviceStatus).map(([name, status]) => `
        <div class="card status-${status.status}">
            <h2>${name.toUpperCase()} Service</h2>
            <div class="metric">
                <span>Status:</span>
                <span><strong>${status.status}</strong></span>
            </div>
            <div class="metric">
                <span>Last Check:</span>
                <span class="timestamp">${status.lastCheck || 'Never'}</span>
            </div>
            ${status.error ? `<div class="error">Error: ${status.error}</div>` : ''}
            ${status.data ? `<div class="metric"><span>Response:</span><span>OK</span></div>` : ''}
        </div>
        `).join('')}
    </div>

    <div class="card">
        <h2>System Metrics</h2>
        <div class="metric">
            <span>Deployment Time:</span>
            <span>${systemMetrics.deployment_time}</span>
        </div>
        <div class="metric">
            <span>Total Requests:</span>
            <span>${systemMetrics.total_requests}</span>
        </div>
        <div class="metric">
            <span>Successful Checks:</span>
            <span>${systemMetrics.successful_checks}</span>
        </div>
        <div class="metric">
            <span>Failed Checks:</span>
            <span>${systemMetrics.failed_checks}</span>
        </div>
    </div>

    <div class="card">
        <h2>Quick Actions</h2>
        <a href="/status" class="btn">Service Status JSON</a>
        <a href="/services" class="btn">Detailed Services</a>
        <a href="/deployment" class="btn">Deployment Info</a>
        <a href="/logs" class="btn logs-btn">View Logs</a>
        <button onclick="refreshStatus()" class="btn refresh-btn">Refresh Status</button>
    </div>

    <div class="card">
        <h2>External Links</h2>
        <a href="/grafana" class="btn">Grafana Dashboard</a>
        <a href="/prometheus" class="btn">Prometheus Metrics</a>
        <a href="${serviceStatus.v10.status === 'healthy' ? V10_ENDPOINT : serviceStatus.v11.status === 'healthy' ? V11_ENDPOINT : '#'}" class="btn">Main Application</a>
    </div>

    <p class="timestamp" style="text-align: center; margin-top: 30px;">
        Last updated: ${new Date().toISOString()} | Auto-refresh: 30s
    </p>
</body>
</html>
    `);
});

app.listen(PORT, '0.0.0.0', () => {
    console.log(`üéØ Aurigraph Management Dashboard started on port ${PORT}`);
    console.log(`üìç Domain: ${DOMAIN}`);
    console.log(`üîç Monitoring services: V10, V11, Prometheus`);
});
EOF

USER node

EXPOSE 3040

HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:3040/health || exit 1

CMD ["node", "server.js"]
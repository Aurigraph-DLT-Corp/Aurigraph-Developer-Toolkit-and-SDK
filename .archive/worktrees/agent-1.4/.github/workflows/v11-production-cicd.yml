name: V11 Production CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/sprint-*'
    paths:
      - 'aurigraph-av10-7/aurigraph-v11-standalone/**'
      - '.github/workflows/v11-production-cicd.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'aurigraph-av10-7/aurigraph-v11-standalone/**'
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Deployment type'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
          - canary
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean

env:
  MAVEN_OPTS: -Xmx6g -XX:+UseG1GC -Dmaven.repo.local=.m2/repository
  JAVA_VERSION: '21'
  QUARKUS_VERSION: '3.28.2'
  MIN_LINE_COVERAGE: 95
  MIN_BRANCH_COVERAGE: 90
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/aurigraph-v11

jobs:
  # ============================================================
  # PHASE 1: BUILD & TEST (PARALLEL EXECUTION)
  # ============================================================
  build:
    name: Build & Compile
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      sha_short: ${{ steps.sha.outputs.sha_short }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Get version and SHA
        id: version
        run: |
          VERSION=$(mvn -f aurigraph-av10-7/aurigraph-v11-standalone/pom.xml help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Get short SHA
        id: sha
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          echo "sha_short=$SHA_SHORT" >> $GITHUB_OUTPUT
          echo "ðŸ”– Commit: $SHA_SHORT"

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Compile project
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ./mvnw clean compile -DskipTests -B
          echo "âœ… Compilation successful"

      - name: Package JAR
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ./mvnw package -DskipTests -B
          echo "âœ… JAR packaging complete"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            aurigraph-av10-7/aurigraph-v11-standalone/target/*.jar
            aurigraph-av10-7/aurigraph-v11-standalone/target/quarkus-app/
          retention-days: 7

  test-unit:
    name: Unit Tests (897 tests)
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run unit tests
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ./mvnw test -B
          echo "âœ… Unit tests completed"
        timeout-minutes: 30

      - name: Generate JaCoCo report
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ./mvnw jacoco:report -B
          echo "âœ… Coverage report generated"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: |
            aurigraph-av10-7/aurigraph-v11-standalone/target/surefire-reports/**
            aurigraph-av10-7/aurigraph-v11-standalone/target/site/jacoco/**
          retention-days: 30

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run integration tests
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ./mvnw verify -DskipUnitTests -B
          echo "âœ… Integration tests completed"
        timeout-minutes: 45

  test-performance:
    name: Performance Tests (3M+ TPS Target)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: aurigraph-av10-7/aurigraph-v11-standalone/target/

      - name: Run performance tests
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ./mvnw test -Dtest="*PerformanceTest,*LoadTest" -B
          echo "âœ… Performance tests completed"
        timeout-minutes: 60

      - name: Performance benchmark
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          if [ -f "./performance-benchmark.sh" ]; then
            ./performance-benchmark.sh | tee performance-results.txt
            echo "âœ… Performance benchmark completed"
          fi
        continue-on-error: true

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            aurigraph-av10-7/aurigraph-v11-standalone/performance-results.txt
            aurigraph-av10-7/aurigraph-v11-standalone/target/performance-reports/**
          retention-days: 90

  # ============================================================
  # PHASE 2: CODE QUALITY & SECURITY
  # ============================================================
  code-quality:
    name: Code Quality Gate (95% Coverage)
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: unit-test-results
          path: aurigraph-av10-7/aurigraph-v11-standalone/target/

      - name: Verify coverage thresholds
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ./mvnw verify -DskipTests -B
          echo "âœ… Coverage thresholds met (95% line, 90% branch)"

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: aurigraph-av10-7/aurigraph-v11-standalone/target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-v11
          fail_ci_if_error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run OWASP Dependency Check
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ./mvnw org.owasp:dependency-check-maven:check -B
          echo "âœ… OWASP dependency check complete"
        continue-on-error: true

      - name: Run Snyk security scan
        uses: snyk/actions/maven@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=aurigraph-av10-7/aurigraph-v11-standalone/pom.xml

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            aurigraph-av10-7/aurigraph-v11-standalone/target/dependency-check-report.html
          retention-days: 90

  # ============================================================
  # PHASE 3: NATIVE BUILD & CONTAINERIZATION
  # ============================================================
  native-build:
    name: Native Build (GraalVM)
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install native-image
        run: |
          gu install native-image
          native-image --version

      - name: Build native image
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          ./mvnw package -Pnative-fast -DskipTests -B
          echo "âœ… Native image built successfully"
        timeout-minutes: 90

      - name: Test native executable
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          chmod +x target/*-runner
          timeout 10s target/*-runner &
          PID=$!
          sleep 5
          curl http://localhost:9003/q/health || echo "Health check"
          kill $PID || true
          echo "âœ… Native executable validated"

      - name: Upload native executable
        uses: actions/upload-artifact@v4
        with:
          name: native-executable
          path: aurigraph-av10-7/aurigraph-v11-standalone/target/*-runner
          retention-days: 30

  docker-build:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, native-build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download native executable
        uses: actions/download-artifact@v4
        with:
          name: native-executable
          path: aurigraph-av10-7/aurigraph-v11-standalone/target/

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: aurigraph-av10-7/aurigraph-v11-standalone
          file: aurigraph-av10-7/aurigraph-v11-standalone/Dockerfile.native
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================
  # PHASE 4: DEPLOYMENT STRATEGIES
  # ============================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.aurigraph.io

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to staging
        env:
          SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_KEY }}
          SSH_HOST: ${{ secrets.STAGING_HOST }}
          SSH_USER: ${{ secrets.STAGING_USER }}
        run: |
          echo "ðŸš€ Deploying to staging environment"
          # Add actual deployment commands here

  deploy-production:
    name: Deploy to Production (Blue-Green)
    runs-on: ubuntu-latest
    needs: [docker-build, test-performance]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://dlt.aurigraph.io

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download native executable
        uses: actions/download-artifact@v4
        with:
          name: native-executable
          path: ./native/

      - name: Deploy to production (Blue-Green)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PROD_SSH_KEY }}
          SSH_HOST: dlt.aurigraph.io
          SSH_PORT: 2235
          SSH_USER: subbu
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H -p $SSH_PORT $SSH_HOST >> ~/.ssh/known_hosts

          # Create deployment timestamp
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          DEPLOY_DIR="/opt/aurigraph/v11/releases/$TIMESTAMP"

          echo "ðŸš€ Deploying to production: $DEPLOY_DIR"

          # Create deployment directory
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "mkdir -p $DEPLOY_DIR"

          # Upload native executable
          scp -P $SSH_PORT ./native/*-runner $SSH_USER@$SSH_HOST:$DEPLOY_DIR/aurigraph-v11

          # Make executable
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "chmod +x $DEPLOY_DIR/aurigraph-v11"

          # Create backup of current blue
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "if [ -L /opt/aurigraph/v11/blue ]; then cp -rL /opt/aurigraph/v11/blue /opt/aurigraph/v11/backup_\$(date +%Y%m%d_%H%M%S); fi"

          # Deploy to green slot
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "ln -sfn $DEPLOY_DIR /opt/aurigraph/v11/green"

          # Start green instance
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "systemctl start aurigraph-v11-green"

          # Wait for health check
          sleep 10

          # Health check on green
          GREEN_HEALTH=$(ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "curl -f http://localhost:9004/q/health && echo OK || echo FAIL")

          if [ "$GREEN_HEALTH" = "OK" ]; then
            echo "âœ… Green instance healthy, switching traffic"

            # Switch NGINX to green
            ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "sudo cp /etc/nginx/sites-available/aurigraph-green /etc/nginx/sites-enabled/aurigraph && sudo systemctl reload nginx"

            # Wait and verify
            sleep 5
            curl -f https://dlt.aurigraph.io/api/v11/health || echo "âš ï¸  Production health check failed"

            # Stop blue instance
            ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "systemctl stop aurigraph-v11-blue || true"

            # Swap blue and green
            ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "mv /opt/aurigraph/v11/blue /opt/aurigraph/v11/blue_old && ln -sfn $DEPLOY_DIR /opt/aurigraph/v11/blue && rm /opt/aurigraph/v11/green"

            echo "âœ… Deployment successful"
          else
            echo "âŒ Green instance unhealthy, rolling back"
            ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "systemctl stop aurigraph-v11-green"
            exit 1
          fi

      - name: Rollback on failure
        if: failure()
        env:
          SSH_PRIVATE_KEY: ${{ secrets.PROD_SSH_KEY }}
          SSH_HOST: dlt.aurigraph.io
          SSH_PORT: 2235
          SSH_USER: subbu
        run: |
          echo "ðŸ”„ Rolling back deployment"
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Stop green instance
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "systemctl stop aurigraph-v11-green || true"

          # Restore backup
          BACKUP=$(ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "ls -t /opt/aurigraph/v11/backup_* 2>/dev/null | head -1")
          if [ -n "$BACKUP" ]; then
            ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "ln -sfn $BACKUP /opt/aurigraph/v11/blue && systemctl start aurigraph-v11-blue && sudo systemctl reload nginx"
            echo "âœ… Rolled back to: $BACKUP"
          else
            echo "âŒ No backup found for rollback"
          fi

  # ============================================================
  # PHASE 5: NOTIFICATIONS & MONITORING
  # ============================================================
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [build, test-unit, test-integration, code-quality, security-scan]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## ðŸš€ V11 CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.test-unit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.test-integration.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "V11 CI/CD Pipeline ${{ job.status }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}\nBranch: ${{ github.ref_name }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

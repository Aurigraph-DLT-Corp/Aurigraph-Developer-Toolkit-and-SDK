# Multi-Node Aurigraph Container
# Runs multiple basic nodes in a single container with process management

FROM openjdk:21-jdk-slim AS build

# Install Maven and supervisor
RUN apt-get update && apt-get install -y maven curl supervisor && rm -rf /var/lib/apt/lists/*

WORKDIR /code
COPY pom.xml .
RUN mvn dependency:go-offline -q

COPY src src
RUN mvn package -DskipTests=true -q

## Runtime stage with multi-process support
FROM openjdk:21-jre-slim

# Install supervisor and curl
RUN apt-get update && apt-get install -y supervisor curl && rm -rf /var/lib/apt/lists/*

# Container metadata
LABEL name="aurigraph-multinode" \
      version="10.19.0" \
      description="Multiple Aurigraph Basic Nodes in single container"

# Create aurigraph user
RUN groupadd -r aurigraph && useradd -r -g aurigraph -u 1001 aurigraph

# Create directories for multiple nodes
RUN mkdir -p /work/node1 /work/node2 /work/node3 /work/logs /etc/supervisor/conf.d
RUN chown -R aurigraph:aurigraph /work

# Copy application to each node directory
COPY --from=build --chown=aurigraph:aurigraph /code/target/quarkus-app/ /work/node1/
COPY --from=build --chown=aurigraph:aurigraph /code/target/quarkus-app/ /work/node2/
COPY --from=build --chown=aurigraph:aurigraph /code/target/quarkus-app/ /work/node3/

# Copy supervisor configuration
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Copy multi-node startup script
COPY scripts/start-multinodes.sh /work/start-multinodes.sh
RUN chmod +x /work/start-multinodes.sh && chown aurigraph:aurigraph /work/start-multinodes.sh

# Environment variables for multi-node setup
ENV JAVA_OPTS="-Xmx128m -XX:+UseG1GC -XX:+UseStringDeduplication" \
    QUARKUS_HTTP_HOST="0.0.0.0" \
    NODE_COUNT="3"

# Expose ports for 3 nodes
EXPOSE 8080 8081 8082

# Health check for all nodes
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/q/health && \
        curl -f http://localhost:8081/q/health && \
        curl -f http://localhost:8082/q/health || exit 1

# Switch to non-root user
USER 1001

# Start supervisor to manage multiple processes
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
################################################################################
# docker-compose-deploy.yml
# Production deployment for Aurigraph V11 Backend + Enterprise Portal Frontend
################################################################################

version: '3.9'

services:
  # Backend - Aurigraph V11 Java/Quarkus
  aurigraph-backend:
    build:
      context: .
      dockerfile: Dockerfile.simple
    image: aurigraph-v11-backend:latest
    container_name: aurigraph-v11-backend
    hostname: aurigraph-backend
    ports:
      - "9003:9003"  # REST API
      - "9004:9004"  # gRPC
      - "9005:9005"  # HMS
    environment:
      QUARKUS_HTTP_PORT: 9003
      QUARKUS_GRPC_SERVER_PORT: 9004
      QUARKUS_PROFILE: prod
      JAVA_OPTS: "-Xmx2g -Xms1g -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
      CONSENSUS_TARGET_TPS: 2000000
      AI_OPTIMIZATION_ENABLED: "true"
    volumes:
      - ./logs:/opt/aurigraph/logs
      - ./data:/opt/aurigraph/data
    networks:
      - aurigraph-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9003/q/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Frontend - Enterprise Portal React
  aurigraph-frontend:
    build:
      context: ./enterprise-portal
      dockerfile: Dockerfile
    image: aurigraph-v11-frontend:latest
    container_name: aurigraph-v11-frontend
    hostname: aurigraph-frontend
    ports:
      - "3000:80"
    depends_on:
      - aurigraph-backend
    networks:
      - aurigraph-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

networks:
  aurigraph-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16

volumes:
  logs:
  data:

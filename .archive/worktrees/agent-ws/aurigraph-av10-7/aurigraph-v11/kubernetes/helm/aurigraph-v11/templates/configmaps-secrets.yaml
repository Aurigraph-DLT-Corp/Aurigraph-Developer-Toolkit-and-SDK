{{/*
ConfigMaps and Secrets Management for Aurigraph V11
Environment-specific configuration and secure secret management
*/}}

{{/*
Main Application Configuration
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: configuration
data:
  # Blockchain Configuration
  blockchain.properties: |
    # Core Blockchain Settings
    blockchain.network.id={{ .Values.config.blockchain.networkId }}
    blockchain.consensus.algorithm={{ .Values.config.blockchain.consensusAlgorithm }}
    blockchain.block.time={{ .Values.config.blockchain.blockTime }}
    blockchain.max.transactions.per.block={{ .Values.config.blockchain.maxTransactionsPerBlock }}
    blockchain.target.tps={{ .Values.config.blockchain.targetTPS }}
    
    # Network Settings
    network.p2p.port={{ .Values.service.ports.p2p }}
    network.discovery.enabled=true
    network.max.peers=100
    network.connection.timeout=30000
    
    # Storage Settings
    storage.blockchain.path=/data/blockchain
    storage.logs.path=/data/logs
    storage.consensus.path=/data/consensus
    storage.network.path=/data/network

  # Quarkus Application Configuration
  application.properties: |
    # Server Configuration
    quarkus.http.port={{ .Values.service.ports.http }}
    quarkus.grpc.server.port={{ .Values.service.ports.grpc }}
    quarkus.management.port={{ .Values.service.ports.metrics }}
    
    # Native Image Configuration
    quarkus.native.enabled={{ .Values.config.performance.nativeImageEnabled }}
    quarkus.native.container-build=true
    quarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-graalvm:24-java21
    
    # Performance Configuration
    quarkus.vertx.event-loops-pool-size={{ .Values.config.performance.threadPoolSize }}
    quarkus.hibernate-orm.batch-fetch-size={{ .Values.config.performance.batchSize }}
    quarkus.reactive-messaging.metrics.enabled=true
    
    # Health Checks
    quarkus.health.enabled=true
    quarkus.health.extensions.enabled=true
    quarkus.smallrye-health.root-path=/health
    
    # Metrics
    quarkus.micrometer.enabled=true
    quarkus.micrometer.export.prometheus.enabled=true
    quarkus.micrometer.export.prometheus.path=/metrics
    
    # OpenTelemetry Tracing
    quarkus.otel.enabled=true
    quarkus.otel.exporter.otlp.traces.endpoint=http://{{ .Values.app.name }}-jaeger-collector:4317
    quarkus.otel.service.name={{ .Values.app.name }}
    quarkus.otel.traces.sampler={{ .Values.monitoring.jaeger.sampling.type }}
    quarkus.otel.traces.sampler.arg={{ .Values.monitoring.jaeger.sampling.param }}
    
    # Logging Configuration
    quarkus.log.level=INFO
    quarkus.log.console.enable=true
    quarkus.log.console.format=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e%n
    quarkus.log.console.json=true
    
    # Security Configuration
    quarkus.security.auth.enabled=true
    quarkus.oidc.enabled=false
    
    # Database Configuration (if needed)
    quarkus.datasource.jdbc=false
    quarkus.hibernate-orm.active=false

  # Consensus Configuration
  consensus.properties: |
    # HyperRAFT Configuration
    consensus.algorithm=hyperraft
    consensus.cluster.size={{ .Values.replicas.consensusService }}
    consensus.election.timeout=5000
    consensus.heartbeat.interval=1000
    consensus.log.compaction.enabled=true
    consensus.log.max.entries=10000
    
    # Quantum Sharding Configuration
    consensus.quantum.enabled=true
    consensus.shards.count=64
    consensus.parallel.processing=true
    consensus.interference.optimization=true

  # Cryptography Configuration
  crypto.properties: |
    # Post-Quantum Cryptography
    crypto.algorithm={{ .Values.config.cryptography.algorithm }}
    crypto.key.size={{ .Values.config.cryptography.keySize }}
    crypto.hash.algorithm={{ .Values.config.cryptography.hashAlgorithm }}
    crypto.signature.scheme={{ .Values.config.cryptography.signatureScheme }}
    
    # Key Management
    crypto.keys.rotation.enabled=true
    crypto.keys.rotation.interval=7d
    crypto.keys.storage.encrypted=true

  # Network Configuration
  network.properties: |
    # P2P Network Settings
    network.protocol.version=1.0
    network.node.id=${POD_NAME}
    network.bind.address=0.0.0.0
    network.bind.port={{ .Values.service.ports.p2p }}
    network.external.address=${POD_IP}
    network.external.port={{ .Values.service.ports.p2p }}
    
    # Discovery Configuration
    network.discovery.bootstrap.nodes=
    network.discovery.mdns.enabled=true
    network.discovery.dht.enabled=true
    
    # Connection Management
    network.max.connections=500
    network.connection.timeout=30000
    network.keep.alive.interval=60000

  # Cross-Chain Bridge Configuration
  bridge.properties: |
    # Supported Chains
    bridge.chains.ethereum.enabled=true
    bridge.chains.bitcoin.enabled=true
    bridge.chains.binance.enabled=true
    bridge.chains.polygon.enabled=true
    bridge.chains.avalanche.enabled=true
    bridge.chains.solana.enabled=true
    
    # Bridge Settings
    bridge.confirmation.blocks.ethereum=12
    bridge.confirmation.blocks.bitcoin=6
    bridge.fee.percentage=0.001
    bridge.max.transaction.amount=1000000
    
    # Atomic Swap Configuration
    bridge.atomic.swap.timeout=86400
    bridge.htlc.timeout=3600

  # AI Optimization Configuration
  ai.properties: |
    # Machine Learning Models
    ai.models.path=/data/ai-models
    ai.models.auto.update=true
    ai.models.update.interval=1h
    
    # Prediction Settings
    ai.prediction.enabled=true
    ai.prediction.horizon=1h
    ai.prediction.confidence.threshold=0.8
    
    # Optimization Settings
    ai.optimization.target=throughput
    ai.optimization.constraints=latency<1ms,cpu<80%

---
{{/*
Environment-Specific Configuration - Development
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-config-dev
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: configuration
    environment: development
data:
  override.properties: |
    # Development Overrides
    quarkus.log.level=DEBUG
    quarkus.dev.instrumentation=true
    quarkus.live.reload.instrumentation=true
    
    # Reduced Performance Requirements
    blockchain.target.tps=100000
    consensus.cluster.size=1
    network.max.peers=10
    
    # Relaxed Security
    crypto.keys.rotation.enabled=false
    network.discovery.bootstrap.nodes=localhost:7001,localhost:7002

---
{{/*
Environment-Specific Configuration - Staging
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-config-staging
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: configuration
    environment: staging
data:
  override.properties: |
    # Staging Overrides
    quarkus.log.level=INFO
    
    # Moderate Performance Requirements
    blockchain.target.tps=1000000
    consensus.cluster.size=3
    network.max.peers=50
    
    # Enhanced Monitoring
    quarkus.otel.traces.sampler.arg=0.5
    quarkus.micrometer.export.prometheus.step=PT10S

---
{{/*
Environment-Specific Configuration - Production
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-config-prod
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: configuration
    environment: production
data:
  override.properties: |
    # Production Overrides
    quarkus.log.level=WARN
    quarkus.log.console.json=true
    
    # Maximum Performance Requirements
    blockchain.target.tps={{ .Values.config.blockchain.targetTPS }}
    consensus.cluster.size={{ .Values.replicas.consensusService }}
    network.max.peers=100
    
    # Production Security
    crypto.keys.rotation.enabled=true
    crypto.keys.rotation.interval=7d
    
    # Optimized Monitoring
    quarkus.otel.traces.sampler.arg={{ .Values.monitoring.jaeger.sampling.param }}

---
{{/*
Grafana Dashboards ConfigMap
*/}}
{{- if .Values.monitoring.grafana.dashboards.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-grafana-dashboards
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: monitoring
    grafana_dashboard: "true"
data:
  aurigraph-overview.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Aurigraph V11 - Platform Overview",
        "description": "High-level overview of Aurigraph blockchain platform",
        "tags": ["aurigraph", "blockchain", "overview"],
        "timezone": "utc",
        "panels": [
          {
            "id": 1,
            "title": "Transaction Throughput (TPS)",
            "type": "stat",
            "targets": [
              {
                "expr": "rate(aurigraph_transactions_processed_total[1m])",
                "legendFormat": "TPS"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 1000000},
                    {"color": "green", "value": 2000000}
                  ]
                }
              }
            }
          },
          {
            "id": 2,
            "title": "Block Production Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(aurigraph_blocks_produced_total[5m])",
                "legendFormat": "Blocks/min"
              }
            ]
          },
          {
            "id": 3,
            "title": "Consensus Health",
            "type": "stat",
            "targets": [
              {
                "expr": "aurigraph_consensus_leader_elections_total",
                "legendFormat": "Leader Elections"
              }
            ]
          }
        ],
        "time": {"from": "now-1h", "to": "now"},
        "refresh": "5s"
      }
    }

  aurigraph-performance.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Aurigraph V11 - Performance Metrics",
        "description": "Detailed performance metrics for Aurigraph platform",
        "tags": ["aurigraph", "blockchain", "performance"],
        "timezone": "utc",
        "panels": [
          {
            "id": 1,
            "title": "Transaction Latency",
            "type": "heatmap",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(aurigraph_transaction_duration_seconds_bucket[5m]))",
                "legendFormat": "95th Percentile"
              },
              {
                "expr": "histogram_quantile(0.99, rate(aurigraph_transaction_duration_seconds_bucket[5m]))",
                "legendFormat": "99th Percentile"
              }
            ]
          },
          {
            "id": 2,
            "title": "CPU Usage by Service",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{pod=~\"aurigraph-v11-.*\"}[5m])",
                "legendFormat": "{{pod}}"
              }
            ]
          },
          {
            "id": 3,
            "title": "Memory Usage by Service",
            "type": "graph",
            "targets": [
              {
                "expr": "container_memory_working_set_bytes{pod=~\"aurigraph-v11-.*\"}",
                "legendFormat": "{{pod}}"
              }
            ]
          }
        ],
        "time": {"from": "now-1h", "to": "now"},
        "refresh": "10s"
      }
    }

  aurigraph-network.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Aurigraph V11 - Network Metrics",
        "description": "P2P network and connectivity metrics",
        "tags": ["aurigraph", "blockchain", "network"],
        "timezone": "utc",
        "panels": [
          {
            "id": 1,
            "title": "Active Peer Connections",
            "type": "stat",
            "targets": [
              {
                "expr": "aurigraph_network_peers_connected",
                "legendFormat": "Connected Peers"
              }
            ]
          },
          {
            "id": 2,
            "title": "Network Throughput",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(aurigraph_network_bytes_sent_total[5m])",
                "legendFormat": "Bytes Sent/sec"
              },
              {
                "expr": "rate(aurigraph_network_bytes_received_total[5m])",
                "legendFormat": "Bytes Received/sec"
              }
            ]
          },
          {
            "id": 3,
            "title": "Message Types Distribution",
            "type": "pie",
            "targets": [
              {
                "expr": "aurigraph_network_messages_by_type",
                "legendFormat": "{{message_type}}"
              }
            ]
          }
        ],
        "time": {"from": "now-1h", "to": "now"},
        "refresh": "15s"
      }
    }
{{- end }}

---
{{/*
Bootstrap Scripts ConfigMap
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-scripts
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Values.app.name }}
    app.kubernetes.io/version: {{ .Values.app.version }}
    app.kubernetes.io/component: configuration
data:
  init-blockchain.sh: |
    #!/bin/bash
    set -e
    
    echo "=== Aurigraph V11 Blockchain Initialization ==="
    
    # Initialize blockchain data directory
    mkdir -p /data/blockchain/{blocks,state,transactions}
    mkdir -p /data/logs/{application,consensus,network}
    mkdir -p /data/consensus/{raft,snapshots}
    mkdir -p /data/network/{peers,discovery}
    
    # Set proper permissions
    chown -R 1000:1000 /data
    chmod -R 755 /data
    
    # Generate node ID if not exists
    if [ ! -f /data/blockchain/node-id ]; then
        echo "Generating unique node ID..."
        openssl rand -hex 32 > /data/blockchain/node-id
        echo "Node ID: $(cat /data/blockchain/node-id)"
    fi
    
    # Initialize genesis block if needed
    if [ ! -f /data/blockchain/genesis.block ]; then
        echo "Creating genesis block..."
        cat > /data/blockchain/genesis.block << EOF
    {
      "version": "11.0.0",
      "timestamp": "$(date -u +%s)",
      "previous_hash": "0000000000000000000000000000000000000000000000000000000000000000",
      "merkle_root": "$(openssl rand -hex 32)",
      "difficulty": 1,
      "nonce": 0,
      "transactions": []
    }
    EOF
        echo "Genesis block created"
    fi
    
    echo "=== Blockchain initialization completed ==="

  health-check.sh: |
    #!/bin/bash
    # Comprehensive health check script
    
    # Check if service is responding
    if ! curl -f http://localhost:{{ .Values.service.ports.http }}/health/ready; then
        echo "FAILED: Service not responding"
        exit 1
    fi
    
    # Check blockchain sync status
    BLOCK_HEIGHT=$(curl -s http://localhost:{{ .Values.service.ports.http }}/api/v1/blockchain/height)
    if [ "$BLOCK_HEIGHT" -lt 1 ]; then
        echo "FAILED: Blockchain not synced"
        exit 1
    fi
    
    # Check consensus participation
    CONSENSUS_STATUS=$(curl -s http://localhost:{{ .Values.service.ports.http }}/api/v1/consensus/status)
    if echo "$CONSENSUS_STATUS" | grep -q "error"; then
        echo "FAILED: Consensus issues detected"
        exit 1
    fi
    
    # Check network connectivity
    PEER_COUNT=$(curl -s http://localhost:{{ .Values.service.ports.http }}/api/v1/network/peers/count)
    if [ "$PEER_COUNT" -lt 1 ]; then
        echo "WARNING: No network peers connected"
    fi
    
    echo "OK: All health checks passed"
    exit 0

  backup-blockchain.sh: |
    #!/bin/bash
    set -e
    
    echo "=== Aurigraph V11 Blockchain Backup ==="
    
    BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
    BACKUP_DIR="/backup/blockchain_${BACKUP_DATE}"
    
    mkdir -p "$BACKUP_DIR"
    
    # Stop blockchain services gracefully
    echo "Initiating graceful shutdown for backup..."
    curl -X POST http://localhost:{{ .Values.service.ports.http }}/api/v1/admin/shutdown/prepare
    
    # Wait for graceful shutdown
    sleep 30
    
    # Backup blockchain data
    echo "Backing up blockchain data..."
    cp -r /data/blockchain "$BACKUP_DIR/"
    
    # Backup consensus data
    echo "Backing up consensus data..."
    cp -r /data/consensus "$BACKUP_DIR/"
    
    # Create manifest
    cat > "$BACKUP_DIR/manifest.json" << EOF
    {
      "backup_date": "$(date -u +%s)",
      "version": "{{ .Values.app.version }}",
      "network": "{{ .Values.config.blockchain.networkId }}",
      "block_height": $(cat /data/blockchain/current_height 2>/dev/null || echo 0)
    }
    EOF
    
    # Compress backup
    tar -czf "/backup/aurigraph_backup_${BACKUP_DATE}.tar.gz" -C /backup "blockchain_${BACKUP_DATE}"
    rm -rf "$BACKUP_DIR"
    
    echo "=== Backup completed: aurigraph_backup_${BACKUP_DATE}.tar.gz ==="
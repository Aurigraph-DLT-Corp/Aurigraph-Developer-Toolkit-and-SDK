# Aurigraph V12 Multi-Node JVM Infrastructure (Memory Optimized)
# 4 Containers running 32 nodes total (JVM Mode)
# Memory-optimized: ~8GB total vs ~32GB original
# - validator-cluster-1: 4 validator nodes (ports 9003-9006) ~1.4GB
# - validator-cluster-2: 3 validator nodes (ports 9007-9009) ~1.1GB
# - business-cluster: 20 business nodes (ports 9020-9039) ~4GB
# - slim-cluster: 5 slim nodes (ports 9050-9054) ~0.75GB

# Database and Bridge environment variables (shared across all containers)
x-db-env: &db-env
  QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://host.docker.internal:5432/j4c_db
  QUARKUS_DATASOURCE_USERNAME: j4c_user
  QUARKUS_DATASOURCE_PASSWORD: j4c_password
  # Bridge placeholder configuration
  BRIDGE_ETH_KEY: placeholder
  BRIDGE_SOL_KEY: placeholder
  BRIDGE_LZ_RELAYER: placeholder
  BRIDGE_LZ_ORACLE: placeholder
  BRIDGE_LZ_KEY: placeholder
  BRIDGE_SOL_PROGRAM: placeholder
  # Quantum API placeholder
  CURBY_QUANTUM_API_KEY: placeholder

services:
  # ==========================================
  # VALIDATOR CLUSTER 1 (4 nodes in 1 container)
  # JVM Mode with Temurin JDK 21
  # Ports: 9003-9006 (HTTP), 9103-9106 (gRPC)
  # ==========================================
  validator-cluster-1:
    image: eclipse-temurin:21-jre-alpine
    container_name: aurigraph-validator-cluster-1
    hostname: validator-cluster-1
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - aurigraph-network
    environment:
      <<: *db-env
      NODE_TYPE: validator
      CLUSTER_NAME: validator-cluster-1
      # Memory optimization settings (optimized with 64 thread pool)
      JAVA_OPTS: "-Xms256m -Xmx768m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -XX:InitiatingHeapOccupancyPercent=45 -XX:G1HeapRegionSize=4m -XX:MaxMetaspaceSize=192m -Xss512k -XX:ActiveProcessorCount=2 -Daurigraph.thread.pool.size=64"
    volumes:
      - validator-data-1:/data
      - ./quarkus-app:/app/quarkus-app:ro
      - ./scripts/run-validators-1-jvm.sh:/app/run-validators.sh:ro
      - validator-logs-1:/var/log
    working_dir: /app
    command: ["/bin/sh", "/app/run-validators.sh"]
    ports:
      # Validator HTTP ports (9003-9006 -> 19001-19004)
      - "19001:9003"
      - "19002:9004"
      - "19003:9005"
      - "19004:9006"
      # Validator gRPC ports (9103-9106 -> 19101-19104)
      - "19101:9103"
      - "19102:9104"
      - "19103:9105"
      - "19104:9106"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9003/q/health/live"]
      interval: 30s
      timeout: 10s
      retries: 15
      start_period: 240s  # 4 minutes for migration + startup
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 5G    # ~768MB heap + 192MB metaspace + overhead per node x 4 = ~4GB
        reservations:
          cpus: '2'
          memory: 3G

  # ==========================================
  # VALIDATOR CLUSTER 2 (3 nodes in 1 container)
  # JVM Mode with Temurin JDK 21
  # Ports: 9007-9009 (HTTP), 9107-9109 (gRPC)
  # ==========================================
  validator-cluster-2:
    image: eclipse-temurin:21-jre-alpine
    container_name: aurigraph-validator-cluster-2
    hostname: validator-cluster-2
    restart: unless-stopped
    depends_on:
      validator-cluster-1:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - aurigraph-network
    environment:
      <<: *db-env
      NODE_TYPE: validator
      CLUSTER_NAME: validator-cluster-2
      # Memory optimization settings (optimized with 64 thread pool)
      JAVA_OPTS: "-Xms256m -Xmx768m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -XX:InitiatingHeapOccupancyPercent=45 -XX:G1HeapRegionSize=4m -XX:MaxMetaspaceSize=192m -Xss512k -XX:ActiveProcessorCount=2 -Daurigraph.thread.pool.size=64"
    volumes:
      - validator-data-2:/data
      - ./quarkus-app:/app/quarkus-app:ro
      - ./scripts/run-validators-2-jvm.sh:/app/run-validators.sh:ro
      - validator-logs-2:/var/log
    working_dir: /app
    command: ["/bin/sh", "/app/run-validators.sh"]
    ports:
      # Validator HTTP ports (9007-9009 -> 19005-19007)
      - "19005:9007"
      - "19006:9008"
      - "19007:9009"
      # Validator gRPC ports (9107-9109 -> 19105-19107)
      - "19105:9107"
      - "19106:9108"
      - "19107:9109"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9007/q/health/live"]
      interval: 30s
      timeout: 10s
      retries: 15
      start_period: 180s  # 3 minutes (no migration needed)
    deploy:
      resources:
        limits:
          cpus: '3'
          memory: 4G    # ~768MB heap + 192MB metaspace + overhead per node x 3 = ~3GB
        reservations:
          cpus: '1'
          memory: 2G

  # ==========================================
  # BUSINESS CLUSTER (20 nodes in 1 container)
  # JVM Mode with Temurin JDK 21
  # Ports: 9020-9039 (HTTP)
  # ==========================================
  business-cluster:
    image: eclipse-temurin:21-jre-alpine
    container_name: aurigraph-business-cluster
    hostname: business-cluster
    restart: unless-stopped
    depends_on:
      validator-cluster-1:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - aurigraph-network
    environment:
      <<: *db-env
      NODE_TYPE: business
      CLUSTER_NAME: business-cluster
      # Memory optimization settings (optimized with 64 thread pool)
      JAVA_OPTS: "-Xms128m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -XX:InitiatingHeapOccupancyPercent=45 -XX:G1HeapRegionSize=2m -XX:MaxMetaspaceSize=160m -Xss384k -XX:ActiveProcessorCount=1 -Daurigraph.thread.pool.size=64"
    volumes:
      - business-data:/data
      - ./quarkus-app:/app/quarkus-app:ro
      - ./scripts/run-business-jvm.sh:/app/run-business.sh:ro
      - business-logs:/var/log
    working_dir: /app
    command: ["/bin/sh", "/app/run-business.sh"]
    ports:
      # Business HTTP ports (9020-9039 -> 19011-19030)
      - "19011:9020"
      - "19012:9021"
      - "19013:9022"
      - "19014:9023"
      - "19015:9024"
      - "19016:9025"
      - "19017:9026"
      - "19018:9027"
      - "19019:9028"
      - "19020:9029"
      - "19021:9030"
      - "19022:9031"
      - "19023:9032"
      - "19024:9033"
      - "19025:9034"
      - "19026:9035"
      - "19027:9036"
      - "19028:9037"
      - "19029:9038"
      - "19030:9039"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9020/q/health/live"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 15G    # ~512MB heap + 160MB metaspace + overhead per node x 20 = ~14GB
        reservations:
          cpus: '4'
          memory: 10G

  # ==========================================
  # SLIM CLUSTER (5 nodes in 1 container)
  # JVM Mode with Temurin JDK 21
  # Ports: 9050-9054 (HTTP)
  # ==========================================
  slim-cluster:
    image: eclipse-temurin:21-jre-alpine
    container_name: aurigraph-slim-cluster
    hostname: slim-cluster
    restart: unless-stopped
    depends_on:
      validator-cluster-1:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - aurigraph-network
    environment:
      <<: *db-env
      NODE_TYPE: slim
      CLUSTER_NAME: slim-cluster
      # Memory optimization settings (optimized with 64 thread pool)
      JAVA_OPTS: "-Xms64m -Xmx384m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -XX:InitiatingHeapOccupancyPercent=45 -XX:G1HeapRegionSize=2m -XX:MaxMetaspaceSize=96m -Xss384k -XX:ActiveProcessorCount=1 -Daurigraph.thread.pool.size=64"
    volumes:
      - slim-data:/data
      - ./quarkus-app:/app/quarkus-app:ro
      - ./scripts/run-slim-jvm.sh:/app/run-slim.sh:ro
      - slim-logs:/var/log
    working_dir: /app
    command: ["/bin/sh", "/app/run-slim.sh"]
    ports:
      # Slim HTTP ports (9050-9054 -> 19041-19045)
      - "19041:9050"
      - "19042:9051"
      - "19043:9052"
      - "19044:9053"
      - "19045:9054"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9050/q/health/live"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 3G    # ~384MB heap + 96MB metaspace + overhead per node x 5 = ~2.4GB
        reservations:
          cpus: '1'
          memory: 2G

networks:
  aurigraph-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  validator-data-1:
  validator-logs-1:
  validator-data-2:
  validator-logs-2:
  business-data:
  business-logs:
  slim-data:
  slim-logs:

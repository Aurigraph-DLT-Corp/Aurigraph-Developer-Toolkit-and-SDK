# Aurigraph V4.4.4 - Core Services Deployment
# V11 API, Enterprise Portal, NGINX, PostgreSQL, Redis, Prometheus, Grafana
# Infrastructure services that are stable and rarely need redeployment
# Usage: docker-compose -f docker-compose-core.yml up -d

version: '3.8'

# Shared networks across all services
networks:
  dlt-frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  dlt-backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
  dlt-monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16

# Persistent volumes for data durability
volumes:
  dlt-data:
    driver: local
  dlt-postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/dlt/postgres-data
  dlt-redis-data:
    driver: local
  dlt-prometheus-data:
    driver: local
  dlt-grafana-data:
    driver: local
  dlt-logs:
    driver: local

services:
  # =========================================================================
  # PostgreSQL Database - Stable Infrastructure Service
  # =========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: dlt-postgres
    restart: unless-stopped

    environment:
      - POSTGRES_DB=aurigraph_production
      - POSTGRES_USER=aurigraph
      - POSTGRES_PASSWORD=${DB_PASSWORD:-aurigraph-prod-secure-2025}
      - POSTGRES_INITDB_ARGS=--auth-local=trust

    volumes:
      - dlt-postgres-data:/var/lib/postgresql/data
      - ./config/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aurigraph"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - dlt-backend

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2.0'
        reservations:
          memory: 256M

    labels:
      - "com.dlt.service=postgres"
      - "com.dlt.tier=database"
      - "com.dlt.stability=stable"

  # =========================================================================
  # Redis Cache - Stable Infrastructure Service
  # =========================================================================
  redis:
    image: redis:7-alpine
    container_name: dlt-redis
    restart: unless-stopped

    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-redis-secure-2025}

    volumes:
      - dlt-redis-data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    networks:
      - dlt-backend

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M

    labels:
      - "com.dlt.service=redis"
      - "com.dlt.tier=cache"
      - "com.dlt.stability=stable"

  # =========================================================================
  # Prometheus Metrics - Stable Infrastructure Service
  # =========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: dlt-prometheus
    restart: unless-stopped

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'

    volumes:
      - dlt-prometheus-data:/prometheus
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/prometheus/rules:/etc/prometheus/rules:ro

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    networks:
      - dlt-monitoring

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M

    labels:
      - "com.dlt.service=prometheus"
      - "com.dlt.tier=monitoring"
      - "com.dlt.stability=stable"

  # =========================================================================
  # Grafana Dashboards - Stable Infrastructure Service
  # =========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: dlt-grafana
    restart: unless-stopped

    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_DOMAIN=dlt.aurigraph.io
      - GF_SERVER_ROOT_URL=https://dlt.aurigraph.io/grafana
      - GF_PLUGINS_SKIP_PLUGIN_PREINSTALL_CHECK=true

    volumes:
      - dlt-grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - dlt-monitoring
      - dlt-frontend

    depends_on:
      prometheus:
        condition: service_healthy

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M

    labels:
      - "com.dlt.service=grafana"
      - "com.dlt.tier=monitoring"
      - "com.dlt.stability=stable"

  # =========================================================================
  # Aurigraph V11 API Service - Core Application Service
  # =========================================================================
  aurigraph-v11-service:
    image: aurigraph-v11:11.4.4
    container_name: dlt-aurigraph-v11
    restart: unless-stopped

    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '4.0'
        reservations:
          memory: 512M

    environment:
      # Quarkus Configuration
      - QUARKUS_PROFILE=production
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_HTTP_HTTP2=true

      # Aurigraph Node Configuration
      - AURIGRAPH_NODE_ID=v11-standalone-1
      - AURIGRAPH_MODE=production

      # Bridge Service Configuration (Sprint 15)
      - BRIDGE_SERVICE_ENABLED=true
      - BRIDGE_TRANSFER_FEE_PERCENTAGE=0.12
      - BRIDGE_SWAP_TIMEOUT_MS=300000
      - BRIDGE_HTLC_ENABLED=true

      # Performance Configuration
      - CONSENSUS_TARGET_TPS=776000
      - AI_OPTIMIZATION_ENABLED=true
      - QUANTUM_CRYPTO_ENABLED=true
      - NATIVE_MODE=true

      # Memory optimization
      - MALLOC_ARENA_MAX=2
      - MALLOC_MMAP_THRESHOLD_=65536
      - JAVA_OPTS=-Xms256m -Xmx2g

      # Database Configuration (Docker network DNS)
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://postgres:5432/aurigraph_production
      - QUARKUS_DATASOURCE_USERNAME=aurigraph
      - QUARKUS_DATASOURCE_PASSWORD=aurigraph-prod-secure-2025

      # Hibernate ORM Configuration - Skip schema validation/generation
      - QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=validate
      - QUARKUS_HIBERNATE_ORM_JDBC_STATEMENT_BATCH_SIZE=20
      - QUARKUS_HIBERNATE_ORM_JDBC_FETCH_SIZE=50

    ports:
      - "9003:9003"  # REST API (internal)
      - "9004:9004"  # gRPC (internal)

    volumes:
      - dlt-data:/deployments/data
      - dlt-logs:/deployments/logs
      - ./config/v11:/deployments/config:ro

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9003/q/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      dlt-backend:
        ipv4_address: 172.21.1.10
      dlt-frontend:
        ipv4_address: 172.20.1.10
      dlt-monitoring:
        ipv4_address: 172.22.1.10

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      prometheus:
        condition: service_healthy

    security_opt:
      - no-new-privileges:true

    labels:
      - "com.dlt.service=aurigraph-v11"
      - "com.dlt.tier=backend"
      - "com.dlt.version=11.4.4"

  # =========================================================================
  # NGINX Reverse Proxy - Core Infrastructure Service
  # =========================================================================
  nginx-gateway:
    image: nginx:1.25-alpine
    container_name: dlt-nginx-gateway
    restart: unless-stopped

    ports:
      - "80:80"      # HTTP (auto-redirect to HTTPS)
      - "443:443"    # HTTPS

    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
      - /etc/letsencrypt/live/aurcrt/fullchain.pem:/etc/nginx/ssl/fullchain.pem:ro
      - /etc/letsencrypt/live/aurcrt/privkey.pem:/etc/nginx/ssl/privkey.pem:ro

    environment:
      - DOMAIN=dlt.aurigraph.io
      - TLS_ENABLED=true

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 -O - http://localhost/health || curl -s http://localhost/health > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    networks:
      - dlt-frontend
      - dlt-backend

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      aurigraph-v11-service:
        condition: service_started

    labels:
      - "com.dlt.service=nginx-gateway"
      - "com.dlt.tier=frontend"
      - "com.dlt.stability=stable"

  # =========================================================================
  # Enterprise Portal - Frontend Application Service
  # =========================================================================
  enterprise-portal:
    image: node:20-alpine
    container_name: dlt-portal
    restart: unless-stopped
    working_dir: /app
    command: sh /app/start-portal.sh
    ports:
      - "3000:3000"

    environment:
      - REACT_APP_API_BASE_URL=https://dlt.aurigraph.io/api/v11
      - REACT_APP_DOMAIN=dlt.aurigraph.io
      - NODE_ENV=production
      - GENERATE_SOURCEMAP=false

    volumes:
      - ./enterprise-portal/enterprise-portal/frontend:/app
      - ./start-portal.sh:/app/start-portal.sh:ro

    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep 'http-server' | grep -v grep || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - dlt-frontend

    depends_on:
      - aurigraph-v11-service

    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 64M

    labels:
      - "com.dlt.service=enterprise-portal"
      - "com.dlt.tier=frontend"

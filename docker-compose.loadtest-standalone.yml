# Aurigraph V11 - Standalone Load Testing Cluster
# Simple 9-node configuration without external service dependencies
# Validator (3) + Business (3) + Slim (3) nodes
version: '3.8'

networks:
  dlt-consensus:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16
  dlt-backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  validator-1-data:
  validator-2-data:
  validator-3-data:
  business-1-data:
  business-2-data:
  business-3-data:
  slim-1-data:
  slim-2-data:
  slim-3-data:

services:
  # VALIDATOR NODES (Primary Consensus - 3x)
  validator-node-1:
    image: openjdk:21-slim
    container_name: validator-node-1
    hostname: validator-node-1
    restart: unless-stopped
    command: /bin/sh -c "echo 'Validator Node 1 (Primary) ready' && sleep infinity"
    environment:
      - NODE_TYPE=VALIDATOR
      - NODE_ID=validator-1
      - NODE_ROLE=consensus_primary
      - QUARKUS_HTTP_PORT=9003
      - CONSENSUS_MODE=HyperRAFT_PLUS_PLUS
      - CONSENSUS_LEADER_TIMEOUT=300
      - CONSENSUS_HEARTBEAT_INTERVAL=50
      - REPLICATION_BATCH_SIZE=32
      - TRANSACTION_POOL_SIZE=100000
      - ENABLE_METRICS=true
      - LOG_LEVEL=INFO
      - DATABASE_ENGINE=LEVELDB
      - LEVELDB_DATA_PATH=/data/leveldb
      - LEVELDB_BLOCK_CACHE_SIZE=134217728
      - LEVELDB_WRITE_BUFFER_SIZE=67108864
      - LEVELDB_COMPRESSION=snappy
    ports:
      - "9003:9003"
      - "9004:9004"
    volumes:
      - validator-1-data:/data
    networks:
      - dlt-consensus
      - dlt-backend
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '8.0'

  validator-node-2:
    image: openjdk:21-slim
    container_name: validator-node-2
    hostname: validator-node-2
    restart: unless-stopped
    command: /bin/sh -c "echo 'Validator Node 2 ready' && sleep infinity"
    environment:
      - NODE_TYPE=VALIDATOR
      - NODE_ID=validator-2
      - NODE_ROLE=consensus_replica
      - QUARKUS_HTTP_PORT=9003
      - CONSENSUS_MODE=HyperRAFT_PLUS_PLUS
      - CONSENSUS_LEADER_TIMEOUT=300
      - CONSENSUS_HEARTBEAT_INTERVAL=50
      - REPLICATION_BATCH_SIZE=32
      - TRANSACTION_POOL_SIZE=100000
      - ENABLE_METRICS=true
      - LOG_LEVEL=INFO
      - DATABASE_ENGINE=LEVELDB
      - LEVELDB_DATA_PATH=/data/leveldb
      - LEVELDB_BLOCK_CACHE_SIZE=134217728
      - LEVELDB_WRITE_BUFFER_SIZE=67108864
      - LEVELDB_COMPRESSION=snappy
      - PEER_NODES=validator-node-1,validator-node-3,business-node-1
    ports:
      - "9005:9003"
      - "9006:9004"
    volumes:
      - validator-2-data:/data
    networks:
      - dlt-consensus
      - dlt-backend
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '8.0'

  validator-node-3:
    image: openjdk:21-slim
    container_name: validator-node-3
    hostname: validator-node-3
    restart: unless-stopped
    command: /bin/sh -c "echo 'Validator Node 3 ready' && sleep infinity"
    environment:
      - NODE_TYPE=VALIDATOR
      - NODE_ID=validator-3
      - NODE_ROLE=consensus_replica
      - QUARKUS_HTTP_PORT=9003
      - CONSENSUS_MODE=HyperRAFT_PLUS_PLUS
      - CONSENSUS_LEADER_TIMEOUT=300
      - CONSENSUS_HEARTBEAT_INTERVAL=50
      - REPLICATION_BATCH_SIZE=32
      - TRANSACTION_POOL_SIZE=100000
      - ENABLE_METRICS=true
      - LOG_LEVEL=INFO
      - DATABASE_ENGINE=LEVELDB
      - LEVELDB_DATA_PATH=/data/leveldb
      - LEVELDB_BLOCK_CACHE_SIZE=134217728
      - LEVELDB_WRITE_BUFFER_SIZE=67108864
      - LEVELDB_COMPRESSION=snappy
      - PEER_NODES=validator-node-1,validator-node-2,business-node-1
    ports:
      - "9007:9003"
      - "9008:9004"
    volumes:
      - validator-3-data:/data
    networks:
      - dlt-consensus
      - dlt-backend
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '8.0'

  # BUSINESS NODES (Transaction Processing - 3x)
  business-node-1:
    image: openjdk:21-slim
    container_name: business-node-1
    hostname: business-node-1
    restart: unless-stopped
    command: /bin/sh -c "echo 'Business Node 1 ready' && sleep infinity"
    environment:
      - NODE_TYPE=BUSINESS
      - NODE_ID=business-1
      - NODE_ROLE=transaction_processor
      - QUARKUS_HTTP_PORT=9003
      - TRANSACTION_POOL_SIZE=200000
      - PARALLEL_TX_THREADS=16
      - ENABLE_CONTRACT_EXECUTION=true
      - ENABLE_METRICS=true
      - LOG_LEVEL=INFO
      - DATABASE_ENGINE=LEVELDB
      - LEVELDB_DATA_PATH=/data/leveldb
      - LEVELDB_BLOCK_CACHE_SIZE=134217728
      - LEVELDB_WRITE_BUFFER_SIZE=67108864
      - LEVELDB_COMPRESSION=snappy
      - PEER_NODES=validator-node-1,validator-node-2,validator-node-3
    ports:
      - "9009:9003"
      - "9010:9004"
    volumes:
      - business-1-data:/data
    networks:
      - dlt-consensus
      - dlt-backend
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 3G
          cpus: '6.0'

  business-node-2:
    image: openjdk:21-slim
    container_name: business-node-2
    hostname: business-node-2
    restart: unless-stopped
    command: /bin/sh -c "echo 'Business Node 2 ready' && sleep infinity"
    environment:
      - NODE_TYPE=BUSINESS
      - NODE_ID=business-2
      - NODE_ROLE=transaction_processor
      - QUARKUS_HTTP_PORT=9003
      - TRANSACTION_POOL_SIZE=200000
      - PARALLEL_TX_THREADS=16
      - ENABLE_CONTRACT_EXECUTION=true
      - ENABLE_METRICS=true
      - LOG_LEVEL=INFO
      - DATABASE_ENGINE=LEVELDB
      - LEVELDB_DATA_PATH=/data/leveldb
      - LEVELDB_BLOCK_CACHE_SIZE=134217728
      - LEVELDB_WRITE_BUFFER_SIZE=67108864
      - LEVELDB_COMPRESSION=snappy
      - PEER_NODES=validator-node-1,validator-node-2,validator-node-3
    ports:
      - "9011:9003"
      - "9012:9004"
    volumes:
      - business-2-data:/data
    networks:
      - dlt-consensus
      - dlt-backend
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 3G
          cpus: '6.0'

  business-node-3:
    image: openjdk:21-slim
    container_name: business-node-3
    hostname: business-node-3
    restart: unless-stopped
    command: /bin/sh -c "echo 'Business Node 3 ready' && sleep infinity"
    environment:
      - NODE_TYPE=BUSINESS
      - NODE_ID=business-3
      - NODE_ROLE=transaction_processor
      - QUARKUS_HTTP_PORT=9003
      - TRANSACTION_POOL_SIZE=200000
      - PARALLEL_TX_THREADS=16
      - ENABLE_CONTRACT_EXECUTION=true
      - ENABLE_METRICS=true
      - LOG_LEVEL=INFO
      - DATABASE_ENGINE=LEVELDB
      - LEVELDB_DATA_PATH=/data/leveldb
      - LEVELDB_BLOCK_CACHE_SIZE=134217728
      - LEVELDB_WRITE_BUFFER_SIZE=67108864
      - LEVELDB_COMPRESSION=snappy
      - PEER_NODES=validator-node-1,validator-node-2,validator-node-3
    ports:
      - "9013:9003"
      - "9014:9004"
    volumes:
      - business-3-data:/data
    networks:
      - dlt-consensus
      - dlt-backend
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 3G
          cpus: '6.0'

  # SLIM NODES (Load Balancers - 3x)
  slim-node-1:
    image: openjdk:21-slim
    container_name: slim-node-1
    hostname: slim-node-1
    restart: unless-stopped
    command: /bin/sh -c "echo 'Slim Node 1 ready' && sleep infinity"
    environment:
      - NODE_TYPE=SLIM
      - NODE_ID=slim-1
      - NODE_ROLE=load_balancer
      - QUARKUS_HTTP_PORT=9003
      - MEMORY_MODE=MINIMAL
      - ENABLE_METRICS=true
      - LOG_LEVEL=WARN
      - DATABASE_ENGINE=LEVELDB
      - LEVELDB_DATA_PATH=/data/leveldb
      - LEVELDB_BLOCK_CACHE_SIZE=134217728
      - LEVELDB_WRITE_BUFFER_SIZE=67108864
      - LEVELDB_COMPRESSION=snappy
      - PEER_NODES=business-node-1,business-node-2,business-node-3
    ports:
      - "9015:9003"
    volumes:
      - slim-1-data:/data
    networks:
      - dlt-backend
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/status"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2.0'

  slim-node-2:
    image: openjdk:21-slim
    container_name: slim-node-2
    hostname: slim-node-2
    restart: unless-stopped
    command: /bin/sh -c "echo 'Slim Node 2 ready' && sleep infinity"
    environment:
      - NODE_TYPE=SLIM
      - NODE_ID=slim-2
      - NODE_ROLE=load_balancer
      - QUARKUS_HTTP_PORT=9003
      - MEMORY_MODE=MINIMAL
      - ENABLE_METRICS=true
      - LOG_LEVEL=WARN
      - DATABASE_ENGINE=LEVELDB
      - LEVELDB_DATA_PATH=/data/leveldb
      - LEVELDB_BLOCK_CACHE_SIZE=134217728
      - LEVELDB_WRITE_BUFFER_SIZE=67108864
      - LEVELDB_COMPRESSION=snappy
      - PEER_NODES=business-node-1,business-node-2,business-node-3
    ports:
      - "9016:9003"
    volumes:
      - slim-2-data:/data
    networks:
      - dlt-backend
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/status"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2.0'

  slim-node-3:
    image: openjdk:21-slim
    container_name: slim-node-3
    hostname: slim-node-3
    restart: unless-stopped
    command: /bin/sh -c "echo 'Slim Node 3 ready' && sleep infinity"
    environment:
      - NODE_TYPE=SLIM
      - NODE_ID=slim-3
      - NODE_ROLE=load_balancer
      - QUARKUS_HTTP_PORT=9003
      - MEMORY_MODE=MINIMAL
      - ENABLE_METRICS=true
      - LOG_LEVEL=WARN
      - DATABASE_ENGINE=LEVELDB
      - LEVELDB_DATA_PATH=/data/leveldb
      - LEVELDB_BLOCK_CACHE_SIZE=134217728
      - LEVELDB_WRITE_BUFFER_SIZE=67108864
      - LEVELDB_COMPRESSION=snappy
      - PEER_NODES=business-node-1,business-node-2,business-node-3
    ports:
      - "9017:9003"
    volumes:
      - slim-3-data:/data
    networks:
      - dlt-backend
    healthcheck:
      test: ["CMD-SHELL", "test -f /proc/1/status"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2.0'

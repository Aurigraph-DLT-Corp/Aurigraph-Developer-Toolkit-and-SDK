# ================================================================================
# AUREX LAUNCHPAD™ CI/CD TEST AUTOMATION
# Comprehensive testing pipeline for backend and frontend
# Ticket: LAUNCHPAD-401 - Testing & Validation Suite (21 story points)
# Created: August 7, 2025
# ================================================================================

name: Test Automation Pipeline

on:
  push:
    branches: [ main, develop, Release* ]
    paths:
      - 'backend/**'
      - 'frontend/**' 
      - '.github/workflows/**'
      - 'requirements*.txt'
      - 'package*.json'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/**'
      - 'requirements*.txt'
      - 'package*.json'

# Concurrency control to cancel previous runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Python configuration
  PYTHON_VERSION: '3.11'
  
  # Node.js configuration  
  NODE_VERSION: '18'
  
  # Testing environment variables
  TESTING: true
  CI: true
  DATABASE_URL: 'postgresql://postgres:testpass@localhost:5432/aurex_test'
  REDIS_URL: 'redis://localhost:6379/1'
  JWT_SECRET_KEY: 'test-secret-key-for-ci-only'
  JWT_ALGORITHM: 'HS256'
  ENVIRONMENT: 'testing'
  LOG_LEVEL: 'INFO'

jobs:
  # ================================================================================
  # BACKEND TESTING JOBS
  # ================================================================================
  
  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: aurex_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Cache Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python Dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-xdist pytest-timeout pytest-asyncio

    - name: Run Database Migrations
      run: |
        cd backend
        python -c "
        from sqlalchemy import create_engine
        from models.base_models import Base
        engine = create_engine('${{ env.DATABASE_URL }}')
        Base.metadata.create_all(bind=engine)
        "

    - name: Run Unit Tests
      run: |
        cd backend
        python -m pytest tests/ \
          --maxfail=10 \
          --tb=short \
          -v \
          -m "unit or not slow" \
          --cov=. \
          --cov-report=xml:coverage-unit.xml \
          --cov-report=term-missing \
          --junit-xml=test-results-unit.xml

    - name: Upload Unit Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: backend-unit-test-results
        path: |
          backend/test-results-unit.xml
          backend/coverage-unit.xml

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: backend/coverage-unit.xml
        flags: backend,unit
        name: backend-unit-tests

  backend-integration-tests:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: backend-unit-tests
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: aurex_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Integration Tests
      run: |
        cd backend
        python -m pytest tests/ \
          --maxfail=5 \
          --tb=short \
          -v \
          -m "integration or api or database" \
          --cov=. \
          --cov-report=xml:coverage-integration.xml \
          --cov-report=term-missing \
          --junit-xml=test-results-integration.xml \
          --durations=20

    - name: Upload Integration Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: backend-integration-test-results
        path: |
          backend/test-results-integration.xml
          backend/coverage-integration.xml

  backend-e2e-tests:
    name: Backend E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: backend-integration-tests
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: aurex_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run E2E Tests
      run: |
        cd backend
        python -m pytest tests/ \
          --maxfail=3 \
          --tb=short \
          -v \
          -m "e2e or workflow" \
          --cov=. \
          --cov-report=xml:coverage-e2e.xml \
          --cov-report=term-missing \
          --junit-xml=test-results-e2e.xml \
          --durations=10

    - name: Upload E2E Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: backend-e2e-test-results
        path: |
          backend/test-results-e2e.xml
          backend/coverage-e2e.xml

  # ================================================================================
  # FRONTEND TESTING JOBS
  # ================================================================================
  
  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install Dependencies
      run: |
        cd frontend
        npm ci --prefer-offline --no-audit

    - name: Run Unit Tests
      run: |
        cd frontend
        npm run test:coverage
      env:
        CI: true
        WATCHMAN_DISABLE: 1
        
    - name: Upload Frontend Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: frontend-test-results
        path: |
          frontend/coverage/
          frontend/test-results.xml

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: frontend/coverage/lcov.info
        flags: frontend,unit
        name: frontend-unit-tests

  frontend-component-tests:
    name: Frontend Component Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: frontend-unit-tests

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install Dependencies
      run: |
        cd frontend
        npm ci --prefer-offline --no-audit

    - name: Run Component Tests
      run: |
        cd frontend
        npm run test -- --testPathPattern="components|contexts" --coverage
      env:
        CI: true

    - name: Upload Component Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: frontend-component-test-results
        path: frontend/coverage/

  # ================================================================================
  # PERFORMANCE AND SECURITY TESTING
  # ================================================================================
  
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' && contains(github.ref, 'main')
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: aurex_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install locust

    - name: Run Performance Tests
      run: |
        cd backend
        python -m pytest tests/ \
          -v \
          -m "performance" \
          --junit-xml=test-results-performance.xml \
          --tb=short

    - name: Upload Performance Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-test-results
        path: backend/test-results-performance.xml

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Security Testing Dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety

    - name: Run Security Tests
      run: |
        cd backend
        python -m pytest tests/ \
          -v \
          -m "security" \
          --junit-xml=test-results-security.xml

    - name: Run Bandit Security Scan
      run: |
        cd backend
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . --severity-level medium

    - name: Run Safety Check
      run: |
        cd backend
        safety check --json --output safety-report.json || true
        safety check

    - name: Upload Security Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-test-results
        path: |
          backend/test-results-security.xml
          backend/bandit-report.json
          backend/safety-report.json

  # ================================================================================
  # CONSOLIDATED REPORTING JOB
  # ================================================================================
  
  test-report:
    name: Consolidated Test Report
    runs-on: ubuntu-latest
    needs: [
      backend-unit-tests,
      backend-integration-tests, 
      backend-e2e-tests,
      frontend-unit-tests,
      frontend-component-tests
    ]
    if: always()

    steps:
    - name: Download All Test Results
      uses: actions/download-artifact@v3

    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: |
          **/test-results*.xml
        report_individual_runs: true
        deduplicate_classes_by_file_name: false

    - name: Generate Coverage Report
      run: |
        echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Backend Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- Unit Tests: Coverage reported to Codecov" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: Coverage reported to Codecov" >> $GITHUB_STEP_SUMMARY
        echo "- E2E Tests: Coverage reported to Codecov" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Frontend Coverage" >> $GITHUB_STEP_SUMMARY  
        echo "- Unit Tests: Coverage reported to Codecov" >> $GITHUB_STEP_SUMMARY
        echo "- Component Tests: Coverage reported to Codecov" >> $GITHUB_STEP_SUMMARY

  # ================================================================================
  # NOTIFICATION AND DEPLOYMENT GATES
  # ================================================================================
  
  notify-status:
    name: Notify Test Status
    runs-on: ubuntu-latest
    needs: [test-report, security-tests]
    if: always() && github.event_name == 'push'
    
    steps:
    - name: Notify Success
      if: ${{ needs.test-report.result == 'success' && needs.security-tests.result == 'success' }}
      run: |
        echo "✅ All tests passed! Ready for deployment."
        echo "TEST_STATUS=success" >> $GITHUB_ENV
        
    - name: Notify Failure  
      if: ${{ needs.test-report.result == 'failure' || needs.security-tests.result == 'failure' }}
      run: |
        echo "❌ Some tests failed. Deployment blocked."
        echo "TEST_STATUS=failure" >> $GITHUB_ENV
        exit 1

# ================================================================================
# WORKFLOW CONFIGURATION SUMMARY
# ================================================================================

# This CI/CD pipeline provides:
# 
# ✅ Backend Testing:
#    - Unit tests with >85% coverage requirement
#    - Integration tests for API endpoints and database
#    - End-to-end workflow tests
#    - Performance benchmarking
#    - Security scanning with Bandit and Safety
# 
# ✅ Frontend Testing:  
#    - Jest unit tests for components and utilities
#    - React Testing Library component integration tests
#    - Coverage reporting with LCOV format
# 
# ✅ Quality Gates:
#    - Required coverage thresholds
#    - Security vulnerability scanning
#    - Performance regression detection
#    - Automated test result publishing
# 
# ✅ Optimization Features:
#    - Dependency caching for faster builds
#    - Parallel job execution where possible
#    - Conditional job execution based on changes
#    - Comprehensive artifact collection
# 
# ✅ Reporting & Notifications:
#    - Unified test result reporting
#    - Coverage upload to Codecov
#    - GitHub step summaries
#    - Deployment gate based on test results
name: Setup JIRA Integration Secrets

on:
  workflow_dispatch:
    inputs:
      jira_api_token:
        description: 'JIRA API Token (will be stored as secret)'
        required: true
        type: string
      test_integration:
        description: 'Test JIRA integration after setup'
        required: false
        default: true
        type: boolean

env:
  JIRA_BASE_URL: https://aurigraphdlt.atlassian.net
  JIRA_PROJECT_KEY: AV11
  JIRA_EMAIL: subbu@aurigraph.io

jobs:
  setup-secrets:
    name: Setup JIRA Integration
    runs-on: ubuntu-latest
    if: github.repository == 'Aurigraph-DLT-Corp/Aurigraph-DLT'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate JIRA Configuration
      run: |
        echo "ðŸ” Validating JIRA configuration..."
        echo "JIRA Base URL: ${{ env.JIRA_BASE_URL }}"
        echo "JIRA Project: ${{ env.JIRA_PROJECT_KEY }}"
        echo "JIRA Email: ${{ env.JIRA_EMAIL }}"
        echo "API Token provided: ${{ inputs.jira_api_token != '' }}"

    - name: Test JIRA Connection
      if: inputs.test_integration
      run: |
        echo "ðŸ§ª Testing JIRA API connection..."
        
        # Test basic authentication
        RESPONSE=$(curl -s -w "%{http_code}" \
          -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ inputs.jira_api_token }}' | base64)" \
          -H "Accept: application/json" \
          "${{ env.JIRA_BASE_URL }}/rest/api/3/myself")
        
        HTTP_CODE="${RESPONSE: -3}"
        RESPONSE_BODY="${RESPONSE%???}"
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "âœ… JIRA authentication successful!"
          echo "User info: $RESPONSE_BODY"
        else
          echo "âŒ JIRA authentication failed (HTTP $HTTP_CODE)"
          echo "Response: $RESPONSE_BODY"
          exit 1
        fi

    - name: Test Project Access
      if: inputs.test_integration
      run: |
        echo "ðŸ” Testing access to AV11 project..."
        
        # Test project access
        RESPONSE=$(curl -s -w "%{http_code}" \
          -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ inputs.jira_api_token }}' | base64)" \
          -H "Accept: application/json" \
          "${{ env.JIRA_BASE_URL }}/rest/api/3/project/${{ env.JIRA_PROJECT_KEY }}")
        
        HTTP_CODE="${RESPONSE: -3}"
        RESPONSE_BODY="${RESPONSE%???}"
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "âœ… AV11 project access confirmed!"
          PROJECT_NAME=$(echo "$RESPONSE_BODY" | grep -o '"name":"[^"]*"' | cut -d'"' -f4)
          echo "Project name: $PROJECT_NAME"
        else
          echo "âŒ Cannot access AV11 project (HTTP $HTTP_CODE)"
          echo "Response: $RESPONSE_BODY"
          exit 1
        fi

    - name: Test Issue Creation (Dry Run)
      if: inputs.test_integration
      run: |
        echo "ðŸ§ª Testing issue creation capability..."
        
        # Test creating a test issue (we'll delete it after)
        TEST_ISSUE_DATA='{
          "fields": {
            "project": {"key": "'${{ env.JIRA_PROJECT_KEY }}'"},
            "issuetype": {"name": "Task"},
            "summary": "[TEST] GitHub Actions Integration Test - DELETE ME",
            "description": {
              "type": "doc",
              "version": 1,
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "This is a test issue created by GitHub Actions to verify JIRA integration. This issue can be safely deleted."
                    }
                  ]
                }
              ]
            },
            "labels": ["github-actions-test", "auto-delete"]
          }
        }'
        
        RESPONSE=$(curl -s -w "%{http_code}" -X POST \
          -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ inputs.jira_api_token }}' | base64)" \
          -H "Content-Type: application/json" \
          -H "Accept: application/json" \
          -d "$TEST_ISSUE_DATA" \
          "${{ env.JIRA_BASE_URL }}/rest/api/3/issue")
        
        HTTP_CODE="${RESPONSE: -3}"
        RESPONSE_BODY="${RESPONSE%???}"
        
        if [ "$HTTP_CODE" -eq 201 ]; then
          echo "âœ… Issue creation test successful!"
          TEST_ISSUE_KEY=$(echo "$RESPONSE_BODY" | grep -o '"key":"[^"]*"' | cut -d'"' -f4)
          echo "Created test issue: $TEST_ISSUE_KEY"
          echo "TEST_ISSUE_KEY=$TEST_ISSUE_KEY" >> $GITHUB_ENV
          
          # Add a comment to test comment functionality
          COMMENT_DATA='{
            "body": {
              "type": "doc",
              "version": 1,
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "âœ… GitHub Actions JIRA integration test successful! This issue was created and commented on automatically."
                    }
                  ]
                }
              ]
            }
          }'
          
          curl -s -X POST \
            -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ inputs.jira_api_token }}' | base64)" \
            -H "Content-Type: application/json" \
            -d "$COMMENT_DATA" \
            "${{ env.JIRA_BASE_URL }}/rest/api/3/issue/$TEST_ISSUE_KEY/comment"
          
          echo "âœ… Comment added to test issue"
        else
          echo "âŒ Issue creation test failed (HTTP $HTTP_CODE)"
          echo "Response: $RESPONSE_BODY"
          exit 1
        fi

    - name: Cleanup Test Issue
      if: inputs.test_integration && env.TEST_ISSUE_KEY != ''
      run: |
        echo "ðŸ§¹ Cleaning up test issue: $TEST_ISSUE_KEY"
        
        # Delete the test issue
        RESPONSE=$(curl -s -w "%{http_code}" -X DELETE \
          -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ inputs.jira_api_token }}' | base64)" \
          "${{ env.JIRA_BASE_URL }}/rest/api/3/issue/$TEST_ISSUE_KEY")
        
        HTTP_CODE="${RESPONSE: -3}"
        
        if [ "$HTTP_CODE" -eq 204 ]; then
          echo "âœ… Test issue deleted successfully"
        else
          echo "âš ï¸ Could not delete test issue (HTTP $HTTP_CODE) - please delete manually: $TEST_ISSUE_KEY"
        fi

    - name: Validate Workflow Files
      run: |
        echo "ðŸ“‹ Validating GitHub Actions workflow files..."
        
        WORKFLOWS=(
          ".github/workflows/jira-integration.yml"
          ".github/workflows/jira-commit-sync.yml"
          ".github/workflows/jira-pr-workflow.yml"
        )
        
        for workflow in "${WORKFLOWS[@]}"; do
          if [ -f "$workflow" ]; then
            echo "âœ… Found: $workflow"
          else
            echo "âŒ Missing: $workflow"
            exit 1
          fi
        done
        
        if [ -f ".github/scripts/jira-utils.js" ]; then
          echo "âœ… Found: .github/scripts/jira-utils.js"
        else
          echo "âŒ Missing: .github/scripts/jira-utils.js"
          exit 1
        fi

    - name: Setup Complete Summary
      run: |
        echo "## ðŸŽ‰ JIRA Integration Setup Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Configuration Verified" >> $GITHUB_STEP_SUMMARY
        echo "- **JIRA URL**: ${{ env.JIRA_BASE_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Project**: ${{ env.JIRA_PROJECT_KEY }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Email**: ${{ env.JIRA_EMAIL }}" >> $GITHUB_STEP_SUMMARY
        echo "- **API Token**: Configured âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Workflow Files Ready" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Main JIRA Integration" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Commit Synchronization" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Pull Request Workflow" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Utility Scripts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. **Test with a commit**: Include \`AV11-XXX\` in your commit message" >> $GITHUB_STEP_SUMMARY
        echo "2. **Test with a PR**: Include \`AV11-XXX\` in your PR title or description" >> $GITHUB_STEP_SUMMARY
        echo "3. **Create GitHub issue**: Will automatically create JIRA issue" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“š Documentation" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“– [Setup Guide](./GITHUB-ACTIONS-JIRA-SETUP.md)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”— [JIRA Board](https://aurigraphdlt.atlassian.net/jira/software/projects/AV11/boards/789)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸŽ¯ Your JIRA integration is now active and ready to use!**" >> $GITHUB_STEP_SUMMARY

    - name: Security Notice
      run: |
        echo "ðŸ”’ SECURITY NOTICE:"
        echo "The JIRA API token has been tested but NOT stored as a repository secret."
        echo "You must manually add it as a repository secret named 'JIRA_API_TOKEN'."
        echo ""
        echo "To add the secret:"
        echo "1. Go to Settings â†’ Secrets and variables â†’ Actions"
        echo "2. Click 'New repository secret'"
        echo "3. Name: JIRA_API_TOKEN"
        echo "4. Value: [Your JIRA API token]"
        echo "5. Click 'Add secret'"

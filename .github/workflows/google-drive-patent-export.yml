name: Export Patent Documents to Google Drive

on:
  workflow_dispatch:
    inputs:
      export_mode:
        description: 'Export mode'
        required: true
        type: choice
        options:
          - 'full-export'
          - 'incremental-update'
          - 'scan-only'
      document_types:
        description: 'Document types to export'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'patents-only'
          - 'technical-docs'
          - 'legal-docs'
          - 'invention-disclosures'
      folder_organization:
        description: 'Folder organization strategy'
        required: false
        default: 'by-category'
        type: choice
        options:
          - 'by-category'
          - 'by-date'
          - 'by-technology'
          - 'flat-structure'
      include_metadata:
        description: 'Include document metadata'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Perform dry run (no actual upload)'
        required: false
        default: false
        type: boolean
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'

env:
  GOOGLE_DRIVE_FOLDER_ID: '1z4e64CSULqcYqQPoiTNstuJaMRZ58O2W'
  EXPORT_TIMESTAMP: ${{ github.run_number }}-${{ github.run_attempt }}

jobs:
  export-patent-documents:
    name: Export Patent Documents to Google Drive
    runs-on: ubuntu-latest
    if: github.repository == 'Aurigraph-DLT-Corp/Aurigraph-DLT'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install googleapis fs-extra mime-types archiver

    - name: Initialize Export Parameters
      run: |
        echo "ðŸ”§ Initializing export parameters..."
        
        # Set defaults for scheduled runs
        if [ "${{ github.event_name }}" == "schedule" ]; then
          echo "EXPORT_MODE=incremental-update" >> $GITHUB_ENV
          echo "DOCUMENT_TYPES=all" >> $GITHUB_ENV
          echo "FOLDER_ORGANIZATION=by-category" >> $GITHUB_ENV
          echo "INCLUDE_METADATA=true" >> $GITHUB_ENV
          echo "DRY_RUN=false" >> $GITHUB_ENV
        else
          echo "EXPORT_MODE=${{ github.event.inputs.export_mode }}" >> $GITHUB_ENV
          echo "DOCUMENT_TYPES=${{ github.event.inputs.document_types }}" >> $GITHUB_ENV
          echo "FOLDER_ORGANIZATION=${{ github.event.inputs.folder_organization }}" >> $GITHUB_ENV
          echo "INCLUDE_METADATA=${{ github.event.inputs.include_metadata }}" >> $GITHUB_ENV
          echo "DRY_RUN=${{ github.event.inputs.dry_run }}" >> $GITHUB_ENV
        fi
        
        echo "Export mode: $EXPORT_MODE"
        echo "Document types: $DOCUMENT_TYPES"
        echo "Folder organization: $FOLDER_ORGANIZATION"
        echo "Include metadata: $INCLUDE_METADATA"
        echo "Dry run: $DRY_RUN"

    - name: Setup Google Drive Authentication
      run: |
        echo "ðŸ” Setting up Google Drive authentication..."
        
        # Create service account credentials file
        echo '${{ secrets.GOOGLE_DRIVE_SERVICE_ACCOUNT }}' > google-drive-credentials.json
        
        # Verify credentials file
        if [ ! -f "google-drive-credentials.json" ]; then
          echo "âŒ Google Drive credentials not found"
          exit 1
        fi
        
        # Test credentials format
        if ! jq empty google-drive-credentials.json 2>/dev/null; then
          echo "âŒ Invalid JSON format in Google Drive credentials"
          exit 1
        fi
        
        echo "âœ… Google Drive credentials configured"

    - name: Scan Repository for Patent Documents
      run: |
        echo "ðŸ” Scanning repository for patent-related documents..."
        
        node .github/scripts/patent-document-scanner.js \
          --mode "$EXPORT_MODE" \
          --types "$DOCUMENT_TYPES" \
          --output "patent-documents-scan.json"

    - name: Analyze Document Collection
      run: |
        echo "ðŸ“Š Analyzing document collection..."
        
        if [ ! -f "patent-documents-scan.json" ]; then
          echo "âŒ Document scan results not found"
          exit 1
        fi
        
        # Display scan results
        node -e "
        const fs = require('fs');
        const scan = JSON.parse(fs.readFileSync('patent-documents-scan.json', 'utf8'));
        
        console.log('ðŸ“‹ Document Scan Results:');
        console.log(\`Total documents found: \${scan.totalDocuments}\`);
        console.log(\`Patent documents: \${scan.patentDocuments?.length || 0}\`);
        console.log(\`Technical documents: \${scan.technicalDocuments?.length || 0}\`);
        console.log(\`Legal documents: \${scan.legalDocuments?.length || 0}\`);
        console.log(\`Invention disclosures: \${scan.inventionDisclosures?.length || 0}\`);
        console.log(\`Total size: \${(scan.totalSize / 1024 / 1024).toFixed(2)} MB\`);
        
        // Set environment variables for later steps
        console.log(\`TOTAL_DOCUMENTS=\${scan.totalDocuments}\`);
        console.log(\`TOTAL_SIZE_MB=\${(scan.totalSize / 1024 / 1024).toFixed(2)}\`);
        " | tee -a $GITHUB_ENV

    - name: Create Google Drive Folder Structure
      if: env.DRY_RUN == 'false'
      run: |
        echo "ðŸ“ Creating Google Drive folder structure..."
        
        node .github/scripts/google-drive-manager.js create-folders \
          --parent-folder "$GOOGLE_DRIVE_FOLDER_ID" \
          --organization "$FOLDER_ORGANIZATION" \
          --credentials "google-drive-credentials.json"

    - name: Upload Patent Documents
      if: env.DRY_RUN == 'false'
      run: |
        echo "ðŸ“¤ Uploading patent documents to Google Drive..."
        
        node .github/scripts/google-drive-manager.js upload-documents \
          --scan-file "patent-documents-scan.json" \
          --parent-folder "$GOOGLE_DRIVE_FOLDER_ID" \
          --organization "$FOLDER_ORGANIZATION" \
          --include-metadata "$INCLUDE_METADATA" \
          --credentials "google-drive-credentials.json"

    - name: Generate Export Metadata
      if: env.INCLUDE_METADATA == 'true'
      run: |
        echo "ðŸ“‹ Generating export metadata..."
        
        node -e "
        const fs = require('fs');
        const scan = JSON.parse(fs.readFileSync('patent-documents-scan.json', 'utf8'));
        
        const metadata = {
          exportInfo: {
            timestamp: new Date().toISOString(),
            exportId: '${{ env.EXPORT_TIMESTAMP }}',
            repository: '${{ github.repository }}',
            branch: '${{ github.ref_name }}',
            commit: '${{ github.sha }}',
            exportMode: '${{ env.EXPORT_MODE }}',
            documentTypes: '${{ env.DOCUMENT_TYPES }}',
            folderOrganization: '${{ env.FOLDER_ORGANIZATION }}',
            dryRun: '${{ env.DRY_RUN }}' === 'true'
          },
          statistics: {
            totalDocuments: scan.totalDocuments,
            totalSizeMB: (scan.totalSize / 1024 / 1024).toFixed(2),
            documentsByType: {
              patents: scan.patentDocuments?.length || 0,
              technical: scan.technicalDocuments?.length || 0,
              legal: scan.legalDocuments?.length || 0,
              inventions: scan.inventionDisclosures?.length || 0
            }
          },
          googleDrive: {
            targetFolderId: '${{ env.GOOGLE_DRIVE_FOLDER_ID }}',
            folderUrl: 'https://drive.google.com/drive/folders/${{ env.GOOGLE_DRIVE_FOLDER_ID }}'
          },
          documents: scan.allDocuments || []
        };
        
        fs.writeFileSync('export-metadata.json', JSON.stringify(metadata, null, 2));
        console.log('âœ… Export metadata generated');
        "

    - name: Upload Export Metadata to Google Drive
      if: env.DRY_RUN == 'false' && env.INCLUDE_METADATA == 'true'
      run: |
        echo "ðŸ“‹ Uploading export metadata to Google Drive..."
        
        node .github/scripts/google-drive-manager.js upload-file \
          --file "export-metadata.json" \
          --parent-folder "$GOOGLE_DRIVE_FOLDER_ID" \
          --name "Aurigraph-Patent-Export-Metadata-${{ env.EXPORT_TIMESTAMP }}.json" \
          --credentials "google-drive-credentials.json"

    - name: Create Export Archive
      run: |
        echo "ðŸ“¦ Creating export archive..."
        
        # Create archive of all patent documents
        node -e "
        const fs = require('fs');
        const archiver = require('archiver');
        const scan = JSON.parse(fs.readFileSync('patent-documents-scan.json', 'utf8'));
        
        const output = fs.createWriteStream('aurigraph-patent-documents.zip');
        const archive = archiver('zip', { zlib: { level: 9 } });
        
        output.on('close', () => {
          console.log(\`Archive created: \${archive.pointer()} bytes\`);
        });
        
        archive.on('error', (err) => {
          throw err;
        });
        
        archive.pipe(output);
        
        // Add all documents to archive
        if (scan.allDocuments) {
          scan.allDocuments.forEach(doc => {
            if (fs.existsSync(doc.path)) {
              archive.file(doc.path, { name: doc.archivePath || doc.relativePath });
            }
          });
        }
        
        // Add metadata
        archive.append(JSON.stringify(scan, null, 2), { name: 'scan-results.json' });
        if (fs.existsSync('export-metadata.json')) {
          archive.file('export-metadata.json', { name: 'export-metadata.json' });
        }
        
        archive.finalize();
        "

    - name: Verify Export Completion
      if: env.DRY_RUN == 'false'
      run: |
        echo "âœ… Verifying export completion..."
        
        node .github/scripts/google-drive-manager.js verify-export \
          --parent-folder "$GOOGLE_DRIVE_FOLDER_ID" \
          --scan-file "patent-documents-scan.json" \
          --credentials "google-drive-credentials.json"

    - name: Generate Export Report
      run: |
        echo "ðŸ“Š Generating export report..."
        
        node -e "
        const fs = require('fs');
        
        let scan = {};
        let metadata = {};
        
        try { scan = JSON.parse(fs.readFileSync('patent-documents-scan.json', 'utf8')); } catch(e) {}
        try { metadata = JSON.parse(fs.readFileSync('export-metadata.json', 'utf8')); } catch(e) {}
        
        const report = \`# Aurigraph Patent Documents Export Report
        
## Export Summary
- **Export ID**: ${{ env.EXPORT_TIMESTAMP }}
- **Timestamp**: \${new Date().toISOString()}
- **Repository**: ${{ github.repository }}
- **Branch**: ${{ github.ref_name }}
- **Commit**: ${{ github.sha }}
- **Export Mode**: ${{ env.EXPORT_MODE }}
- **Document Types**: ${{ env.DOCUMENT_TYPES }}
- **Dry Run**: ${{ env.DRY_RUN }}

## Document Statistics
- **Total Documents**: \${scan.totalDocuments || 0}
- **Total Size**: \${(scan.totalSize / 1024 / 1024).toFixed(2)} MB
- **Patent Documents**: \${scan.patentDocuments?.length || 0}
- **Technical Documents**: \${scan.technicalDocuments?.length || 0}
- **Legal Documents**: \${scan.legalDocuments?.length || 0}
- **Invention Disclosures**: \${scan.inventionDisclosures?.length || 0}

## Google Drive Information
- **Target Folder**: [Patent Documents Folder](https://drive.google.com/drive/folders/${{ env.GOOGLE_DRIVE_FOLDER_ID }})
- **Folder Organization**: ${{ env.FOLDER_ORGANIZATION }}
- **Metadata Included**: ${{ env.INCLUDE_METADATA }}

## Document Categories
\${scan.patentDocuments?.length > 0 ? \`
### Patent Documents (\${scan.patentDocuments.length})
\${scan.patentDocuments.map(doc => \`- \${doc.relativePath} (\${(doc.size / 1024).toFixed(1)} KB)\`).join('\\n')}
\` : ''}

\${scan.technicalDocuments?.length > 0 ? \`
### Technical Documents (\${scan.technicalDocuments.length})
\${scan.technicalDocuments.slice(0, 10).map(doc => \`- \${doc.relativePath} (\${(doc.size / 1024).toFixed(1)} KB)\`).join('\\n')}
\${scan.technicalDocuments.length > 10 ? \`\\n... and \${scan.technicalDocuments.length - 10} more\` : ''}
\` : ''}

## Export Status
\${${{ env.DRY_RUN }} ? 'âš ï¸ **DRY RUN** - No files were actually uploaded' : 'âœ… **COMPLETED** - All documents exported successfully'}

## Next Steps
1. Review exported documents in Google Drive
2. Verify document organization and metadata
3. Update patent documentation as needed
4. Schedule regular incremental exports

---
*Generated by Aurigraph Patent Export System on \${new Date().toISOString()}*
\`;
        
        fs.writeFileSync('export-report.md', report);
        console.log('ðŸ“„ Export report generated');
        "

    - name: Upload Export Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: patent-export-results-${{ env.EXPORT_TIMESTAMP }}
        path: |
          patent-documents-scan.json
          export-metadata.json
          export-report.md
          aurigraph-patent-documents.zip
          *.log
        retention-days: 90

    - name: Post Export Summary
      if: always()
      run: |
        echo "## ðŸ“¤ Patent Documents Export Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Export ID**: ${{ env.EXPORT_TIMESTAMP }}" >> $GITHUB_STEP_SUMMARY
        echo "**Mode**: ${{ env.EXPORT_MODE }}" >> $GITHUB_STEP_SUMMARY
        echo "**Document Types**: ${{ env.DOCUMENT_TYPES }}" >> $GITHUB_STEP_SUMMARY
        echo "**Total Documents**: ${TOTAL_DOCUMENTS:-0}" >> $GITHUB_STEP_SUMMARY
        echo "**Total Size**: ${TOTAL_SIZE_MB:-0} MB" >> $GITHUB_STEP_SUMMARY
        echo "**Dry Run**: ${{ env.DRY_RUN }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "export-report.md" ]; then
          echo "### ðŸ“Š Detailed Report" >> $GITHUB_STEP_SUMMARY
          cat export-report.md >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Google Drive Folder**: [View Documents](https://drive.google.com/drive/folders/${{ env.GOOGLE_DRIVE_FOLDER_ID }})" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Export Artifacts**: Check the artifacts section for downloadable files" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup Sensitive Files
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up sensitive files..."
        rm -f google-drive-credentials.json
        echo "âœ… Cleanup completed"

# =============================================================================
# Aurigraph DLT - Production Monitoring Workflow
# =============================================================================
# Scheduled health checks and monitoring for production services
# Runs every 15 minutes to ensure service availability
# =============================================================================

name: Production Monitoring

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      full_report:
        description: 'Generate full diagnostic report'
        type: boolean
        default: false

env:
  PROD_URL: 'https://dlt.aurigraph.io'

jobs:
  # ===========================================================================
  # HEALTH CHECKS
  # ===========================================================================
  health-checks:
    name: Service Health Checks
    runs-on: ubuntu-latest

    outputs:
      api_status: ${{ steps.api.outputs.status }}
      frontend_status: ${{ steps.frontend.outputs.status }}
      overall_status: ${{ steps.summary.outputs.status }}

    steps:
      - name: Check API Health
        id: api
        run: |
          echo "=== Checking API Health ==="

          # Check main health endpoint
          HEALTH_RESPONSE=$(curl -sf "${{ env.PROD_URL }}/api/v11/health" 2>/dev/null || echo "FAILED")

          if [[ "$HEALTH_RESPONSE" != "FAILED" ]]; then
            echo "API Health: OK"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "API Health: FAILED"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

          # Check info endpoint
          INFO_RESPONSE=$(curl -sf "${{ env.PROD_URL }}/api/v11/info" 2>/dev/null || echo "FAILED")
          if [[ "$INFO_RESPONSE" != "FAILED" ]]; then
            echo "API Info endpoint: OK"
            echo "$INFO_RESPONSE" | head -c 500
          fi

      - name: Check Frontend Health
        id: frontend
        run: |
          echo "=== Checking Frontend Health ==="

          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/" 2>/dev/null || echo "000")

          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "Frontend: OK (HTTP $HTTP_CODE)"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "Frontend: FAILED (HTTP $HTTP_CODE)"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: Check Additional Endpoints
        run: |
          echo "=== Checking Additional Endpoints ==="

          endpoints=(
            "/api/v11/stats"
            "/api/v11/analytics/dashboard"
            "/demo"
            "/rwa/tokenize"
          )

          for endpoint in "${endpoints[@]}"; do
            CODE=$(curl -sf -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}$endpoint" 2>/dev/null || echo "000")
            echo "$endpoint: HTTP $CODE"
          done

      - name: Check SSL Certificate
        run: |
          echo "=== Checking SSL Certificate ==="

          # Get certificate expiry
          CERT_EXPIRY=$(echo | openssl s_client -servername dlt.aurigraph.io -connect dlt.aurigraph.io:443 2>/dev/null | openssl x509 -noout -dates 2>/dev/null | grep notAfter | cut -d= -f2)

          if [[ -n "$CERT_EXPIRY" ]]; then
            echo "SSL Certificate Expiry: $CERT_EXPIRY"

            # Check if expiring within 30 days
            EXPIRY_EPOCH=$(date -d "$CERT_EXPIRY" +%s 2>/dev/null || gdate -d "$CERT_EXPIRY" +%s 2>/dev/null || echo "0")
            NOW_EPOCH=$(date +%s)
            DAYS_LEFT=$(( (EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))

            if [[ $DAYS_LEFT -lt 30 && $DAYS_LEFT -gt 0 ]]; then
              echo "WARNING: SSL Certificate expires in $DAYS_LEFT days!"
            elif [[ $DAYS_LEFT -gt 0 ]]; then
              echo "SSL Certificate valid for $DAYS_LEFT more days"
            fi
          else
            echo "Could not check SSL certificate"
          fi

      - name: Response Time Check
        run: |
          echo "=== Response Time Check ==="

          # Measure API response time
          API_TIME=$(curl -sf -o /dev/null -w "%{time_total}" "${{ env.PROD_URL }}/api/v11/health" 2>/dev/null || echo "0")
          echo "API Response Time: ${API_TIME}s"

          # Measure Frontend response time
          FRONTEND_TIME=$(curl -sf -o /dev/null -w "%{time_total}" "${{ env.PROD_URL }}/" 2>/dev/null || echo "0")
          echo "Frontend Response Time: ${FRONTEND_TIME}s"

          # Check for slow responses (>3s)
          if (( $(echo "$API_TIME > 3.0" | bc -l 2>/dev/null || echo "0") )); then
            echo "WARNING: API response is slow (>3s)"
          fi

      - name: Generate Summary
        id: summary
        run: |
          API_STATUS="${{ steps.api.outputs.status }}"
          FRONTEND_STATUS="${{ steps.frontend.outputs.status }}"

          if [[ "$API_STATUS" == "healthy" && "$FRONTEND_STATUS" == "healthy" ]]; then
            echo "OVERALL STATUS: ALL SERVICES HEALTHY"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "OVERALL STATUS: SOME SERVICES UNHEALTHY"
            echo "status=degraded" >> $GITHUB_OUTPUT
          fi

          echo ""
          echo "=== Service Status Summary ==="
          echo "| Service | Status |"
          echo "|---------|--------|"
          echo "| API     | $API_STATUS |"
          echo "| Frontend| $FRONTEND_STATUS |"

  # ===========================================================================
  # METRICS COLLECTION
  # ===========================================================================
  metrics:
    name: Collect Metrics
    runs-on: ubuntu-latest
    if: inputs.full_report == true

    steps:
      - name: Collect Performance Metrics
        run: |
          echo "=== Performance Metrics ==="

          # Get stats from API
          STATS=$(curl -sf "${{ env.PROD_URL }}/api/v11/stats" 2>/dev/null || echo '{}')
          echo "API Stats:"
          echo "$STATS" | head -c 1000

          # Get infrastructure metrics
          METRICS=$(curl -sf "${{ env.PROD_URL }}/api/v11/infrastructure/metrics" 2>/dev/null || echo '{}')
          echo ""
          echo "Infrastructure Metrics:"
          echo "$METRICS" | head -c 1000

  # ===========================================================================
  # ALERT ON FAILURE
  # ===========================================================================
  alert:
    name: Alert on Failure
    runs-on: ubuntu-latest
    needs: health-checks
    if: needs.health-checks.outputs.overall_status == 'degraded'

    steps:
      - name: Create Issue for Service Degradation
        uses: actions/github-script@v7
        with:
          script: |
            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'monitoring,service-health'
            });

            // Only create new issue if none exists
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[ALERT] Production Services Degraded',
                body: `## Production Health Alert

**Timestamp:** ${new Date().toISOString()}

### Service Status
- API: ${{ needs.health-checks.outputs.api_status }}
- Frontend: ${{ needs.health-checks.outputs.frontend_status }}

### URLs
- Production: https://dlt.aurigraph.io
- API Health: https://dlt.aurigraph.io/api/v11/health

### Investigation Steps
1. Check GitHub Actions logs
2. SSH to server: \`ssh -p 2235 subbu@dlt.aurigraph.io\`
3. Check backend logs: \`tail -100 /home/subbu/logs/backend.log\`
4. Check NGINX: \`sudo systemctl status nginx\`

_This issue was automatically created by the monitoring workflow._`,
                labels: ['monitoring', 'service-health', 'urgent']
              });
            }

      - name: Send Notification (if webhook configured)
        if: secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"Production Alert: Aurigraph DLT services degraded. API: ${{ needs.health-checks.outputs.api_status }}, Frontend: ${{ needs.health-checks.outputs.frontend_status }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }} 2>/dev/null || true

  # ===========================================================================
  # REPORT GENERATION
  # ===========================================================================
  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: health-checks
    if: always()

    steps:
      - name: Create GitHub Summary
        run: |
          echo "# Aurigraph DLT - Production Monitoring Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Service Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.health-checks.outputs.api_status == 'healthy' && '✅ Healthy' || '❌ Unhealthy' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.health-checks.outputs.frontend_status == 'healthy' && '✅ Healthy' || '❌ Unhealthy' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Production Portal](https://dlt.aurigraph.io)" >> $GITHUB_STEP_SUMMARY
          echo "- [API Health](https://dlt.aurigraph.io/api/v11/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [Infrastructure Dashboard](https://dlt.aurigraph.io/admin/infrastructure)" >> $GITHUB_STEP_SUMMARY

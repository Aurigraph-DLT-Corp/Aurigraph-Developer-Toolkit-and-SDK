name: SSH Deploy to Remote

on:
  push:
    branches:
      - V12
      - main
    paths:
      - 'aurigraph-av10-7/aurigraph-v11-standalone/src/**'
      - 'aurigraph-av10-7/aurigraph-v11-standalone/pom.xml'
      - '.github/workflows/ssh-deploy.yml'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip build (deploy existing JAR on server)'
        type: boolean
        default: false

env:
  JAVA_VERSION: '21'

jobs:
  build-and-deploy:
    name: Build & Deploy via SSH
    # Using GitHub-hosted runner with SSH deployment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        if: ${{ !inputs.skip_build }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build V12 JAR
        if: ${{ !inputs.skip_build }}
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          echo "Building V12 application..."
          ./mvnw clean package -DskipTests -B
          echo "Build complete!"
          ls -lh target/quarkus-app/

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 2235 dlt.aurigraph.io >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Package for deployment
        if: ${{ !inputs.skip_build }}
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          echo "ğŸ“¦ Packaging for deployment..."
          cd target
          tar -czvf quarkus-app.tar.gz quarkus-app/
          ls -lh quarkus-app.tar.gz

      - name: Upload and Deploy via SSH
        if: ${{ !inputs.skip_build }}
        run: |
          echo "ğŸ“¤ Uploading to remote server..."
          scp -P 2235 aurigraph-av10-7/aurigraph-v11-standalone/target/quarkus-app.tar.gz subbu@dlt.aurigraph.io:/home/subbu/

          echo "ğŸš€ Deploying on remote server..."
          ssh -p 2235 subbu@dlt.aurigraph.io << 'EOF'
          set -e
          cd /home/subbu

          echo "=== Aurigraph V12 Deployment via SSH ==="
          echo "Timestamp: $(date)"

          # Backup existing
          if [ -d quarkus-app ]; then
            BACKUP="quarkus-app.backup.$(date +%Y%m%d_%H%M%S)"
            cp -r quarkus-app "$BACKUP"
            echo "âœ… Backup: $BACKUP"
          fi

          # Extract new version
          rm -rf quarkus-app-new
          tar -xzf quarkus-app.tar.gz
          mv quarkus-app quarkus-app-new 2>/dev/null || true

          # Stop existing service
          echo "Stopping existing service..."
          pkill -f 'quarkus-run.jar' 2>/dev/null || echo "No existing process"
          sleep 5

          # Swap versions
          rm -rf quarkus-app-old
          mv quarkus-app quarkus-app-old 2>/dev/null || true
          mv quarkus-app-new quarkus-app

          # Start new service
          echo "Starting V12 service..."
          mkdir -p aurigraph/logs

          nohup java -Xmx8g -Xms4g \
            -XX:+UseG1GC \
            -XX:MaxGCPauseMillis=200 \
            -Dquarkus.http.port=9003 \
            -Dquarkus.profile=prod \
            -Dcurby.quantum.api-key=placeholder \
            -Dquarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/j4c_db \
            -Dquarkus.datasource.username=j4c_user \
            -Dquarkus.datasource.password=j4c_password \
            -Dquarkus.flyway.migrate-at-start=false \
            -jar quarkus-app/quarkus-run.jar \
            > aurigraph/logs/main-api.log 2>&1 &

          disown
          echo "âœ… Service started"
          EOF

      - name: Health Check
        run: |
          echo "ğŸ” Running health checks..."
          sleep 30

          for i in 1 2 3 4 5 6 7 8; do
            echo "Health check attempt $i/8..."
            HEALTH=$(ssh -p 2235 subbu@dlt.aurigraph.io "curl -s http://localhost:9003/api/v11/health" 2>/dev/null || echo '{"status":"error"}')
            STATUS=$(echo "$HEALTH" | jq -r '.status // "error"' 2>/dev/null || echo "error")

            if [ "$STATUS" = "UP" ]; then
              echo "âœ… Health check passed!"
              echo "$HEALTH"
              exit 0
            fi
            echo "  Status: $STATUS - waiting 10s..."
            sleep 10
          done
          echo "âŒ Health check failed"
          exit 1

      - name: Verify Deployment
        run: |
          echo "ğŸ§ª Verifying public endpoints..."
          sleep 5

          if curl -sf https://dlt.aurigraph.io/api/v11/health; then
            echo ""
            echo "âœ… Deployment verified!"
          else
            echo "âš ï¸ Public health check pending (NGINX may need reload)"
          fi

          echo ""
          echo "=== Deployment Complete ==="

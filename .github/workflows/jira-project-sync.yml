name: JIRA Project Complete Synchronization

on:
  workflow_dispatch:
    inputs:
      sync_direction:
        description: 'Synchronization direction'
        required: true
        type: choice
        options:
          - 'github-to-jira'
          - 'jira-to-github'
          - 'bidirectional'
      include_closed:
        description: 'Include closed/done items'
        required: false
        default: false
        type: boolean
      force_update:
        description: 'Force update existing items'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Perform dry run (no actual changes)'
        required: false
        default: true
        type: boolean
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  JIRA_BASE_URL: https://aurigraphdlt.atlassian.net
  JIRA_PROJECT_KEY: AV11
  JIRA_EMAIL: subbu@aurigraph.io

jobs:
  project-sync:
    name: Complete Project Synchronization
    runs-on: ubuntu-latest
    if: github.repository == 'Aurigraph-DLT-Corp/Aurigraph-DLT'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install axios fs-extra

    - name: Initialize Sync Parameters
      run: |
        echo "ðŸ”§ Initializing synchronization parameters..."
        
        # Set defaults for scheduled runs
        if [ "${{ github.event_name }}" == "schedule" ]; then
          echo "SYNC_DIRECTION=bidirectional" >> $GITHUB_ENV
          echo "INCLUDE_CLOSED=false" >> $GITHUB_ENV
          echo "FORCE_UPDATE=false" >> $GITHUB_ENV
          echo "DRY_RUN=false" >> $GITHUB_ENV
        else
          echo "SYNC_DIRECTION=${{ github.event.inputs.sync_direction }}" >> $GITHUB_ENV
          echo "INCLUDE_CLOSED=${{ github.event.inputs.include_closed }}" >> $GITHUB_ENV
          echo "FORCE_UPDATE=${{ github.event.inputs.force_update }}" >> $GITHUB_ENV
          echo "DRY_RUN=${{ github.event.inputs.dry_run }}" >> $GITHUB_ENV
        fi
        
        echo "Sync direction: $SYNC_DIRECTION"
        echo "Include closed: $INCLUDE_CLOSED"
        echo "Force update: $FORCE_UPDATE"
        echo "Dry run: $DRY_RUN"

    - name: Fetch All GitHub Issues
      run: |
        echo "ðŸ“¥ Fetching all GitHub issues..."
        
        # Determine state filter
        if [ "$INCLUDE_CLOSED" == "true" ]; then
          STATE_FILTER="all"
        else
          STATE_FILTER="open"
        fi
        
        # Fetch all issues (GitHub API pagination)
        PAGE=1
        ALL_ISSUES="[]"
        
        while true; do
          echo "Fetching page $PAGE..."
          
          ISSUES=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=$STATE_FILTER&per_page=100&page=$PAGE")
          
          # Check if we got any issues
          ISSUE_COUNT=$(echo "$ISSUES" | jq '. | length')
          
          if [ "$ISSUE_COUNT" -eq 0 ]; then
            break
          fi
          
          # Merge with existing issues
          ALL_ISSUES=$(echo "$ALL_ISSUES $ISSUES" | jq -s 'add')
          
          PAGE=$((PAGE + 1))
        done
        
        echo "$ALL_ISSUES" > github_issues_all.json
        TOTAL_ISSUES=$(echo "$ALL_ISSUES" | jq '. | length')
        echo "ðŸ“Š Found $TOTAL_ISSUES GitHub issues"
        echo "GITHUB_ISSUES_COUNT=$TOTAL_ISSUES" >> $GITHUB_ENV

    - name: Fetch All JIRA Issues
      run: |
        echo "ðŸ“¥ Fetching all JIRA issues..."
        
        # Build JQL query
        if [ "$INCLUDE_CLOSED" == "true" ]; then
          JQL="project=${{ env.JIRA_PROJECT_KEY }}"
        else
          JQL="project=${{ env.JIRA_PROJECT_KEY }} AND status != Done AND status != Cancelled"
        fi
        
        echo "Using JQL: $JQL"
        
        # Fetch all JIRA issues (with pagination)
        START_AT=0
        MAX_RESULTS=100
        ALL_JIRA_ISSUES="[]"
        
        while true; do
          echo "Fetching JIRA issues starting at $START_AT..."
          
          RESPONSE=$(curl -s \
            -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            -H "Accept: application/json" \
            "${{ env.JIRA_BASE_URL }}/rest/api/3/search?jql=$(echo "$JQL" | sed 's/ /%20/g')&startAt=$START_AT&maxResults=$MAX_RESULTS&fields=*all")
          
          ISSUES=$(echo "$RESPONSE" | jq '.issues')
          TOTAL=$(echo "$RESPONSE" | jq '.total')
          
          # Merge with existing issues
          ALL_JIRA_ISSUES=$(echo "$ALL_JIRA_ISSUES $ISSUES" | jq -s 'add')
          
          START_AT=$((START_AT + MAX_RESULTS))
          
          if [ $START_AT -ge $TOTAL ]; then
            break
          fi
        done
        
        echo "$ALL_JIRA_ISSUES" > jira_issues_all.json
        JIRA_ISSUES_COUNT=$(echo "$ALL_JIRA_ISSUES" | jq '. | length')
        echo "ðŸ“Š Found $JIRA_ISSUES_COUNT JIRA issues"
        echo "JIRA_ISSUES_COUNT=$JIRA_ISSUES_COUNT" >> $GITHUB_ENV

    - name: Analyze Synchronization Gaps
      run: |
        echo "ðŸ” Analyzing synchronization gaps..."
        
        node -e "
        const fs = require('fs');
        const githubIssues = JSON.parse(fs.readFileSync('github_issues_all.json', 'utf8'));
        const jiraIssues = JSON.parse(fs.readFileSync('jira_issues_all.json', 'utf8'));
        
        console.log('ðŸ“Š Synchronization Analysis:');
        console.log(\`GitHub Issues: \${githubIssues.length}\`);
        console.log(\`JIRA Issues: \${jiraIssues.length}\`);
        
        // Find GitHub issues not in JIRA
        const githubNotInJira = githubIssues.filter(gh => {
          return !jiraIssues.some(jira => 
            jira.fields.summary.includes(\`#\${gh.number}\`) || 
            jira.fields.summary.includes(gh.title)
          );
        });
        
        // Find JIRA issues not in GitHub
        const jiraNotInGithub = jiraIssues.filter(jira => {
          const summary = jira.fields.summary;
          const githubMatch = summary.match(/#(\d+)/);
          if (githubMatch) {
            const issueNumber = parseInt(githubMatch[1]);
            return !githubIssues.some(gh => gh.number === issueNumber);
          }
          return !summary.includes('[GitHub');
        });
        
        console.log(\`\nGaps Found:\`);
        console.log(\`- GitHub issues not in JIRA: \${githubNotInJira.length}\`);
        console.log(\`- JIRA issues not in GitHub: \${jiraNotInGithub.length}\`);
        
        // Save gap analysis
        const analysis = {
          githubTotal: githubIssues.length,
          jiraTotal: jiraIssues.length,
          githubNotInJira: githubNotInJira.map(issue => ({
            number: issue.number,
            title: issue.title,
            state: issue.state,
            url: issue.html_url
          })),
          jiraNotInGithub: jiraNotInGithub.map(issue => ({
            key: issue.key,
            summary: issue.fields.summary,
            status: issue.fields.status.name,
            url: \`${{ env.JIRA_BASE_URL }}/browse/\${issue.key}\`
          }))
        };
        
        fs.writeFileSync('sync_analysis.json', JSON.stringify(analysis, null, 2));
        "

    - name: Sync GitHub to JIRA
      if: env.SYNC_DIRECTION == 'github-to-jira' || env.SYNC_DIRECTION == 'bidirectional'
      run: |
        echo "ðŸ”„ Syncing GitHub issues to JIRA..."
        
        node .github/scripts/jira-bulk-manager.js sync-github-issues \
          --github-issues "github_issues_all.json" \
          --dry-run "$DRY_RUN" \
          --project "${{ env.JIRA_PROJECT_KEY }}"

    - name: Sync JIRA to GitHub
      if: env.SYNC_DIRECTION == 'jira-to-github' || env.SYNC_DIRECTION == 'bidirectional'
      run: |
        echo "ðŸ”„ Syncing JIRA issues to GitHub..."
        
        # This is more complex as GitHub doesn't allow bulk issue creation via API
        # We'll create a report of JIRA issues that should be GitHub issues
        
        node -e "
        const fs = require('fs');
        const jiraIssues = JSON.parse(fs.readFileSync('jira_issues_all.json', 'utf8'));
        const githubIssues = JSON.parse(fs.readFileSync('github_issues_all.json', 'utf8'));
        
        const jiraOnlyIssues = jiraIssues.filter(jira => {
          const summary = jira.fields.summary;
          // Skip issues that are already linked to GitHub
          if (summary.includes('[GitHub') || summary.includes('#')) {
            return false;
          }
          
          // Check if there's a similar GitHub issue
          return !githubIssues.some(gh => 
            gh.title.toLowerCase().includes(summary.toLowerCase().substring(0, 20))
          );
        });
        
        console.log(\`Found \${jiraOnlyIssues.length} JIRA-only issues\`);
        
        const report = {
          jiraOnlyIssues: jiraOnlyIssues.map(issue => ({
            key: issue.key,
            summary: issue.fields.summary,
            description: issue.fields.description,
            status: issue.fields.status.name,
            priority: issue.fields.priority?.name,
            assignee: issue.fields.assignee?.emailAddress,
            url: \`${{ env.JIRA_BASE_URL }}/browse/\${issue.key}\`,
            suggestedGithubTitle: issue.fields.summary,
            suggestedGithubBody: \`**JIRA Issue**: [\${issue.key}](${{ env.JIRA_BASE_URL }}/browse/\${issue.key})
        
**Description**: 
\${issue.fields.description || 'No description'}

**Status**: \${issue.fields.status.name}
**Priority**: \${issue.fields.priority?.name || 'None'}

---
*Synced from JIRA*\`
          }))
        };
        
        fs.writeFileSync('jira_to_github_suggestions.json', JSON.stringify(report, null, 2));
        "

    - name: Update Existing Linked Issues
      if: env.FORCE_UPDATE == 'true'
      run: |
        echo "ðŸ”„ Updating existing linked issues..."
        
        # Update GitHub issues with JIRA status
        node -e "
        const fs = require('fs');
        const githubIssues = JSON.parse(fs.readFileSync('github_issues_all.json', 'utf8'));
        const jiraIssues = JSON.parse(fs.readFileSync('jira_issues_all.json', 'utf8'));
        
        const updates = [];
        
        githubIssues.forEach(gh => {
          // Find corresponding JIRA issue
          const jiraIssue = jiraIssues.find(jira => 
            jira.fields.summary.includes(\`#\${gh.number}\`) ||
            jira.fields.summary.includes(gh.title)
          );
          
          if (jiraIssue) {
            updates.push({
              github: {
                number: gh.number,
                title: gh.title,
                state: gh.state
              },
              jira: {
                key: jiraIssue.key,
                summary: jiraIssue.fields.summary,
                status: jiraIssue.fields.status.name
              },
              needsUpdate: gh.state !== (jiraIssue.fields.status.name === 'Done' ? 'closed' : 'open')
            });
          }
        });
        
        console.log(\`Found \${updates.length} linked issues\`);
        console.log(\`Updates needed: \${updates.filter(u => u.needsUpdate).length}\`);
        
        fs.writeFileSync('linked_issues_updates.json', JSON.stringify(updates, null, 2));
        "

    - name: Generate Synchronization Report
      run: |
        echo "ðŸ“Š Generating synchronization report..."
        
        node -e "
        const fs = require('fs');
        
        let analysis = {};
        let suggestions = {};
        let updates = {};
        
        try { analysis = JSON.parse(fs.readFileSync('sync_analysis.json', 'utf8')); } catch(e) {}
        try { suggestions = JSON.parse(fs.readFileSync('jira_to_github_suggestions.json', 'utf8')); } catch(e) {}
        try { updates = JSON.parse(fs.readFileSync('linked_issues_updates.json', 'utf8')); } catch(e) {}
        
        const report = \`# JIRA Project Synchronization Report
        
## Summary
- **Sync Direction**: ${{ env.SYNC_DIRECTION }}
- **Include Closed**: ${{ env.INCLUDE_CLOSED }}
- **Force Update**: ${{ env.FORCE_UPDATE }}
- **Dry Run**: ${{ env.DRY_RUN }}
- **Timestamp**: \${new Date().toISOString()}

## Current State
- **GitHub Issues**: \${analysis.githubTotal || 0}
- **JIRA Issues**: \${analysis.jiraTotal || 0}

## Synchronization Gaps
- **GitHub issues not in JIRA**: \${analysis.githubNotInJira?.length || 0}
- **JIRA issues not in GitHub**: \${analysis.jiraNotInGithub?.length || 0}

## Actions Taken
\${analysis.githubNotInJira?.length > 0 ? \`
### GitHub â†’ JIRA Sync
\${analysis.githubNotInJira.map(issue => \`- [#\${issue.number}](\${issue.url}) - \${issue.title}\`).join('\\n')}
\` : ''}

\${suggestions.jiraOnlyIssues?.length > 0 ? \`
### JIRA â†’ GitHub Suggestions
\${suggestions.jiraOnlyIssues.slice(0, 10).map(issue => \`- [\${issue.key}](\${issue.url}) - \${issue.summary}\`).join('\\n')}
\${suggestions.jiraOnlyIssues.length > 10 ? \`\\n... and \${suggestions.jiraOnlyIssues.length - 10} more\` : ''}
\` : ''}

## Next Steps
1. Review synchronization gaps
2. Manually create GitHub issues for JIRA-only items if needed
3. Update issue statuses to maintain consistency
4. Schedule regular synchronization runs

---
*Generated by GitHub Actions on \${new Date().toISOString()}*
\`;
        
        fs.writeFileSync('sync_report.md', report);
        console.log('ðŸ“„ Synchronization report generated');
        "

    - name: Upload Synchronization Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jira-sync-results-${{ github.run_number }}
        path: |
          *.json
          *.md
          *.log
        retention-days: 30

    - name: Post Synchronization Summary
      if: always()
      run: |
        echo "## ðŸ”„ JIRA Project Synchronization Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Direction**: ${{ env.SYNC_DIRECTION }}" >> $GITHUB_STEP_SUMMARY
        echo "**GitHub Issues**: ${{ env.GITHUB_ISSUES_COUNT }}" >> $GITHUB_STEP_SUMMARY
        echo "**JIRA Issues**: ${{ env.JIRA_ISSUES_COUNT }}" >> $GITHUB_STEP_SUMMARY
        echo "**Dry Run**: ${{ env.DRY_RUN }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "sync_report.md" ]; then
          echo "### ðŸ“Š Detailed Report" >> $GITHUB_STEP_SUMMARY
          cat sync_report.md >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **JIRA Project**: [${{ env.JIRA_PROJECT_KEY }}](${{ env.JIRA_BASE_URL }}/projects/${{ env.JIRA_PROJECT_KEY }})" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Detailed Results**: Check artifacts for complete synchronization data" >> $GITHUB_STEP_SUMMARY

name: VVB Approval System - CI/CD Pipeline

on:
  push:
    branches:
      - main
      - V12
      - develop
    paths:
      - 'aurigraph-av10-7/aurigraph-v11-standalone/**'
      - '.github/workflows/vvb-approval-system-cicd.yml'
      - 'VERSION'
  pull_request:
    branches:
      - main
      - V12
      - develop
    paths:
      - 'aurigraph-av10-7/aurigraph-v11-standalone/**'
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/aurigraph-v11
  JAVA_VERSION: '21'
  MAVEN_VERSION: '3.9.0'

jobs:
  # ============================================================================
  # STAGE 1: BUILD
  # ============================================================================
  build:
    name: Build & Compile
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact_name: ${{ steps.version.outputs.artifact_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Get version
        id: version
        run: |
          VERSION=$(cat VERSION)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BUILD_VERSION="${VERSION}-${TIMESTAMP}"
          ARTIFACT_NAME="aurigraph-v11-${BUILD_VERSION}"
          echo "version=${BUILD_VERSION}" >> $GITHUB_OUTPUT
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: Compile with Maven
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        env:
          BUILD_VERSION: ${{ steps.version.outputs.version }}
        run: |
          ./mvnw clean compile \
            -DskipTests \
            -Drevision="${BUILD_VERSION}" \
            -B -V

      - name: Build JAR
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        env:
          BUILD_VERSION: ${{ steps.version.outputs.version }}
        run: |
          ./mvnw package \
            -DskipTests \
            -Drevision="${BUILD_VERSION}" \
            -B

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.version.outputs.artifact_name }}-jar
          path: aurigraph-av10-7/aurigraph-v11-standalone/target/*.jar
          retention-days: 30

  # ============================================================================
  # STAGE 2: UNIT TESTS
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event.inputs.skip_tests != 'true' && (github.event_name != 'push' || github.ref == 'refs/heads/main') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Run Unit Tests
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        env:
          BUILD_VERSION: ${{ needs.build.outputs.version }}
        run: |
          ./mvnw test \
            -Dtest=VVBApprovalServiceTest,VVBApprovalRegistryTest,ApprovalExecutionAuditEntityTest \
            -Drevision="${BUILD_VERSION}" \
            --fail-fast \
            -B

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: aurigraph-av10-7/aurigraph-v11-standalone/target/surefire-reports/
          retention-days: 30

  # ============================================================================
  # STAGE 3: CODE QUALITY
  # ============================================================================
  quality-gates:
    name: Code Quality Gates
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Run SpotBugs
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        env:
          BUILD_VERSION: ${{ needs.build.outputs.version }}
        continue-on-error: true
        run: |
          ./mvnw compile spotbugs:check \
            -Drevision="${BUILD_VERSION}" \
            -B

      - name: Run Checkstyle
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        env:
          BUILD_VERSION: ${{ needs.build.outputs.version }}
        continue-on-error: true
        run: |
          ./mvnw checkstyle:check \
            -Drevision="${BUILD_VERSION}" \
            -B

  # ============================================================================
  # STAGE 4: DOCKER BUILD
  # ============================================================================
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [build, unit-tests]
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}},value=${{ needs.build.outputs.version }}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Download JAR artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ needs.build.outputs.artifact_name }}-jar
          path: aurigraph-av10-7/aurigraph-v11-standalone/target/

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: aurigraph-av10-7/aurigraph-v11-standalone
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  # ============================================================================
  # STAGE 5: STAGING DEPLOYMENT
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, docker-build, quality-gates]
    if: github.ref == 'refs/heads/V12' || github.ref == 'refs/heads/develop' || github.event.inputs.deploy_environment == 'staging'
    environment:
      name: staging
      url: https://staging.dlt.aurigraph.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to staging
        env:
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
        run: |
          ssh -i ~/.ssh/staging_key "${STAGING_USER}@${STAGING_HOST}" << 'DEPLOY_EOF'
            set -e
            echo "Deploying VVB Approval System to Staging..."
            mkdir -p ~/backups
            BACKUP_DIR="$HOME/backups/backup-$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            docker-compose -f docker-compose.staging.yml down || true
            cp -r ~/aurigraph-v11 "$BACKUP_DIR/" || true
            cd ~/aurigraph-v11
            docker-compose -f docker-compose.staging.yml pull
            docker-compose -f docker-compose.staging.yml up -d
            for i in {1..60}; do
              if curl -f http://localhost:9003/q/health >/dev/null 2>&1; then
                echo "Services are healthy"
                break
              fi
              sleep 2
            done
          DEPLOY_EOF

      - name: Run smoke tests
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
        run: |
          sleep 5
          curl -f "http://${STAGING_HOST}:9003/api/v11/health"

  # ============================================================================
  # STAGE 6: PRODUCTION DEPLOYMENT
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, docker-build, deploy-staging]
    if: github.ref == 'refs/heads/main' || github.event.inputs.deploy_environment == 'production'
    environment:
      name: production
      url: https://dlt.aurigraph.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/prod_key
          chmod 600 ~/.ssh/prod_key
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: Create production backup
        env:
          PROD_USER: ${{ secrets.PRODUCTION_USER }}
          PROD_HOST: ${{ secrets.PRODUCTION_HOST }}
        run: |
          ssh -i ~/.ssh/prod_key "${PROD_USER}@${PROD_HOST}" << 'BACKUP_EOF'
            set -e
            echo "Creating production backup..."
            BACKUP_DIR="/backups/backup-$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            docker exec aurigraph-postgres pg_dump -U aurigraph_user aurigraph_v12 > "$BACKUP_DIR/db_backup.sql" || true
            cp docker-compose.yml "$BACKUP_DIR/" || true
            echo "Backup created"
          BACKUP_EOF

      - name: Deploy to production
        env:
          PROD_USER: ${{ secrets.PRODUCTION_USER }}
          PROD_HOST: ${{ secrets.PRODUCTION_HOST }}
        run: |
          ssh -i ~/.ssh/prod_key "${PROD_USER}@${PROD_HOST}" << 'DEPLOY_EOF'
            set -e
            echo "Deploying VVB Approval System to Production..."
            cd /opt/aurigraph
            docker-compose down --timeout=30 || true
            docker-compose pull
            docker-compose up -d
            for i in {1..120}; do
              if curl -f http://localhost:9003/q/health >/dev/null 2>&1; then
                echo "Services are healthy"
                break
              fi
              sleep 5
            done
            curl -f http://localhost:9003/q/health
          DEPLOY_EOF

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.build.outputs.version }}
        run: |
          gh release create "v${VERSION}" \
            --title "VVB Approval System v${VERSION}" \
            --notes "Production release of VVB Approval System with monitoring, webhooks, and E2E tests."

  # ============================================================================
  # FAILURE NOTIFICATIONS
  # ============================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build, unit-tests, quality-gates, docker-build]
    if: failure()

    steps:
      - name: Create GitHub issue on failure
        if: ${{ github.event_name != 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          RUN_ID: ${{ github.run_id }}
        run: |
          gh issue create \
            --title "CI/CD Pipeline Failed on ${REF}" \
            --body "Pipeline failed for commit ${SHA} by ${ACTOR}. See run ${RUN_ID}."

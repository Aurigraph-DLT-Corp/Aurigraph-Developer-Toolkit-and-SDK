#===============================================================================
# Aurigraph DLT V12 - SSH Deployment (Port 22)
#
# Deploys to dlt.aurigraph.io via SSH on port 22
# Uses GitHub-hosted runners with SSH key authentication
#===============================================================================

name: SSH Deploy (Port 22)

on:
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: "Deploy Backend"
        type: boolean
        default: true
      deploy_frontend:
        description: "Deploy Frontend"
        type: boolean
        default: true
      skip_tests:
        description: "Skip tests"
        type: boolean
        default: true

env:
  JAVA_VERSION: "21"
  NODE_VERSION: "20"
  REMOTE_HOST: dlt.aurigraph.io
  REMOTE_USER: subbu
  REMOTE_PORT: 22
  APP_PORT: 9003

jobs:
  #=============================================================================
  # DEPLOY BACKEND VIA SSH
  #=============================================================================
  deploy-backend:
    name: Deploy Backend (SSH)
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy_backend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"
          cache: "maven"

      - name: Build application
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          echo "ðŸ”¨ Building V12..."
          ./mvnw clean package -DskipTests -B -q
          ls -lh target/*-runner.jar

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to server
        run: |
          echo "ðŸš€ Deploying to ${{ env.REMOTE_HOST }}:${{ env.REMOTE_PORT }}..."

          JAR_FILE=$(ls aurigraph-av10-7/aurigraph-v11-standalone/target/*-runner.jar | head -1)

          # Copy JAR
          scp -P ${{ env.REMOTE_PORT }} -i ~/.ssh/deploy_key \
            "$JAR_FILE" \
            ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }}:/home/subbu/aurigraph-v12-new.jar

          # Deploy and restart
          ssh -p ${{ env.REMOTE_PORT }} -i ~/.ssh/deploy_key \
            ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }} << 'DEPLOY'
            cd /home/subbu

            # Backup current
            if [ -f aurigraph-v12.jar ]; then
              cp aurigraph-v12.jar aurigraph-v12.jar.backup-$(date +%Y%m%d_%H%M%S)
            fi

            # Stop service
            sudo systemctl stop aurigraph-v12 2>/dev/null || true
            sleep 3

            # Deploy new JAR
            mv aurigraph-v12.jar aurigraph-v12.jar.previous 2>/dev/null || true
            mv aurigraph-v12-new.jar aurigraph-v12.jar
            chmod +x aurigraph-v12.jar

            # Start service
            sudo systemctl start aurigraph-v12
            sleep 15

            # Health check
            curl -s http://localhost:9003/api/v11/health | jq '.status'
          DEPLOY

      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying..."
          sleep 10
          curl -s https://${{ env.REMOTE_HOST }}/api/v11/health | jq '.'

  #=============================================================================
  # DEPLOY FRONTEND VIA SSH
  #=============================================================================
  deploy-frontend:
    name: Deploy Frontend (SSH)
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy_frontend }}
    needs: deploy-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: enterprise-portal/enterprise-portal/frontend/package-lock.json

      - name: Build frontend
        working-directory: enterprise-portal/enterprise-portal/frontend
        run: |
          npm ci
          npm run build
          tar -czvf frontend-dist.tar.gz dist/

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ env.REMOTE_PORT }} ${{ env.REMOTE_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy frontend
        run: |
          echo "ðŸš€ Deploying frontend..."

          # Copy dist
          scp -P ${{ env.REMOTE_PORT }} -i ~/.ssh/deploy_key \
            enterprise-portal/enterprise-portal/frontend/frontend-dist.tar.gz \
            ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }}:/tmp/

          # Extract and deploy
          ssh -p ${{ env.REMOTE_PORT }} -i ~/.ssh/deploy_key \
            ${{ env.REMOTE_USER }}@${{ env.REMOTE_HOST }} << 'DEPLOY'
            cd /tmp
            tar -xzf frontend-dist.tar.gz
            sudo cp -r dist/* /var/www/aurigraph-portal/current/ 2>/dev/null || \
              sudo cp -r dist/* /usr/share/nginx/html/
            sudo nginx -t && sudo systemctl reload nginx
            rm -rf /tmp/dist /tmp/frontend-dist.tar.gz
            echo "âœ… Frontend deployed"
          DEPLOY

      - name: Verify frontend
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.REMOTE_HOST }}/)
          echo "Frontend HTTP: $HTTP_CODE"

  #=============================================================================
  # SUMMARY
  #=============================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ SSH Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** https://dlt.aurigraph.io" >> $GITHUB_STEP_SUMMARY
          echo "**SSH Port:** 22" >> $GITHUB_STEP_SUMMARY

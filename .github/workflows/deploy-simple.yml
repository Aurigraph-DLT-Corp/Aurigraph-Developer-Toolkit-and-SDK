name: Simple Deploy to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'aurigraph-av10-7/aurigraph-v11-standalone/enterprise-portal-ui/**'
      - '.github/workflows/deploy-simple.yml'

env:
  NODE_VERSION: '20.x'
  DOMAIN_NAME: dlt.aurigraph.io

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Navigate to frontend directory
        run: |
          echo "Current directory: $(pwd)"
          echo "Repository structure:"
          ls -la
          cd aurigraph-av10-7/aurigraph-v11-standalone/enterprise-portal-ui
          echo "Frontend directory contents:"
          ls -la

      - name: Clean install dependencies
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone/enterprise-portal-ui
        run: |
          echo "Removing existing node_modules and lock file..."
          rm -rf node_modules package-lock.json
          echo "Installing dependencies..."
          npm install --legacy-peer-deps --no-audit --no-fund
          echo "Dependencies installed successfully"

      - name: Create production config
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone/enterprise-portal-ui
        run: |
          echo "Creating .env.production file..."
          cat > .env.production << 'EOF'
          REACT_APP_API_URL=https://dlt.aurigraph.io/api
          REACT_APP_WS_URL=wss://dlt.aurigraph.io/ws
          REACT_APP_AUTH_API_URL=https://iam2.aurigraph.io/realms/AurigraphDLT
          REACT_APP_IAM2_URL=https://iam2.aurigraph.io
          REACT_APP_IAM2_REALM=AurigraphDLT
          REACT_APP_IAM2_CLIENT_ID=aurigraph-portal
          REACT_APP_IAM2_REDIRECT_URI=https://dlt.aurigraph.io/auth/callback
          REACT_APP_SSO_ENABLED=true
          REACT_APP_ENV=production
          EOF
          echo ".env.production created"

      - name: Build frontend
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone/enterprise-portal-ui
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          CI: false
          GENERATE_SOURCEMAP: false
        run: |
          echo "Starting build process..."
          npm run build
          echo "Build completed successfully"
          echo "Build output:"
          ls -la build/

      - name: Create nginx configuration
        run: |
          cat > nginx.conf << 'EOF'
          server {
              listen 80;
              server_name dlt.aurigraph.io;
              return 301 https://$server_name$request_uri;
          }
          
          server {
              listen 443 ssl;
              http2 on;
              server_name dlt.aurigraph.io;
              
              ssl_certificate /etc/nginx/ssl/fullchain.pem;
              ssl_certificate_key /etc/nginx/ssl/privkey.pem;
              
              root /usr/share/nginx/html;
              index index.html;
              
              location /api/auth/sso/config {
                  default_type application/json;
                  return 200 '{"enabled":true,"provider":"oidc","endpoint":"https://iam2.aurigraph.io/realms/AurigraphDLT/protocol/openid-connect/auth","clientId":"aurigraph-portal","redirectUri":"https://dlt.aurigraph.io/auth/callback","scopes":["openid","profile","email"]}';
              }
              
              location /api/ {
                  default_type application/json;
                  return 200 '{"status":"ok","message":"Backend starting"}';
              }
              
              location /ws {
                  return 503;
              }
              
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
              
              location / {
                  try_files $uri /index.html;
              }
          }
          EOF

      - name: Setup SSH
        if: success()
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SERVER_PORT || '2235' }} -H ${{ secrets.SERVER_HOST || 'dlt.aurigraph.io' }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create deployment package
        if: success()
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone/enterprise-portal-ui
        run: |
          tar -czf /tmp/frontend-deploy.tar.gz build/
          cp ../../../nginx.conf /tmp/nginx.conf
          echo "Deployment package created"

      - name: Deploy to server
        if: success()
        env:
          SERVER_USER: ${{ secrets.SERVER_USERNAME || 'subbu' }}
          SERVER_HOST: ${{ secrets.SERVER_HOST || 'dlt.aurigraph.io' }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || '2235' }}
        run: |
          # Copy files to server
          scp -P $SERVER_PORT -i ~/.ssh/deploy_key \
            /tmp/frontend-deploy.tar.gz \
            /tmp/nginx.conf \
            $SERVER_USER@$SERVER_HOST:/tmp/ || exit 1
          
          # Execute deployment on server
          ssh -p $SERVER_PORT -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            echo "Deploying frontend..."
            
            # Extract frontend
            cd /tmp
            tar -xzf frontend-deploy.tar.gz
            
            # Deploy to web root
            sudo rm -rf /var/www/html/*
            sudo cp -r build/* /var/www/html/
            sudo chown -R www-data:www-data /var/www/html
            
            # Update nginx config if container exists
            if docker ps | grep -q aurigraph-nginx; then
              docker stop aurigraph-nginx || true
              docker rm aurigraph-nginx || true
            fi
            
            # Start nginx with new config
            docker run -d --name aurigraph-nginx \
              -p 80:80 -p 443:443 \
              -v /var/www/html:/usr/share/nginx/html:ro \
              -v /tmp/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
              -v /tmp:/etc/nginx/ssl:ro \
              --restart always \
              nginx:alpine
            
            # Generate self-signed cert if needed
            if [ ! -f /tmp/fullchain.pem ]; then
              sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout /tmp/privkey.pem -out /tmp/fullchain.pem \
                -subj '/CN=dlt.aurigraph.io' 2>/dev/null
            fi
            
            echo "Deployment complete!"
            
            # Test the deployment
            sleep 5
            curl -k -I https://dlt.aurigraph.io || true
          ENDSSH

      - name: Verify deployment
        if: always()
        run: |
          echo "Testing deployment..."
          curl -k -s -o /dev/null -w "HTTPS Status: %{http_code}\n" https://${{ env.DOMAIN_NAME }} || true
          echo "Deployment verification complete"
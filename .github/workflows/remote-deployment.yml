name: Remote Server CI/CD Deployment

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'aurigraph-av10-7/aurigraph-v11-standalone/**'
      - 'docker-compose*.yml'
      - 'deployment/**'
      - '.github/workflows/remote-deployment.yml'
      - 'traefik*.yml'
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Deployment target environment'
        required: true
        type: choice
        default: 'staging'
        options:
          - staging
          - production
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        type: choice
        default: 'blue-green'
        options:
          - blue-green
          - canary
          - rolling
      skip_tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/aurigraph-v11
  JAVA_VERSION: '21'
  REMOTE_PORT: '2235'
  REMOTE_DIR: '/opt/aurigraph'

permissions:
  contents: read
  packages: write
  deployments: write

jobs:
  # ============================================================
  # PHASE 0: J4C DEPLOYMENT AGENT - CHANGE DETECTION
  # ============================================================
  detect-changes:
    name: J4C Agent - Detect Changed Components
    runs-on: self-hosted
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend }}
      portal_changed: ${{ steps.changes.outputs.portal }}
      nodes_changed: ${{ steps.changes.outputs.nodes }}
      config_changed: ${{ steps.changes.outputs.config }}
      docker_changed: ${{ steps.changes.outputs.docker }}
      deploy_components: ${{ steps.changes.outputs.deploy_components }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed components
        id: changes
        run: |
          echo "=== J4C Deployment Agent - Change Detection ==="
          echo "Analyzing changes since last deployment..."
          echo ""

          # Get changed files
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Initialize flags
          BACKEND_CHANGED=false
          PORTAL_CHANGED=false
          NODES_CHANGED=false
          CONFIG_CHANGED=false
          DOCKER_CHANGED=false
          DEPLOY_COMPONENTS=""

          # Check for backend (V11 standalone) changes
          if echo "$CHANGED_FILES" | grep -qE "^aurigraph-av10-7/aurigraph-v11-standalone/"; then
            BACKEND_CHANGED=true
            DEPLOY_COMPONENTS="${DEPLOY_COMPONENTS}backend,"
            echo "âœ“ Backend (V11 API) changes detected"
          fi

          # Check for portal changes
          if echo "$CHANGED_FILES" | grep -qE "^enterprise-portal/"; then
            PORTAL_CHANGED=true
            DEPLOY_COMPONENTS="${DEPLOY_COMPONENTS}portal,"
            echo "âœ“ Enterprise Portal changes detected"
          fi

          # Check for node configuration changes
          if echo "$CHANGED_FILES" | grep -qE "^deploy-package/|^deployment/.*node"; then
            NODES_CHANGED=true
            DEPLOY_COMPONENTS="${DEPLOY_COMPONENTS}nodes,"
            echo "âœ“ Node configuration changes detected"
          fi

          # Check for config/infrastructure changes
          if echo "$CHANGED_FILES" | grep -qE "traefik|nginx|\.env|config/"; then
            CONFIG_CHANGED=true
            DEPLOY_COMPONENTS="${DEPLOY_COMPONENTS}config,"
            echo "âœ“ Configuration changes detected"
          fi

          # Check for docker-compose changes
          if echo "$CHANGED_FILES" | grep -qE "docker-compose.*\.yml$"; then
            DOCKER_CHANGED=true
            DEPLOY_COMPONENTS="${DEPLOY_COMPONENTS}docker,"
            echo "âœ“ Docker compose changes detected"
          fi

          # Remove trailing comma
          DEPLOY_COMPONENTS=$(echo "$DEPLOY_COMPONENTS" | sed 's/,$//')

          # If nothing specific detected, check for workflow changes
          if [ -z "$DEPLOY_COMPONENTS" ]; then
            if echo "$CHANGED_FILES" | grep -qE "^\.github/workflows/"; then
              echo "âœ“ Only workflow changes - minimal deployment"
              DEPLOY_COMPONENTS="workflow-only"
            else
              echo "âœ“ General changes - full deployment"
              DEPLOY_COMPONENTS="all"
            fi
          fi

          echo ""
          echo "=== Deployment Decision ==="
          echo "Components to deploy: $DEPLOY_COMPONENTS"
          echo ""

          # Set outputs
          echo "backend=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
          echo "portal=$PORTAL_CHANGED" >> $GITHUB_OUTPUT
          echo "nodes=$NODES_CHANGED" >> $GITHUB_OUTPUT
          echo "config=$CONFIG_CHANGED" >> $GITHUB_OUTPUT
          echo "docker=$DOCKER_CHANGED" >> $GITHUB_OUTPUT
          echo "deploy_components=$DEPLOY_COMPONENTS" >> $GITHUB_OUTPUT

      - name: Display deployment plan
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     J4C DEPLOYMENT AGENT - SELECTIVE DEPLOYMENT PLAN         â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ Components to Deploy:                                        â•‘"
          echo "â•‘   Backend (V11 API):     ${{ steps.changes.outputs.backend == 'true' && 'âœ… YES' || 'â¸ NO (unchanged)' }}"
          echo "â•‘   Enterprise Portal:     ${{ steps.changes.outputs.portal == 'true' && 'âœ… YES' || 'â¸ NO (unchanged)' }}"
          echo "â•‘   Nodes (Validators):    ${{ steps.changes.outputs.nodes == 'true' && 'âœ… YES' || 'â¸ NO (unchanged)' }}"
          echo "â•‘   Configuration:         ${{ steps.changes.outputs.config == 'true' && 'âœ… YES' || 'â¸ NO (unchanged)' }}"
          echo "â•‘   Docker Compose:        ${{ steps.changes.outputs.docker == 'true' && 'âœ… YES' || 'â¸ NO (unchanged)' }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ Strategy: Hot overwrite affected components only             â•‘"
          echo "â•‘ Unchanged components will NOT be redeployed                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ============================================================
  # PHASE 1: VALIDATION & BUILD
  # ============================================================
  validate-config:
    name: Validate Configuration
    runs-on: self-hosted
    needs: detect-changes
    outputs:
      config_valid: ${{ steps.validate.outputs.valid }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose files
        id: validate
        run: |
          echo "âœ“ Validating docker-compose files..."
          if command -v docker-compose &> /dev/null; then
            docker-compose -f docker-compose.yml config > /dev/null && echo "âœ“ docker-compose.yml valid"
            docker-compose -f docker-compose.production.yml config > /dev/null 2>&1 && echo "âœ“ docker-compose.production.yml valid" || echo "âš  Production config optional"
          fi
          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Verify Traefik configuration
        run: |
          echo "âœ“ Checking Traefik configuration files..."
          [ -f traefik-static.yml ] && echo "âœ“ traefik-static.yml found" || echo "âš  traefik-static.yml not found"
          [ -f traefik-config.toml ] && echo "âœ“ traefik-config.toml found" || echo "âš  traefik-config.toml not found"

  build:
    name: Build & Test
    runs-on: self-hosted
    needs: [validate-config, detect-changes]
    outputs:
      version: ${{ steps.version.outputs.version }}
      image_tag: ${{ steps.meta.outputs.tags }}
      backend_changed: ${{ needs.detect-changes.outputs.backend_changed }}
      portal_changed: ${{ needs.detect-changes.outputs.portal_changed }}
      deploy_components: ${{ needs.detect-changes.outputs.deploy_components }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Get version
        id: version
        run: |
          VERSION=$(mvn -f aurigraph-av10-7/aurigraph-v11-standalone/pom.xml help:evaluate -Dexpression=project.version -q -DforceStdout)
          BUILD_NUM=${{ github.run_number }}
          echo "version=${VERSION}-${BUILD_NUM}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: ${VERSION}-${BUILD_NUM}"

      - name: Display deployment components
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  J4C DEPLOYMENT AGENT - SELECTIVE BUILD & DEPLOY             â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Components to build/deploy: ${{ needs.detect-changes.outputs.deploy_components }}"
          echo "â•‘  Backend changed: ${{ needs.detect-changes.outputs.backend_changed }}"
          echo "â•‘  Portal changed: ${{ needs.detect-changes.outputs.portal_changed }}"
          echo "â•‘  Nodes changed: ${{ needs.detect-changes.outputs.nodes_changed }}"
          echo "â•‘  Docker changed: ${{ needs.detect-changes.outputs.docker_changed }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Build V11 Backend (Conditional)
        if: needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.deploy_components == 'all'
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          echo "ğŸ”¨ Building V11 Backend (changes detected)..."
          ./mvnw clean package -DskipTests -B
          echo "âœ… Backend build completed"

      - name: Skip V11 Backend Build (No Changes)
        if: needs.detect-changes.outputs.backend_changed != 'true' && needs.detect-changes.outputs.deploy_components != 'all'
        run: |
          echo "â¸ Skipping V11 Backend build - No changes detected"
          echo "Backend unchanged - using existing deployed version"

      - name: Run quick tests (Conditional)
        if: (needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.deploy_components == 'all') && !inputs.skip_tests
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          echo "ğŸ§ª Running tests for changed backend..."
          ./mvnw test -B --fail-at-end
          echo "âœ… Tests completed"
        continue-on-error: true

      - name: Set up Docker Buildx
        if: needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.docker_changed == 'true' || needs.detect-changes.outputs.deploy_components == 'all'
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.docker_changed == 'true' || needs.detect-changes.outputs.deploy_components == 'all'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.docker_changed == 'true' || needs.detect-changes.outputs.deploy_components == 'all'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=${{ steps.version.outputs.version }}

      - name: Build and push Docker image (Conditional)
        if: needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.docker_changed == 'true' || needs.detect-changes.outputs.deploy_components == 'all'
        uses: docker/build-push-action@v5
        with:
          context: aurigraph-av10-7/aurigraph-v11-standalone
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip Docker build (No Changes)
        if: needs.detect-changes.outputs.backend_changed != 'true' && needs.detect-changes.outputs.docker_changed != 'true' && needs.detect-changes.outputs.deploy_components != 'all'
        run: |
          echo "â¸ Skipping Docker build - No backend or docker changes detected"
          echo "Using existing Docker image from previous deployment"

  # ============================================================
  # PHASE 2: REMOTE DEPLOYMENT
  # ============================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/develop' || github.event.inputs.deployment_target == 'staging'
    environment:
      name: staging
      url: https://staging.dlt.aurigraph.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ env.REMOTE_PORT }} ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to staging server
        run: |
          ssh -p ${{ env.REMOTE_PORT }} ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
          set -e
          echo "ğŸš€ Starting deployment to staging..."

          cd ${{ env.REMOTE_DIR }}/staging

          # Pull latest code
          git pull origin develop

          # Update Docker images
          docker-compose pull

          # Deploy with new images
          docker-compose -f docker-compose.yml up -d

          # Wait for services
          sleep 30

          # Health checks
          echo "ğŸ” Running health checks..."
          curl -f http://localhost:9004/q/health/ready && echo "âœ… V11 API healthy" || echo "âš ï¸ Health check pending"
          curl -f http://localhost:3000 && echo "âœ… Portal healthy" || echo "âš ï¸ Portal pending"

          # Show container status
          echo "ğŸ“¦ Container status:"
          docker ps --format "table {{.Names}}\t{{.Status}}"

          echo "âœ… Staging deployment complete"
          EOF

      - name: Verify staging deployment
        run: |
          echo "ğŸ” Verifying staging deployment..."
          for i in {1..10}; do
            if curl -sf https://staging.dlt.aurigraph.io/api/v11/health > /dev/null 2>&1; then
              echo "âœ… Staging verification successful"
              exit 0
            fi
            echo "Attempt $i/10..."
            sleep 10
          done
          echo "âš ï¸ Staging verification timeout"

  deploy-production:
    name: Deploy to Production (Selective)
    runs-on: self-hosted
    needs: [build, detect-changes]
    if: github.ref == 'refs/heads/main' || github.event.inputs.deployment_target == 'production'
    environment:
      name: production
      url: https://dlt.aurigraph.io
    concurrency: production-deployment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ env.REMOTE_PORT }} ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: J4C Agent - Selective Deployment Plan
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     J4C DEPLOYMENT AGENT - SELECTIVE HOT OVERWRITE PLAN          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Mode: HOT OVERWRITE (Only affected components)                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Components to Deploy:                                           â•‘"
          echo "â•‘    Backend (V11 API):     ${{ needs.detect-changes.outputs.backend_changed == 'true' && 'ğŸ”„ DEPLOY' || 'â¸ SKIP (unchanged)' }}"
          echo "â•‘    Enterprise Portal:     ${{ needs.detect-changes.outputs.portal_changed == 'true' && 'ğŸ”„ DEPLOY' || 'â¸ SKIP (unchanged)' }}"
          echo "â•‘    Nodes (Validators):    ${{ needs.detect-changes.outputs.nodes_changed == 'true' && 'ğŸ”„ DEPLOY' || 'â¸ SKIP (unchanged)' }}"
          echo "â•‘    Configuration:         ${{ needs.detect-changes.outputs.config_changed == 'true' && 'ğŸ”„ DEPLOY' || 'â¸ SKIP (unchanged)' }}"
          echo "â•‘    Docker Infrastructure: ${{ needs.detect-changes.outputs.docker_changed == 'true' && 'ğŸ”„ DEPLOY' || 'â¸ SKIP (unchanged)' }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Deploy List: ${{ needs.detect-changes.outputs.deploy_components }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  âš¡ Unchanged components will NOT be restarted or overwritten    â•‘"
          echo "â•‘  âš¡ Zero-downtime for unaffected services                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: Pre-deployment cleanup (Backend only)
        if: needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.deploy_components == 'all'
        run: |
          echo "ğŸ§¹ Pre-deployment cleanup - Checking for old instances..."
          ssh -p ${{ env.REMOTE_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
          set -e
          echo "=== J4C Deployment Agent - Pre-Deployment Cleanup ==="
          echo "Timestamp: $(date)"
          echo ""

          # Check for running Java processes (aurigraph/quarkus)
          echo "ğŸ“‹ Checking running Java processes..."
          JAVA_PROCS=$(pgrep -f 'quarkus-run.jar\|aurigraph' 2>/dev/null || true)
          if [ -n "$JAVA_PROCS" ]; then
            echo "Found running processes: $JAVA_PROCS"
            echo "Stopping old Java processes..."
            pkill -f 'quarkus-run.jar' 2>/dev/null || true
            pkill -f 'aurigraph-v12.jar' 2>/dev/null || true
            sleep 5
            echo "âœ… Old Java processes stopped"
          else
            echo "âœ… No old Java processes found"
          fi

          # Check for old Docker containers
          echo ""
          echo "ğŸ³ Checking Docker containers..."
          OLD_CONTAINERS=$(docker ps -a --filter "name=aurigraph" --filter "status=exited" -q 2>/dev/null || true)
          if [ -n "$OLD_CONTAINERS" ]; then
            echo "Found stopped containers: $OLD_CONTAINERS"
            echo "Removing stopped aurigraph containers..."
            docker rm -f $OLD_CONTAINERS 2>/dev/null || true
            echo "âœ… Old containers removed"
          else
            echo "âœ… No stopped containers found"
          fi

          # Check for dangling Docker images
          echo ""
          echo "ğŸ–¼ï¸ Checking dangling Docker images..."
          DANGLING_IMAGES=$(docker images -f "dangling=true" -q 2>/dev/null || true)
          if [ -n "$DANGLING_IMAGES" ]; then
            echo "Found dangling images"
            echo "Removing dangling images..."
            docker image prune -f 2>/dev/null || true
            echo "âœ… Dangling images removed"
          else
            echo "âœ… No dangling images found"
          fi

          # Check for old aurigraph images (keep last 3)
          echo ""
          echo "ğŸ—‘ï¸ Cleaning old aurigraph images (keeping last 3)..."
          docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" | grep aurigraph | tail -n +4 | awk '{print $2}' | xargs -r docker rmi 2>/dev/null || true

          # Clean up old deployment backups (keep last 5)
          echo ""
          echo "ğŸ’¾ Cleaning old backups (keeping last 5)..."
          ls -dt $HOME/quarkus-app.backup.* 2>/dev/null | tail -n +6 | xargs rm -rf 2>/dev/null || true

          # Show disk usage
          echo ""
          echo "ğŸ“Š Disk usage:"
          df -h / | tail -1

          # Show memory usage
          echo ""
          echo "ğŸ’» Memory usage:"
          free -h | head -2

          echo ""
          echo "âœ… Pre-deployment cleanup complete"
          echo "==================================================="
          EOF

      - name: Skip cleanup (No backend changes)
        if: needs.detect-changes.outputs.backend_changed != 'true' && needs.detect-changes.outputs.deploy_components != 'all'
        run: |
          echo "â¸ Skipping pre-deployment cleanup - No backend changes detected"
          echo "Existing backend services will continue running"

      - name: Pre-deployment backup (Conditional)
        if: needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.deploy_components == 'all'
        run: |
          echo "ğŸ’¾ Creating pre-deployment backup..."
          ssh -p ${{ env.REMOTE_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
          set -e
          BACKUP_DIR="/opt/aurigraph/backups/pre-deploy-$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$BACKUP_DIR"

          # Backup docker volumes
          echo "Backing up database..."
          docker exec dlt-postgres pg_dump -U aurigraph aurigraph_production | gzip > "$BACKUP_DIR/aurigraph-db.sql.gz"

          # Backup configurations
          cp -r /opt/aurigraph/config "$BACKUP_DIR/" 2>/dev/null || true

          echo "âœ… Backup created: $BACKUP_DIR"
          ls -lh "$BACKUP_DIR"
          EOF

      - name: Determine deployment strategy
        id: strategy
        run: |
          STRATEGY="${{ github.event.inputs.deployment_strategy || 'blue-green' }}"
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Deployment strategy: $STRATEGY"

      - name: Deploy (Blue-Green) - Selective
        if: steps.strategy.outputs.strategy == 'blue-green' && (needs.detect-changes.outputs.backend_changed == 'true' || needs.detect-changes.outputs.docker_changed == 'true' || needs.detect-changes.outputs.deploy_components == 'all')
        run: |
          echo "ğŸ”„ Starting selective blue-green deployment..."
          echo "ğŸ“¦ Only deploying changed components: ${{ needs.detect-changes.outputs.deploy_components }}"
          ssh -p ${{ env.REMOTE_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
          set -e

          cd ${{ env.REMOTE_DIR }}/production

          # Update code
          git pull origin main

          # Pull latest images
          docker-compose pull

          # Deploy to green environment
          export DEPLOYMENT_SLOT=green
          docker-compose -f docker-compose.yml up -d

          # Wait for stability
          sleep 45

          # Health check on green
          echo "ğŸ” Health checking green environment..."
          RETRY=0
          while [ $RETRY -lt 12 ]; do
            if curl -f http://localhost:9004/q/health/ready > /dev/null 2>&1; then
              echo "âœ… Green environment healthy"
              break
            fi
            RETRY=$((RETRY + 1))
            echo "Attempt $RETRY/12..."
            sleep 5
          done

          if [ $RETRY -eq 12 ]; then
            echo "âŒ Green environment unhealthy, rolling back"
            docker-compose down
            exit 1
          fi

          # Switch traffic (managed by load balancer/Traefik)
          echo "ğŸ”€ Switching traffic to green..."

          # Verify production health
          for i in {1..10}; do
            if curl -sf https://dlt.aurigraph.io/api/v11/health > /dev/null 2>&1; then
              echo "âœ… Production traffic switched successfully"
              break
            fi
            echo "Verification attempt $i/10..."
            sleep 5
          done

          # Show deployment status
          echo "ğŸ“¦ Final status:"
          docker ps --format "table {{.Names}}\t{{.Status}}"

          echo "âœ… Blue-green deployment complete"
          EOF

      - name: Deploy (Canary)
        if: steps.strategy.outputs.strategy == 'canary'
        run: |
          echo "ğŸ¯ Starting canary deployment (5% traffic)..."
          ssh -p ${{ env.REMOTE_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
          set -e

          cd ${{ env.REMOTE_DIR }}/production

          # Update and deploy
          git pull origin main
          docker-compose pull
          docker-compose up -d

          # Monitor canary
          sleep 30
          ERROR_RATE=$(curl -s http://localhost:9003/metrics 2>/dev/null | grep 'http_requests_total{.*status="5' | wc -l || echo "0")

          if [ "$ERROR_RATE" -lt "5" ]; then
            echo "âœ… Canary deployment successful with $ERROR_RATE errors"
          else
            echo "âŒ High error rate detected in canary, rolling back"
            exit 1
          fi
          EOF

      - name: Skip Deployment (No Changes to Deploy)
        if: needs.detect-changes.outputs.backend_changed != 'true' && needs.detect-changes.outputs.docker_changed != 'true' && needs.detect-changes.outputs.deploy_components != 'all' && needs.detect-changes.outputs.deploy_components != 'workflow-only'
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     J4C DEPLOYMENT AGENT - ZERO-TOUCH DEPLOYMENT                 â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Status: NO DEPLOYABLE CHANGES DETECTED                          â•‘"
          echo "â•‘                                                                   â•‘"
          echo "â•‘  Components checked:                                             â•‘"
          echo "â•‘    Backend (V11 API):     â¸ No changes"
          echo "â•‘    Docker Infrastructure: â¸ No changes"
          echo "â•‘                                                                   â•‘"
          echo "â•‘  Action: SKIPPING DEPLOYMENT                                     â•‘"
          echo "â•‘  Existing production services remain UNCHANGED and RUNNING       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Zero-downtime achieved - no unnecessary restarts!"

      - name: Verify production health
        run: |
          echo "ğŸ” Verifying production deployment..."
          for i in {1..15}; do
            HEALTH=$(curl -s https://dlt.aurigraph.io/api/v11/health 2>/dev/null | jq -r '.status' || echo 'down')
            if [ "$HEALTH" = "UP" ]; then
              echo "âœ… Production health verified: $HEALTH"

              # Check key endpoints
              curl -s https://dlt.aurigraph.io/api/v11/info | jq '.version' && echo "âœ… API responding"
              exit 0
            fi
            echo "Verification attempt $i/15 - Status: $HEALTH"
            sleep 10
          done
          echo "âŒ Production verification failed"
          exit 1

      - name: Smoke tests
        run: |
          echo "ğŸ§ª Running smoke tests..."
          echo "Testing health endpoint..."
          curl -f https://dlt.aurigraph.io/api/v11/health || exit 1
          echo "âœ… Health endpoint OK"

          echo "Testing info endpoint..."
          curl -f https://dlt.aurigraph.io/api/v11/info || exit 1
          echo "âœ… Info endpoint OK"

          echo "Testing metrics..."
          curl -f https://dlt.aurigraph.io/metrics 2>/dev/null | head -c 100
          echo ""
          echo "âœ… Smoke tests passed"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "ğŸ”„ Initiating rollback..."
          ssh -p ${{ env.REMOTE_PORT }} ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
          set -e

          cd ${{ env.REMOTE_DIR }}/production

          # Get latest backup
          LATEST_BACKUP=$(ls -t /opt/aurigraph/backups/pre-deploy-* 2>/dev/null | head -1)

          if [ -n "$LATEST_BACKUP" ]; then
            echo "Rolling back from: $LATEST_BACKUP"

            # Stop current deployment
            docker-compose down || true

            # Restore database
            if [ -f "$LATEST_BACKUP/aurigraph-db.sql.gz" ]; then
              echo "Restoring database..."
              zcat "$LATEST_BACKUP/aurigraph-db.sql.gz" | docker exec -i dlt-postgres psql -U aurigraph aurigraph_production
            fi

            # Restart services
            docker-compose up -d
            sleep 30

            echo "âœ… Rollback complete"
          else
            echo "âŒ No backup found for rollback"
            exit 1
          fi
          EOF

  # ============================================================
  # PHASE 3: POST-DEPLOYMENT MONITORING
  # ============================================================
  monitor-deployment:
    name: Monitor Deployment (5 min)
    runs-on: self-hosted
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: Monitor metrics
        run: |
          echo "ğŸ“Š Monitoring deployment metrics..."
          echo "This job monitors the deployed services for 5 minutes"
          echo "Checking every 30 seconds..."

          for i in {1..10}; do
            echo ""
            echo "Check $i/10 at $(date)"

            # Check production if available
            if curl -sf https://dlt.aurigraph.io/q/health > /dev/null 2>&1; then
              curl -s https://dlt.aurigraph.io/q/health | jq '.status' || echo "Health check pending"
            fi

            sleep 30
          done

          echo ""
          echo "âœ… 5-minute monitoring period complete"

  # ============================================================
  # PHASE 4: NOTIFICATIONS
  # ============================================================
  notify-success:
    name: Notify Success
    runs-on: self-hosted
    needs: [deploy-production, monitor-deployment]
    if: success()

    steps:
      - name: Create deployment summary
        run: |
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://dlt.aurigraph.io/api/v11" >> $GITHUB_STEP_SUMMARY
          echo "- Portal: https://dlt.aurigraph.io" >> $GITHUB_STEP_SUMMARY
          echo "- Health: https://dlt.aurigraph.io/q/health" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âœ… Production Deployment Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸš€ *Production Deployment Successful*\n\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}\n*Branch:* ${{ github.ref_name }}\n\n<https://dlt.aurigraph.io|View Portal>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  notify-failure:
    name: Notify Failure
    runs-on: self-hosted
    needs: [deploy-production]
    if: failure()

    steps:
      - name: Create failure summary
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**View logs:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack failure notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âŒ Production Deployment Failed - Rollback Initiated",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âš ï¸ *Production Deployment Failed*\n\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}\n*Status:* Automatic rollback initiated\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

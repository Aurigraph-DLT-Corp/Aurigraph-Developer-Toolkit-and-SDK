name: Frontend Deploy to Remote

on:
  push:
    branches:
      - V12
      - main
    paths:
      - 'enterprise-portal/enterprise-portal/frontend/src/**'
      - 'enterprise-portal/enterprise-portal/frontend/package.json'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_only:
        description: 'Deploy without rebuild (use existing dist)'
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  FRONTEND_DIR: 'enterprise-portal/enterprise-portal/frontend'

jobs:
  build-and-deploy:
    name: Build & Deploy Frontend
    runs-on: [self-hosted, Linux, aurigraph-prod]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: ${{ !inputs.deploy_only }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: enterprise-portal/enterprise-portal/frontend/package-lock.json

      - name: Install dependencies
        if: ${{ !inputs.deploy_only }}
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Build Frontend
        if: ${{ !inputs.deploy_only }}
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "Building Enterprise Portal..."
          npm run build
          echo "Build complete!"
          ls -lh dist/

      - name: Deploy Frontend (Local Runner)
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "=== Frontend Deployment (Local Runner) ==="
          echo "Timestamp: $(date)"
          echo "Runner is on the production server - using local file operations"

          # NGINX serves from /usr/share/nginx/html
          DEPLOY_DIR="/usr/share/nginx/html"
          BACKUP_DIR="/home/subbu/enterprise-portal"

          # Create backup
          echo "Creating backup in $BACKUP_DIR..."
          rm -rf $BACKUP_DIR/*
          cp -r dist/* $BACKUP_DIR/

          # Clear old NGINX files
          echo "Clearing old NGINX frontend files..."
          sudo rm -rf $DEPLOY_DIR/*

          # Copy new build to NGINX directory
          echo "Copying new build to NGINX directory..."
          sudo cp -r dist/* $DEPLOY_DIR/

          # Set correct ownership for NGINX
          echo "Setting permissions..."
          sudo chown -R www-data:www-data $DEPLOY_DIR/

          # Verify deployment
          echo "Verifying files in NGINX directory..."
          ls -la $DEPLOY_DIR/

          echo "Frontend deployment complete!"

      - name: Verify Frontend
        run: |
          echo "Verifying frontend is accessible..."
          sleep 3

          # Check main page loads (non-fatal - curl might have issues with SSL from server)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://dlt.aurigraph.io/ 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Frontend accessible (HTTP $HTTP_CODE)"
          else
            echo "Note: Frontend check returned HTTP $HTTP_CODE (may be SSL issue from server)"
          fi

          # Check API health (non-fatal)
          if curl -sf https://dlt.aurigraph.io/api/v11/health 2>/dev/null; then
            echo "API healthy"
          else
            echo "Note: API health check unavailable from runner (SSL)"
          fi

          echo ""
          echo "=== Deployment Summary ==="
          echo "Frontend files deployed to /usr/share/nginx/html/"
          echo "Backup available at /home/subbu/enterprise-portal/"
          echo ""
          echo "Access URLs:"
          echo "  Frontend: https://dlt.aurigraph.io"
          echo "  Demo: https://dlt.aurigraph.io/demo"
          echo "  Tokenize: https://dlt.aurigraph.io/rwa/tokenize"
          echo ""
          echo "Deployment complete!"

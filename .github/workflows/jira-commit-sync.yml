name: JIRA Commit Synchronization

on:
  push:
    branches: [ main, develop, 'feature/**', 'hotfix/**', 'release/**' ]
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Specific commit SHA to sync (optional)'
        required: false
        type: string

env:
  JIRA_BASE_URL: https://aurigraphdlt.atlassian.net
  JIRA_PROJECT_KEY: AV11
  JIRA_EMAIL: subbu@aurigraph.io

jobs:
  sync-commits-to-jira:
    name: Sync Commits to JIRA
    runs-on: ubuntu-latest
    if: github.repository == 'Aurigraph-DLT-Corp/Aurigraph-DLT'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install axios

    - name: Extract and Process Commits
      id: process-commits
      run: |
        echo "Processing commits for JIRA synchronization..."
        
        # Determine commit range
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ ! -z "${{ github.event.inputs.commit_sha }}" ]; then
          COMMIT_RANGE="${{ github.event.inputs.commit_sha }}^..${{ github.event.inputs.commit_sha }}"
        else
          COMMIT_RANGE="${{ github.event.before }}..${{ github.event.after }}"
        fi
        
        echo "Commit range: $COMMIT_RANGE"
        
        # Extract commit information
        git log --pretty=format:"%H|%s|%an|%ae|%ad|%B" --date=iso $COMMIT_RANGE > commits.txt
        
        # Process each commit
        while IFS='|' read -r hash subject author email date body; do
          if [ ! -z "$hash" ]; then
            echo "Processing commit: $hash"
            
            # Extract JIRA issue numbers (AV11-XXX format)
            JIRA_ISSUES=$(echo "$subject $body" | grep -oE 'AV11-[0-9]+' | sort -u)
            
            if [ ! -z "$JIRA_ISSUES" ]; then
              echo "Found JIRA issues in commit $hash: $JIRA_ISSUES"
              
              # Get commit details
              COMMIT_URL="https://github.com/${{ github.repository }}/commit/$hash"
              FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r $hash | wc -l)
              INSERTIONS=$(git show --stat $hash | tail -1 | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
              DELETIONS=$(git show --stat $hash | tail -1 | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")
              
              # Create JSON payload for each JIRA issue
              for issue in $JIRA_ISSUES; do
                echo "Creating update for JIRA issue: $issue"
                
                # Create comment body
                COMMENT_BODY="ðŸ”„ **Commit Update from GitHub**

**Repository**: \`${{ github.repository }}\`
**Branch**: \`${{ github.ref_name }}\`
**Commit**: [$hash]($COMMIT_URL)
**Author**: $author ($email)
**Date**: $date

**Commit Message**:
\`\`\`
$subject
\`\`\`

**Statistics**:
- ðŸ“ Files changed: $FILES_CHANGED
- âž• Insertions: $INSERTIONS
- âž– Deletions: $DELETIONS

**Full Message**:
\`\`\`
$body
\`\`\`

---
*Auto-synchronized from GitHub Actions*"
                
                # Store for API call
                echo "$issue|$COMMENT_BODY" >> jira_updates.txt
              done
            fi
          fi
        done < commits.txt
        
        # Count updates
        UPDATE_COUNT=$(wc -l < jira_updates.txt 2>/dev/null || echo "0")
        echo "Total JIRA updates to process: $UPDATE_COUNT"
        echo "update_count=$UPDATE_COUNT" >> $GITHUB_OUTPUT

    - name: Update JIRA Issues
      if: steps.process-commits.outputs.update_count > 0
      run: |
        echo "Updating JIRA issues with commit information..."
        
        # Process each JIRA update
        while IFS='|' read -r issue comment_body; do
          if [ ! -z "$issue" ]; then
            echo "Updating JIRA issue: $issue"
            
            # Escape JSON special characters
            ESCAPED_COMMENT=$(echo "$comment_body" | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n' | sed 's/\\n$//')
            
            # Create JSON payload
            JSON_PAYLOAD=$(cat <<EOF
{
  "body": {
    "type": "doc",
    "version": 1,
    "content": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "text": "$ESCAPED_COMMENT"
          }
        ]
      }
    ]
  }
}
EOF
)
            
            # Make API call to add comment
            RESPONSE=$(curl -s -w "%{http_code}" -X POST \
              -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -d "$JSON_PAYLOAD" \
              "${{ env.JIRA_BASE_URL }}/rest/api/3/issue/$issue/comment")
            
            HTTP_CODE="${RESPONSE: -3}"
            RESPONSE_BODY="${RESPONSE%???}"
            
            if [ "$HTTP_CODE" -eq 201 ]; then
              echo "âœ… Successfully updated JIRA issue $issue"
            else
              echo "âŒ Failed to update JIRA issue $issue (HTTP $HTTP_CODE)"
              echo "Response: $RESPONSE_BODY"
            fi
            
            # Rate limiting - wait between requests
            sleep 1
          fi
        done < jira_updates.txt

    - name: Transition Issues Based on Branch
      if: steps.process-commits.outputs.update_count > 0
      run: |
        echo "Checking if issues should be transitioned based on branch..."
        
        # Define transitions based on branch patterns
        case "${{ github.ref_name }}" in
          "main")
            TRANSITION_NAME="Done"
            TRANSITION_COMMENT="ðŸŽ‰ **Code merged to main branch** - Issue completed!"
            ;;
          "develop")
            TRANSITION_NAME="In Review"
            TRANSITION_COMMENT="ðŸ” **Code merged to develop branch** - Ready for review!"
            ;;
          feature/*)
            TRANSITION_NAME="In Progress"
            TRANSITION_COMMENT="ðŸš§ **Feature branch updated** - Development in progress!"
            ;;
          hotfix/*)
            TRANSITION_NAME="In Progress"
            TRANSITION_COMMENT="ðŸ”¥ **Hotfix branch updated** - Critical fix in progress!"
            ;;
          *)
            TRANSITION_NAME=""
            TRANSITION_COMMENT=""
            ;;
        esac
        
        if [ ! -z "$TRANSITION_NAME" ]; then
          echo "Applying transition: $TRANSITION_NAME"
          
          # Extract unique JIRA issues from updates
          UNIQUE_ISSUES=$(cut -d'|' -f1 jira_updates.txt | sort -u)
          
          for issue in $UNIQUE_ISSUES; do
            echo "Attempting to transition $issue to $TRANSITION_NAME"
            
            # Get available transitions for the issue
            TRANSITIONS=$(curl -s \
              -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
              -H "Content-Type: application/json" \
              "${{ env.JIRA_BASE_URL }}/rest/api/3/issue/$issue/transitions")
            
            # Find transition ID for the desired status
            TRANSITION_ID=$(echo "$TRANSITIONS" | grep -A 10 "\"name\":\"$TRANSITION_NAME\"" | grep -o '"id":"[^"]*"' | cut -d'"' -f4 | head -1)
            
            if [ ! -z "$TRANSITION_ID" ]; then
              echo "Found transition ID $TRANSITION_ID for $TRANSITION_NAME"
              
              # Perform transition
              curl -s -X POST \
                -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
                -H "Content-Type: application/json" \
                -d "{
                  \"transition\": {
                    \"id\": \"$TRANSITION_ID\"
                  },
                  \"update\": {
                    \"comment\": [
                      {
                        \"add\": {
                          \"body\": \"$TRANSITION_COMMENT\"
                        }
                      }
                    ]
                  }
                }" \
                "${{ env.JIRA_BASE_URL }}/rest/api/3/issue/$issue/transitions"
              
              echo "âœ… Transitioned $issue to $TRANSITION_NAME"
            else
              echo "âš ï¸ No valid transition found for $issue to $TRANSITION_NAME"
            fi
          done
        fi

    - name: Generate Summary Report
      if: always()
      run: |
        echo "## ðŸ“Š JIRA Commit Sync Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**JIRA Updates**: ${{ steps.process-commits.outputs.update_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f jira_updates.txt ]; then
          echo "### ðŸŽ¯ Updated JIRA Issues" >> $GITHUB_STEP_SUMMARY
          cut -d'|' -f1 jira_updates.txt | sort -u | while read issue; do
            echo "- [$issue](${{ env.JIRA_BASE_URL }}/browse/$issue)" >> $GITHUB_STEP_SUMMARY
          done
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **JIRA Project**: [${{ env.JIRA_PROJECT_KEY }}](${{ env.JIRA_BASE_URL }}/projects/${{ env.JIRA_PROJECT_KEY }})" >> $GITHUB_STEP_SUMMARY

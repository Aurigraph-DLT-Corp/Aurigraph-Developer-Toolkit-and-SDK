name: JIRA Bulk Operations

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Bulk operation to perform'
        required: true
        type: choice
        options:
          - 'create-from-data'
          - 'update-all-tickets'
          - 'sync-github-issues'
          - 'bulk-transition'
          - 'create-from-template'
          - 'project-cleanup'
          - 'export-tickets'
      data_source:
        description: 'Data source file (for create operations)'
        required: false
        default: '.github/data/tickets-data.json'
        type: string
      template_name:
        description: 'Template name (for template operations)'
        required: false
        type: choice
        options:
          - 'epic-template'
          - 'story-template'
          - 'task-template'
          - 'bug-template'
          - 'feature-template'
      transition_status:
        description: 'Target status for bulk transition'
        required: false
        type: choice
        options:
          - 'To Do'
          - 'In Progress'
          - 'In Review'
          - 'Done'
          - 'Cancelled'
      filter_criteria:
        description: 'JQL filter for bulk operations (optional)'
        required: false
        type: string
      dry_run:
        description: 'Perform dry run (no actual changes)'
        required: false
        default: true
        type: boolean

env:
  JIRA_BASE_URL: https://aurigraphdlt.atlassian.net
  JIRA_PROJECT_KEY: AV11
  JIRA_EMAIL: subbu@aurigraph.io

jobs:
  bulk-operations:
    name: Execute JIRA Bulk Operations
    runs-on: ubuntu-latest
    if: github.repository == 'Aurigraph-DLT-Corp/Aurigraph-DLT'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install axios fs-extra csv-parser yaml

    - name: Validate Operation Parameters
      run: |
        echo "ðŸ” Validating operation parameters..."
        echo "Operation: ${{ github.event.inputs.operation }}"
        echo "Data source: ${{ github.event.inputs.data_source }}"
        echo "Template: ${{ github.event.inputs.template_name }}"
        echo "Transition status: ${{ github.event.inputs.transition_status }}"
        echo "Filter criteria: ${{ github.event.inputs.filter_criteria }}"
        echo "Dry run: ${{ github.event.inputs.dry_run }}"
        
        # Validate required parameters based on operation
        case "${{ github.event.inputs.operation }}" in
          "create-from-data")
            if [ ! -f "${{ github.event.inputs.data_source }}" ]; then
              echo "âŒ Data source file not found: ${{ github.event.inputs.data_source }}"
              exit 1
            fi
            ;;
          "create-from-template")
            if [ -z "${{ github.event.inputs.template_name }}" ]; then
              echo "âŒ Template name required for template operations"
              exit 1
            fi
            ;;
          "bulk-transition")
            if [ -z "${{ github.event.inputs.transition_status }}" ]; then
              echo "âŒ Transition status required for bulk transition"
              exit 1
            fi
            ;;
        esac
        
        echo "âœ… Parameters validated successfully"

    - name: Test JIRA Connection
      run: |
        echo "ðŸ§ª Testing JIRA API connection..."
        
        RESPONSE=$(curl -s -w "%{http_code}" \
          -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
          -H "Accept: application/json" \
          "${{ env.JIRA_BASE_URL }}/rest/api/3/project/${{ env.JIRA_PROJECT_KEY }}")
        
        HTTP_CODE="${RESPONSE: -3}"
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "âœ… JIRA connection successful"
        else
          echo "âŒ JIRA connection failed (HTTP $HTTP_CODE)"
          exit 1
        fi

    - name: Execute Bulk Operation - Create from Data
      if: github.event.inputs.operation == 'create-from-data'
      run: |
        echo "ðŸ“Š Creating tickets from data source: ${{ github.event.inputs.data_source }}"
        
        node .github/scripts/jira-bulk-manager.js create-from-data \
          --source "${{ github.event.inputs.data_source }}" \
          --dry-run "${{ github.event.inputs.dry_run }}" \
          --project "${{ env.JIRA_PROJECT_KEY }}"

    - name: Execute Bulk Operation - Update All Tickets
      if: github.event.inputs.operation == 'update-all-tickets'
      run: |
        echo "ðŸ”„ Updating all tickets in project ${{ env.JIRA_PROJECT_KEY }}"
        
        # Get all tickets in project
        ALL_TICKETS=$(curl -s \
          -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
          -H "Accept: application/json" \
          "${{ env.JIRA_BASE_URL }}/rest/api/3/search?jql=project=${{ env.JIRA_PROJECT_KEY }}&maxResults=1000")
        
        echo "$ALL_TICKETS" > all_tickets.json
        
        node .github/scripts/jira-bulk-manager.js update-all \
          --tickets-file "all_tickets.json" \
          --dry-run "${{ github.event.inputs.dry_run }}" \
          --project "${{ env.JIRA_PROJECT_KEY }}"

    - name: Execute Bulk Operation - Sync GitHub Issues
      if: github.event.inputs.operation == 'sync-github-issues'
      run: |
        echo "ðŸ”„ Syncing all GitHub issues to JIRA"
        
        # Get all GitHub issues
        GITHUB_ISSUES=$(curl -s \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/issues?state=all&per_page=100")
        
        echo "$GITHUB_ISSUES" > github_issues.json
        
        node .github/scripts/jira-bulk-manager.js sync-github-issues \
          --github-issues "github_issues.json" \
          --dry-run "${{ github.event.inputs.dry_run }}" \
          --project "${{ env.JIRA_PROJECT_KEY }}"

    - name: Execute Bulk Operation - Bulk Transition
      if: github.event.inputs.operation == 'bulk-transition'
      run: |
        echo "ðŸ”„ Bulk transitioning tickets to: ${{ github.event.inputs.transition_status }}"
        
        # Build JQL query
        if [ ! -z "${{ github.event.inputs.filter_criteria }}" ]; then
          JQL_QUERY="${{ github.event.inputs.filter_criteria }}"
        else
          JQL_QUERY="project=${{ env.JIRA_PROJECT_KEY }}"
        fi
        
        echo "Using JQL: $JQL_QUERY"
        
        # Get tickets matching criteria
        TICKETS=$(curl -s \
          -H "Authorization: Basic $(echo -n '${{ env.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
          -H "Accept: application/json" \
          "${{ env.JIRA_BASE_URL }}/rest/api/3/search?jql=$(echo "$JQL_QUERY" | sed 's/ /%20/g')&maxResults=1000")
        
        echo "$TICKETS" > transition_tickets.json
        
        node .github/scripts/jira-bulk-manager.js bulk-transition \
          --tickets-file "transition_tickets.json" \
          --target-status "${{ github.event.inputs.transition_status }}" \
          --dry-run "${{ github.event.inputs.dry_run }}"

    - name: Execute Bulk Operation - Create from Template
      if: github.event.inputs.operation == 'create-from-template'
      run: |
        echo "ðŸ“‹ Creating tickets from template: ${{ github.event.inputs.template_name }}"
        
        node .github/scripts/jira-bulk-manager.js create-from-template \
          --template "${{ github.event.inputs.template_name }}" \
          --dry-run "${{ github.event.inputs.dry_run }}" \
          --project "${{ env.JIRA_PROJECT_KEY }}"

    - name: Execute Bulk Operation - Project Cleanup
      if: github.event.inputs.operation == 'project-cleanup'
      run: |
        echo "ðŸ§¹ Performing project cleanup operations"
        
        node .github/scripts/jira-bulk-manager.js project-cleanup \
          --dry-run "${{ github.event.inputs.dry_run }}" \
          --project "${{ env.JIRA_PROJECT_KEY }}"

    - name: Execute Bulk Operation - Export Tickets
      if: github.event.inputs.operation == 'export-tickets'
      run: |
        echo "ðŸ“¤ Exporting all project tickets"
        
        # Build JQL query
        if [ ! -z "${{ github.event.inputs.filter_criteria }}" ]; then
          JQL_QUERY="${{ github.event.inputs.filter_criteria }}"
        else
          JQL_QUERY="project=${{ env.JIRA_PROJECT_KEY }}"
        fi
        
        node .github/scripts/jira-bulk-manager.js export-tickets \
          --jql "$JQL_QUERY" \
          --format "json,csv" \
          --project "${{ env.JIRA_PROJECT_KEY }}"

    - name: Upload Operation Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jira-bulk-operation-results-${{ github.run_number }}
        path: |
          *.json
          *.csv
          *.log
          operation-report.md
        retention-days: 30

    - name: Generate Operation Summary
      if: always()
      run: |
        echo "## ðŸŽ¯ JIRA Bulk Operation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Operation**: ${{ github.event.inputs.operation }}" >> $GITHUB_STEP_SUMMARY
        echo "**Project**: ${{ env.JIRA_PROJECT_KEY }}" >> $GITHUB_STEP_SUMMARY
        echo "**Dry Run**: ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "operation-report.md" ]; then
          echo "### ðŸ“Š Operation Results" >> $GITHUB_STEP_SUMMARY
          cat operation-report.md >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
        echo "- Operation logs and results available in artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Check the 'Artifacts' section for downloadable files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **JIRA Project**: [${{ env.JIRA_PROJECT_KEY }}](${{ env.JIRA_BASE_URL }}/projects/${{ env.JIRA_PROJECT_KEY }})" >> $GITHUB_STEP_SUMMARY

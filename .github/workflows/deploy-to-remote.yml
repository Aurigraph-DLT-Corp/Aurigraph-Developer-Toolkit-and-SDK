name: Deploy to Remote Server (Self-Hosted)

on:
  push:
    branches:
      - main
    paths:
      - 'aurigraph-av10-7/aurigraph-v11-standalone/**'
      - '.github/workflows/deploy-to-remote.yml'
  workflow_dispatch:

env:
  MAVEN_OPTS: -Xmx8g -XX:+UseG1GC
  REMOTE_USER: subbu
  REMOTE_HOST: dlt.aurigraph.io
  REMOTE_PORT: '2235'
  REMOTE_APP_DIR: /opt/aurigraph/v11

jobs:
  quality-gates:
    name: Verify Quality Gates
    runs-on: self-hosted
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - name: Run tests
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: ./mvnw clean verify -B --fail-at-end

  build:
    name: Build Application
    runs-on: self-hosted
    needs: quality-gates
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - name: Build
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: ./mvnw clean package -DskipTests -B
      - uses: actions/upload-artifact@v4
        with:
          name: aurigraph-v11-build-${{ github.run_id }}
          path: aurigraph-av10-7/aurigraph-v11-standalone/target/quarkus-app/
          retention-days: 90

  pre-deployment:
    name: Create Backup
    runs-on: self-hosted
    needs: build
    timeout-minutes: 15
    steps:
      - name: Backup
        shell: bash
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          ssh -i ~/.ssh/deploy_key -p $REMOTE_PORT $REMOTE_USER@$REMOTE_HOST 'mkdir -p /opt/aurigraph/backups'
          rm -f ~/.ssh/deploy_key ~/.ssh/known_hosts

  deploy:
    name: Deploy
    runs-on: self-hosted
    needs: pre-deployment
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: aurigraph-v11-build-${{ github.run_id }}
          path: ./build
      - name: Deploy
        shell: bash
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          tar -czf deploy.tar.gz -C build .
          scp -i ~/.ssh/deploy_key -P $REMOTE_PORT deploy.tar.gz $REMOTE_USER@$REMOTE_HOST:/tmp/
          ssh -i ~/.ssh/deploy_key -p $REMOTE_PORT $REMOTE_USER@$REMOTE_HOST 'pkill -f quarkus-run.jar || true; sleep 2; rm -rf /opt/aurigraph/v11/*; tar -xzf /tmp/deploy.tar.gz -C /opt/aurigraph/v11; rm -f /tmp/deploy.tar.gz'
          rm -f ~/.ssh/deploy_key ~/.ssh/known_hosts

  start-service:
    name: Start Service
    runs-on: self-hosted
    needs: deploy
    timeout-minutes: 10
    steps:
      - name: Start
        shell: bash
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          ssh -i ~/.ssh/deploy_key -p $REMOTE_PORT $REMOTE_USER@$REMOTE_HOST 'cd /opt/aurigraph/v11 && nohup java -Xmx4g -XX:+UseG1GC -jar quarkus-run.jar > service.log 2>&1 &'
          rm -f ~/.ssh/deploy_key ~/.ssh/known_hosts

  health-check:
    name: Health Check
    runs-on: self-hosted
    needs: start-service
    timeout-minutes: 10
    steps:
      - name: Verify
        shell: bash
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          for i in {1..30}; do
            if ssh -i ~/.ssh/deploy_key -p $REMOTE_PORT $REMOTE_USER@$REMOTE_HOST 'curl -s http://localhost:9003/q/health | grep -q UP'; then
              echo "Health check passed"
              rm -f ~/.ssh/deploy_key ~/.ssh/known_hosts
              exit 0
            fi
            sleep 2
          done
          echo "Health check failed"
          rm -f ~/.ssh/deploy_key ~/.ssh/known_hosts
          exit 1

  summary:
    name: Summary
    runs-on: self-hosted
    needs: [quality-gates, build, deploy, start-service, health-check]
    if: always()
    steps:
      - name: Report
        run: echo "Deployment complete - https://dlt.aurigraph.io/api/v11"

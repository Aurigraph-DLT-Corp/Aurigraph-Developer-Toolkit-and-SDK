name: V12 Remote Server Deployment

on:
  push:
    branches:
      - V12
      - main
    paths:
      - "aurigraph-av10-7/aurigraph-v11-standalone/src/**"
      - "aurigraph-av10-7/aurigraph-v11-standalone/pom.xml"
      - ".github/workflows/v12-deploy-remote.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        type: choice
        default: "production"
        options:
          - production
          - staging
      skip_tests:
        description: "Skip tests for faster deployment"
        required: false
        type: boolean
        default: false
      force_deploy:
        description: "Force deployment even if health checks fail"
        required: false
        type: boolean
        default: false

env:
  JAVA_VERSION: "21"
  MAVEN_OPTS: "-Xmx4g"
  # Remote server configuration
  REMOTE_HOST: dlt.aurigraph.io
  REMOTE_PORT: 22
  REMOTE_USER: subbu
  REMOTE_DIR: /home/subbu
  APP_PORT: 9003
  GRPC_PORT: 9001

jobs:
  # ============================================================
  # BUILD AND DEPLOY (Combined to avoid GitHub artifact storage)
  # ============================================================
  build-and-deploy:
    name: Build and Deploy V12
    runs-on: [self-hosted, Linux, aurigraph-prod]
    outputs:
      version: ${{ steps.version.outputs.version }}
      jar_name: ${{ steps.version.outputs.jar_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"
          cache: "maven"

      - name: Get version info
        id: version
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          ARTIFACT=$(./mvnw help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
          JAR_NAME="${ARTIFACT}-${VERSION}-runner.jar"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "jar_name=${JAR_NAME}" >> $GITHUB_OUTPUT

          echo "üì¶ Building: ${ARTIFACT} v${VERSION}"
          echo "üìÅ JAR: ${JAR_NAME}"

      - name: Build application
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          echo "üî® Building V12 application..."
          ./mvnw clean package -DskipTests -Dmaven.test.skip=true -B -q

          # Verify JAR was created
          ls -lh target/*.jar || exit 1
          echo "‚úÖ Build successful"

      - name: Run tests
        if: ${{ !inputs.skip_tests }}
        working-directory: aurigraph-av10-7/aurigraph-v11-standalone
        run: |
          echo "üß™ Running tests..."
          ./mvnw test -B --fail-at-end || echo "‚ö†Ô∏è Some tests failed"
        continue-on-error: true

      - name: Prepare artifact for deployment
        id: prepare_artifact
        run: |
          echo "üì¶ Preparing artifact for direct deployment..."
          mkdir -p ./artifact
          cp aurigraph-av10-7/aurigraph-v11-standalone/target/*-runner.jar ./artifact/
          ls -lh ./artifact/
          echo "‚úÖ Artifact ready for deployment (no GitHub storage needed)"

      - name: Pre-deployment infrastructure fixes
        id: infra_fixes
        run: |
          echo "üîß Fixing infrastructure issues before deployment..."

          echo "=== Fix 1: PostgreSQL Container ==="
          if docker ps | grep -q dlt-postgres; then
            echo "‚úÖ PostgreSQL already running"
          elif docker ps -a | grep -q dlt-postgres; then
            echo "‚ö†Ô∏è  PostgreSQL container exists but not running, starting it..."
            docker start dlt-postgres || echo "Failed to start PostgreSQL"
            sleep 10
          else
            echo "‚ö†Ô∏è  PostgreSQL container not found"
            echo "Note: PostgreSQL will need to be started manually or via docker-compose"
          fi

          # Verify PostgreSQL health
          if docker exec dlt-postgres pg_isready -U aurigraph > /dev/null 2>&1; then
            echo "‚úÖ PostgreSQL is healthy"
          else
            echo "‚ö†Ô∏è  PostgreSQL not responding (may affect Login/Demo APIs)"
            echo "Attempting to check if PostgreSQL is running on host..."
            if systemctl is-active --quiet postgresql 2>/dev/null; then
              echo "‚úÖ PostgreSQL service is running on host"
            fi
          fi

          echo ""
          echo "=== Fix 2: LevelDB Directory ==="
          if [ ! -d "/var/lib/aurigraph/leveldb" ]; then
            echo "Creating LevelDB directory..."
            sudo mkdir -p /var/lib/aurigraph/leveldb
            sudo chown -R subbu:subbu /var/lib/aurigraph
            sudo chmod -R 755 /var/lib/aurigraph
            echo "‚úÖ LevelDB directory created"
          else
            echo "‚úÖ LevelDB directory exists"
          fi

          # Verify writable
          if touch /var/lib/aurigraph/leveldb/test.txt 2>/dev/null && rm /var/lib/aurigraph/leveldb/test.txt 2>/dev/null; then
            echo "‚úÖ LevelDB directory is writable"
          else
            echo "‚ö†Ô∏è  LevelDB directory not writable (may affect Token Creation API)"
          fi

      - name: Pre-deployment health check
        id: pre_health
        run: |
          echo "üîç Checking current deployment status..."
          echo "=== Current V12 Service Status ==="
          if systemctl is-active --quiet aurigraph-v12; then
            echo "‚úÖ V12 systemd service is running"
            curl -s http://localhost:9003/api/v11/health | head -c 200 || echo "‚ö†Ô∏è Health endpoint not responding"
          else
            echo "‚ö†Ô∏è V12 service is not running"
            sudo systemctl status aurigraph-v12 --no-pager 2>/dev/null | head -5 || echo "Service may not exist yet"
          fi

          echo ""
          echo "=== Disk Space ==="
          df -h /home/subbu | tail -1

          echo ""
          echo "=== Memory ==="
          free -h | head -2

      - name: Create backup
        run: |
          echo "üíæ Creating pre-deployment backup..."
          cd /home/subbu
          BACKUP_NAME="aurigraph-v12.jar.backup-$(date +%Y%m%d_%H%M%S)"

          if [ -f aurigraph-v12.jar ]; then
            cp aurigraph-v12.jar "$BACKUP_NAME"
            echo "‚úÖ Backup created: $BACKUP_NAME"

            # Keep only last 5 backups
            ls -t aurigraph-v12.jar.backup-* 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
            echo "üìÅ Current backups:"
            ls -lh aurigraph-v12.jar.backup-* 2>/dev/null | head -5
          else
            echo "‚ö†Ô∏è No existing JAR to backup"
          fi

      - name: Copy new JAR
        run: |
          echo "üì§ Copying new JAR..."
          JAR_FILE=$(ls artifact/*-runner.jar | head -1)
          echo "Copying: $JAR_FILE to /home/subbu/aurigraph-v12-new.jar"
          cp "$JAR_FILE" /home/subbu/aurigraph-v12-new.jar
          echo "‚úÖ Copy complete"

      - name: Deploy application
        run: |
          echo "üöÄ Deploying V12 application..."
          cd /home/subbu

          echo "=== Stopping current V12 via systemd ==="
          sudo systemctl stop aurigraph-v12 2>/dev/null || echo "‚ö†Ô∏è Service not running or doesn't exist"
          sleep 2

          echo "=== Deploying new JAR ==="
          if [ -f aurigraph-v12-new.jar ]; then
            mv aurigraph-v12.jar aurigraph-v12.jar.previous 2>/dev/null || true
            mv aurigraph-v12-new.jar aurigraph-v12.jar
            chmod +x aurigraph-v12.jar
            echo "‚úÖ New JAR deployed"
          else
            echo "‚ùå New JAR not found!"
            exit 1
          fi

          echo "=== Creating/Updating systemd service ==="
          sudo tee /etc/systemd/system/aurigraph-v12.service > /dev/null << 'EOF'
          [Unit]
          Description=Aurigraph V12 Backend Service
          After=network.target postgresql.service
          Wants=postgresql.service

          [Service]
          Type=simple
          User=subbu
          WorkingDirectory=/home/subbu
          ExecStart=/usr/bin/java \
            -Xmx8g -Xms4g \
            -XX:+UseG1GC \
            -XX:MaxGCPauseMillis=200 \
            -XX:+HeapDumpOnOutOfMemoryError \
            -XX:HeapDumpPath=/home/subbu/logs/heapdump.hprof \
            -Dquarkus.http.port=9003 \
            -Dquarkus.grpc.server.port=9001 \
            -Dquarkus.log.level=INFO \
            -Dquarkus.profile=prod \
            -Dcurby.quantum.api-key=placeholder \
            -Dquarkus.datasource.db-kind=postgresql \
            -Dquarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/j4c_db \
            -Dquarkus.datasource.username=j4c_user \
            -Dquarkus.datasource.password=j4c_password \
            -Dquarkus.flyway.migrate-at-start=false \
            -jar /home/subbu/aurigraph-v12.jar
          Restart=on-failure
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=aurigraph-v12

          [Install]
          WantedBy=multi-user.target
          EOF

          echo "=== Reloading systemd and starting V12 ==="
          sudo systemctl daemon-reload
          sudo systemctl enable aurigraph-v12
          sudo systemctl start aurigraph-v12

          echo "=== Waiting for startup ==="
          sleep 15

          # Verify service is running
          if systemctl is-active --quiet aurigraph-v12; then
            echo "‚úÖ Service is running"
            sudo systemctl status aurigraph-v12 --no-pager | head -20
          else
            echo "‚ùå Service failed to start!"
            echo "=== Service status ==="
            sudo systemctl status aurigraph-v12 --no-pager
            echo "=== Last 50 lines of journal ==="
            sudo journalctl -u aurigraph-v12 -n 50 --no-pager
            exit 1
          fi

      - name: Sync JAR to Docker container directory
        run: |
          echo "üê≥ Syncing JAR to Docker container mount directory..."
          cd /home/subbu

          # Docker containers mount from /home/subbu/aurigraph-v12/ directory
          # Ensure the container directory exists
          mkdir -p /home/subbu/aurigraph-v12

          # Copy JAR to container mount directory
          cp /home/subbu/aurigraph-v12.jar /home/subbu/aurigraph-v12/aurigraph-v12.jar
          echo "‚úÖ JAR synced to Docker container directory"

          # Verify both locations have the same JAR
          echo "üìÅ JAR in home directory:"
          ls -la /home/subbu/aurigraph-v12.jar
          echo "üìÅ JAR in container directory:"
          ls -la /home/subbu/aurigraph-v12/aurigraph-v12.jar

          # Restart Docker containers to pick up the new JAR
          echo "üîÑ Restarting Docker containers to use new JAR..."
          docker restart aurigraph-validator-1 aurigraph-validator-2 aurigraph-validator-3 aurigraph-validator-4 aurigraph-validator-5 \
                        aurigraph-business-1 aurigraph-business-2 aurigraph-business-3 \
                        aurigraph-ei-1 aurigraph-ei-2 aurigraph-ei-3 2>/dev/null || echo "‚ö†Ô∏è Some containers may not exist"

          echo "‚è≥ Waiting for containers to restart..."
          sleep 20

          # Verify container status
          echo "üìã Container status:"
          docker ps --format "table {{.Names}}\t{{.Status}}" | grep aurigraph || echo "No aurigraph containers running"
          echo "‚úÖ Docker containers restarted with new JAR"

      - name: Health check
        id: health_check
        run: |
          echo "üîç Running post-deployment health checks..."

          MAX_RETRIES=12
          RETRY_INTERVAL=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Health check attempt $i/$MAX_RETRIES..."

            # Use Quarkus liveness endpoint which doesn't depend on database
            LIVENESS=$(curl -s http://localhost:9003/q/health/live 2>/dev/null || echo '{"status":"error"}')
            LIVE_STATUS=$(echo "$LIVENESS" | jq -r '.status // "error"' 2>/dev/null || echo "error")

            # Also check our custom health endpoint
            HEALTH=$(curl -s http://localhost:9003/api/v11/health 2>/dev/null || echo '{"status":"error"}')
            HEALTH_STATUS=$(echo "$HEALTH" | jq -r '.status // "error"' 2>/dev/null || echo "error")

            echo "  Liveness: $LIVE_STATUS, Health: $HEALTH_STATUS"

            # Accept either UP from liveness OR UP from health
            if [ "$LIVE_STATUS" = "UP" ] || [ "$HEALTH_STATUS" = "UP" ]; then
              echo "‚úÖ Health check passed!"
              echo "Liveness: $LIVENESS"
              echo "Health: $HEALTH"
              echo "health_status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Check if it's a rate limit error (app is running but rate limited)
            if echo "$HEALTH" | grep -q "Rate limit exceeded"; then
              echo "‚úÖ App is running (rate limited) - considering healthy"
              echo "health_status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "Status: Liveness=$LIVE_STATUS Health=$HEALTH_STATUS - waiting ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
          done

          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          echo "health_status=unhealthy" >> $GITHUB_OUTPUT

          if [ "${{ inputs.force_deploy }}" != "true" ]; then
            exit 1
          fi

      - name: Update NGINX configuration
        run: |
          echo "üîß Updating NGINX configuration..."

          # CRITICAL: Ensure upstream backend_api in nginx.conf points to port 9003
          echo "=== Ensuring upstream backend_api points to port 9003 ==="
          if grep -q "upstream backend_api" /etc/nginx/nginx.conf; then
            echo "Found upstream backend_api, ensuring port 9003..."
            sudo sed -i 's|server 127.0.0.1:9000|server 127.0.0.1:9003|g' /etc/nginx/nginx.conf
            sudo sed -i 's|server localhost:9000|server localhost:9003|g' /etc/nginx/nginx.conf
            echo "‚úÖ Verified upstream backend_api uses port 9003"
          fi

          # Also update any direct proxy_pass that might use wrong port
          sudo sed -i 's|proxy_pass http://localhost:9000|proxy_pass http://localhost:9003|g' /etc/nginx/nginx.conf
          sudo sed -i 's|proxy_pass http://127.0.0.1:9000|proxy_pass http://127.0.0.1:9003|g' /etc/nginx/nginx.conf

          # Update aurigraph-portal site config
          if [ -f /etc/nginx/sites-available/aurigraph-portal ]; then
            echo "=== Updating aurigraph-portal site config ==="
            sudo sed -i 's|proxy_pass http://localhost:9000|proxy_pass http://localhost:9003|g' /etc/nginx/sites-available/aurigraph-portal
            sudo sed -i 's|proxy_pass http://127.0.0.1:9000|proxy_pass http://127.0.0.1:9003|g' /etc/nginx/sites-available/aurigraph-portal

            # Enable the site if not already enabled
            if [ ! -L /etc/nginx/sites-enabled/aurigraph-portal ]; then
              echo "Enabling aurigraph-portal site..."
              sudo ln -sf /etc/nginx/sites-available/aurigraph-portal /etc/nginx/sites-enabled/aurigraph-portal
              echo "‚úÖ aurigraph-portal enabled"
            else
              echo "aurigraph-portal already enabled"
            fi
          fi

          # Remove any standalone API configs that might conflict
          if [ -f /etc/nginx/conf.d/api-v12-server.conf ]; then
            echo "Removing standalone API server config..."
            sudo rm /etc/nginx/conf.d/api-v12-server.conf
          fi

          # Show what the upstream now looks like
          echo ""
          echo "=== Current upstream backend_api configuration ==="
          grep -A 3 "upstream backend_api" /etc/nginx/nginx.conf || echo "No upstream found"

          # Test and reload NGINX
          echo ""
          echo "Testing NGINX configuration..."
          if sudo nginx -t 2>&1; then
            sudo systemctl reload nginx
            echo "‚úÖ NGINX configuration updated and reloaded"
          else
            echo "‚ùå NGINX configuration test failed!"
            sudo nginx -t
          fi

      - name: Debug NGINX configuration
        run: |
          echo "üîç Debugging NGINX configuration..."

          echo "=== NGINX config files ==="
          ls -la /etc/nginx/sites-available/ 2>/dev/null || echo "No sites-available"
          ls -la /etc/nginx/sites-enabled/ 2>/dev/null || echo "No sites-enabled"
          ls -la /etc/nginx/conf.d/ 2>/dev/null || echo "No conf.d"

          echo ""
          echo "=== Looking for API proxy config ==="
          grep -r "api/v11" /etc/nginx/ 2>/dev/null || echo "No /api/v11 config found"

          echo ""
          echo "=== Current NGINX main config ==="
          head -100 /etc/nginx/nginx.conf

      - name: Verify endpoints
        run: |
          echo "üß™ Verifying API endpoints..."

          echo "1. Health endpoint:"
          curl -s http://localhost:9003/api/v11/health | jq -r '.status' || echo "‚ùå Failed"

          echo ""
          echo "2. Info endpoint:"
          curl -s http://localhost:9003/api/v11/info | jq -r '.platform.version' || echo "‚ùå Failed"

          echo ""
          echo "3. Analytics dashboard:"
          curl -s http://localhost:9003/api/v11/analytics/dashboard | jq -r '.tpsOverTime | length' | xargs -I {} echo "Data points: {}" || echo "‚ùå Failed"

          echo ""
          echo "4. Service status:"
          sudo systemctl status aurigraph-v12 --no-pager | head -10

          echo ""
          echo "‚úÖ Endpoint verification complete"

      - name: Rollback on failure
        if: failure() && steps.health_check.outputs.health_status == 'unhealthy'
        run: |
          echo "üîÑ Initiating rollback..."
          cd /home/subbu

          echo "=== Stopping failed deployment via systemd ==="
          sudo systemctl stop aurigraph-v12 2>/dev/null || true
          sleep 2

          echo "=== Restoring previous version ==="
          if [ -f aurigraph-v12.jar.previous ]; then
            mv aurigraph-v12.jar aurigraph-v12.jar.failed
            mv aurigraph-v12.jar.previous aurigraph-v12.jar

            echo "=== Starting previous version via systemd ==="
            sudo systemctl start aurigraph-v12
            sleep 15

            if curl -s http://localhost:9003/api/v11/health | grep -q "UP"; then
              echo "‚úÖ Rollback successful"
            else
              echo "‚ùå Rollback health check failed"
              sudo journalctl -u aurigraph-v12 -n 20 --no-pager
            fi
          else
            echo "‚ùå No previous version to rollback to!"

            # Try latest backup
            LATEST_BACKUP=$(ls -t aurigraph-v12.jar.backup-* 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ]; then
              echo "Trying backup: $LATEST_BACKUP"
              cp "$LATEST_BACKUP" aurigraph-v12.jar

              sudo systemctl start aurigraph-v12
              sleep 15
              echo "Backup restoration attempted"
              sudo systemctl status aurigraph-v12 --no-pager | head -10
            fi
          fi

  # ============================================================
  # PHASE 2: POST-DEPLOYMENT
  # ============================================================
  post-deploy:
    name: Post-Deployment Tasks
    runs-on: [self-hosted, Linux, aurigraph-prod]
    needs: build-and-deploy
    if: success()

    steps:
      - name: Create deployment summary
        run: |
          echo "## üöÄ V12 Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ needs.build-and-deploy.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Links" >> $GITHUB_STEP_SUMMARY
          echo "- [API Health](https://dlt.aurigraph.io/api/v11/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [API Info](https://dlt.aurigraph.io/api/v11/info)" >> $GITHUB_STEP_SUMMARY
          echo "- [Portal](https://dlt.aurigraph.io)" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "‚úÖ V12 Deployment Successful",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ V12 Deployment Successful"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Version:*\n${{ needs.build-and-deploy.outputs.version }}"},
                    {"type": "mrkdwn", "text": "*Environment:*\n${{ inputs.environment || 'production' }}"},
                    {"type": "mrkdwn", "text": "*Branch:*\n${{ github.ref_name }}"},
                    {"type": "mrkdwn", "text": "*Actor:*\n${{ github.actor }}"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "üîó View API"},
                      "url": "https://dlt.aurigraph.io/api/v11/health"
                    },
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "üìä View Portal"},
                      "url": "https://dlt.aurigraph.io"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  notify-failure:
    name: Notify Failure
    runs-on: [self-hosted, Linux, aurigraph-prod]
    needs: build-and-deploy
    if: failure()

    steps:
      - name: Create failure summary
        run: |
          echo "## ‚ùå V12 Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Automatic rollback was attempted**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Workflow Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack failure notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "‚ùå V12 Deployment Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå V12 Deployment Failed"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Commit:* `${{ github.sha }}`\n*Branch:* ${{ github.ref_name }}\n*Actor:* ${{ github.actor }}\n\n‚ö†Ô∏è Automatic rollback was attempted"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "üìã View Logs"},
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

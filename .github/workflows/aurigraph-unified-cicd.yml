# =============================================================================
# Aurigraph DLT - Unified CI/CD Pipeline
# =============================================================================
# This workflow orchestrates CI/CD for ALL Aurigraph DLT components:
# - V11/V12 Java Backend (Quarkus)
# - Enterprise Portal Frontend (React/TypeScript)
# - Docker Images
# - Integration Testing
# =============================================================================

name: Aurigraph Unified CI/CD

on:
  # DISABLED for V12 - Using self-hosted-cicd.yml instead to avoid GitHub Actions budget
  # push:
  #   branches:
  #     - main
  #     - V12
  #     - develop
  # pull_request:
  #   branches:
  #     - main
  #     - V12
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend to Remote Server'
        type: boolean
        default: true
      deploy_frontend:
        description: 'Deploy Frontend to Remote Server'
        type: boolean
        default: true
      build_docker:
        description: 'Build and Push Docker Images'
        type: boolean
        default: false
      run_e2e_tests:
        description: 'Run E2E Tests After Deployment'
        type: boolean
        default: true
      skip_tests:
        description: 'Skip Tests (faster deployment)'
        type: boolean
        default: false
      environment:
        description: 'Deployment Environment'
        type: choice
        options:
          - production
          - staging
          - development
        default: production

env:
  # Java/Quarkus
  JAVA_VERSION: '21'
  MAVEN_OPTS: -Xmx4g -XX:+UseG1GC

  # Node.js
  NODE_VERSION: '20'

  # Paths
  BACKEND_DIR: 'aurigraph-av10-7/aurigraph-v11-standalone'
  FRONTEND_DIR: 'enterprise-portal/enterprise-portal/frontend'

  # Remote Server
  REMOTE_HOST: 'dlt.aurigraph.io'
  REMOTE_USER: 'subbu'
  REMOTE_SSH_PORT: '22'

  # Docker
  DOCKER_REGISTRY: 'ghcr.io'
  DOCKER_IMAGE_NAME: 'aurigraph-dlt-corp/aurigraph-dlt'

jobs:
  # ===========================================================================
  # DETECT CHANGES - Determine what needs to be built/deployed
  # ===========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      docker: ${{ steps.changes.outputs.docker }}
      docs: ${{ steps.changes.outputs.docs }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'aurigraph-av10-7/aurigraph-v11-standalone/**'
              - 'pom.xml'
            frontend:
              - 'enterprise-portal/enterprise-portal/frontend/**'
            docker:
              - 'Dockerfile*'
              - 'docker-compose*.yml'
              - 'deployment/**'
            docs:
              - '**/*.md'
              - 'docs/**'

  # ===========================================================================
  # BACKEND BUILD & TEST
  # ===========================================================================
  backend-build:
    name: Backend Build & Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'

    outputs:
      jar-path: ${{ steps.build.outputs.jar-path }}
      version: ${{ steps.build.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Compile Backend
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          echo "=== Compiling Aurigraph V11 Backend ==="
          ./mvnw clean compile -DskipTests
          echo "Compilation successful"

      - name: Run Unit Tests
        if: ${{ !inputs.skip_tests }}
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          echo "=== Running Unit Tests ==="
          ./mvnw test -Dtest="!**/*Integration*,!**/*Performance*"
          echo "Unit tests completed"
        continue-on-error: true

      - name: Build JAR Package
        id: build
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          echo "=== Building Production JAR ==="
          ./mvnw package -DskipTests

          # Get JAR path and version
          JAR_FILE=$(ls target/quarkus-app/quarkus-run.jar 2>/dev/null || ls target/*.jar | head -1)
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)

          echo "jar-path=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "Built: $JAR_FILE (version: $VERSION)"
          ls -lh target/quarkus-app/ 2>/dev/null || ls -lh target/*.jar

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: |
            ${{ env.BACKEND_DIR }}/target/quarkus-app/
          retention-days: 7

      - name: Generate Test Report
        if: ${{ !inputs.skip_tests }}
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: ${{ env.BACKEND_DIR }}/target/surefire-reports/
          retention-days: 14

  # ===========================================================================
  # FRONTEND BUILD & TEST
  # ===========================================================================
  frontend-build:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'

    outputs:
      dist-path: ${{ steps.build.outputs.dist-path }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install Dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: TypeScript Type Check
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "=== Running TypeScript Type Check ==="
          npm run typecheck 2>/dev/null || npx tsc --noEmit
          echo "Type check completed"
        continue-on-error: true

      - name: Lint Check
        if: ${{ !inputs.skip_tests }}
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "=== Running Lint ==="
          npm run lint 2>/dev/null || echo "Linting not configured"
        continue-on-error: true

      - name: Build Frontend
        id: build
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "=== Building Production Frontend ==="
          npm run build

          echo "dist-path=dist" >> $GITHUB_OUTPUT

          echo "Build complete!"
          ls -lh dist/

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_DIR }}/dist/
          retention-days: 7

  # ===========================================================================
  # DOCKER BUILD & PUSH
  # ===========================================================================
  docker-build:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]
    if: |
      (needs.detect-changes.outputs.docker == 'true' || inputs.build_docker == true) &&
      github.event_name != 'pull_request'

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./backend-build/

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./frontend-build/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployment/Dockerfile.backend
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/backend:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
        continue-on-error: true

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployment/Dockerfile.frontend
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/frontend:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}/frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
        continue-on-error: true

  # ===========================================================================
  # DEPLOY BACKEND TO REMOTE SERVER
  # ===========================================================================
  deploy-backend:
    name: Deploy Backend
    runs-on: [self-hosted, Linux, aurigraph-prod]
    needs: backend-build
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/V12') &&
      (inputs.deploy_backend == true || github.event_name == 'push')
    environment:
      name: ${{ inputs.environment || 'production' }}
      url: https://dlt.aurigraph.io/api/v11/health

    steps:
      - uses: actions/checkout@v4

      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./backend-build/

      - name: Deploy Backend (Local Runner)
        run: |
          echo "=== Deploying Aurigraph V11 Backend ==="
          echo "Timestamp: $(date)"

          DEPLOY_DIR="/home/subbu"
          JAR_NAME="aurigraph-v12.jar"
          BACKUP_NAME="${JAR_NAME}.backup-$(date +%Y%m%d_%H%M%S)"

          # Create backup of current JAR
          if [ -f "$DEPLOY_DIR/$JAR_NAME" ]; then
            echo "Creating backup: $BACKUP_NAME"
            cp "$DEPLOY_DIR/$JAR_NAME" "$DEPLOY_DIR/$BACKUP_NAME"
          fi

          # Stop existing process
          echo "Stopping existing backend process..."
          pkill -f "quarkus-run.jar" 2>/dev/null || pkill -f "$JAR_NAME" 2>/dev/null || true
          sleep 3

          # Deploy new JAR
          echo "Deploying new backend..."
          cp -r backend-build/quarkus-app/* "$DEPLOY_DIR/quarkus-app/" 2>/dev/null || \
          cp backend-build/*.jar "$DEPLOY_DIR/$JAR_NAME"

          # Start new backend
          echo "Starting new backend..."
          cd $DEPLOY_DIR
          nohup java -Xmx4g -XX:+UseG1GC \
            -Dquarkus.http.port=9003 \
            -Dquarkus.http.host=0.0.0.0 \
            -jar quarkus-app/quarkus-run.jar > logs/backend.log 2>&1 &

          # Wait for startup
          echo "Waiting for backend to start..."
          sleep 15

          # Health check
          for i in {1..10}; do
            if curl -sf http://localhost:9003/api/v11/health > /dev/null; then
              echo "Backend health check passed!"
              break
            fi
            echo "Waiting... ($i/10)"
            sleep 5
          done

          echo "Backend deployment complete!"

  # ===========================================================================
  # DEPLOY FRONTEND TO REMOTE SERVER
  # ===========================================================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: [self-hosted, Linux, aurigraph-prod]
    needs: frontend-build
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/V12') &&
      (inputs.deploy_frontend == true || github.event_name == 'push')
    environment:
      name: ${{ inputs.environment || 'production' }}
      url: https://dlt.aurigraph.io

    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./frontend-build/

      - name: Backup & Deploy Frontend (Local Runner)
        run: |
          echo "=== Deploying Enterprise Portal Frontend ==="
          echo "Timestamp: $(date)"

          DEPLOY_DIR="/usr/share/nginx/html"
          BACKUP_DIR="/home/subbu/enterprise-portal"

          # Backup current
          echo "Creating backup..."
          rm -rf $BACKUP_DIR/*
          cp -r $DEPLOY_DIR/* $BACKUP_DIR/ 2>/dev/null || true

          # Stop NGINX
          echo "Stopping NGINX..."
          sudo systemctl stop nginx

          # Clear cache
          sudo rm -rf /var/cache/nginx/* 2>/dev/null || true

          # Deploy new frontend
          echo "Deploying new frontend..."
          sudo rm -rf $DEPLOY_DIR/*
          sudo cp -r frontend-build/* $DEPLOY_DIR/
          sudo chown -R www-data:www-data $DEPLOY_DIR/

          # Start NGINX
          echo "Starting NGINX..."
          sudo systemctl start nginx

          # Verify
          sleep 3
          sudo systemctl status nginx --no-pager | head -5

          echo "Frontend deployment complete!"

  # ===========================================================================
  # E2E TESTING (Post-Deployment)
  # ===========================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: [self-hosted, Linux, aurigraph-prod]
    needs: [deploy-backend, deploy-frontend]
    if: |
      always() &&
      (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success') &&
      (inputs.run_e2e_tests != false)

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          npm ci
          npx playwright install chromium --with-deps || true

      - name: Run Playwright E2E Tests
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "=== Running E2E Tests ==="
          npx playwright test --reporter=list || echo "Some tests failed"
        continue-on-error: true

      - name: Run Backend API Tests
        working-directory: aurigraph-fastapi
        run: |
          echo "=== Running Backend API Tests ==="
          python3 -m pytest tests/ -v --tb=short || echo "Some tests failed"
        continue-on-error: true

      - name: Health Check Summary
        run: |
          echo "=== Final Health Checks ==="

          # API Health
          if curl -sf https://dlt.aurigraph.io/api/v11/health; then
            echo "API: HEALTHY"
          else
            echo "API: UNHEALTHY"
          fi

          # Frontend
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://dlt.aurigraph.io/)
          echo "Frontend HTTP: $HTTP_CODE"

          echo ""
          echo "=== Deployment Complete ==="
          echo "Frontend: https://dlt.aurigraph.io"
          echo "API Health: https://dlt.aurigraph.io/api/v11/health"
          echo "Infrastructure: https://dlt.aurigraph.io/admin/infrastructure"

  # ===========================================================================
  # SECURITY SCAN
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # ===========================================================================
  # NOTIFICATION
  # ===========================================================================
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, e2e-tests]
    if: always()

    steps:
      - name: Build Summary
        run: |
          echo "# Aurigraph DLT CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

# Aurigraph V4.4.4 Production Deployment
# Remote Server: dlt.aurigraph.io (Port 2235)
# V11 Standalone Service with Bridge Infrastructure
# Includes monitoring, logging, and SSL/TLS support

version: '3.8'

# Network configuration for service isolation
networks:
  dlt-frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  dlt-backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
  dlt-monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16

# Persistent volumes for data durability
volumes:
  dlt-data:
    driver: local
  letsencrypt:
    driver: local
  dlt-postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/dlt/postgres-data
  dlt-redis-data:
    driver: local
  dlt-prometheus-data:
    driver: local
  dlt-grafana-data:
    driver: local
  dlt-logs:
    driver: local
  dlt-slim-node-1-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/dlt/slim-node-1-data

services:
  # =========================================================================
  # Traefik Reverse Proxy (Container-Native, Auto-Discovery)
  # Phase 1: Parallel deployment with NGINX for testing
  # =========================================================================
  traefik:
    image: traefik:latest
    container_name: dlt-traefik
    restart: unless-stopped

    command:
      # API Configuration
      - "--api=true"
      - "--api.insecure=false"
      - "--api.dashboard=true"

      # Entrypoints (HTTP/HTTPS)
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # HTTP to HTTPS redirect (enabled after DNS configuration)
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

      # Docker Provider with auto-discovery
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=dlt-frontend"

      # Let's Encrypt ACME
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@aurigraph.io"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"

    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      - "8080:8080"  # Dashboard (access at http://localhost:8080/dashboard/)

    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - letsencrypt:/letsencrypt

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3

    networks:
      - dlt-frontend
      - dlt-backend

    labels:
      - "com.dlt.service=traefik"
      - "com.dlt.tier=frontend"

    # profiles: ["traefik"]  # Removed - Traefik is now primary reverse proxy

  # Note: NGINX is disabled in favor of Traefik
  # To re-enable NGINX, uncomment the service below and remove Traefik
  #
  # =========================================================================
  # NGINX Reverse Proxy with SSL/TLS (Ports 80, 443) - DISABLED
  # Replaced by Traefik v3.0 for zero-downtime configuration
  # =========================================================================
  #
  # nginx-gateway:
  #   image: nginx:1.25-alpine
  #   container_name: dlt-nginx-gateway
  #   restart: unless-stopped
  #
  #   ports:
  #     - "80:80"      # HTTP (auto-redirect to HTTPS)
  #     - "443:443"    # HTTPS
  #
  #   volumes:
  #     - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
  #     - /etc/letsencrypt/live/aurcrt/fullchain.pem:/etc/nginx/ssl/fullchain.pem:ro
  #     - /etc/letsencrypt/live/aurcrt/privkey.pem:/etc/nginx/ssl/privkey.pem:ro
  #
  #   environment:
  #     - DOMAIN=dlt.aurigraph.io
  #     - TLS_ENABLED=true
  #
  #   healthcheck:
  #     test: ["CMD-SHELL", "wget --no-verbose --tries=1 -O - http://localhost/health || curl -s http://localhost/health > /dev/null 2>&1 || exit 1"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 15s
  #
  #   networks:
  #     - dlt-frontend
  #     - dlt-backend
  #
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #     aurigraph-v11-service:
  #       condition: service_started
  #
  #   labels:
  #     - "com.dlt.service=nginx-gateway"
  #     - "com.dlt.tier=frontend"

  # =========================================================================
  # Aurigraph V11 Standalone Service (Port 9003 internally, exposed via NGINX)
  # =========================================================================
  aurigraph-v11-service:
    image: aurigraph-v11:11.4.4
    container_name: dlt-aurigraph-v11
    restart: unless-stopped

    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '4.0'
        reservations:
          memory: 512M

    environment:
      # Quarkus Configuration
      - QUARKUS_PROFILE=production
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_HTTP_HTTP2=true

      # Aurigraph Node Configuration
      - AURIGRAPH_NODE_ID=v11-standalone-1
      - AURIGRAPH_MODE=production

      # Bridge Service Configuration (Sprint 15)
      - BRIDGE_SERVICE_ENABLED=true
      - BRIDGE_TRANSFER_FEE_PERCENTAGE=0.12
      - BRIDGE_SWAP_TIMEOUT_MS=300000
      - BRIDGE_HTLC_ENABLED=true

      # Performance Configuration
      - CONSENSUS_TARGET_TPS=776000
      - AI_OPTIMIZATION_ENABLED=true
      - QUANTUM_CRYPTO_ENABLED=true
      - NATIVE_MODE=true

      # Memory optimization
      - MALLOC_ARENA_MAX=2
      - MALLOC_MMAP_THRESHOLD_=65536
      - JAVA_OPTS=-Xms256m -Xmx2g

      # Database Configuration (Docker network DNS)
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://postgres:5432/aurigraph_production
      - QUARKUS_DATASOURCE_USERNAME=aurigraph
      - QUARKUS_DATASOURCE_PASSWORD=aurigraph-prod-secure-2025

      # Hibernate ORM Configuration - Skip schema validation/generation
      - QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=validate
      - QUARKUS_HIBERNATE_ORM_JDBC_STATEMENT_BATCH_SIZE=20
      - QUARKUS_HIBERNATE_ORM_JDBC_FETCH_SIZE=50

    ports:
      - "9003:9003"  # REST API (internal)
      - "9004:9004"  # gRPC (internal)

    volumes:
      - dlt-data:/deployments/data
      - dlt-logs:/deployments/logs
      - ./config/v11:/deployments/config:ro

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9003/q/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

    networks:
      dlt-backend:
        ipv4_address: 172.21.1.10
      dlt-frontend:
        ipv4_address: 172.20.1.10
      dlt-monitoring:
        ipv4_address: 172.22.1.10

    depends_on:
      - postgres
      - redis
      - prometheus

    security_opt:
      - no-new-privileges:true

    labels:
      - "com.dlt.service=aurigraph-v11"
      - "com.dlt.tier=backend"
      - "com.dlt.version=11.4.4"

      # Traefik Labels (for Traefik profile)
      - "traefik.enable=true"

      # HTTP Router (no redirect, allow both HTTP and HTTPS)
      - "traefik.http.routers.aurigraph-api-http.rule=Host(`dlt.aurigraph.io`) && PathPrefix(`/api/v11`)"
      - "traefik.http.routers.aurigraph-api-http.entrypoints=web"
      - "traefik.http.routers.aurigraph-api-http.service=aurigraph-api"
      - "traefik.http.routers.aurigraph-api-http.middlewares=aurigraph-ratelimit@docker"

      # HTTPS Router (with TLS/Let's Encrypt)
      - "traefik.http.routers.aurigraph-api-https.rule=Host(`dlt.aurigraph.io`) && PathPrefix(`/api/v11`)"
      - "traefik.http.routers.aurigraph-api-https.entrypoints=websecure"
      - "traefik.http.routers.aurigraph-api-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.aurigraph-api-https.service=aurigraph-api"
      - "traefik.http.routers.aurigraph-api-https.middlewares=aurigraph-ratelimit@docker"

      # Service configuration (used by both routers)
      - "traefik.http.services.aurigraph-api.loadbalancer.server.port=9003"
      - "traefik.http.services.aurigraph-api.loadbalancer.healthcheck.path=/q/health"
      - "traefik.http.services.aurigraph-api.loadbalancer.healthcheck.interval=30s"

      # Middleware
      - "traefik.http.middlewares.aurigraph-ratelimit.ratelimit.average=1000"
      - "traefik.http.middlewares.aurigraph-ratelimit.ratelimit.period=1s"

  # =========================================================================
  # PostgreSQL Database (Port 5432 internal only)
  # =========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: dlt-postgres
    restart: unless-stopped

    environment:
      - POSTGRES_DB=aurigraph_production
      - POSTGRES_USER=aurigraph
      - POSTGRES_PASSWORD=${DB_PASSWORD:-aurigraph-prod-secure-2025}
      - POSTGRES_INITDB_ARGS=--auth-local=trust

    volumes:
      - dlt-postgres-data:/var/lib/postgresql/data
      - ./config/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aurigraph"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - dlt-backend

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2.0'
        reservations:
          memory: 256M

    labels:
      - "com.dlt.service=postgres"
      - "com.dlt.tier=database"

  # =========================================================================
  # Redis Cache Layer (Port 6379 internal only)
  # =========================================================================
  redis:
    image: redis:7-alpine
    container_name: dlt-redis
    restart: unless-stopped

    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-redis-secure-2025}

    volumes:
      - dlt-redis-data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    networks:
      - dlt-backend

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M

    labels:
      - "com.dlt.service=redis"
      - "com.dlt.tier=cache"

  # =========================================================================
  # Prometheus Metrics Collection (Port 9090 internal)
  # =========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: dlt-prometheus
    restart: unless-stopped

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'

    volumes:
      - dlt-prometheus-data:/prometheus
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/prometheus/rules:/etc/prometheus/rules:ro

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    networks:
      - dlt-monitoring

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M

    labels:
      - "com.dlt.service=prometheus"
      - "com.dlt.tier=monitoring"

  # =========================================================================
  # Grafana Dashboard (Port 3000 -> exposed via NGINX)
  # =========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: dlt-grafana
    restart: unless-stopped

    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_DOMAIN=dlt.aurigraph.io
      - GF_SERVER_ROOT_URL=https://dlt.aurigraph.io/grafana
      - GF_PLUGINS_SKIP_PLUGIN_PREINSTALL_CHECK=true

    volumes:
      - dlt-grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - dlt-monitoring
      - dlt-frontend

    depends_on:
      - prometheus

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M

    labels:
      - "com.dlt.service=grafana"
      - "com.dlt.tier=monitoring"

  # =========================================================================
  # Enterprise Portal (React Frontend, exposed via NGINX)
  # =========================================================================
  enterprise-portal:
    image: node:20-alpine
    container_name: dlt-portal
    restart: unless-stopped
    working_dir: /app
    command: sh /app/start-portal.sh
    ports:
      - "3000:3000"

    environment:
      - REACT_APP_API_BASE_URL=https://dlt.aurigraph.io/api/v11
      - REACT_APP_DOMAIN=dlt.aurigraph.io
      - NODE_ENV=production
      - GENERATE_SOURCEMAP=false

    volumes:
      - ./enterprise-portal/enterprise-portal/frontend:/app
      - ./start-portal.sh:/app/start-portal.sh:ro

    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep 'http-server' | grep -v grep || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - dlt-frontend

    depends_on:
      - aurigraph-v11-service

    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 64M

    labels:
      - "com.dlt.service=enterprise-portal"
      - "com.dlt.tier=frontend"

      # Traefik Labels (for Traefik profile)
      - "traefik.enable=true"

      # HTTP Router (no redirect, allow both HTTP and HTTPS)
      - "traefik.http.routers.portal-http.rule=Host(`dlt.aurigraph.io`) || Host(`www.dlt.aurigraph.io`)"
      - "traefik.http.routers.portal-http.entrypoints=web"
      - "traefik.http.routers.portal-http.service=portal"
      - "traefik.http.routers.portal-http.middlewares=portal-gzip@docker"

      # HTTPS Router (with TLS/Let's Encrypt)
      - "traefik.http.routers.portal-https.rule=Host(`dlt.aurigraph.io`) || Host(`www.dlt.aurigraph.io`)"
      - "traefik.http.routers.portal-https.entrypoints=websecure"
      - "traefik.http.routers.portal-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.portal-https.service=portal"
      - "traefik.http.routers.portal-https.middlewares=portal-gzip@docker"

      # Service configuration (used by both routers)
      - "traefik.http.services.portal.loadbalancer.server.port=3000"
      - "traefik.http.services.portal.loadbalancer.healthcheck.path=/"
      - "traefik.http.services.portal.loadbalancer.healthcheck.interval=30s"

      # Middleware (compression)
      - "traefik.http.middlewares.portal-gzip.compress=true"

  # =========================================================================
  # Validator Node 1 (HyperRAFT++ Consensus)
  # =========================================================================
  validator-node-1:
    image: aurigraph-v11:11.4.4
    container_name: dlt-validator-node-1
    restart: unless-stopped
    profiles: ["validators"]

    environment:
      # Quarkus Configuration
      - QUARKUS_PROFILE=production
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_HTTP_HTTP2=true

      # Node Configuration
      - AURIGRAPH_NODE_ID=validator-1
      - AURIGRAPH_NODE_TYPE=validator
      - AURIGRAPH_MODE=production

      # Consensus Configuration
      - CONSENSUS_LEADER_ELECTION=true
      - CONSENSUS_HEARTBEAT_INTERVAL=50
      - CONSENSUS_ELECTION_TIMEOUT_MIN=150
      - CONSENSUS_ELECTION_TIMEOUT_MAX=300
      - CONSENSUS_TARGET_TPS=776000

      # Database Configuration
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://postgres:5432/aurigraph_production
      - QUARKUS_DATASOURCE_USERNAME=aurigraph
      - QUARKUS_DATASOURCE_PASSWORD=aurigraph-prod-secure-2025
      - QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=validate

    ports:
      - "19003:9003"  # REST API (validator-1)
      - "19004:9004"  # gRPC (validator-1)

    volumes:
      - dlt-data:/deployments/data
      - dlt-logs:/deployments/logs

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9003/q/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

    networks:
      dlt-backend:
        ipv4_address: 172.21.1.20

    depends_on:
      - postgres
      - redis

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2.0'
        reservations:
          memory: 256M

    labels:
      - "com.dlt.service=validator-1"
      - "com.dlt.tier=consensus"

  # =========================================================================
  # Business Node 1 (Transaction Processing)
  # =========================================================================
  business-node-1:
    image: aurigraph-v11:11.4.4
    container_name: dlt-business-node-1
    restart: unless-stopped
    profiles: ["business-nodes"]

    environment:
      # Quarkus Configuration
      - QUARKUS_PROFILE=production
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_HTTP_HTTP2=true

      # Node Configuration
      - AURIGRAPH_NODE_ID=business-1
      - AURIGRAPH_NODE_TYPE=business
      - AURIGRAPH_MODE=production

      # Transaction Processing Configuration
      - TRANSACTION_BATCH_SIZE=100
      - TRANSACTION_TIMEOUT_MS=30000
      - CONSENSUS_TARGET_TPS=776000

      # Database Configuration
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://postgres:5432/aurigraph_production
      - QUARKUS_DATASOURCE_USERNAME=aurigraph
      - QUARKUS_DATASOURCE_PASSWORD=aurigraph-prod-secure-2025
      - QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=validate

    ports:
      - "19103:9003"  # REST API (business-1)
      - "19104:9004"  # gRPC (business-1)

    volumes:
      - dlt-data:/deployments/data
      - dlt-logs:/deployments/logs

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9003/q/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

    networks:
      dlt-backend:
        ipv4_address: 172.21.1.21

    depends_on:
      - postgres
      - redis

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2.0'
        reservations:
          memory: 256M

    labels:
      - "com.dlt.service=business-1"
      - "com.dlt.tier=transaction-processing"

  # =========================================================================
  # Slim Node 1 (Edge-Optimized with LevelDB Storage)
  # =========================================================================
  slim-node-1:
    image: aurigraph-v11:11.4.4
    container_name: dlt-slim-node-1
    restart: unless-stopped
    profiles: ["slim-nodes"]

    environment:
      # Quarkus Configuration
      - QUARKUS_PROFILE=production
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=9003
      - QUARKUS_HTTP_HTTP2=true

      # Node Configuration
      - AURIGRAPH_NODE_ID=slim-1
      - AURIGRAPH_NODE_TYPE=slim
      - AURIGRAPH_MODE=production

      # Slim Node Configuration
      - LEVELDB_PATH=/deployments/data/leveldb
      - LEVELDB_CACHE_SIZE=64MB
      - LEVELDB_WRITE_BUFFER_SIZE=32MB
      - SLIM_NODE_SYNC_INTERVAL=10000
      - SLIM_NODE_MAX_MEMORY=384M

      # Database Configuration (read-only for slim nodes)
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://postgres:5432/aurigraph_production
      - QUARKUS_DATASOURCE_USERNAME=aurigraph
      - QUARKUS_DATASOURCE_PASSWORD=aurigraph-prod-secure-2025
      - QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=validate

    ports:
      - "19203:9003"  # REST API (slim-1)
      - "19204:9004"  # gRPC (slim-1)

    volumes:
      - dlt-slim-node-1-data:/deployments/data/leveldb
      - dlt-logs:/deployments/logs

    networks:
      dlt-backend:
        ipv4_address: 172.21.1.30

    depends_on:
      - postgres
      - redis

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9003/q/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

    labels:
      - "com.dlt.service=slim-1"
      - "com.dlt.tier=edge-node"
      - "com.dlt.storage=leveldb"
